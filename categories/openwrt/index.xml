<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Openwrt on </title>
        <link>https://charles-7777.github.io/hugo-stack/categories/openwrt/</link>
        <description>Recent content in Openwrt on </description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <copyright>Charles Lv</copyright>
        <lastBuildDate>Fri, 12 Dec 2025 16:08:56 +0800</lastBuildDate><atom:link href="https://charles-7777.github.io/hugo-stack/categories/openwrt/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>OverlayFS</title>
        <link>https://charles-7777.github.io/hugo-stack/p/overlayfs/</link>
        <pubDate>Tue, 29 Jul 2025 09:52:54 +0800</pubDate>
        
        <guid>https://charles-7777.github.io/hugo-stack/p/overlayfs/</guid>
        <description>&lt;h2 id=&#34;overlayfs-简介&#34;&gt;OverlayFS 简介
&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;OverlayFS&lt;/strong&gt; (Overlay Filesystem) 是一种联合文件系统（Union Filesystem），它允许用户将一个文件系统（通常是可写的）“覆盖”在另一个文件系统（通常是只读的）之上。对于用户来说，这两个文件系统看起来像是一个合并后的单一目录树。&lt;/p&gt;
&lt;p&gt;OverlayFS 在 Linux 内核 3.18 中被合并进主线，因其设计简洁、性能高效而被广泛应用于容器技术（如 Docker）和嵌入式系统（如 OpenWrt）。&lt;/p&gt;
&lt;h3 id=&#34;核心概念&#34;&gt;核心概念
&lt;/h3&gt;&lt;p&gt;OverlayFS 主要涉及四个目录层级：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Lower Dir (底层目录)&lt;/strong&gt;:
通常是只读的。
在 OpenWrt 中，这通常对应于压缩的只读固件部分（SquashFS）。
可以有多个 Lower 层。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Upper Dir (上层目录)&lt;/strong&gt;:
是可写的。
所有对文件系统的修改（新建、修改、删除）都会记录在这里。
在 OpenWrt 中，这通常对应于 JFFS2 或 UBIFS 分区。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Work Dir (工作目录)&lt;/strong&gt;:
一个对用户不可见的空目录，OverlayFS 使用它来准备文件操作（如原子性保证）。
必须与 Upper Dir 在同一个文件系统下。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Merged Dir (合并目录)&lt;/strong&gt;:
这是用户最终看到的挂载点。
它展示了 Lower 和 Upper 合并后的视图。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;工作原理&#34;&gt;工作原理
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;读取 (Read)&lt;/strong&gt;:
如果文件在 Upper 层存在，直接读取 Upper 层的文件。
如果文件仅在 Lower 层存在，读取 Lower 层的文件。
如果两层都有，Upper 层的文件会“遮盖”住 Lower 层的文件。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;写入 (Write)&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;修改文件&lt;/strong&gt;: 当尝试修改一个位于 Lower 层的文件时，OverlayFS 会触发 &lt;strong&gt;Copy-Up&lt;/strong&gt; 操作，将文件从 Lower 层复制到 Upper 层，然后对 Upper 层的文件进行修改。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;新建文件&lt;/strong&gt;: 直接在 Upper 层创建。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;删除 (Delete)&lt;/strong&gt;:
如果删除的是 Upper 层的文件，直接删除。
如果删除的是 Lower 层的文件，OverlayFS 会在 Upper 层创建一个特殊的 &lt;strong&gt;Whiteout&lt;/strong&gt; 文件（通常是字符设备 0/0），用于标记该文件已被“遮盖”（即删除），从而在 Merged 视图中不可见。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id=&#34;openwrt-中的-overlayfs-应用&#34;&gt;OpenWrt 中的 OverlayFS 应用
&lt;/h2&gt;&lt;p&gt;OpenWrt 是 OverlayFS 最经典的落地场景之一。它利用 OverlayFS 完美解决了嵌入式设备存储空间有限且需要系统恢复能力的矛盾。&lt;/p&gt;
&lt;h3 id=&#34;openwrt-的文件系统架构&#34;&gt;OpenWrt 的文件系统架构
&lt;/h3&gt;&lt;p&gt;OpenWrt 的固件通常包含两个主要部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;/rom&lt;/code&gt; (Read-Only)&lt;/strong&gt;:
这是一个 SquashFS 文件系统，包含了系统启动所需的所有基础文件、内核模块和默认配置。
它是高度压缩的，且在运行时是&lt;strong&gt;只读&lt;/strong&gt;的。这保证了系统核心文件的安全性，无论用户如何误操作，都可以恢复出厂设置。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;/overlay&lt;/code&gt; (Read-Write)&lt;/strong&gt;:
这是一个 JFFS2 (对于 NOR Flash) 或 UBIFS (对于 NAND Flash) 文件系统，或者是 ext4 (对于 SD 卡/硬盘)。
它用于存储用户的配置更改、安装的软件包等。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;挂载机制&#34;&gt;挂载机制
&lt;/h3&gt;&lt;p&gt;当 OpenWrt 启动时，它会执行以下逻辑（简化版）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;挂载 SquashFS 分区到 &lt;code&gt;/rom&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;挂载可写分区（如 JFFS2）到 &lt;code&gt;/overlay&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;使用 OverlayFS 将 &lt;code&gt;/overlay&lt;/code&gt;（Upper）覆盖在 &lt;code&gt;/rom&lt;/code&gt;（Lower）之上，并将结果挂载到根目录 &lt;code&gt;/&lt;/code&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;挂载命令示例&lt;/strong&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mount -t overlay overlay -o &lt;span class=&#34;nv&#34;&gt;lowerdir&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/rom,upperdir&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/overlay/upper,workdir&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/overlay/work /
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;(注：OpenWrt 的实际挂载过程由 &lt;code&gt;mount_root&lt;/code&gt; 和 &lt;code&gt;preinit&lt;/code&gt; 脚本处理，细节可能因版本而异，早期版本使用 &lt;code&gt;mini_fo&lt;/code&gt;，现代版本均使用 &lt;code&gt;overlayfs&lt;/code&gt;)*&lt;/p&gt;&lt;/blockquote&gt;
&lt;h3 id=&#34;实际操作与管理&#34;&gt;实际操作与管理
&lt;/h3&gt;&lt;h4 id=&#34;查看挂载状态&#34;&gt;查看挂载状态
&lt;/h4&gt;&lt;p&gt;在 OpenWrt 终端中输入 &lt;code&gt;df -h&lt;/code&gt; 或 &lt;code&gt;mount&lt;/code&gt; 可以看到 OverlayFS 的结构：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;root@OpenWrt:~# df -h
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Filesystem                Size      Used Available Use% Mounted on
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;/dev/root                 2.5M      2.5M         &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt; 100% /rom
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tmpfs                    61.8M    168.0K     61.6M   0% /tmp
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;/dev/mtdblock3            5.0M    424.0K      4.6M   8% /overlay
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;overlayfs:/overlay        5.0M    424.0K      4.6M   8% /
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;可以看到 &lt;code&gt;/&lt;/code&gt; 的类型是 &lt;code&gt;overlayfs:/overlay&lt;/code&gt;，它的大小等于 &lt;code&gt;/overlay&lt;/code&gt; 分区的大小。&lt;/p&gt;
&lt;h4 id=&#34;恢复出厂设置-firstboot&#34;&gt;恢复出厂设置 (Firstboot)
&lt;/h4&gt;&lt;p&gt;由于 OverlayFS 的特性，恢复出厂设置变得非常简单：只需要&lt;strong&gt;清空 &lt;code&gt;/overlay&lt;/code&gt; 分区&lt;/strong&gt;即可。&lt;/p&gt;
&lt;p&gt;当 &lt;code&gt;/overlay&lt;/code&gt; 被清空后，Upper 层没有了任何文件，系统重启后，OverlayFS 呈现的完全是 Lower 层（即 &lt;code&gt;/rom&lt;/code&gt;）的内容，系统就回到了初始状态。&lt;/p&gt;
&lt;p&gt;命令：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;firstboot -y
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;reboot
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h4 id=&#34;扩容-extroot&#34;&gt;扩容 (Extroot)
&lt;/h4&gt;&lt;p&gt;OpenWrt 设备的内置 Flash 通常很小（如 16MB）。利用 OverlayFS，我们可以轻松实现扩容（Extroot）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;插入一个 USB U盘。&lt;/li&gt;
&lt;li&gt;将 U盘格式化为 ext4。&lt;/li&gt;
&lt;li&gt;将 U盘挂载为 &lt;code&gt;/overlay&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;这样，系统的可用空间就变成了 U盘的大小，可以安装大量的软件包。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;常见问题&#34;&gt;常见问题
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;空间不足&lt;/strong&gt;: 如果 &lt;code&gt;/overlay&lt;/code&gt; 满了，系统可能无法保存配置或安装软件。此时删除文件实际上是在 Upper 层操作。
&lt;strong&gt;文件被遮挡&lt;/strong&gt;: 如果你在 &lt;code&gt;/rom&lt;/code&gt; 中修改了源码重新编译固件，但刷机后发现文件没变，可能是因为 &lt;code&gt;/overlay&lt;/code&gt; 中存在旧的修改版本遮挡了新的 &lt;code&gt;/rom&lt;/code&gt; 文件。刷机时通常建议选择“不保留配置”来清空 &lt;code&gt;/overlay&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&#34;总结&#34;&gt;总结
&lt;/h2&gt;&lt;p&gt;OverlayFS 是 OpenWrt 灵活性的基石。它通过分层机制，既保证了系统底层的稳定性（只读的 &lt;code&gt;/rom&lt;/code&gt;），又提供了用户所需的灵活性（可写的 &lt;code&gt;/overlay&lt;/code&gt;），并且实现了极低成本的“恢复出厂设置”功能。理解 OverlayFS 对于深入玩转 OpenWrt（如定制固件、扩容、调试）至关重要。&lt;/p&gt;
</description>
        </item>
        
    </channel>
</rss>
