[{"content":"æœ¬æ–‡ä»‹ç» Wi-Fi ç‰©ç†å±‚åå•†é€Ÿç‡ï¼ˆPHY Rateï¼‰çš„è®¡ç®—æ–¹æ³•ï¼Œå¹¶æä¾› 802.11ac (Wi-Fi 5) å’Œ 802.11ax (Wi-Fi 6) çš„ MCS (Modulation and Coding Scheme) è¡¨ã€‚\nè®¡ç®—å…¬å¼ Wi-Fi çš„ç†è®ºç‰©ç†å±‚é€Ÿç‡å¯ä»¥é€šè¿‡ä»¥ä¸‹å…¬å¼è®¡ç®—ï¼š\n$$ \\text{Data Rate} = N_{ss} \\times \\frac{N_{sd} \\times N_{bps} \\times R}{T_{sym}} $$ä¾‹å¦‚ ac 40Mhz 4x4 çš„æœ€å¤§é€Ÿç‡ $ \\text{Rate} = 4 \\times \\frac{108 \\times 8 \\times (5/6)}{3.6 \\mu s} = 800 Mbps$\nå…¶ä¸­å„å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š\nå‚æ•° å«ä¹‰ è¯´æ˜ $N_{ss}$ Spatial Streams ç©ºé—´æµæ•°é‡ (MIMO)ï¼Œä¾‹å¦‚ 1x1, 2x2, 3x3, 4x4ã€‚$Nss,max=min(N_{Tx},N_{Rx})$ $N_{sd}$ Data Subcarriers æ•°æ®å­è½½æ³¢æ•°é‡ã€‚å–å†³äºä¿¡é“å¸¦å®½ (20/40/80/160 MHz) å’Œåè®®æ ‡å‡† (11n/ac/ax)ã€‚ $N_{bps}$ Bits per Symbol æ¯ä¸ªç¬¦å·æºå¸¦çš„æ¯”ç‰¹æ•°ã€‚ç”±è°ƒåˆ¶æ–¹å¼å†³å®š (e.g., 64-QAM = 6 bits, 256-QAM = 8 bits, 1024-QAM = 10 bits)ã€‚ $R$ Coding Rate ç¼–ç ç‡ã€‚æœ‰æ•ˆæ•°æ®ä½ä¸æ€»ä¼ è¾“ä½ï¼ˆå«çº é”™ç ï¼‰çš„æ¯”ç‡ (e.g., 3/4, 5/6)ã€‚ $T_{sym}$ Symbol Duration ç¬¦å·æŒç»­æ—¶é—´ã€‚$T_{sym} = T_{base} + T_{GI}$ (Guard Interval)ã€‚ ç®€åŒ–ç†è§£ é€Ÿç‡ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªç»´åº¦å†³å®šï¼š\né¢‘å®½ (Bandwidth): è½¦é“è¶Šå®½ï¼Œé€šè¿‡çš„è½¦è¶Šå¤š (20MHz vs 160MHz)ã€‚\nè°ƒåˆ¶æ–¹å¼ (Modulation): è½¦è£…çš„è´§è¶Šå¤š (QAM é˜¶æ•°è¶Šé«˜)ã€‚\nMIMO (Spatial Streams): é«˜æ¶æ¡¥å±‚æ•°è¶Šå¤š (å¤©çº¿æ•°)ã€‚\nä¿æŠ¤é—´éš” (Guard Interval): è½¦è·è¶Šå°ï¼Œå‘è½¦è¶Šå¿«ã€‚ ç¬¦å·æŒç»­æ—¶é—´ æ ‡å‡† å­è½½æ³¢é—´éš” åŸºç¡€ç¬¦å·æ—¶é—´ ($T_{base}$) ä¿æŠ¤é—´éš” ($T_{GI}$) æ€»ç¬¦å·æ—¶é—´ ($T_{sym}$) 802.11n/ac 312.5 kHz 3.2 Âµs 0.4 Âµs (Short GI) 3.6 Âµs 802.11n/ac 312.5 kHz 3.2 Âµs 0.8 Âµs (Long GI) 4.0 Âµs 802.11ax 78.125Â kHz 12.8 Âµs 0.8 Âµs 13.6 Âµs 802.11ax 78.125 kHz 12.8 Âµs 1.6 Âµs 14.4 Âµs 802.11ax 78.125 kHz 12.8 Âµs 3.2 Âµs 16.0 Âµs æ•°æ®å­è½½æ³¢æ•°é‡ é¢‘å®½ (Bandwidth) 802.11ac (Wi-Fi 5) 802.11ax (Wi-Fi 6) 20 MHz 52 234 40 MHz 108 468 80 MHz 234 980 160 MHz 468 1960 802.11ac: ä½¿ç”¨ 312.5 kHz çš„å­è½½æ³¢é—´éš”, 802.11ax: ä½¿ç”¨æ›´å¯†é›†çš„ 78.125 kHz å­è½½æ³¢é—´éš”ï¼ˆæ˜¯ ac çš„ 1/4ï¼‰ 20MHz/312.5kHz=64,è¿™ä¸ª 64 æ­£æ˜¯ Wi-Fi (802.11ac) åœ¨ 20MHz é¢‘å®½ä¸‹çš„ FFT å¤§å° (æ€»å­è½½æ³¢æ•°é‡)ã€‚ä½†åœ¨å®é™…ä¼ è¾“ä¸­ï¼Œå¹¶ä¸æ˜¯è¿™ 64 ä¸ªå­è½½æ³¢éƒ½èƒ½ç”¨æ¥ä¼ æ•°æ®ã€‚ä¸ºäº†é¿å…å¹²æ‰°å’ŒåŒæ­¥ä¿¡å·.å®ƒä»¬è¢«åˆ†é…å¦‚ä¸‹52(æ•°æ®å­è½½æ³¢)+4(å¯¼é¢‘å­è½½æ³¢)+1(ç›´æµå­è½½æ³¢)+7(ä¿æŠ¤å­è½½æ³¢)=64;802.11axçš„ 234+8+3+11=256\n802.11ac (Wi-Fi 5) MCS è¡¨ æ ‡å‡†ç‰¹æ€§:\næœ€é«˜æ”¯æŒ 256-QAM (MCS 8, 9)ã€‚\næ”¯æŒ 20/40/80/160 MHz é¢‘å®½ã€‚\nGuard Interval (GI): Long (800ns), Short (400ns)ã€‚\nä»¥ä¸‹è¡¨æ ¼å±•ç¤º å•æµ (1 Spatial Stream) åœ¨ Short GI (400ns) ä¸‹çš„é€Ÿç‡ (Mbps)ã€‚\nå¦‚æœæ˜¯å¤šæµ (å¦‚ 2x2)ï¼Œå°†ä¸‹è¡¨é€Ÿç‡ä¹˜ä»¥ 2 å³å¯ã€‚\nMCS Index Modulation Coding Rate 20 MHz 40 MHz 80 MHz 160 MHz 0 BPSK 1/2 7.2 15.0 32.5 65.0 1 QPSK 1/2 14.4 30.0 65.0 130.0 2 QPSK 3/4 21.7 45.0 97.5 195.0 3 16-QAM 1/2 28.9 60.0 130.0 260.0 4 16-QAM 3/4 43.3 90.0 195.0 390.0 5 64-QAM 2/3 57.8 120.0 260.0 520.0 6 64-QAM 3/4 65.0 135.0 292.5 585.0 7 64-QAM 5/6 72.2 150.0 325.0 650.0 8 256-QAM 3/4 86.7 180.0 390.0 780.0 9 256-QAM 5/6 N/A 200.0 433.3 866.7 æ³¨: å¸¸è§çš„ \u0026ldquo;433 Mbps\u0026rdquo; å°±æ˜¯ 11ac 1x1 80MHz MCS9 çš„é€Ÿç‡ï¼›\u0026ldquo;866 Mbps\u0026rdquo; æ˜¯ 2x2 çš„é€Ÿç‡ã€‚\n802.11ax (Wi-Fi 6) MCS è¡¨ æ ‡å‡†ç‰¹æ€§:\nå¼•å…¥ 1024-QAM (MCS 10, 11)ã€‚\næ›´é«˜æ•ˆçš„å­è½½æ³¢åˆ©ç”¨ç‡ (æ›´å¤šçš„æ•°æ®å­è½½æ³¢)ã€‚\nGuard Interval (GI): 0.8us, 1.6us, 3.2usã€‚é€šå¸¸ä½¿ç”¨ 0.8us è·å¾—æœ€é«˜é€Ÿç‡ã€‚\nä»¥ä¸‹è¡¨æ ¼å±•ç¤º å•æµ (1 Spatial Stream) åœ¨ 0.8us GI ä¸‹çš„é€Ÿç‡ (Mbps)ã€‚\nMCS Index Modulation Coding Rate 20 MHz 40 MHz 80 MHz 160 MHz 0 BPSK 1/2 8.6 17.2 36.0 72.1 1 QPSK 1/2 17.2 34.4 72.1 144.1 2 QPSK 3/4 25.8 51.6 108.1 216.2 3 16-QAM 1/2 34.4 68.8 144.1 288.2 4 16-QAM 3/4 51.6 103.2 216.2 432.4 5 64-QAM 2/3 68.8 137.6 288.2 576.5 6 64-QAM 3/4 77.4 154.9 324.3 648.5 7 64-QAM 5/6 86.0 172.1 360.3 720.6 8 256-QAM 3/4 103.2 206.5 432.4 864.7 9 256-QAM 5/6 114.7 229.4 480.4 960.8 10 1024-QAM 3/4 129.0 258.1 540.4 1080.9 11 1024-QAM 5/6 143.4 286.8 600.5 1201.0 æ³¨: Wi-Fi 6 çš„ \u0026ldquo;1201 Mbps\u0026rdquo; æ˜¯ 2x2 80MHz MCS11 çš„é€Ÿç‡ (600.5 * 2)ã€‚\nå‚è€ƒé“¾æ¥ https://zhuanlan.zhihu.com/p/1944204299568677330\n","date":"2025-12-12T15:25:55+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/wi-fi-%E9%80%9F%E7%8E%87%E8%AE%A1%E7%AE%97/","title":"Wi-Fi é€Ÿç‡è®¡ç®—"},{"content":" èšç±»ï¼ˆclusteringï¼‰æ˜¯ä¸€ç§å¯»æ‰¾æ•°æ®ä¹‹é—´å†…åœ¨ç»“æ„çš„æŠ€æœ¯ã€‚èšç±»æŠŠå…¨ä½“æ•°æ®å®ä¾‹ç»„ç»‡æˆä¸€äº›ç›¸ä¼¼ç»„ï¼Œè€Œè¿™äº›ç›¸ä¼¼ç»„è¢«ç§°ä½œç°‡ã€‚å¤„äºç›¸åŒç°‡ä¸­çš„æ•°æ®å®ä¾‹å½¼æ­¤ç›¸åŒï¼Œå¤„äºä¸åŒç°‡ä¸­çš„å®ä¾‹å½¼æ­¤ä¸åŒã€‚K-Meansã€AgglomerativeClusteringã€DBSCANã€MeanShiftã€SpectralClustering ç­‰æ˜¯å¸¸ç”¨çš„èšç±»æ–¹æ³•ã€‚ K-Means ç®—æ³•åˆå K å‡å€¼ç®—æ³•ï¼ŒK-Means ç®—æ³•ä¸­çš„ K è¡¨ç¤ºçš„æ˜¯èšç±»ä¸º K ä¸ªç°‡ï¼ŒMeans ä»£è¡¨å–æ¯ä¸€ä¸ªèšç±»ä¸­æ•°æ®å€¼çš„å‡å€¼ä½œä¸ºè¯¥ç°‡çš„ä¸­å¿ƒï¼Œæˆ–è€…ç§°ä¸ºè´¨å¿ƒï¼Œå³ç”¨æ¯ä¸€ä¸ªç±»çš„è´¨å¿ƒå¯¹è¯¥ç°‡è¿›è¡Œæè¿°ã€‚\nK-Means ç®—æ³•åŸç† ç®€ä»‹ K-Means æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„æ— ç›‘ç£å­¦ä¹ (æ²¡æ ‡å‡†ç­”æ¡ˆä¸‹å»å­¦ä¹ )ç®—æ³•ï¼Œç”¨äºå°†æ•°æ®ç‚¹åˆ’åˆ†ä¸ºÂ kÂ ä¸ªç°‡ï¼ˆClusterï¼‰ã€‚å…¶ç›®æ ‡æ˜¯ä½¿åŒä¸€ç°‡å†…çš„æ•°æ®ç‚¹å°½å¯èƒ½ç›¸ä¼¼ï¼Œè€Œä¸åŒç°‡ä¹‹é—´çš„æ•°æ®ç‚¹å°½å¯èƒ½ä¸åŒã€‚\nç®—æ³•åŸç† K-Means ç®—æ³•æ˜¯ä¸€ä¸ªè¿­ä»£è¿‡ç¨‹ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š\nåˆå§‹åŒ– (Initialization): éšæœºé€‰æ‹©Â kÂ ä¸ªæ•°æ®ç‚¹ä½œä¸ºåˆå§‹è´¨å¿ƒï¼ˆCentroidsï¼‰ã€‚ åˆ†é… (Assignment): è®¡ç®—æ¯ä¸ªæ•°æ®ç‚¹åˆ°è¿™Â kÂ ä¸ªè´¨å¿ƒçš„è·ç¦»ï¼Œå¹¶å°†æ¯ä¸ªæ•°æ®ç‚¹åˆ†é…ç»™æœ€è¿‘çš„è´¨å¿ƒæ‰€ä»£è¡¨çš„ç°‡ã€‚ æ›´æ–° (Update): é‡æ–°è®¡ç®—æ¯ä¸ªç°‡çš„è´¨å¿ƒã€‚æ–°çš„è´¨å¿ƒæ˜¯è¯¥ç°‡å†…æ‰€æœ‰æ•°æ®ç‚¹çš„å¹³å‡å€¼ï¼ˆå‡å€¼ï¼‰ã€‚ é‡å¤ (Repeat): é‡å¤æ­¥éª¤ 2 å’Œ 3ï¼Œç›´åˆ°æ»¡è¶³åœæ­¢æ¡ä»¶ï¼ˆä¾‹å¦‚ï¼šè´¨å¿ƒä¸å†å‘ç”Ÿå˜åŒ–ã€è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°æˆ–è¯¯å·®å¹³æ–¹å’Œæ”¶æ•›ï¼‰ æ•°å­¦å…¬å¼ ç›®æ ‡å‡½æ•° K-Means çš„ç›®æ ‡æ˜¯æœ€å°åŒ–ç°‡å†…è¯¯å·®å¹³æ–¹å’Œ(Within-Cluster Sum of Squares, WCSS)ï¼Œä¹Ÿç§°ä¸ºæƒ¯æ€§ï¼ˆInertiaï¼‰ã€‚\n$$ J =SEE= \\sum_{i=1}^k\\sum_{x\\in C_i}||x-\\mu_i||^2 $$å…¶ä¸­ï¼š\nJÂ æ˜¯ç›®æ ‡å‡½æ•°å€¼:æ•´ä¸ªæ•°æ®é›†çš„è¯¯å·®å¹³æ–¹å’Œï¼ˆSum of Squared Errorï¼ŒSSEï¼‰ã€‚ kÂ æ˜¯ç°‡çš„æ•°é‡ã€‚ $C_i$â€‹Â æ˜¯ç¬¬Â iÂ ä¸ªç°‡ã€‚ XÂ æ˜¯ç°‡Â $C_i$ä¸­çš„æ•°æ®ç‚¹ã€‚ $\\mu_i$æ˜¯ç°‡Â $C_i$çš„è´¨å¿ƒã€‚ $||x-\\mu_i||^2$ æ˜¯æ•°æ®ç‚¹Â xÂ åˆ°è´¨å¿ƒÂ $\\mu_i$â€‹Â çš„æ¬§å‡ é‡Œå¾—è·ç¦»çš„å¹³æ–¹ è´¨å¿ƒæ›´æ–°å…¬å¼ åœ¨ç¬¬Â t+1Â æ¬¡è¿­ä»£ä¸­ï¼Œç°‡$C_i$Â çš„æ–°è´¨å¿ƒ$\\mu_i^{(t+1)}$Â è®¡ç®—å¦‚ä¸‹ï¼š\n$$ \\mu_i^{(t+1)} = \\frac{1}{|C_i^{(t)}|} \\sum_{x\\in C_i^{(t)}} x $$å…¶ä¸­Â $|C_i^{(t)}|$Â æ˜¯ç¬¬Â tÂ æ¬¡è¿­ä»£ä¸­ç°‡Â $C_i$å†…æ•°æ®ç‚¹çš„æ•°é‡ã€‚\nç®€å•æ ·ä¾‹è¯´æ˜ å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸€ç»´æ•°æ®ç‚¹ï¼š[2, 4, 10, 12, 3, 20, 30, 11, 25]ï¼Œæˆ‘ä»¬æƒ³å°†å…¶åˆ†ä¸ºÂ k=2Â ä¸ªç°‡ã€‚\nåˆå§‹åŒ–: éšæœºé€‰Â 2Â å’ŒÂ 30Â ä¸ºè´¨å¿ƒã€‚ Î¼1â€‹=2,Â Î¼2â€‹=30 åˆ†é…: é è¿‘ 2 çš„ç‚¹:Â {2, 3, 4, 10, 11, 12}Â -\u0026gt; ç°‡ 1 é è¿‘ 30 çš„ç‚¹:Â {20, 25, 30}Â -\u0026gt; ç°‡ 2 æ›´æ–°: æ–°Â Î¼1â€‹=(2+3+4+10+11+12)/6=42/6=7 æ–°Â Î¼2â€‹=(20+25+30)/3=75/3=25 è¿­ä»£: ä½¿ç”¨æ–°è´¨å¿ƒÂ 7Â å’ŒÂ 25Â é‡æ–°åˆ†é…ï¼Œç›´åˆ°è´¨å¿ƒç¨³å®š Python ä»£ç æ ·ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 import numpy as np import matplotlib.pyplot as plt from sklearn.datasets import make_blobs from matplotlib.animation import FuncAnimation # ========================================== # 1. æ•°æ®å‡†å¤‡ # ========================================== print(\u0026#34;Generating data...\u0026#34;) X, y_true = make_blobs(n_samples=300, centers=4, cluster_std=0.60, random_state=0) # ========================================== # 2. K-Means ç®—æ³•æ‰‹åŠ¨å®ç° (ä¸ºäº†è®°å½•æ¯ä¸€æ­¥) # ========================================== class KMeansManual: def __init__(self, X, k=4): self.X = X self.k = k # éšæœºé€‰æ‹©kä¸ªç‚¹ä½œä¸ºåˆå§‹è´¨å¿ƒ indices = np.random.choice(X.shape[0], k, replace=False) self.centroids = X[indices] self.labels = None self.history = [] # ç”¨äºå­˜å‚¨æ¯ä¸€æ­¥çš„çŠ¶æ€: (centroids, labels, title) def run(self, max_iters=10): # è®°å½•åˆå§‹çŠ¶æ€ self.history.append((self.centroids.copy(), None, \u0026#34;Initialization\u0026#34;)) for i in range(max_iters): # --- æ­¥éª¤ 1: åˆ†é… (Assignment) --- # è®¡ç®—è·ç¦»çŸ©é˜µ: (k, n_samples) # åˆ©ç”¨å¹¿æ’­æœºåˆ¶è®¡ç®—æ¯ä¸ªç‚¹åˆ°æ¯ä¸ªè´¨å¿ƒçš„æ¬§æ°è·ç¦» distances = np.linalg.norm(self.X[:, np.newaxis] - self.centroids, axis=2) # è·å–æœ€è¿‘è´¨å¿ƒçš„ç´¢å¼• self.labels = np.argmin(distances, axis=1) # è®°å½•åˆ†é…åçš„çŠ¶æ€ self.history.append((self.centroids.copy(), self.labels.copy(), f\u0026#34;Iteration {i+1}: Assignment\u0026#34;)) # --- æ­¥éª¤ 2: æ›´æ–° (Update) --- new_centroids = np.array([ self.X[self.labels == j].mean(axis=0) if np.sum(self.labels == j) \u0026gt; 0 else self.centroids[j] for j in range(self.k) ]) # è®°å½•æ›´æ–°è´¨å¿ƒåçš„çŠ¶æ€ self.history.append((new_centroids.copy(), self.labels.copy(), f\u0026#34;Iteration {i+1}: Update Centroids\u0026#34;)) # --- æ£€æŸ¥æ”¶æ•› --- if np.allclose(self.centroids, new_centroids): print(f\u0026#34;Converged at iteration {i+1}\u0026#34;) break self.centroids = new_centroids # è¿è¡Œç®—æ³• k = 4 kmeans = KMeansManual(X, k=k) kmeans.run() # ========================================== # 3. åŠ¨ç”»å¯è§†åŒ– # ========================================== print(\u0026#34;Starting animation...\u0026#34;) fig, ax = plt.subplots(figsize=(10, 7)) def update(frame_idx): ax.clear() centroids, labels, title = kmeans.history[frame_idx] # ç»˜åˆ¶æ•°æ®ç‚¹ if labels is None: # åˆå§‹çŠ¶æ€ï¼Œæœªåˆ†ç±»ï¼Œæ˜¾ç¤ºä¸ºç°è‰² ax.scatter(X[:, 0], X[:, 1], c=\u0026#39;gray\u0026#39;, s=50, alpha=0.5) else: # å·²åˆ†ç±»ï¼ŒæŒ‰ç±»åˆ«ç€è‰² ax.scatter(X[:, 0], X[:, 1], c=labels, s=50, cmap=\u0026#39;viridis\u0026#39;, alpha=0.6) # ç»˜åˆ¶è´¨å¿ƒ (çº¢è‰²å¤§å‰) ax.scatter(centroids[:, 0], centroids[:, 1], c=\u0026#39;red\u0026#39;, s=200, marker=\u0026#39;X\u0026#39;, edgecolors=\u0026#39;white\u0026#39;, linewidths=2, label=\u0026#39;Centroids\u0026#39;) # ç»˜åˆ¶è´¨å¿ƒç§»åŠ¨è½¨è¿¹ (å¯é€‰ï¼Œå¦‚æœä¸æ˜¯ç¬¬ä¸€å¸§) if frame_idx \u0026gt; 0: prev_centroids, _, _ = kmeans.history[frame_idx-1] # ç®€å•çš„ç»˜åˆ¶ä»ä¸Šä¸€ä¸ªä½ç½®åˆ°å½“å‰ä½ç½®çš„çº¿ for i in range(k): ax.plot([prev_centroids[i, 0], centroids[i, 0]], [prev_centroids[i, 1], centroids[i, 1]], \u0026#39;k--\u0026#39;, alpha=0.5) ax.set_title(title, fontsize=14) ax.set_xlabel(\u0026#34;Feature 1\u0026#34;) ax.set_ylabel(\u0026#34;Feature 2\u0026#34;) ax.legend() ax.grid(True, alpha=0.3) # åˆ›å»ºåŠ¨ç”» # interval=1000 è¡¨ç¤ºæ¯å¸§åœç•™ 1000ms (1ç§’) ani = FuncAnimation(fig, update, frames=len(kmeans.history), interval=2000, repeat=True) plt.show() K-Meansç®—æ³•çš„é—®é¢˜ Kå¦‚ä½•ç¡®å®š æ‰‹è‚˜æ³• ç®—æ³•æ‰€éœ€è¦é¢„è®¾çš„å‚æ•°è‡³å°‘æœ‰2ä¸ªï¼šç°‡ä¸ªæ•°Kå’Œåˆå§‹ç°‡è´¨å¿ƒ\nèšç±»çš„ç›®æ ‡æ˜¯ä½¿å¾—æ¯ä¸ªæ ·æœ¬ç‚¹åˆ°è·ç¦»å…¶æœ€è¿‘çš„èšç±»ä¸­å¿ƒçš„æ€»è¯¯å·®å¹³æ–¹å’Œ(SSE)å°½å¯èƒ½å°ã€‚\nç†è®ºä¸Šéšç€Kçš„å¢åŠ ï¼ŒSSEä¼šå•è°ƒé€’å‡ï¼Œå› ä¸ºç±»æ•°çš„å¢åŠ æ„å‘³ç€æ€»æœ‰ä¸€éƒ¨åˆ†æ ·æœ¬ç‚¹ä¼šå› ä¸ºå½’å±åˆ°æ–°çš„ç±»ç°‡è€ŒèŠ‚çº¦ä¸‹ä¸€æ®µè·ç¦»ï¼Œç›´åˆ°K=Næ—¶ï¼Œæƒ…å†µå°†æ¼”å˜ä¸ºæ¯ä¸ªæ ·æœ¬è‡ªæˆä¸€ç±»ï¼Œæ­¤æ—¶SSEå€¼å°±ä¼šé™ä¸º0,è¿™ä¹Ÿå°±æ²¡æ„ä¹‰äº†ã€‚\næ ¹æ®å­¦è€…ä»¬çš„é•¿æœŸå®è·µç»éªŒï¼ŒKå€¼æœ€å¤§ä¸åº”è¶…è¿‡æ ·æœ¬é‡çš„å¼€å¹³æ–¹æ ¹ï¼Œå³$K_{max}\u0026lt;= \\sqrt N$ ã€‚è€Œç¡®å®šäº†èŒƒå›´åï¼Œæœ€ä¼˜Kå€¼åˆåº”è¯¥æ€ä¹ˆåˆ¤æ–­ï¼Ÿä¸€ç§ç®€å•çš„æ€è·¯æ˜¯ï¼šè¯•å›¾æ‰¾åˆ°æŸä¸€ä¸ªKå€¼ï¼Œè¦æ±‚å½“Kå¤§äºè¯¥å€¼æ—¶ï¼ŒSSEçš„ä¸‹é™å˜åŒ–å¹…åº¦ï¼ˆæˆ–é€Ÿåº¦ï¼‰æ˜æ˜¾å˜å°ã€‚æ¢å¥è¯è¯´ï¼Œå½“Kè¶…è¿‡æŸä¸€ä¸ªæ•°åï¼Œæ¯ä¸ªç±»ç°‡çš„èšåˆç¨‹åº¦ä¸å†è·å¾—æ˜¾è‘—æå‡ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºå·²æ‰¾åˆ°æœ€ä½³Kçš„å–å€¼ã€‚è¿™ä¹Ÿæ˜¯æ‰‹è‚˜æ³•é€šè¿‡ç”»å‡ºä¸åŒKå€¼ä¸SSEå€¼çš„æŠ˜çº¿å›¾ï¼Œè‹¥SSEå€¼ä¸‹é™è¿‡ç¨‹ä¸­å­˜åœ¨â€œè‚˜ç‚¹â€ï¼ˆä¸‹é™é€Ÿåº¦éª¤å‡çš„æ‹ç‚¹å¤„ï¼‰ï¼Œè¯¥ç‚¹æ‰€å¯¹åº”çš„Kå€¼å³åˆé€‚çš„èšç±»æ•°ã€‚ä¸è¿‡é—æ†¾çš„æ˜¯ï¼Œè‹¥SSEçš„ä¸‹é™æ˜¯å‡åŒ€çš„ï¼Œä¼ ç»Ÿçš„è‚˜éƒ¨å›¾æ³•ä¹Ÿå°±å¤±çµäº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 import numpy as np import matplotlib.pyplot as plt from sklearn.cluster import KMeans from sklearn.datasets import make_blobs # ========================================== # 1. æ•°æ®å‡†å¤‡ # ========================================== print(\u0026#34;Generating data...\u0026#34;) # ç”Ÿæˆç¨å¾®å¤æ‚ä¸€ç‚¹çš„æ•°æ®ï¼Œä»¥ä¾¿è§‚å¯Ÿè‚˜éƒ¨ X, y_true = make_blobs(n_samples=500, centers=5, cluster_std=0.8, random_state=42) # ========================================== # 2. è®¡ç®—ä¸åŒ K å€¼çš„ WCSS (Inertia) # ========================================== wcss = [] # Within-Cluster Sum of Squares (ç°‡å†…è¯¯å·®å¹³æ–¹å’Œ) k_range = range(1, 11) # æµ‹è¯• k ä» 1 åˆ° 10 print(\u0026#34;Calculating WCSS for different k values...\u0026#34;) for k in k_range: kmeans = KMeans(n_clusters=k, random_state=42) kmeans.fit(X) wcss.append(kmeans.inertia_) # inertia_ å±æ€§å°±æ˜¯ WCSS print(f\u0026#34;k={k}, WCSS={kmeans.inertia_:.2f}\u0026#34;) # ========================================== # 3. ç»˜åˆ¶è‚˜éƒ¨å›¾ (Elbow Plot) # ========================================== plt.figure(figsize=(10, 6)) plt.plot(k_range, wcss, marker=\u0026#39;o\u0026#39;, linestyle=\u0026#39;-\u0026#39;, color=\u0026#39;b\u0026#39;) # æ ‡æ³¨è½´å’Œæ ‡é¢˜ plt.title(\u0026#39;Elbow Method For Optimal k (è‚˜éƒ¨æ³•åˆ™)\u0026#39;, fontsize=16) plt.xlabel(\u0026#39;Number of clusters (k)\u0026#39;, fontsize=12) plt.ylabel(\u0026#39;WCSS (Inertia)\u0026#39;, fontsize=12) plt.xticks(k_range) plt.grid(True) # æ ‡è®°å¯èƒ½çš„è‚˜éƒ¨ç‚¹ (åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“çœŸå®ä¸­å¿ƒæ˜¯5ï¼Œæ‰€ä»¥è‚˜éƒ¨åº”è¯¥åœ¨5é™„è¿‘) # è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ç®€å•æ ‡æ³¨ä¸€ä¸‹ k=5 çš„ä½ç½® optimal_k = 5 plt.annotate(f\u0026#39;Possible Elbow Point (k={optimal_k})\u0026#39;, xy=(optimal_k, wcss[optimal_k-1]), xytext=(optimal_k+1, wcss[optimal_k-1]+1000), arrowprops=dict(facecolor=\u0026#39;red\u0026#39;, shrink=0.05), fontsize=12, color=\u0026#39;red\u0026#39;) plt.show() è½®å»“ç³»æ•°ï¼ˆSilhouette Coefficientï¼‰æ³• æ˜¯ä¸€ç§ç”¨äºè¯„ä¼°èšç±»æ•ˆæœå¹¶å¸®åŠ©ç¡®å®šæœ€ä¼˜èšç±»æ•° K çš„æ–¹æ³•ã€‚å®ƒç»“åˆäº†å‡èšåº¦ï¼ˆcohesionï¼‰å’Œåˆ†ç¦»åº¦ï¼ˆseparationï¼‰ä¸¤ä¸ªæŒ‡æ ‡\nè½®å»“ç³»æ•°çš„å®šä¹‰ å¯¹äºæ•°æ®é›†ä¸­çš„æ¯ä¸€ä¸ªæ ·æœ¬ç‚¹ $x_i$â€‹ï¼Œå…¶è½®å»“ç³»æ•° $s(i)$ å®šä¹‰ä¸ºï¼š\n$$ s(i) = \\frac{b(i) - a(i)}{\\max\\{a(i), b(i)\\}} $$å…¶ä¸­ï¼š a(i)ï¼šæ ·æœ¬Â xiâ€‹Â åˆ°åŒç°‡å†…å…¶ä»–ç‚¹çš„å¹³å‡è·ç¦»ï¼ˆè¡¡é‡å‡èšåº¦ï¼‰ã€‚ b(i)ï¼šæ ·æœ¬Â xiâ€‹Â åˆ°æœ€è¿‘çš„å…¶ä»–ç°‡ä¸­æ‰€æœ‰ç‚¹çš„å¹³å‡è·ç¦»ï¼ˆè¡¡é‡åˆ†ç¦»åº¦ï¼‰ã€‚\nè½®å»“ç³»æ•°çš„å–å€¼èŒƒå›´ä¸º [âˆ’1,1]ï¼š - æ¥è¿‘ 1ï¼šè¡¨ç¤ºæ ·æœ¬èšç±»åˆç†ï¼Œç°‡å†…ç´§å¯†ã€ç°‡é—´åˆ†ç¦»è‰¯å¥½ã€‚ - æ¥è¿‘ 0ï¼šè¡¨ç¤ºæ ·æœ¬åœ¨ä¸¤ä¸ªç°‡è¾¹ç•Œä¸Šã€‚ - æ¥è¿‘ -1ï¼šè¡¨ç¤ºæ ·æœ¬å¯èƒ½è¢«åˆ†é…åˆ°äº†é”™è¯¯çš„ç°‡ã€‚\nä½¿ç”¨è½®å»“ç³»æ•°ç¡®å®š K å€¼çš„æ­¥éª¤ å¯¹ä¸åŒçš„Â KÂ å€¼ï¼ˆå¦‚Â K=2,3,\u0026hellip;,Kmaxâ€‹ï¼‰è¿è¡Œ K-means èšç±»ã€‚ å¯¹æ¯æ¬¡èšç±»ç»“æœï¼Œè®¡ç®—æ¯ä¸ªæ ·æœ¬çš„è½®å»“ç³»æ•°ï¼Œå†æ±‚æ‰€æœ‰æ ·æœ¬çš„å¹³å‡è½®å»“ç³»æ•°ã€‚ é€‰æ‹©ä½¿å¹³å‡è½®å»“ç³»æ•°æœ€å¤§çš„Â KÂ å€¼ä½œä¸ºæœ€ä¼˜èšç±»æ•°. æ³¨æ„ï¼šè½®å»“ç³»æ•°æ³•å‡è®¾ç°‡æ˜¯å‡¸å½¢ä¸”å¤§å°ç›¸è¿‘çš„ï¼Œå¯¹äºéçƒå½¢æˆ–å¯†åº¦å·®å¼‚å¤§çš„ç°‡å¯èƒ½ä¸é€‚ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 import numpy as np import matplotlib.pyplot as plt from sklearn.cluster import KMeans from sklearn.datasets import make_blobs from sklearn.metrics import silhouette_score # ========================================== # 1. æ•°æ®å‡†å¤‡ # ========================================== print(\u0026#34;Generating data...\u0026#34;) # ç”Ÿæˆä¸ä¹‹å‰ç±»ä¼¼çš„æ¨¡æ‹Ÿæ•°æ®ï¼Œé¢„è®¾ä¸­å¿ƒä¸º 5 X, y_true = make_blobs(n_samples=500, centers=5, cluster_std=0.8, random_state=42) # ========================================== # 2. è®¡ç®—ä¸åŒ K å€¼çš„è½®å»“ç³»æ•° (Silhouette Score) # ========================================== silhouette_scores = [] # æ³¨æ„ï¼šè½®å»“ç³»æ•°è‡³å°‘éœ€è¦ 2 ä¸ªç°‡æ‰èƒ½è®¡ç®—ï¼Œæ‰€ä»¥ä» k=2 å¼€å§‹ k_range = range(2, 11) print(\u0026#34;Calculating Silhouette Scores for different k values...\u0026#34;) for k in k_range: kmeans = KMeans(n_clusters=k, random_state=42) labels = kmeans.fit_predict(X) # è®¡ç®—æ‰€æœ‰æ ·æœ¬çš„å¹³å‡è½®å»“ç³»æ•° # è½®å»“ç³»æ•°èŒƒå›´æ˜¯ [-1, 1]ï¼Œè¶Šæ¥è¿‘ 1 è¡¨ç¤ºèšç±»æ•ˆæœè¶Šå¥½ score = silhouette_score(X, labels) silhouette_scores.append(score) print(f\u0026#34;k={k}, Silhouette Score={score:.4f}\u0026#34;) # ========================================== # 3. ç»˜åˆ¶è½®å»“ç³»æ•°å›¾ # ========================================== plt.figure(figsize=(10, 6)) plt.plot(k_range, silhouette_scores, marker=\u0026#39;o\u0026#39;, linestyle=\u0026#39;-\u0026#39;, color=\u0026#39;g\u0026#39;, linewidth=2) # æ ‡æ³¨è½´å’Œæ ‡é¢˜ plt.title(\u0026#39;Silhouette Method For Optimal k\u0026#39;, fontsize=16) plt.xlabel(\u0026#39;Number of clusters (k)\u0026#39;, fontsize=12) plt.ylabel(\u0026#39;Silhouette Score (Avg)\u0026#39;, fontsize=12) plt.xticks(k_range) plt.grid(True, alpha=0.3) # æ ‡è®°æœ€é«˜åˆ† (æœ€ä½³ K å€¼) best_k_idx = np.argmax(silhouette_scores) best_k = k_range[best_k_idx] best_score = silhouette_scores[best_k_idx] plt.annotate(f\u0026#39;Best k={best_k}\\nScore={best_score:.3f}\u0026#39;, xy=(best_k, best_score), xytext=(best_k, best_score - 0.1), # æ–‡æœ¬ä½ç½®ç¨å¾®å¾€ä¸‹ä¸€ç‚¹ arrowprops=dict(facecolor=\u0026#39;red\u0026#39;, shrink=0.05), fontsize=12, color=\u0026#39;red\u0026#39;, ha=\u0026#39;center\u0026#39;) print(f\u0026#34;The optimal k according to Silhouette Score is {best_k}\u0026#34;) plt.show() é—´éš”ç»Ÿè®¡æ³•ï¼ˆgap statisticï¼‰ Gapç»Ÿè®¡é‡åŸºäºä»¥ä¸‹å‡è®¾ï¼šå¦‚æœèšç±»æ˜¯æœ‰æ„ä¹‰çš„ï¼Œé‚£ä¹ˆæ•°æ®é›†ä¸­çš„æ ·æœ¬ç‚¹åº”è¯¥æ¯”éšæœºæ•°æ®æ›´ç´§å¯†åœ°èšé›†åœ¨ä¸€èµ·ã€‚å› æ­¤ï¼ŒGapç»Ÿè®¡é‡è®¡ç®—äº†å®é™…æ•°æ®é›†çš„WCSSä¸éšæœºæ•°æ®é›†WCSSçš„æœŸæœ›å€¼ä¹‹é—´çš„å·®å¼‚ã€‚\nå¯¹äºæ¯ä¸€ä¸ªKå€¼ï¼Œé¦–å…ˆè¿è¡ŒK-meansç®—æ³•ï¼Œå¾—åˆ°ä¸€ä¸ªç¾¤å†…å¹³æ–¹å’Œã€‚ ç„¶åï¼Œç”Ÿæˆä¸€ç»„éšæœºæ•°æ®ï¼Œå¹¶ç”¨ç›¸åŒçš„Kå€¼è¿è¡ŒK-meansç®—æ³•ã€‚ æ¯”è¾ƒçœŸå®æ•°æ®çš„ç¾¤å†…å¹³æ–¹å’Œå’Œéšæœºæ•°æ®çš„ç»“æœï¼Œå¹¶è®¡ç®—ä»–ä»¬ä¹‹é—´çš„å·®è·ï¼ˆç§°ä¹‹ä¸ºé—´éš”å€¼ï¼‰ã€‚ å¯¹äºå¤šä¸ªKå€¼ï¼Œé‡å¤ä»¥ä¸Šæ­¥éª¤ï¼Œå¹¶é€‰æ‹©æ‹¥æœ‰æœ€å¤§é—´éš”å€¼çš„K åˆå§‹çš„ç°‡è´¨å¿ƒçš„é€‰å– å¸¸ç”¨åˆ†æè½¯ä»¶ä¸­çš„åŠŸèƒ½æ¨¡å—æˆ–å‡½æ•°åŒ…ï¼ŒåŸºæœ¬ä¸Šéƒ½å·²ç»ä»£æ›¿ä½¿ç”¨è€…ä»¬è‡ªåŠ¨é¢„è®¾äº†éšæœºåˆå§‹ç‚¹ï¼Œåªéœ€å¡«å…¥ç›®æ ‡Kå€¼ï¼Œå°±å¯ä»¥è·‘åŠ¨ç®—æ³•ã€‚ä½†å®é™…ä¸Šï¼ŒK-Meanså¯¹åˆå§‹èšç±»ä¸­å¿ƒçš„ä½ç½®ååˆ†æ•æ„Ÿï¼Œæ¯æ¬¡è¿­ä»£ï¼Œåˆå§‹ç‚¹çš„ä¸åŒå¾€å¾€ä¼šå¯¼è‡´ä¸åŒçš„èšç±»ç»“æœã€‚æ­¤å¤–è¿‡äºä¸´è¿‘çš„åˆå§‹ä¸­å¿ƒç‚¹ï¼Œæœ‰æ—¶è¿˜ä¼šå¯¼è‡´æ¨¡å‹çš„æ”¶æ•›æ—¶é—´å˜é•¿ï¼ˆå³Step4ä¸­è¿­ä»£æ—¶é—´å˜é•¿ï¼‰ã€‚ä¸€ç§ç®€å•ç²—æš´çš„è§£å†³æ–¹å¼æ˜¯ï¼Œé€‰æ‹©ä¸åŒçš„åˆå§‹èšç±»ä¸­å¿ƒï¼Œå¤šæ¬¡è¿è¡Œç®—æ³•ï¼ŒæŒ‘å‡ºèšç±»æ•ˆæœæ›´ä½³ï¼ˆSSEæ›´å°ï¼‰ã€è§£é‡Šæ€§æ›´å¼ºçš„ä¸€ç»„ç»“æœã€‚\nå½“ç„¶äº†ï¼Œæˆ‘ä»¬æˆ–è®¸æ›´æƒ³çŸ¥é“ç®—æ³•ä¸Šçš„æ”¹è¿›æ‰‹æ®µã€‚ä¸€ç§å¸¸è§çš„ä¼˜åŒ–æ–¹æ³•æ˜¯é‡‡ç”¨æœ€å¤§è·ç¦»æ³•ï¼Œå¦‚ï¼šé¦–å…ˆé€‰å–æ•°æ®é›†ä¸­è·ç¦»æœ€å¤§çš„ä¸¤ä¸ªç‚¹ä½œä¸ºåˆå§‹èšç±»ä¸­å¿ƒï¼Œå°†å‰©ä½™æ•°æ®å¯¹è±¡ä¾æ®åˆ°èšç±»ä¸­å¿ƒç‚¹è·ç¦»çš„è¿œè¿‘åˆ†é…åˆ°ç›¸åº”çš„ç°‡ä¸­ï¼Œå¹¶æ›´æ–°èšç±»ä¸­å¿ƒï¼Œç„¶åç»§ç»­å¯»æ‰¾ä¸èšç±»ä¸­å¿ƒè·ç¦»æœ€è¿œçš„ç‚¹ä½œä¸ºä¸‹ä¸€ä¸ªä¸­å¿ƒç‚¹â€¦â€¦\nä¸æ­¤ç±»ä¼¼åœ°è¿˜æœ‰K-Means++ ç®—æ³•ï¼Œå®ƒæ˜¯ä¼ ç»ŸK-Meansçš„æ”¹è‰¯ç‰ˆï¼ŒåŒæ ·æ˜¯åŸºäºæœ€å¤§è·ç¦»ï¼Œè¿™é‡Œç»“åˆåŠ æƒæ¦‚ç‡çš„æ€æƒ³ä¼˜åŒ–äº†å¯¹Kä¸ªåˆå§‹ä¸­å¿ƒçš„é€‰å–ï¼Œä½¿å¾—åœ¨é€‰å–ç¬¬n+1(n+1\u0026lt;k)ä¸ªèšç±»ä¸­å¿ƒæ—¶ï¼Œè·ç¦»å½“å‰nä¸ªèšç±»ä¸­å¿ƒè¶Šè¿œçš„ç‚¹ä¼šæœ‰æ›´é«˜çš„æ¦‚ç‡è¢«é€‰ä¸ºç¬¬n+1ä¸ªèšç±»ä¸­å¿ƒã€‚è¿˜æœ‰å­¦è€…ä»ç‚¹é›†å¯†åº¦çš„è§’åº¦æ”¹è¿›ï¼Œåˆæˆ–è€…å°†ä¼˜åŒ–æœç´¢ç®—æ³•ï¼ˆå¦‚æ¨¡æ‹Ÿé€€ç«ã€ç”Ÿç‰©é—ä¼ ç®—æ³•ç­‰ï¼‰è¿ç”¨åˆ°äº†èšç±»ä¸­å¿ƒçš„é€‰å–ä¸­\u0026hellip;\u0026hellip;\nç›¸ä¼¼æ€§ä¸è·ç¦»åº¦é‡é—®é¢˜ ç‰¹å¾é‡åŒ–åï¼Œä¸åŒä¸ªä½“çš„ç›¸ä¼¼æ€§åæ˜ åœ¨äº†å‘é‡ä¹‹é—´çš„ç©ºé—´è·ç¦»å¤§å°ï¼Œå¸¸è§çš„åº¦é‡æ–¹æ³•åŒ…æ‹¬æ¬§å‡ é‡Œå¾—è·ç¦»ã€æ›¼å“ˆé¡¿è·ç¦»ç­‰ç­‰ï¼Œæœ‰æ—¶æˆ‘ä»¬è¿˜ä¼šç”¨åˆ°ä½™å¼¦ç›¸ä¼¼åº¦ç­‰ï¼ˆå¦‚è®¡ç®—æ–‡æ¡£ç›¸ä¼¼æ€§ï¼‰ã€‚è€Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæ¬§æ°è·ç¦»è®¡ç®—å°±å¯ä»¥æ»¡è¶³æˆ‘ä»¬å¯¹å®ç°K-Meansçš„éœ€è¦ã€‚æ ¹æ®è·ç¦»çš„åº¦é‡æ–¹å¼å®¹æ˜“å‘ç°ï¼ŒK-Meansæ‰€åˆ’åˆ†å‡ºçš„ç±»åˆ«æ˜¯ç±»çƒå½¢çš„ï¼Œæ¢å¥è¯è¯´ï¼Œåªæœ‰ç±»çƒå‹åˆ†å¸ƒçš„è¿ç»­å‹æ ·æœ¬æ•°æ®ï¼Œæ‰èƒ½å¾—åˆ°è¾ƒå¥½çš„èšç±»æ•ˆæœï¼Œè€Œå¦‚æœéæ•°å€¼å‹ã€æ ·æœ¬ç±»åˆ«æä¸å¹³è¡¡ã€éçƒå½¢çš„åˆ†ç±»ï¼Œåˆ™èšç±»æ•ˆæœä¼šå—é™ã€‚å¯¹äºéç†æƒ³æƒ…å½¢çš„æ•°æ®ï¼Œæœ‰æ—¶æˆ‘ä»¬å°±éœ€è¦åšä¸€äº›çµæ´»å˜é€šäº†ã€‚å¦‚ï¼Œè‹¥æ•°æ®ä¸ºç¦»æ•£å‹ï¼Œå‡å€¼æ²¡æœ‰å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨K-ä¼—æ•°(æ¯ä¸ªç°‡çš„è´¨å¿ƒä¸æ˜¯å‡å€¼ï¼Œè€Œæ˜¯æ¯ä¸ªç»´åº¦ä¸Šå‡ºç°é¢‘ç‡æœ€é«˜çš„ç±»åˆ«)çš„æ–¹æ³•ã€‚å¦‚æœæ ·æœ¬ç±»åˆ«æä¸å¹³è¡¡æˆ–è€…æ˜¯éçƒå‹ï¼Œåˆ™å¯èƒ½è€ƒè™‘æ›´æ¢èšç±»æ–¹æ³•ï¼Œå¦‚ä½¿ç”¨åŸºäºå¯†åº¦çš„èšç±»ï¼ˆç»å…¸çš„DBSCANç®—æ³•ï¼‰ã€å±‚æ¬¡èšç±»æ³•ç­‰ç­‰ã€‚\nèšç±»æ—¶é—´é—®é¢˜ ä¸Šé¢çš„æµç¨‹ä¸­æåˆ°ï¼Œå½“èšç±»ä¸­å¿ƒä¸å†æ”¹å˜æ—¶ï¼ˆæ•°å­¦ä¸Šå³è¦æ±‚SSEå‡½æ•°æ”¶æ•›ï¼‰ï¼Œæˆ‘ä»¬è®¤ä¸ºèšç±»è¿‡ç¨‹ç»“æŸï¼Œä½†æ˜¯è¿™å¹¶ä¸æ˜¯å”¯ä¸€çš„ç»“æŸä¿¡å·ã€‚ä¸ºäº†èŠ‚çœè®¡ç®—æ—¶é—´ï¼Œæœ‰æ—¶æˆ‘ä»¬ä¹Ÿä¼šé€šè¿‡è®¾ç½®è¿­ä»£æ¬¡æ•°ã€è®¾ç½®ç°‡å†…å¹³æ–¹å’Œæˆ–SSEä¸‹é™é˜ˆå€¼ï¼Œåˆæˆ–è€…æ›¿æ¢ä¸ºâ€œç›´åˆ°ä»…æœ‰1%çš„ç‚¹æ”¹å˜ç°‡â€è¿™æ ·çš„å¼±æ¡ä»¶ï¼Œæ¥æ§åˆ¶ç®—æ³•çš„è¿›ç¨‹ã€‚å‡ºäºå¯¹é—®é¢˜å¤æ‚åº¦å’Œè®¡ç®—é‡çš„åˆç†é¢„åˆ¤ï¼Œè‹¥èšç±»ä¸­å¿ƒçš„æ›´æ–°è¶…è¿‡äº†è¿­ä»£æ¬¡æ•°ä¸Šé™ï¼Œæˆ–è€…ä»£ä»·å‡½æ•°SSEå·²ç»å°äºæ‰€è®¾å®šçš„é˜ˆå€¼ï¼Œæˆ‘ä»¬éƒ½æœ‰ç†ç”±æå‰ç»ˆæ­¢ã€‚\næ­¤å¤–ï¼Œä¸ºäº†æé«˜æ”¶æ•›é€Ÿåº¦ï¼Œè¿˜å¯ä»¥è€ƒè™‘é‡‡ç”¨äºŒåˆ†K-Meansæ³•ï¼Œå°†æ‰€æœ‰ç‚¹ä½œä¸ºä¸€ä¸ªç°‡ï¼Œå°†è¯¥ç°‡ä¸€åˆ†ä¸ºäºŒï¼Œç„¶åé€‰æ‹©èƒ½æœ€å¤§ç¨‹åº¦é™ä½èšç±»ä»£ä»·å‡½æ•°çš„ç°‡åˆ’åˆ†ä¸ºä¸¤ä¸ªç°‡ï¼Œä»¥æ­¤è¿›è¡Œä¸‹å»ï¼Œç›´åˆ°ç°‡çš„æ•°ç›®ç­‰äºç»™å®šçš„ä¸ªæ•°Kä¸ºæ­¢ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¯¥æ³•æ›´çªå‡ºçš„ä¼˜ç‚¹åœ¨äºèƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³K-Meansæ”¶æ•›åˆ°å±€éƒ¨æœ€ä¼˜çš„é—®é¢˜ï¼Œå¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°å…¨å±€æœ€ä¼˜è§£\næ ‡å‡†åŒ–é—®é¢˜ è€ƒè™‘åˆ°æˆ‘ä»¬æ‰€ç ”ç©¶çš„å¯¹è±¡é€šå¸¸åŒ…å«å¤šåˆ—æ•°æ®ï¼Œè¿™äº›æ•°æ®ä»£è¡¨ä¸åŒæ–¹é¢çš„å±æ€§å€¼ï¼Œåœ¨å•ä½å’Œæ•°é‡çº§ä¸Šå¯èƒ½å­˜åœ¨è¾ƒå¤§çš„å·®åˆ«ï¼Œå› æ­¤ä¸ºäº†é¿å…è¿™äº›å·®å¼‚å¯èƒ½å¼•å‘çš„è®¡ç®—ç²¾åº¦ä¸‹é™ç­‰é—®é¢˜ï¼Œå¯¹äºè¿ç»­å±æ€§ï¼Œå¯ä»¥å…ˆå¯¹æ•°æ®è¿›è¡Œè§„èŒƒåŒ–å¤„ç†ï¼ˆå¦‚é›¶å‡å€¼è§„èŒƒåŒ–ã€æœ€å¤§æœ€å°å€¼è§„èŒƒåŒ–ç­‰ï¼‰ï¼Œå†è¿›è¡Œè·ç¦»çš„è®¡ç®—\n","date":"2025-12-01T17:11:41+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/k-means-%E8%81%9A%E7%B1%BB%E7%AE%97%E6%B3%95/","title":"K-Means èšç±»ç®—æ³•"},{"content":" æ™ºèƒ½ä½“ï¼ˆAgentï¼‰ä¸ MCP ç®€ä»‹ æ™ºèƒ½ä½“ï¼ˆAI Agentï¼‰ å‘å±•è„‰ç»œï¼š\n2023 å¹´ï¼šAutoGPT ç­‰è‡ªæ²»ä»£ç†å‡ºç°ï¼Œå°† GPT-4 ä¸å·¥å…·å¾ªç¯ç»“åˆï¼Œæ ‡å¿—ç€â€œè®© LLM è‡ªä¸»æ‰§è¡Œå¤æ‚ä»»åŠ¡â€çš„æ¢ç´¢å¼€å§‹ï¼Œè¢«è§†ä¸º æ™ºèƒ½ä½“å…ƒå¹´ã€‚ 2024 å¹´ï¼šLangChainã€HuggingGPTã€MetaGPT ç­‰æ¡†æ¶æ¶Œç°ï¼Œæ”¯æŒæ„å»ºå•/å¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼›äº§ä¸šç•Œé«˜åº¦å…³æ³¨ï¼ŒIDC é¢„æµ‹ 2026 å¹´ 50% çš„å¤§å‹ä¼ä¸šæ•°æ®å›¢é˜Ÿå°†ä½¿ç”¨ AI Agentï¼ŒGartner å°† â€œAgentic AIâ€ åˆ—ä¸º 2025 å¹´é¦–è¦æŠ€æœ¯è¶‹åŠ¿ã€‚ æ ¸å¿ƒæœºåˆ¶ï¼š\næ™ºèƒ½ä½“èµ‹äºˆ LLM è‡ªä¸»å†³ç­–ä¸è¡ŒåŠ¨èƒ½åŠ›ï¼Œä¸å†åªæ˜¯è¢«åŠ¨å›ç­”ã€‚\né‡‡ç”¨ â€œæ€è€ƒâ€“è¡ŒåŠ¨â€“è§‚å¯Ÿâ€å¾ªç¯æœºåˆ¶ï¼š\næ€è€ƒï¼šLLM æ¥æ”¶ç›®æ ‡åè¿›è¡Œæ¨ç†ï¼› è¡ŒåŠ¨ï¼šå†³å®šè°ƒç”¨å·¥å…·ï¼ˆå¦‚æœç´¢ã€æ‰§è¡Œä»£ç ï¼‰ï¼› è§‚å¯Ÿï¼šè·å–ç¯å¢ƒåé¦ˆï¼Œç»§ç»­è¿­ä»£ç›´è‡³ä»»åŠ¡å®Œæˆã€‚ åœ¨å¤§æ¨¡å‹ç”Ÿæ€ä¸­çš„è§’è‰²ï¼š\næ™ºèƒ½ä½“æ˜¯ è¿æ¥å¤§æ¨¡å‹ä¸å®é™…åº”ç”¨çš„æ¡¥æ¢ã€‚\nå°è£…ä¸šåŠ¡é€»è¾‘ã€å·¥å…·è°ƒç”¨ï¼ˆå¦‚ Function Callingã€RAGï¼‰ï¼Œå°†ä¼ä¸šçŸ¥è¯†åº“ã€æ•°æ®åº“ã€ç¬¬ä¸‰æ–¹æœåŠ¡èå…¥å†³ç­–ã€‚\næ‰®æ¼”â€œå¤§è„‘æŒ‡æŒ¥å®˜â€ï¼Œåè°ƒè®°å¿†ã€è§„åˆ’ã€å·¥å…·æ¥å£ç­‰æ¨¡å—ï¼Œé©±åŠ¨ä»»åŠ¡æµç¨‹ã€‚\nä¾‹å¦‚ï¼šå®¢æœåœºæ™¯ä¸­ï¼Œæ™ºèƒ½ä½“å¯è‡ªä¸»å¼•å¯¼å¯¹è¯ã€æŸ¥è¯¢æ•°æ®åº“ã€è½¬æ¥äººå·¥ï¼Œæå‡è§£å†³ç‡ã€‚\nMCPï¼ˆModel Context Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼‰ èµ·æºä¸æ¦‚å¿µï¼š\nç”± Anthropic å›¢é˜Ÿäº 2024 å¹´ 11 æœˆæå‡ºï¼Œå—â€œè¯­è¨€æœåŠ¡å™¨åè®®ï¼ˆLSPï¼‰â€å¯å‘ã€‚ è¢«èª‰ä¸º AI ä¸–ç•Œçš„â€œUSB-C æ¥å£â€ï¼Œæä¾›æ¨¡å‹ä¸å¤–éƒ¨å·¥å…·/æ•°æ®äº¤äº’çš„ç»Ÿä¸€æ ‡å‡†ã€‚ è§£å†³é—®é¢˜ï¼šæ­¤å‰å„æ¨¡å‹å‚å•†çš„ Function Calling å®ç°äº”èŠ±å…«é—¨ï¼Œå¼€å‘è€…éœ€ä¸ºæ¯ç§æ¨¡å‹+å·¥å…·ç¼–å†™ç‰¹å®šé›†æˆä»£ç ï¼Œç¹çä¸”éš¾æ‰©å±•ã€‚ ä½œç”¨ï¼š é€šè¿‡ æ ‡å‡†åŒ–åè®®ï¼Œè®© LLM èƒ½ä¾¿æ·æ¥å…¥æ•°æ®åº“ã€æœç´¢å¼•æ“ã€æ’ä»¶ç­‰å¤–éƒ¨èµ„æºã€‚ æ”¯æŒ æ£€ç´¢å¢å¼ºï¼ˆRAGï¼‰ã€å®æ—¶æ•°æ®æŸ¥è¯¢ã€API è°ƒç”¨ç­‰ï¼Œçªç ´è®­ç»ƒè¯­æ–™é™åˆ¶ã€‚ æå‡å›ç­”çš„ å‡†ç¡®æ€§ã€å®æ—¶æ€§ä¸è¡ŒåŠ¨èƒ½åŠ›ã€‚ LLMã€æ™ºèƒ½ä½“ã€MCP å®šä½ä¸èŒè´£ ç»„ä»¶ è§’è‰² èŒè´£ æ™ºèƒ½ä½“ï¼ˆAgentï¼‰ MCP ä¸»æœº / ç”¨æˆ·äº¤äº’å…¥å£ æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼Œè°ƒç”¨ LLMï¼Œæ•´åˆå·¥å…·ç»“æœï¼Œè¿”å›æœ€ç»ˆç­”æ¡ˆ å¤§æ¨¡å‹ï¼ˆLLMï¼‰ æ™ºèƒ½ä½“çš„â€œå¤§è„‘â€ ç†è§£ç”¨æˆ·æ„å›¾ï¼Œæ¨ç†å†³ç­–ï¼Œåˆ¤æ–­æ˜¯å¦è°ƒç”¨å·¥å…·ï¼Œç”Ÿæˆç»“æ„åŒ–è°ƒç”¨æŒ‡ä»¤æˆ–æœ€ç»ˆå›å¤ MCP å®¢æˆ·ç«¯ï¼ˆClientï¼‰ LLM ä¸å¤–éƒ¨èµ„æºçš„â€œä¿¡ä½¿â€ è§£æ LLM çš„å·¥å…·è°ƒç”¨è¯·æ±‚ï¼ŒæŒ‰ MCP åè®®è½¬å‘ç»™å¯¹åº”æœåŠ¡å™¨ MCP æœåŠ¡å™¨ï¼ˆServerï¼‰ å·¥å…·/æ•°æ®æä¾›è€… æä¾› Toolsï¼ˆå¯æ‰§è¡Œå‡½æ•°ï¼‰ å’Œ Resourcesï¼ˆæ•°æ®æºï¼‰ï¼Œæ‰§è¡Œæ“ä½œå¹¶è¿”å›ç»“æœ ğŸ’¡ è¡¥å……ï¼šæ™ºèƒ½ä½“åº”ç”¨é€šå¸¸å†…ç½® MCP å®¢æˆ·ç«¯ï¼Œå¯åŒæ—¶è¿æ¥å¤šä¸ª MCP æœåŠ¡å™¨ã€‚å¼€å‘è€…åªéœ€å°†å·¥å…·ä»¥ MCP Server å½¢å¼æš´éœ²ï¼Œå³å¯è¢«ä»»æ„å…¼å®¹ MCP çš„ LLM è°ƒç”¨ã€‚\nè°ƒç”¨ä¸é€šä¿¡é¡ºåºï¼ˆå®Œæ•´äº¤äº’æµç¨‹ï¼‰ ä»¥ä¸‹ä»¥â€œç”¨æˆ·è¯¢é—®ï¼šæ˜å¤©æƒ³åœ¨ä¸Šæµ·ç©ä¸€å¤©ï¼Œçœ‹çœ‹å¤©æ°”ï¼Œæ€ä¹ˆå®‰æ’è¡Œç¨‹ï¼Ÿâ€ä¸ºä¾‹ï¼š\nç”¨æˆ·æé—® â†’ åœ¨å‰ç«¯è¾“å…¥é—®é¢˜ã€‚\næ™ºèƒ½ä½“è½¬å‘é—®é¢˜ â†’ å°†ç”¨æˆ·è¯·æ±‚ + ä¸Šä¸‹æ–‡ + å¯ç”¨å·¥å…·åˆ—è¡¨å‘é€ç»™ LLMã€‚\nLLM ç†è§£ä¸å†³ç­– â†’ åˆ¤æ–­æ˜¯å¦éœ€å¤–éƒ¨ä¿¡æ¯ã€‚è‹¥éœ€ï¼ˆå¦‚æŸ¥å¤©æ°”ï¼‰ï¼Œè¿›å…¥å·¥å…·è°ƒç”¨æµç¨‹ã€‚\nLLM å‘å‡ºå‡½æ•°è°ƒç”¨è¯·æ±‚ â†’ è¾“å‡ºç»“æ„åŒ–æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 { \u0026#34;tool_calls\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;get_weather\u0026#34;, \u0026#34;arguments\u0026#34;: { \u0026#34;city\u0026#34;: \u0026#34;ä¸Šæµ·\u0026#34; } } ] } MCP å®¢æˆ·ç«¯è§£æå¹¶è°ƒç”¨å·¥å…· â†’ è¯†åˆ«è°ƒç”¨è¯·æ±‚ï¼Œé€šè¿‡ MCP åè®®ï¼ˆå¦‚ JSON-RPC 2.0ï¼‰è½¬å‘ç»™å¯¹åº” MCP æœåŠ¡å™¨ã€‚\nMCP æœåŠ¡å™¨æ‰§è¡Œæ“ä½œ â†’ è°ƒç”¨å†…éƒ¨å‡½æ•°ï¼ˆå¦‚è®¿é—®å¤©æ°” APIï¼‰ï¼Œè·å–å®æ—¶æ•°æ®ã€‚\nè¿”å›æ‰§è¡Œç»“æœ â†’ æœåŠ¡å™¨å°†ç»“æœï¼ˆå¦‚ JSON æˆ–æ–‡æœ¬ï¼‰è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¼ å› LLMã€‚\nLLM ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ â†’ ç»“åˆåŸå§‹é—®é¢˜ + å¤–éƒ¨æ•°æ®ï¼Œç”Ÿæˆå®Œæ•´å›å¤ï¼ˆå¦‚åŒ…å«å¤©æ°”çš„æ¸¸ç©æ”»ç•¥ï¼‰ã€‚\nç»“æœè¿”å›ç”¨æˆ· â†’ æ™ºèƒ½ä½“å°†æœ€ç»ˆç­”æ¡ˆå±•ç¤ºç»™ç”¨æˆ·ï¼Œä»»åŠ¡å®Œæˆã€‚\nâœ… æ•´ä¸ªæµç¨‹å½¢æˆé—­ç¯ï¼šç”¨æˆ· â†’ Agent â†’ LLM â†’ MCP Client â†’ MCP Server â†’ LLM â†’ Agent â†’ ç”¨æˆ·\næ€»ç»“ LLM æ˜¯æ¨ç†æ ¸å¿ƒï¼Œä½†ç¼ºä¹å®æ—¶æ€§å’Œè¡ŒåŠ¨åŠ›ï¼›\nAgent èµ‹äºˆ LLM ç›®æ ‡å¯¼å‘çš„è‡ªä¸»æ€§ï¼Œæ˜¯è½åœ°å…³é”®ï¼›\nMCP æä¾›æ ‡å‡†åŒ–â€œæ’æ‹”å¼â€æ¥å£ï¼Œæå¤§é™ä½å·¥å…·é›†æˆæˆæœ¬ï¼›\nä¸‰è€…åä½œï¼Œä½¿å¤§æ¨¡å‹ä»â€œèŠå¤©æœºå™¨äººâ€è¿›åŒ–ä¸ºâ€œæ•°å­—å‘˜å·¥â€ï¼ŒçœŸæ­£è§£å†³å¤æ‚ä¸šåŠ¡é—®é¢˜ã€‚\nè½¬è½½è‡ª https://zhuanlan.zhihu.com/p/1910411281988588717\n","date":"2025-11-24T14:44:59+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/agentmcp%E4%B8%8Ellm/","title":"Agentã€MCPä¸LLM"},{"content":"ä¿®æ”¹/etcä¸‹çš„æ–‡ä»¶ é€šå¸¸/etcä¸‹çš„æ–‡ä»¶éƒ½æ˜¯read-onlyçš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ä¸´æ—¶ overlay æˆ– bind mountå»ç»•è¿‡åªè¯»é™åˆ¶\n1 2 3 4 5 6 7 8 9 10 mkdir /tmp/etc # æŒ‚è½½ä¸€ä¸ªå¯å†™çš„ tmpfs åˆ° /tmp/etc mount -t tmpfs tmpfs /tmp/etc # å¤åˆ¶åŸ /etc å†…å®¹ cp -a /etc/* /tmp/etc/ # é‡æ–°æŒ‚è½½åˆ° /etcï¼ˆéœ€è¦æ”¯æŒ bind mountï¼‰ mount --bind /tmp/etc /etc è¿™æ · /etc å°±å¯å†™äº†ï¼Œä½†é‡å¯åå¤±æ•ˆã€‚é€‚ç”¨äºä¸´æ—¶è°ƒè¯•\n","date":"2025-09-28T16:37:56+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/linux%E6%9D%82%E8%AE%B0/","title":"Linuxæ‚è®°"},{"content":"Linuxç½‘æ¡¥çš„å®ç° linuxå†…æ ¸å®ç°è™šæ‹Ÿçš„ç½‘æ¡¥è®¾å¤‡ï¼Œå¹¶ç»‘å®šè‹¥å¹²ä¸ªä»¥å¤ªç½‘å£ï¼ˆç›®å‰ç½‘æ¡¥åªæ”¯æŒä»¥å¤ªç½‘æ¥å£ï¼‰ã€‚ äº¤æ¢æœºå¯¹æ”¶åˆ°çš„æ•°æ®åŒ…ï¼Œåªèƒ½ä¸¢å¼ƒæˆ–è½¬å‘ã€‚ä½†æ˜¯linuxå†…æ ¸è®¾å¤‡ä¸ä¸€æ ·ï¼Œä»–å¯èƒ½æœ¬èº«å°±æ˜¯æ•°æ®åŒ…çš„ç›®çš„åœ°ã€‚æ‰€ä»¥é™¤äº†ä¸¢å¼ƒè½¬å‘ï¼Œä»–è¿˜ä¼šå‘å¾€åè®®å±‚è‡ªå·±æ¶ˆåŒ–ã€‚ ç½‘æ¡¥æ˜¯åœ¨æ•°æ®é“¾è·¯å±‚å®ç°çš„ï¼Œä»–çš„ä¸Šé¢æ˜¯é‚»å±…å­ç³»ç»Ÿå’Œç½‘ç»œå±‚ã€‚\nlinuxç½‘æ¡¥æ•°æ®ç»“æ„ è™šæ‹Ÿç½‘æ¡¥ä¹Ÿæ˜¯ä¸€ä¸ªç½‘ç»œè®¾å¤‡ï¼ŒåŸºæœ¬ç»“æ„ä½“ä¸ºnet_deviceï¼Œnet_device â€“\u0026gt; privä¸‹å­˜å‚¨äº†ç½‘æ¡¥æ•°æ®ç»“æ„çš„ç§æœ‰å˜é‡net_bridgeã€‚ä¸Šå›¾ä¸­ä¸€äº›é‡è¦çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š\nnet_bridgeï¼šç½‘æ¡¥ç§æœ‰æ•°æ®\nnet_bridge_portç½‘æ¡¥è¦ç»‘å®šçš„ä»¥å¤ªç½‘ç«¯å£çš„ç»“æ„ä½“\nnet_bridge_fdb_entryï¼šå•æ’­è½¬å‘æ•°æ®åº“æ¡ç›®\nnet_bridge_mdb_entryï¼šç»„æ’­è½¬å‘æ•°æ®åº“æ¡ç›®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 int br_add_bridge(struct net *net, const char *name) { struct net_device *dev; int res; dev = alloc_netdev(sizeof(struct net_bridge), name, NET_NAME_UNKNOWN, br_dev_setup); ////// if (!dev) return -ENOMEM; dev_net_set(dev, net); dev-\u0026gt;rtnl_link_ops = \u0026amp;br_link_ops; res = register_netdevice(dev); if (res) free_netdev(dev); return res; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 void br_dev_setup(struct net_device *dev) { struct net_bridge *br = netdev_priv(dev); ///////// eth_hw_addr_random(dev); ether_setup(dev); dev-\u0026gt;netdev_ops = \u0026amp;br_netdev_ops; dev-\u0026gt;needs_free_netdev = true; dev-\u0026gt;ethtool_ops = \u0026amp;br_ethtool_ops; SET_NETDEV_DEVTYPE(dev, \u0026amp;br_type); dev-\u0026gt;priv_flags = IFF_EBRIDGE | IFF_NO_QUEUE; dev-\u0026gt;features = COMMON_FEATURES | NETIF_F_LLTX | NETIF_F_NETNS_LOCAL | NETIF_F_HW_VLAN_CTAG_TX | NETIF_F_HW_VLAN_STAG_TX; dev-\u0026gt;hw_features = COMMON_FEATURES | NETIF_F_HW_VLAN_CTAG_TX | NETIF_F_HW_VLAN_STAG_TX; dev-\u0026gt;vlan_features = COMMON_FEATURES; br-\u0026gt;dev = dev; ////////////////// spin_lock_init(\u0026amp;br-\u0026gt;lock); INIT_LIST_HEAD(\u0026amp;br-\u0026gt;port_list); //////////// INIT_HLIST_HEAD(\u0026amp;br-\u0026gt;fdb_list); //////////// INIT_HLIST_HEAD(\u0026amp;br-\u0026gt;frame_type_list); #if IS_ENABLED(CONFIG_BRIDGE_MRP) INIT_HLIST_HEAD(\u0026amp;br-\u0026gt;mrp_list); #endif #if IS_ENABLED(CONFIG_BRIDGE_CFM) INIT_HLIST_HEAD(\u0026amp;br-\u0026gt;mep_list); #endif spin_lock_init(\u0026amp;br-\u0026gt;hash_lock); br-\u0026gt;bridge_id.prio[0] = 0x80; br-\u0026gt;bridge_id.prio[1] = 0x00; ether_addr_copy(br-\u0026gt;group_addr, eth_stp_addr); br-\u0026gt;stp_enabled = BR_NO_STP; br-\u0026gt;group_fwd_mask = BR_GROUPFWD_DEFAULT; br-\u0026gt;group_fwd_mask_required = BR_GROUPFWD_DEFAULT; br-\u0026gt;designated_root = br-\u0026gt;bridge_id; br-\u0026gt;bridge_max_age = br-\u0026gt;max_age = 20 * HZ; br-\u0026gt;bridge_hello_time = br-\u0026gt;hello_time = 2 * HZ; br-\u0026gt;bridge_forward_delay = br-\u0026gt;forward_delay = 15 * HZ; br-\u0026gt;bridge_ageing_time = br-\u0026gt;ageing_time = BR_DEFAULT_AGEING_TIME; dev-\u0026gt;max_mtu = ETH_MAX_MTU; br_netfilter_rtable_init(br); br_stp_timer_init(br); br_multicast_init(br); INIT_DELAYED_WORK(\u0026amp;br-\u0026gt;gc_work, br_fdb_cleanup); } 1 2 3 4 static inline void *netdev_priv(const struct net_device *dev) { return (char *)dev + ALIGN(sizeof(struct net_device), NETDEV_ALIGN); } ç®€å•æ¥è¯´ï¼Œstruct net_device æ˜¯æ¡¥çš„â€œå¤–å£³â€æˆ–â€œæ¥å£â€ï¼Œè€Œ struct net_bridge æ˜¯æ¡¥çš„â€œå¤§è„‘â€æˆ–â€œæ ¸å¿ƒé€»è¾‘â€ã€‚å®ƒä»¬é€šè¿‡ä¸€ä¸ªå…³é”®çš„æŒ‡é’ˆç›¸äº’å…³è”ã€‚ä¸‹é¢æˆ‘ä»¬è¿›è¡Œè¯¦ç»†åˆ†è§£ã€‚\næ ¸å¿ƒæ•°æ®ç»“æ„\nstruct net_deviceï¼š è¿™ä¸ªç»“æ„ä½“ä»£è¡¨ä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œæ— è®ºå®ƒæ˜¯ç‰©ç†çš„ï¼ˆå¦‚ eth0ï¼‰è¿˜æ˜¯è™šæ‹Ÿçš„ï¼ˆå¦‚ br-lan, veth0ï¼‰ã€‚å®ƒåŒ…å«äº†æ‰€æœ‰ç½‘ç»œè®¾å¤‡å…±æœ‰çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š\næ¥å£åç§°ï¼ˆnameï¼Œå¦‚ \u0026ldquo;br-lan\u0026rdquo;ï¼‰\nMAC åœ°å€ï¼ˆdev_addrï¼‰\næ¥å£çŠ¶æ€ï¼ˆUP/DOWNï¼‰\nå‘é€å’Œæ¥æ”¶æ•°æ®åŒ…çš„å‡½æ•°æŒ‡é’ˆï¼ˆnetdev_opsï¼‰\nç»Ÿè®¡ä¿¡æ¯ï¼ˆåŒ…è®¡æ•°ã€é”™è¯¯è®¡æ•°ç­‰ï¼‰\nä¸€ä¸ªéå¸¸é‡è¦çš„æˆå‘˜ï¼špriv_flags å’Œ rx_handlerï¼ˆåé¢ä¼šè®²åˆ°ï¼‰\næŒ‡å‘net_deviceç§æœ‰æ•°æ®çš„ä¸€ä¸ªé€šç”¨æŒ‡é’ˆï¼šprivï¼ˆå¯¹äºæ¡¥è®¾å¤‡ï¼Œå®ƒæŒ‡å‘ struct net_bridge,é€šè¿‡ netdev_priv(dev) å®æ¥è·å– priv æŒ‡é’ˆçš„åœ°å€\nstruct net_bridgeï¼š è¿™ä¸ªç»“æ„ä½“æ˜¯ä¸“é—¨ä¸ºæ¡¥æ¥åŠŸèƒ½å®šä¹‰çš„ï¼Œå®ƒåŒ…å«äº†ç®¡ç†ä¸€ä¸ªæ¡¥æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š\næ¡¥çš„ STPï¼ˆç”Ÿæˆæ ‘åè®®ï¼‰çŠ¶æ€å’Œé…ç½®ã€‚\næ¡¥çš„ MAC åœ°å€ï¼ˆé€šå¸¸å–è‡ªç¬¬ä¸€ä¸ªè¢«åŠ å…¥çš„ç«¯å£ï¼‰ã€‚\nç«¯å£åˆ—è¡¨ï¼ˆport_listï¼‰ï¼š ä¸€ä¸ªé“¾è¡¨ï¼ŒåŒ…å«äº†æ‰€æœ‰åŠ å…¥è¿™ä¸ªæ¡¥çš„ç«¯å£ï¼ˆå¦‚ eth0, eth1ï¼‰ã€‚æ¯ä¸ªç«¯å£ç”±ä¸€ä¸ª struct net_bridge_port è¡¨ç¤ºã€‚\nè½¬å‘æ•°æ®åº“ï¼ˆFDBï¼‰ï¼šä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œç”¨äºå­¦ä¹ å’Œç®¡ç† MAC åœ°å€åˆ°ç«¯å£çš„æ˜ å°„ã€‚\næŒ‡å‘å…¶å¯¹åº”çš„ net_device çš„æŒ‡é’ˆã€‚\nå…³é”®å…³è”æœºåˆ¶ å…³è”æ˜¯åœ¨åˆ›å»ºæ¡¥è®¾å¤‡ï¼ˆä¾‹å¦‚ä½¿ç”¨ brctl addbr br-lan æˆ– ip link add br-lan type bridgeï¼‰æ—¶å»ºç«‹çš„ã€‚æ•´ä¸ªè¿‡ç¨‹çš„æ ¸å¿ƒæ˜¯ netdev_priv() æœºåˆ¶ã€‚\nåˆ†é… net_device å¹¶åµŒå…¥ net_bridge å½“å†…æ ¸éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ¡¥è®¾å¤‡æ—¶ï¼Œå®ƒå¹¶ä¸æ˜¯å…ˆåˆ†é…ä¸€ä¸ª net_deviceï¼Œå†åˆ†é…ä¸€ä¸ª net_bridgeï¼Œç„¶åç”¨æŒ‡é’ˆè¿æ¥å®ƒä»¬ã€‚ç›¸åï¼Œå®ƒä½¿ç”¨äº†ä¸€ç§æ›´é«˜æ•ˆã€æ›´å¸¸è§çš„â€œåµŒå…¥å¼â€æ–¹æ³•ï¼š\nä¸€æ¬¡æ€§åˆ†é…å†…å­˜ï¼š å†…æ ¸è°ƒç”¨ alloc_netdev(sizeof(struct net_bridge), \u0026ldquo;br-lan\u0026rdquo;, NET_NAME_UNKNOWN, br_dev_setup)ã€‚ alloc_netdev ä¼šåˆ†é…ä¸€å—è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œè¿™å—å†…å­˜çš„å¤§å° = sizeof(struct net_device) + sizeof(struct net_bridge) + ä¸€äº›å¯¹é½å¡«å……ã€‚è¿™æ ·ï¼Œnet_bridge ç»“æ„ä½“å°±ç›´æ¥å†…åµŒåœ¨ net_device ç»“æ„ä½“ä¹‹åçš„å†…å­˜ä¸­ã€‚\nå…³è”æŒ‡é’ˆï¼š åœ¨ br_dev_setup åˆå§‹åŒ–å‡½æ•°ä¸­ï¼Œä¼šè¿›è¡Œå…³é”®è®¾ç½®:è®¾ç½® net_device-\u0026gt;priv_flags ä¸º IFF_EBRIDGEï¼Œæ ‡è®°è¿™æ˜¯ä¸€ä¸ªæ¡¥è®¾å¤‡ã€‚è®¾ç½® net_device-\u0026gt;netdev_ops ä¸º br_netdev_opsï¼Œè¿™æ„å‘³ç€æ‰€æœ‰é’ˆå¯¹ br-lan è¿™ä¸ªç½‘ç»œè®¾å¤‡çš„æ“ä½œï¼ˆå¦‚æ‰“å¼€ã€å…³é—­ã€å‘é€æ•°æ®åŒ…ï¼‰éƒ½ç”±æ¡¥æ¥æ¨¡å—æä¾›çš„å‡½æ•°å¤„ç†ã€‚æœ€å…³é”®çš„ä¸€æ­¥ï¼šé€šè¿‡ netdev_priv(dev) å®æ¥è·å– priv æŒ‡é’ˆçš„åœ°å€ã€‚ç”±äºå†…å­˜å¸ƒå±€æ˜¯å†…åµŒçš„ï¼Œä¹Ÿå°±æ˜¯ç´§è·Ÿç€ net_device ç»“æ„ä½“çš„é‚£å—å†…å­˜çš„èµ·å§‹åœ°å€â€”â€”è€Œè¿™æ­£å¥½å°±æ˜¯æˆ‘ä»¬ä¸º net_bridge åˆ†é…çš„åœ°æ–¹ã€‚ br-\u0026gt;dev = dev; // net_bridge ä¹Ÿä¿å­˜ä¸€ä¸ªæŒ‡å› net_device çš„æŒ‡é’ˆ\næ•°æ®åŒ…æµå‘ï¼ˆæ¥æ”¶è·¯å¾„ï¼‰ å…³è”å»ºç«‹åï¼Œæ•°æ®åŒ…å¦‚ä½•è¢«æ¡¥å¤„ç†å‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°å¦ä¸€ä¸ªå…³é”®æœºåˆ¶ï¼šRX å¤„ç†ç¨‹åºï¼ˆRX handlerï¼‰ã€‚å½“ä¸€ä¸ªç½‘ç»œæ¥å£ï¼ˆä¾‹å¦‚ eth0ï¼‰è¢«åŠ å…¥åˆ°æ¡¥ br-lan æ—¶ï¼ˆä½¿ç”¨ brctl addif br-lan eth0ï¼‰ï¼Œå†…æ ¸ä¼šè°ƒç”¨ br_add_if()ã€‚ åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¼šä¸º eth0 è¿™ä¸ª net_device å®‰è£…ä¸€ä¸ªRXå¤„ç†ç¨‹åºï¼šdev-\u0026gt;rx_handler = br_handle_frameã€‚ä»æ­¤ä»¥åï¼Œæ‰€æœ‰ä» eth0 æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ï¼Œåœ¨è¿›å…¥ç½‘ç»œåè®®æ ˆçš„æ›´ä¸Šå±‚ï¼ˆå¦‚IPå±‚ï¼‰ä¹‹å‰ï¼Œä¼šå…ˆè¢« br_handle_frame è¿™ä¸ªå‡½æ•°æˆªè·ã€‚br_handle_frame å‡½æ•°å¯ä»¥åˆ¤æ–­è¿™ä¸ªæ•°æ®åŒ…æ‰€å±çš„æ¡¥ï¼ˆé€šè¿‡ eth0 å¯¹åº”çš„ struct net_bridge_port æ‰¾åˆ°å…¶æ‰€å±çš„ struct net_bridgeï¼‰ï¼Œç„¶åè¿›è¡Œæ¡¥æ¥é€»è¾‘ï¼ˆå­¦ä¹ MACåœ°å€ã€è½¬å‘ã€è¿‡æ»¤ç­‰ï¼‰ã€‚\nç½‘æ¡¥ç§æœ‰æ•°æ®ï¼šnet_bridge ç½‘æ¡¥ç›¸å…³ä¿¡æ¯ä¿å­˜åœ¨è¿™é‡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 struct net_bridge { spinlock_t lock; spinlock_t hash_lock; struct hlist_head frame_type_list; struct net_device *dev; /////// unsigned long options; /* These fields are accessed on each packet */ #ifdef CONFIG_BRIDGE_VLAN_FILTERING __be16 vlan_proto; u16 default_pvid; struct net_bridge_vlan_group __rcu *vlgrp; #endif struct rhashtable fdb_hash_tbl; ///// struct list_head port_list; ///// #if IS_ENABLED(CONFIG_BRIDGE_NETFILTER) union { struct rtable fake_rtable; struct rt6_info fake_rt6_info; }; #endif u16 group_fwd_mask; u16 group_fwd_mask_required; /* STP */ bridge_id designated_root; bridge_id bridge_id; unsigned char topology_change; unsigned char topology_change_detected; u16 root_port; unsigned long max_age; unsigned long hello_time; unsigned long forward_delay; unsigned long ageing_time; unsigned long bridge_max_age; unsigned long bridge_hello_time; unsigned long bridge_forward_delay; unsigned long bridge_ageing_time; u32 root_path_cost; u8 group_addr[ETH_ALEN]; enum { BR_NO_STP, /* no spanning tree */ BR_KERNEL_STP, /* old STP in kernel */ BR_USER_STP, /* new RSTP in userspace */ } stp_enabled; struct net_bridge_mcast multicast_ctx; #ifdef CONFIG_BRIDGE_IGMP_SNOOPING struct bridge_mcast_stats __percpu *mcast_stats; u32 hash_max; spinlock_t multicast_lock; struct rhashtable mdb_hash_tbl; //////// struct rhashtable sg_port_tbl; struct hlist_head mcast_gc_list; struct hlist_head mdb_list; ////// struct work_struct mcast_gc_work; #endif struct timer_list hello_timer; struct timer_list tcn_timer; struct timer_list topology_change_timer; struct delayed_work gc_work; struct kobject *ifobj; u32 auto_cnt; #ifdef CONFIG_NET_SWITCHDEV /* Counter used to make sure that hardware domains get unique * identifiers in case a bridge spans multiple switchdev instances. */ int last_hwdom; /* Bit mask of hardware domain numbers in use */ unsigned long busy_hwdoms; #endif struct hlist_head fdb_list; ///// #if IS_ENABLED(CONFIG_BRIDGE_MRP) struct hlist_head mrp_list; #endif #if IS_ENABLED(CONFIG_BRIDGE_CFM) struct hlist_head mep_list; #endif }; ç½‘æ¡¥ç«¯å£ï¼šnet_bridge_port ä¸€ä¸ªç½‘æ¡¥å¯ä»¥å’Œè‹¥å¹²ä»¥å¤ªç½‘ç«¯å£ç»‘å®šï¼Œæ¯ä¸ªç«¯å£ä¿¡æ¯ä¿å­˜åœ¨net_bridge_portç»“æ„ä¸­ï¼Œå¹¶è¢«net_bridge{} â€“\u0026gt;port_listé“¾æ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 struct net_bridge_port { struct net_bridge *br; //// struct net_device *dev; //// netdevice_tracker dev_tracker; struct list_head list; unsigned long flags; #ifdef CONFIG_BRIDGE_VLAN_FILTERING struct net_bridge_vlan_group __rcu *vlgrp; #endif struct net_bridge_port __rcu *backup_port; /* STP */ u8 priority; u8 state; u16 port_no; unsigned char topology_change_ack; unsigned char config_pending; port_id port_id; port_id designated_port; bridge_id designated_root; bridge_id designated_bridge; u32 path_cost; u32 designated_cost; unsigned long designated_age; struct timer_list forward_delay_timer; struct timer_list hold_timer; struct timer_list message_age_timer; struct kobject kobj; struct rcu_head rcu; struct net_bridge_mcast_port multicast_ctx; #ifdef CONFIG_BRIDGE_IGMP_SNOOPING struct bridge_mcast_stats __percpu *mcast_stats; u32 multicast_eht_hosts_limit; u32 multicast_eht_hosts_cnt; struct hlist_head mglist; #endif #ifdef CONFIG_SYSFS char sysfs_name[IFNAMSIZ]; #endif #ifdef CONFIG_NET_POLL_CONTROLLER struct netpoll *np; #endif #ifdef CONFIG_NET_SWITCHDEV /* Identifier used to group ports that share the same switchdev * hardware domain. */ int hwdom; int offload_count; struct netdev_phys_item_id ppid; #endif u16 group_fwd_mask; u16 backup_redirected_cnt; struct bridge_stp_xstats stp_xstats; }; å•æ’­è½¬å‘æ•°æ®åº“æ¡ç›®ï¼šnet_bridge_fdb_entry net_bridgeä¸­æœ‰ä¸¤ä¸ªå­—æ®µä¸è¯¥ç»“æ„ä½“ç›¸å…³ï¼Œfdb_hash_tblä¸fdb_listï¼Œå‡½æ•°fdb_createï¼ˆï¼‰å¯ä»¥çœ‹åˆ°net_bridge_fdb_entryä¸è¿™è¿ä¸ªå­—æ®µçš„å…³ç³»ã€‚æ¯ä¸€æ¡æ–°å»ºçš„fdbè¡¨é¡¹ä¼šåŠ å…¥br-\u0026gt;fdb_hash_tblè¿™ä¸ªå“ˆå¸Œè¡¨ä¸­ï¼Œå‡†ç¡®çš„è¯´æ˜¯br-\u0026gt;fdb_hash_tbl-\u0026gt;tblï¼Œå¯¹åº”çš„é”®å€¼æ˜¯fdbè¡¨é¡¹çš„keyå­—æ®µï¼ˆaddrä¸vlanï¼‰ã€‚æ’å…¥æˆåŠŸï¼Œåˆ™å°†è¯¥fdbè¡¨é¡¹çš„fdb_nodeæ’å…¥br-\u0026gt;fdb_hash_tblä¸­ã€‚ ä¹Ÿå°±è¯´fdbè¡¨é¡¹åˆ†åˆ«ä»¥å“ˆå¸Œè¡¨ä¸é“¾è¡¨çš„å½¢å¼å­˜å‚¨åœ¨brä¸­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 struct net_bridge_fdb_entry { struct rhash_head rhnode; struct net_bridge_port *dst; struct net_bridge_fdb_key key; struct hlist_node fdb_node; unsigned long flags; /* write-heavy members should not affect lookups */ unsigned long updated ____cacheline_aligned_in_smp; unsigned long used; struct rcu_head rcu; }; ç»„æ’­è½¬å‘æ•°æ®åº“æ¡ç›®ï¼šnet_bridge_mdb_entry è¯¥æ¡ç›®æè¿°ä¸€ä¸ªå¤šæ’­ç»„è½¬å‘é¡¹ï¼Œå°†å¤šæ’­å½¢å¼çš„macåœ°å€ä¸ä¸€ç»„ç«¯å£å¯¹åº”ï¼Œtimeré“¾è¡¨ä¸ºè¿™äº›ç«¯å£çš„å¤±æ•ˆå®šæ—¶å™¨é“¾è¡¨ï¼ŒæŸä¸€ä¸ªç«¯å£å®šæ—¶å™¨è¶…æ—¶åˆ™å°†å…¶ç§»é™¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 struct net_bridge_mdb_entry { struct rhash_head rhnode; struct net_bridge *br; struct net_bridge_port_group __rcu *ports; struct br_ip addr; bool host_joined; struct timer_list timer; struct hlist_node mdb_node; struct net_bridge_mcast_gc mcast_gc; struct rcu_head rcu; }; ç½‘æ¡¥è®¾å¤‡å¯¹æ•°æ®åŒ…å¤„ç† ä»¥æ”¶åŒ…ä¸ºä¾‹ã€‚\nç½‘ç»œä¸­æœ‰æ•°æ®åŒ…åˆ°æ¥ï¼Œå½“ç½‘å¡æ¥å—åˆ°æ•°æ®æ—¶ï¼Œç½‘å¡å‘cpuå‘ä¸­æ–­ï¼Œcpuè°ƒç”¨é©±åŠ¨ç¨‹åºï¼Œå°†æ•°æ®åŒ…æ”¾åˆ°å¯¹åº”çš„cpuè¾“å…¥é˜Ÿåˆ—ã€‚æ¥ç€å”¤é†’è½¯ä¸­æ–­ï¼Œè°ƒç”¨netif_receive_skbå‡½æ•°ï¼Œåœ¨è¿™é‡Œåˆ¤æ–­æ•°æ®åŒ…éœ€è¦è½¬åˆ°ä¸Šå±‚åè®®æ ˆï¼Œè¿˜æ˜¯å‘ç½‘æ¡¥æ¥å£å¤„ç†ã€‚æ•°æ®æµå‘å¦‚ä¸‹ï¼Œè¿™é‡Œé»˜è®¤ç½‘æ¡¥è®¾å¤‡ä¸ºédisableçŠ¶æ€\nå…·ä½“æµç¨‹ï¼š\n1 2 3 4 5 6 7 8 9 10 1. netif_receive_skb 2. --\u0026gt;netif_receive_skb_internal /* è®°å½•æ”¶åŒ…æ—¶é—´, rpsæœºåˆ¶ï¼Œå°†æŠ¥æ–‡åœ¨å¤šä¸ªcpuä¹‹é—´åšè´Ÿè½½å‡è¡¡ä»¥åŠæé«˜æŠ¥æ–‡å¤„ç†çš„ç¼“å­˜å‘½ä¸­ç‡ */ 3. --\u0026gt;__netif_receive_skb 4. --\u0026gt;__netif_receive_skb_core 5. --\u0026gt; skb_reset_network_header //é‡ç½®network_headerå­—æ®µ 6. --\u0026gt; skb_vlan_untag //802.1Qã€802.1AD,å‰¥é™¤vxlanå¤´ 7. --\u0026gt; paket_type.func() //å¤„ç† ptype_all ä¸Šæ‰€æœ‰çš„ packet_type-\u0026gt;func() 8. --\u0026gt; vlan_do_receive 9. --\u0026gt; dev-\u0026gt;rx_handler () //å®é™…æ‰§è¡Œå‡½æ•°br_handle_frame(),æ•°æ®åŒ…é€»è¾‘åˆ†å‘ï¼Œç½‘æ¡¥å¤„ç†è½¬å‘å°±åœ¨è¿™é‡Œè¿›è¡Œ 10. --\u0026gt; deliver_ptype_list_skb //å‘L3åˆ†å‘ __netif_receive_skb_core 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 static int __netif_receive_skb_core(struct sk_buff **pskb, bool pfmemalloc, struct packet_type **ppt_prev) { struct packet_type *ptype, *pt_prev; rx_handler_func_t *rx_handler; struct sk_buff *skb = *pskb; struct net_device *orig_dev; bool deliver_exact = false; int ret = NET_RX_DROP; __be16 type; net_timestamp_check(!READ_ONCE(netdev_tstamp_prequeue), skb); trace_netif_receive_skb(skb); orig_dev = skb-\u0026gt;dev; skb_reset_network_header(skb); if (!skb_transport_header_was_set(skb)) skb_reset_transport_header(skb); skb_reset_mac_len(skb); pt_prev = NULL; another_round: skb-\u0026gt;skb_iif = skb-\u0026gt;dev-\u0026gt;ifindex; __this_cpu_inc(softnet_data.processed); if (static_branch_unlikely(\u0026amp;generic_xdp_needed_key)) { int ret2; migrate_disable(); ret2 = do_xdp_generic(rcu_dereference(skb-\u0026gt;dev-\u0026gt;xdp_prog), skb); migrate_enable(); if (ret2 != XDP_PASS) { ret = NET_RX_DROP; goto out; } } if (eth_type_vlan(skb-\u0026gt;protocol)) { skb = skb_vlan_untag(skb); if (unlikely(!skb)) goto out; } if (skb_skip_tc_classify(skb)) goto skip_classify; if (pfmemalloc) goto skip_taps; list_for_each_entry_rcu(ptype, \u0026amp;ptype_all, list) { if (pt_prev) ret = deliver_skb(skb, pt_prev, orig_dev); pt_prev = ptype; } list_for_each_entry_rcu(ptype, \u0026amp;skb-\u0026gt;dev-\u0026gt;ptype_all, list) { if (pt_prev) ret = deliver_skb(skb, pt_prev, orig_dev); pt_prev = ptype; } skip_taps: #ifdef CONFIG_NET_INGRESS if (static_branch_unlikely(\u0026amp;ingress_needed_key)) { bool another = false; skb = sch_handle_ingress(skb, \u0026amp;pt_prev, \u0026amp;ret, orig_dev, \u0026amp;another); if (another) goto another_round; if (!skb) goto out; if (nf_ingress(skb, \u0026amp;pt_prev, \u0026amp;ret, orig_dev) \u0026lt; 0) goto out; } #endif skb_reset_redirect(skb); skip_classify: if (pfmemalloc \u0026amp;\u0026amp; !skb_pfmemalloc_protocol(skb)) goto drop; if (skb_vlan_tag_present(skb)) { if (pt_prev) { ret = deliver_skb(skb, pt_prev, orig_dev); pt_prev = NULL; } if (vlan_do_receive(\u0026amp;skb)) goto another_round; else if (unlikely(!skb)) goto out; } rx_handler = rcu_dereference(skb-\u0026gt;dev-\u0026gt;rx_handler); if (rx_handler) { if (pt_prev) { ret = deliver_skb(skb, pt_prev, orig_dev); pt_prev = NULL; } switch (rx_handler(\u0026amp;skb)) { case RX_HANDLER_CONSUMED: ret = NET_RX_SUCCESS; goto out; case RX_HANDLER_ANOTHER: goto another_round; case RX_HANDLER_EXACT: deliver_exact = true; break; case RX_HANDLER_PASS: break; default: BUG(); } } if (unlikely(skb_vlan_tag_present(skb)) \u0026amp;\u0026amp; !netdev_uses_dsa(skb-\u0026gt;dev)) { check_vlan_id: if (skb_vlan_tag_get_id(skb)) { /* Vlan id is non 0 and vlan_do_receive() above couldn\u0026#39;t * find vlan device. */ skb-\u0026gt;pkt_type = PACKET_OTHERHOST; } else if (eth_type_vlan(skb-\u0026gt;protocol)) { /* Outer header is 802.1P with vlan 0, inner header is * 802.1Q or 802.1AD and vlan_do_receive() above could * not find vlan dev for vlan id 0. */ __vlan_hwaccel_clear_tag(skb); skb = skb_vlan_untag(skb); if (unlikely(!skb)) goto out; if (vlan_do_receive(\u0026amp;skb)) /* After stripping off 802.1P header with vlan 0 * vlan dev is found for inner header. */ goto another_round; else if (unlikely(!skb)) goto out; else /* We have stripped outer 802.1P vlan 0 header. * But could not find vlan dev. * check again for vlan id to set OTHERHOST. */ goto check_vlan_id; } /* Note: we might in the future use prio bits * and set skb-\u0026gt;priority like in vlan_do_receive() * For the time being, just ignore Priority Code Point */ __vlan_hwaccel_clear_tag(skb); } type = skb-\u0026gt;protocol; /* deliver only exact match when indicated */ if (likely(!deliver_exact)) { deliver_ptype_list_skb(skb, \u0026amp;pt_prev, orig_dev, type, \u0026amp;ptype_base[ntohs(type) \u0026amp; PTYPE_HASH_MASK]); } deliver_ptype_list_skb(skb, \u0026amp;pt_prev, orig_dev, type, \u0026amp;orig_dev-\u0026gt;ptype_specific); if (unlikely(skb-\u0026gt;dev != orig_dev)) { deliver_ptype_list_skb(skb, \u0026amp;pt_prev, orig_dev, type, \u0026amp;skb-\u0026gt;dev-\u0026gt;ptype_specific); } if (pt_prev) { if (unlikely(skb_orphan_frags_rx(skb, GFP_ATOMIC))) goto drop; *ppt_prev = pt_prev; } else { drop: if (!deliver_exact) atomic_long_inc(\u0026amp;skb-\u0026gt;dev-\u0026gt;rx_dropped); else atomic_long_inc(\u0026amp;skb-\u0026gt;dev-\u0026gt;rx_nohandler); kfree_skb(skb); /* Jamal, now you will not able to escape explaining * me how you were going to use this. :-) */ ret = NET_RX_DROP; } out: /* The invariant here is that if *ppt_prev is not NULL * then skb should also be non-NULL. * * Apparently *ppt_prev assignment above holds this invariant due to * skb dereferencing near it. */ *pskb = skb; return ret; } CONFIG_NET_INGRESS æ˜¯ Linux å†…æ ¸çš„ä¸€ä¸ªé…ç½®é€‰é¡¹ï¼Œç”¨äºå¯ç”¨æˆ–ç¦ç”¨ç½‘ç»œè®¾å¤‡çš„ Ingress åŠŸèƒ½ã€‚å¯ç”¨ CONFIG_NET_INGRESS é…ç½®é€‰é¡¹åï¼ŒLinux å†…æ ¸å°†æ”¯æŒå¯¹ç½‘ç»œè®¾å¤‡çš„å…¥å£æµé‡è¿›è¡Œæ§åˆ¶å’Œå¤„ç†ã€‚ç½‘ç»œè®¾å¤‡çš„ Ingress åŠŸèƒ½å¯ä»¥ç”¨äºå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š\nÃ˜ æ•°æ®åŒ…è¿‡æ»¤ï¼šæ ¹æ®é¢„å…ˆè®¾ç½®çš„è¿‡æ»¤è§„åˆ™ï¼Œåˆ¤æ–­æ•°æ®åŒ…æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚å¦‚æœæ•°æ®åŒ…è¢«è¿‡æ»¤ï¼Œå¯ä»¥æ ¹æ®ç­–ç•¥è¿›è¡Œä¸¢å¼ƒæˆ–å¤„ç†ã€‚\nÃ˜ æ•°æ®åŒ…å¤„ç†ï¼šæ ¹æ®ç½‘ç»œè®¾å¤‡çš„é…ç½®ï¼Œå¯¹æ•°æ®åŒ…è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼Œè¿›è¡Œ QoS å¤„ç†ã€ä¿®æ”¹æ•°æ®åŒ…å¤´éƒ¨ã€æ›´æ”¹ç›®æ ‡ç«¯å£ç­‰æ“ä½œã€‚\nÃ˜ æ•°æ®åŒ…è½¬å‘ï¼šæ ¹æ®ç­–ç•¥å’Œè·¯ç”±è¡¨ï¼Œå†³å®šæ•°æ®åŒ…çš„è½¬å‘ç›®çš„åœ°ï¼Œå¹¶å°†æ•°æ®åŒ…å‘é€åˆ°ç›¸åº”çš„ç½‘ç»œæ¥å£ã€‚\nä¸Šè¿°åŠŸèƒ½é€šè¿‡å‡½æ•°sch_handle_ingresså®ç°\nå¯¹vlançš„å¤„ç† åˆ¤æ–­skbåè®®æ˜¯å¦ä¸º8021Q 8021ADï¼Œè‹¥æ˜¯vlanåŒ…ï¼Œåˆ™è°ƒç”¨skb_vlan_untag()å‡½æ•°ï¼Œè¯¥å‡½æ•°è¯»å‡ºæ•°æ®æµä¸­çš„vlan_idï¼Œå¹¶å¡«å†™å…¥skb-\u0026gt;vlan_tciä¸­ï¼Œç„¶ååˆ é™¤vlan_headï¼Œä»è€Œå®ç°å¯¹ä¸Šå±‚çš„é€æ˜ã€‚æ³¨æ„è¿™é‡Œçš„skb-\u0026gt;vlan_tciæ ‡å¿—ä»…æ˜¯ä¸ºäº†ä¿å­˜skbæ•°æ®çš„vlanå¤´ä¿¡æ¯ï¼Œè€Œskbä¸­çš„æ•°æ®æ˜¯é€æ˜çš„ä»¥å¤ªç½‘åŒ….\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 static inline bool eth_type_vlan(__be16 ethertype) { switch (ethertype) { case htons(ETH_P_8021Q): case htons(ETH_P_8021AD): return true; default: return false; } } if (eth_type_vlan(skb-\u0026gt;protocol)) { skb = skb_vlan_untag(skb); if (unlikely(!skb)) goto out; } vlanä¿¡æ¯è½¬ç§»åˆ°skbç»“æ„ä¸­åï¼Œä¼šè·å–æ•°æ®åŒ…çœŸå®åè®®ç±»å‹ï¼ˆä¸‰å±‚åè®®ç±»å‹ï¼‰ï¼Œæ›´æ–°åˆ°skbçš„protocolå­—æ®µï¼Œæ›¿æ¢äº†ä¹‹å‰çš„ETH_P_8021Qæˆ–è€…ETH_P_8021ADã€‚å°†vlanä¿¡æ¯å­˜åœ¨skbå­—æ®µåï¼Œè°ƒç”¨vlan_do_receiveï¼Œè¯¥å‡½æ•°ç”±skb-\u0026gt;vlan_tciå¾—åˆ°è¯¥skbåŒ…æ‰€è¦å‘å¾€çš„vlan_devï¼Œå¹¶ä¸”é‡å®šå‘skb-\u0026gt;devä¸ºè¯¥vlan_devï¼Œæœ€åæ¶ˆé™¤skbä¸­çš„vlan_tciæ ‡å¿—ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 if (skb_vlan_tag_present(skb)) { if (pt_prev) { ret = deliver_skb(skb, pt_prev, orig_dev); pt_prev = NULL; } if (vlan_do_receive(\u0026amp;skb)) goto another_round; else if (unlikely(!skb)) goto out; } rx_handler = rcu_dereference(skb-\u0026gt;dev-\u0026gt;rx_handler); if (rx_handler) { æ ·ä¹‹åvlan_do_receive()è¿”å›ï¼Œä¸è¿‡æ­¤æ—¶çš„skbå·²ç»æ˜¯ä¸€ä¸ªæ™®é€šçš„æ•°æ®åŒ…äº†ï¼ˆå®ç°äº†å¯¹ä¸Šå±‚çš„é€æ˜ï¼‰ï¼Œä¸”å®ƒçœ‹èµ·æ¥å°±åƒæ˜¯ç”±vlan_devæ¥æ”¶çš„æ•°æ®åŒ…ã€‚\næ¥ä¸‹æ¥æ˜¯å…³é”®å¤„ç†dev-\u0026gt;rx_handlerï¼Œè¿™ä¸ªå‡½æ•°åœ¨ä¹‹å‰å°†ç½‘å£æ·»åŠ åˆ°ç½‘æ¡¥è®¾å¤‡çš„è¿‡ç¨‹ï¼Œè°ƒç”¨br_add_ifå‡½æ•°ä¸­å®šä¹‰\n1 2 3 4 5 br_add_if () --\u0026gt;netdev_rx_handler_register --\u0026gt;netdev_rx_handler_register(dev, br_get_rx_handler(dev), p); // {rcu_assign_pointer(dev-\u0026gt;rx_handler_data, p) rcu_assign_pointer(dev-\u0026gt;rx_handler, br_get_rx_handler)} çœ‹åˆ°åœ¨netdev_rx_handler_registerå‡½æ•°ï¼š\nå°†dev-\u0026gt;rx_handleä¸br_get_rx_handlerç»‘å®š\ndev-\u0026gt;rx_handler_dataä¸ä»¥å¤ªç½‘ç«¯å£pç»‘å®š\næ‰€ä»¥è¿™é‡Œç½‘æ¡¥æ“ä½œskbåŒ…ï¼Œä¸»è¦åœ¨br_get_rx_handlerå‡½æ•°ä¸­è¿›è¡Œã€‚\nç»è¿‡dev-\u0026gt;rx_handlerå‡½æ•°å¤„ç†ï¼Œè¿”å›å€¼æœ‰å››ç§ç±»å‹ï¼š\nÃ˜ RX_HANDLER_CONSUMEDï¼šæ•°æ®åŒ…å·²å¤„ç†æ¶ˆåŒ–ï¼Œæ— éœ€è¿›ä¸€æ­¥å¤„ç†ã€‚ï¼ˆä»€ä¹ˆåœºæ™¯ï¼‰ ç›´æ¥è·³è½¬åˆ°outæ ‡ç­¾é€€å‡ºã€‚\nÃ˜ RX_HANDLER_ANOTHERï¼šä¿®æ”¹äº†skb-\u0026gt;devï¼Œå†å¤„ç†ä¸€æ¬¡ï¼Œæ¯”å¦‚æ•°æ®åŒ…è®¾å¤‡æ˜¯ç½‘æ¡¥è®¾å¤‡ï¼Œä½†ç»è¿‡åˆ¤æ–­ï¼Œéœ€è¦ç»è¿‡ç½‘æ¡¥è®¾å¤‡è½¬å‘åˆ°å¦ä¸€ä¸ªç½‘æ¡¥å…³è”çš„ç«¯å£ï¼Œè¿™æ—¶å°±ä»bridge_devè½¬æ¢åˆ°äº†port_dev\nÃ˜ RX_HANDLER_EXACTï¼šç²¾ç¡®æŒ‡å®šè¦ä¼ é€’åˆ°ptype-\u0026gt;dev == skb-\u0026gt;devï¼ˆä»€ä¹ˆåœºæ™¯ï¼‰\nÃ˜ RX_HANDLER_PASSï¼š1.æ•°æ®åŒ…ç±»å‹æ˜¯å›ç¯ç±»å‹PACKET_LOOPBACK\nåä¸¤ç§æƒ…å†µä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæœ€ç»ˆå°†æ•°æ®åŒ…æäº¤åˆ°L3å±‚åè®®æ ˆ\nç½‘æ¡¥è®¾å¤‡å¤„ç†skb: br_handle_frame ä»è¿™é‡Œå¼€å§‹æ‰æ˜¯å¯¹æ•°æ®åŒ…çš„å¤„ç†åˆ†æµè½¬å‘ï¼Œä¹‹å‰å¯ä»¥çœ‹ä½œnetif_receive_skbå‡½æ•°å¯¹æ•°æ®åŒ…çš„é¢„å¤„ç†ã€‚br_get_rx_handlerè¢«è®¾ç½®ä¸ºbr_handle_frameï¼Œå…·ä½“è·¯å¾„ï¼šnet/bridge/br_input.cã€‚\nbr_handle_frameå‡½æ•°æ ¹æ®æ•°æ®åŒ…çš„ç±»å‹ï¼Œå¯¹æ•°æ®çš„å¤„ç†è¿›è¡Œåˆ†æµ.\nÃ˜ ç½‘æ¡¥å¤„äºdisableçŠ¶æ€ï¼š\n1.æ•°æ®åŒ…ç›®çš„åœ°å€æ˜¯ç½‘æ¡¥ç«¯å£åœ°å€ï¼šå°†pkt_typeè®¾ä¸ºPACKET_HOST\n1 2 if (ether_addr_equal(p-\u0026gt;br-\u0026gt;dev-\u0026gt;dev_addr, dest)) skb-\u0026gt;pkt_type = PACKET_HOST; 2.å¦åˆ™ï¼Œbr_handle_local_finishå‡½æ•°è®¾ç½®åˆ°ç½‘æ¡¥é¢„å¤„ç†èŠ‚ç‚¹ï¼Œè¯¥å‡½æ•°åœ¨ç½‘æ¡¥çŠ¶æ€éƒ¨ä½disableæ—¶ï¼Œä¼šå­¦ä¹ macä¸ç«¯å£ä¿¡æ¯å¹¶è®°å½•fdbè¡¨ä¸­\n1 2 3 4 5 if (NF_HOOK(NFPROTO_BRIDGE, NF_BR_PRE_ROUTING, dev_net(skb-\u0026gt;dev), NULL, skb, skb-\u0026gt;dev, NULL, br_handle_local_finish) == 1) { return RX_HANDLER_PASS; } Ã˜ ç½‘æ¡¥å¤„äºlearningæˆ–forwardingçŠ¶æ€ï¼š\nè°ƒç”¨å‡½æ•°nf_hook_bridge_pre-\u0026gt; br_handle_frame_finish\nbr_handle_frame_finish br_handle_frame_finishï¼šå†³ç­–å°†ä¸åŒç±»åˆ«çš„æ•°æ®åŒ…åšä¸åŒçš„åˆ†å‘è·¯å¾„ã€‚å…·ä½“å¤„ç†é€»è¾‘å¦‚ä¸‹å›¾.\né¦–å…ˆè¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç‰¹æ€§ï¼Œarp proxyï¼Œæ¥å£å¦‚æœæ˜¯èƒ½äº†æ­¤åŠŸèƒ½ï¼Œå¯¹äºæ”¶åˆ°çš„arp requestï¼Œé€šè¿‡æŸ¥è¯¢æœ¬åœ°çš„arpè¡¨æ„é€ arp replyæŠ¥æ–‡å›åº”ã€‚\næ ¹æ®ç›®æ ‡åœ°å€skb-\u0026gt;hdr-\u0026gt;h_deståˆ¤æ–­æ˜¯å•æ’­ã€å¹¿æ’­ã€å¤šæ’­çš„å“ªä¸€ç§ï¼š\nÃ˜ å•æ’­ï¼šè°ƒç”¨br_fdb_find_rcuæŸ¥æ‰¾fdbè¡¨é¡¹ï¼Œ ï¼ˆ1ï¼‰è‹¥å‘½ä¸­ï¼Œè°ƒç”¨br_forward()å°†æ•°æ®åŒ…è½¬å‘ï¼Œ ï¼ˆ2ï¼‰è‹¥è¡¨é¡¹ä¸ºç©ºï¼Œè°ƒç”¨å‡½æ•°br_flood() br_flood(br, skb, pkt_type, local_rcv, false); æ³¨æ„ï¼Œå¦‚æœå‘ç°ç›®æ ‡åœ°å€æ˜¯æœ¬åœ°åœ°å€ï¼ˆåˆ¤æ–­æ–¹æ³•ç›®æ ‡è¡¨é¡¹dst-\u0026gt;flagsä¸ºBR_FDB_LOCALï¼‰ï¼Œåˆ™ç›´æ¥è°ƒç”¨br_pass_frame_up()å‘å¾€æœ¬åœ°ï¼Œè¯¥å‡½æ•°ä¼šå†æ¬¡è¿›å…¥netif_receive_skbå‡½æ•°ã€‚\nÃ˜ å¹¿æ’­ï¼šç”±äºå¹¿æ’­ç›®æ ‡åœ°å€åŒ…å«æœ¬æœºï¼Œæ‰€ä»¥ä¼šå†æ¬¡è°ƒç”¨br_pass_frame_up()ï¼Œå¹¶è°ƒç”¨br_flood()\nÃ˜ å¤šæ’­ï¼šå› ä¸ºå½“ç›®çš„macåœ°å€æ˜¯0x01å¼€å¤´æ—¶ï¼Œæ—¢å¯ä»¥æ˜¯igmpç±»å‹çš„å¤šæ’­åè®®æ§åˆ¶æŠ¥æ–‡ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šæ’­æ•°æ®æµæŠ¥æ–‡ã€‚å…ˆè°ƒç”¨br_multicast_rcvå¤„ç†igmpç±»å‹æ•°æ®åŒ…ï¼Œå¤šæ’­æ•°æ®è¡¨ä¹Ÿé€šè¿‡è¯¥ç±»å‹æ•°æ®è¡¨ç»´æŠ¤ã€‚æ¥ç€æŸ¥çœ‹å¤šæ’­æ•°æ®è¡¨é¡¹ï¼Œ ï¼ˆ1ï¼‰å¦‚æœå‘½ä¸­ï¼Œè°ƒç”¨br_multicast_flood()ï¼Œ ï¼ˆ2ï¼‰å¦‚æœæœªå‘½ä¸­ä¹Ÿä¼šè°ƒç”¨br_flood()ã€‚ æœ€åå¤šæ’­ä¹Ÿä¼šåˆ¤æ–­æœ¬æœºæ˜¯å¦åŠ å…¥å¤šæ’­ç»„ï¼ŒåŠ å…¥çš„è¯ä¹Ÿä¼šè°ƒç”¨å‡½æ•°br_pass_frame_up()å°†æ•°æ®å‘å¾€æœ¬åœ°ã€‚\nè¿™é‡Œçœ‹åˆ°å•æ’­ï¼Œå¤šæ’­ï¼Œå¹¿æ’­éƒ½ä¼šè°ƒç”¨br_flood()å‡½æ•°ï¼Œåˆ†åˆ«åœ¨ä»¥ä¸‹æƒ…å†µï¼š\nå•æ’­ï¼Œfdbè¡¨é¡¹æœªå‘½ä¸­\nå¹¿æ’­ä¸‹éƒ½ä¼šè°ƒç”¨\nå¤šæ’­ï¼Œmdbè¡¨æœªå‘½ä¸­\nä¸åŒæƒ…å†µï¼Œé€šè¿‡å‡½æ•°å‚æ•°pkt_typeè¿›è¡Œçš„åŒºåˆ†ã€‚\nå•æ’­ï¼špkt_type = BR_PKT_UNICAST\nå¹¿æ’­ï¼špkt_type = BR_PKT_BROADCAST\nå¤šæ’­ï¼špkt_type = BR_PKT_MULTICAST\næ•°æ®åŒ…å‘å¾€æœ¬åœ°ï¼šbr_pass_frame_up æ•°æ®è¿›å…¥br_pass_frame_upï¼Œæ˜¯æ‰“ç®—ç»ç”±Bridgeè®¾å¤‡ï¼Œè¾“å…¥åˆ°æœ¬åœ°Hostçš„ã€‚æ•°æ®åŒ…ä»ç½‘æ¡¥ç«¯å£è®¾å¤‡è¿›å…¥ï¼Œç»è¿‡ç½‘æ¡¥è®¾å¤‡ï¼Œç„¶åå†è¿›å…¥åè®®æ ˆï¼Œå…¶å®æ˜¯â€œä¸¤æ¬¡ç»è¿‡net_deviceâ€ï¼Œä¸€æ¬¡æ˜¯ç«¯å£è®¾å¤‡ï¼Œå¦ä¸€æ¬¡æ˜¯ç½‘æ¡¥è®¾å¤‡ã€‚ç°åœ¨æ•°æ®åŒ…ç¦»å¼€ç½‘æ¡¥ç«¯å£è¿›å…¥ç½‘æ¡¥è®¾å¤‡ï¼Œéœ€è¦ä¿®æ”¹skb-\u0026gt;devå­—æ®µã€‚\n1 2 indev = skb-\u0026gt;dev; skb-\u0026gt;dev = brdev é€’äº¤çš„æœ€åä¸€æ­¥æ˜¯ç»è¿‡NF_BR_LOCAL_INé’©å­ç‚¹ï¼Œç„¶åæ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„netif_receive_skbï¼Œåªä¸è¿‡è¿™æ¬¡è¿›å…¥è¯¥å‡½æ•°çš„æ—¶å€™skb-\u0026gt;devå·²ç»è¢«æ¢æˆäº†Bridgeè®¾å¤‡ã€‚è¿™å¯ä»¥ç†è§£ä¸ºè¿›å…¥äº†Bridgeè®¾å¤‡çš„å¤„ç†ã€‚å®ƒçš„skb-\u0026gt;dev-\u0026gt;rx_handler ä¸ºç©ºï¼Œæ‰€ä»¥ä¸ä¼šå†æ¬¡è¿›å…¥br_handler_frameï¼Œè€Œæ˜¯ä¼šè¿›ä¸Šå±‚åè®®æ ˆã€‚\n1 2 3 return NF_HOOK(NFPROTO_BRIDGE, NF_BR_LOCAL_IN, dev_net(indev), NULL, skb, indev, NULL, br_netif_receive_skb); æ•°æ®è¢«ä¿®æ”¹skb-\u0026gt;devåå†æ¬¡è¿›å…¥netif_receive_skbï¼Œä¸Šæ¬¡æ‰§è¡Œçš„netif_receive_skbå› ä¸ºrx_handlerè¿”å›CONSUMEDè€Œç»“æŸã€‚\næ•°æ®åŒ…è½¬å‘ å•ç«¯å£è½¬å‘ï¼šbr_forward\nbr_forwardç»è¿‡ä¸€ç³»åˆ—çš„æ£€æŸ¥ä¸å‰æœŸå‡†å¤‡ï¼Œæœ€ç»ˆè°ƒç”¨dev_queue_xmit(skb)å°†æ•°æ®åŒ…æ”¾åˆ°ç½‘å¡è¾“å‡ºé˜Ÿåˆ—ä¸­å‘é€å‡ºå»ã€‚ä¹‹åå¯¹åº”å…·ä½“çš„ç½‘å¡é©±åŠ¨å‡½æ•°ã€‚\nå¤šæ’­ï¼šbr_multicast_flood\næ¡¥çš„å¤šæ’­åŠŸèƒ½éœ€è¦ä½¿èƒ½igmp snoopingåŠŸèƒ½\nè½¬å‘ç«¯å£è·å–ï¼š\nä»mdbä¸­è·å–å¤šæ’­ç»„çš„ç«¯å£p1ï¼Œ ä»br-\u0026gt;router_listè·å–æ¡¥æ¥ç«¯å£p2 p = p1\u0026gt;p2? p1: p2 ï¼ˆä¸ºä»€ä¹ˆè¿™æ ·æ¯”è¾ƒï¼‰ è‹¥p=p1æ—¶ï¼Œå¦‚æœè¯¥ç«¯å£æ”¯æŒå¤šæ’­å¯¹å•æ’­è½¬å‘ï¼Œ åˆ™ä»¥å•æ’­å½¢å¼è½¬å‘ï¼ˆä¹Ÿæ˜¯è°ƒç”¨br_forwardï¼Œä¸æ™®é€šå¤šæ’­è²Œä¼¼æ²¡æœ‰ä¸åŒï¼‰ å¤åˆ¶skbæ•°æ®ï¼Œè°ƒç”¨br_forwardä»pç«¯å£è½¬å‘æ•°æ® ä¸‹é¢br_floodä¸€æ ·æ¯æ¬¡è½¬å‘çš„ç«¯å£éƒ½æ˜¯ä¸Šæ¬¡éå†å¾—åˆ°çš„ç«¯å£ï¼Œæœ€åä¸€æ¬¡ç«¯å£ä½¿ç”¨åŸå§‹skbæ•°æ®ï¼Œè¿™æ ·å‡å°‘ä¸€æ¬¡cloneæ“ä½œ\nfloodåˆ°å„ç«¯å£br_flood\nå¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°å¯¹åº”çš„è¡¨é¡¹ï¼ˆå•æ’­ã€ç»„æ’­ï¼‰ï¼Œæˆ–è€…è¦è¿›è¡Œå¹¿æ’­æ¨¡å¼ï¼Œç³»ç»Ÿè°ƒç”¨br_floodï¼Œå‘ç½‘æ¡¥çš„æ¯ä¸ªç«¯å£è½¬å‘ã€‚br_floodå‡½æ•°éå†ç½‘æ¡¥ä¸‹çš„æ¯ä¸ªç«¯å£ï¼Œæ ¹æ®å…è®¸çš„flagsæ¡ä»¶ï¼Œè°ƒç”¨deliver_cloneæˆ–__br_forwardå°†sbkä»è¯¥ç«¯å£è½¬å‘å‡ºå»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 void br_flood(struct net_bridge *br, struct sk_buff *skb, enum br_pkt_type pkt_type, bool local_rcv, bool local_orig) { struct net_bridge_port *prev = NULL; struct net_bridge_port *p; list_for_each_entry_rcu(p, \u0026amp;br-\u0026gt;port_list, list) { /* Do not flood unicast traffic to ports that turn it off, nor * other traffic if flood off, except for traffic we originate */ switch (pkt_type) { case BR_PKT_UNICAST: if (!(p-\u0026gt;flags \u0026amp; BR_FLOOD)) continue; break; case BR_PKT_MULTICAST: if (!(p-\u0026gt;flags \u0026amp; BR_MCAST_FLOOD) \u0026amp;\u0026amp; skb-\u0026gt;dev != br-\u0026gt;dev) continue; break; case BR_PKT_BROADCAST: if (!(p-\u0026gt;flags \u0026amp; BR_BCAST_FLOOD) \u0026amp;\u0026amp; skb-\u0026gt;dev != br-\u0026gt;dev) continue; break; } /* Do not flood to ports that enable proxy ARP */ if (p-\u0026gt;flags \u0026amp; BR_PROXYARP) continue; if ((p-\u0026gt;flags \u0026amp; (BR_PROXYARP_WIFI | BR_NEIGH_SUPPRESS)) \u0026amp;\u0026amp; BR_INPUT_SKB_CB(skb)-\u0026gt;proxyarp_replied) continue; prev = maybe_deliver(prev, p, skb, local_orig); if (IS_ERR(prev)) goto out; } if (!prev) goto out; if (local_rcv) deliver_clone(prev, skb, local_orig); else __br_forward(prev, skb, local_orig); return; out: if (!local_rcv) kfree_skb(skb); } åœ¨å‘æ¯ä¸ªç«¯å£è½¬å‘æ—¶ï¼Œéƒ½ä¼šå¤åˆ¶ä¸€ä»½æ–°çš„skbæ•°æ®ã€‚ maybe_deliveræ˜¯deliver_cloneçš„åŒ…è£…ï¼Œæ¯æ¬¡éå†ç«¯å£åï¼Œä¼šåœ¨ä¸‹ä¸€ä¸ªéå†å‘¨æœŸï¼Œå°†æ•° æ®ä»æœ¬æ¬¡éå†ç«¯å£å‘é€ï¼Œæœ€åä¸€ä¸ªç«¯å£çš„æ•°æ®åˆ™æ˜¯ç›´æ¥ä½¿ç”¨åŸå§‹çš„skbï¼Œè¿™æ ·å¯ä»¥å°‘ä¸€æ¬¡æ•°æ®å¤åˆ¶å¼€é”€ã€‚\nå‚è€ƒé“¾æ¥ linuxç½‘æ¡¥é©±åŠ¨ä¸äºŒå±‚å¯¹æ•°æ®åŒ…åˆ†å‘ - çŸ¥ä¹\n","date":"2025-09-26T16:36:08+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/linux-%E7%BD%91%E6%A1%A5/","title":"Linux ç½‘æ¡¥"},{"content":"\nå…‰æ»‘çš„åœ°é¢ä¸Šæ”¾ç€å¤§å°ä¸¤ä¸ªæ»‘å—ï¼Œå·¦è¾¹æ˜¯å¢™ã€‚å¤§æ»‘å—çš„è´¨é‡æ˜¯å°æ»‘å—çš„Nå€ã€‚ç»™å¤§æ»‘å—ä¸€ä¸ªå‘å·¦çš„åˆé€Ÿåº¦ï¼Œä¸¤ä¸ªæ»‘å—ä¹‹é—´ä¼šå‘ç”Ÿå¤šæ¬¡ç¢°æ’ã€‚å‡è®¾ç¢°æ’æ²¡æœ‰èƒ½é‡æŸå¤±ï¼Œé—®ä¸€å…±ä¼šå‘ç”Ÿå¤šå°‘æ¬¡ç¢°æ’ï¼Ÿ\nèƒ½é‡å®ˆæ’ $$ \\frac{1}{2}mv^2 + \\frac{1}{2}MV^2 = \\frac{1}{2}MV_0^2 $$$$ \\frac{v^2}{M/m} + V^2 = V_0^2 $$ç”±M=Nm\n$$ \\frac{v^2}{N}+V^2=V_0^2 $$$$ \\frac{v^2}{NV_0^2}+\\frac{V^2}{V_0^2}=1 $$ ç¢°æ’è¿‡ç¨‹æ»¡è¶³åŠ¨é‡å®ˆæ’\nè®¾å‘å³ä¸ºæ­£\nç¬¬ä¸€æ¬¡ç¢°æ’\n$$ mv_1+MV_1=MV_0 $$$$ V_1=-\\frac{1}{N}v_1+V_0 $$åˆå§‹$V_0$å‘å·¦ä¸ºè´Ÿï¼Œæ­¤æ—¶$V_1$ ä¸ºè´Ÿï¼Œ$v_1$ä¸ºè´Ÿ\nç¬¬äºŒæ¬¡ç¢°æ’\nå°æ»‘å—m æ’å¢™ä»¥åï¼Œè¢«å¢™åå¼¹ï¼Œé€Ÿåº¦åå‘å˜ä¸º $-v_1$\n$$ mv_2+MV_2=m(-v_1)+MV_1 $$ $$ V_2=-\\frac{1}{N}(v_2+v_1)+V_1 $$Â ç›¸å½“äº$V_2=-\\frac{1}{N}v_2+V_1$å‘å³å¹³ç§»äº†$|v_1|$\nä¸Šè¿°è¿‡ç¨‹å¯ä»¥é‡å¤ä¸‹å»ï¼Œç›´åˆ°Â $V\\geq v \\gt 0$æ—¶ä¸ºæ­¢\n$\\frac{v^2}{NV_0^2}+\\frac{V^2}{V_0^2}=1$ å˜é‡ä»£æ¢$x=\\frac{v}{\\sqrt N |V_0|}$ $y=\\frac {V}{|V_0|}$ ===\u0026gt;$x^2+y^2=1$ï¼› $ V_1=-\\frac{1}{N}v_1+V_0$ ==\u0026gt;$y=-\\frac {1}{\\sqrt N}x-1$\n$\\tan \\theta = -\\frac {1}{\\sqrt N} $\næ»‘å—çš„æ¯ä¸€æ¬¡ç¢°æ’ï¼Œéƒ½å¯ä»¥çœ‹æˆæ˜¯ä»å•ä½åœ†ä¸Šåˆ‡ä¸‹ä¸¤æ®µé•¿åº¦ä¸º $l=\\theta R$\nçš„åœ†å¼§ï¼Œå³æ¯æ¬¡åˆ‡ä¸‹$s=2 l= 2 \\times \\theta \\times R = 2\\arctan \\frac {1}{\\sqrt N} $\næ•´ä¸ªå•ä½åœ†çš„å‘¨é•¿ä¸º$2 \\pi$\nç›´åˆ°å‰©ä¸‹çš„åœ†å¼§ä¸è¶³$s= 2\\arctan \\frac {1}{\\sqrt N}$æ—¶ä¸ä¼šå†ç¢°æ’\næ•…æ€»çš„ç¢°æ’æ¬¡æ•°ä¸º\n$$ \\lceil \\frac {2 \\pi}{2\\arctan \\frac {1}{\\sqrt N}} \\rceil -1 $$ç”±ä¸Šå¼å¯ä»¥ç®—å‡ºï¼Œå½“ä¸¤ä¸ªæ»‘å—è´¨é‡ç›¸ç­‰æ—¶ï¼Œ$s= \\arctan \\frac {1}{\\sqrt N}$Â ä¸º$\\frac {\\pi}{4}$ï¼Œç¢°æ’æ€»æ¬¡æ•°ä¸º 3ã€‚è€Œå½“ä¸¤ä¸ªæ»‘å—è´¨é‡æ‚¬æ®Šæ—¶ï¼ŒÂ $\\frac {1}{\\sqrt N}$å°±å¾ˆå°ï¼Œç”±$\\arctan (x) = x - \\frac {x^3} {3}+\\frac {x^5} {5}-\\frac {x^7} {7}-\u0026hellip;$æ­¤æ—¶å°±å¯ä»¥ç›´æ¥ç”¨Â $\\frac {1}{\\sqrt N}$æ¥è¿‘ä¼¼$\\arctan \\frac {1}{\\sqrt N}$ï¼Œäºæ˜¯ç¢°æ’æ€»æ¬¡æ•°å°±çº¦ä¸º$\\lfloor \\sqrt N \\pi \\rfloor$Â ã€‚å½“ä¸¤ä¸ªæ»‘å—çš„è´¨é‡ä¹‹æ¯”Â Næ˜¯ 100 çš„å¹‚æ—¶ï¼Œ$\\sqrt N$å°±æ˜¯ 10 çš„å¹‚ï¼Œè¿™å°±éš¾æ€ªç¢°æ’æ€»æ¬¡æ•°ä¼šæ°å¥½æ˜¯$\\pi$çš„å‰è‹¥å¹²ä½äº†\n","date":"2025-09-19T14:10:10+08:00","image":"https://cdn.jsdelivr.net/gh/charles-7777/ImageBed@main/blog/2025-09-19-13-54-10-image.png","permalink":"https://charles-7777.github.io/hugo-stack/p/%E5%BC%B9%E6%80%A7%E7%A2%B0%E6%92%9E%E4%B8%8Epi/","title":"å¼¹æ€§ç¢°æ’ä¸pi"},{"content":"ä»€ä¹ˆæ˜¯ UPnPï¼Ÿ UPnPï¼ˆUniversal Plug and Playï¼Œé€šç”¨å³æ’å³ç”¨ï¼‰æ˜¯ä¸€ç§ç½‘ç»œåè®®æ ‡å‡†ï¼Œæ—¨åœ¨è®©ç½‘ç»œè®¾å¤‡ï¼ˆå¦‚è®¡ç®—æœºã€æ‰“å°æœºã€æ‘„åƒå¤´ã€æ™ºèƒ½ç”µè§†ã€è·¯ç”±å™¨ã€IoTè®¾å¤‡ç­‰ï¼‰åœ¨æ¥å…¥ç½‘ç»œæ—¶èƒ½å¤Ÿè‡ªåŠ¨å‘ç°å½¼æ­¤å¹¶å»ºç«‹åŠŸèƒ½æ€§çš„ç½‘ç»œæœåŠ¡ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨é…ç½®ã€‚å…¶è®¾è®¡ç›®æ ‡æ˜¯å®ç°â€œé›¶é…ç½®â€ç½‘ç»œä½“éªŒã€‚ UPnP åŸºäºå¼€æ”¾çš„äº’è”ç½‘æ ‡å‡†å’ŒæŠ€æœ¯ï¼Œå¦‚ TCP/IPã€HTTPã€XMLã€SOAP å’Œ SSDPï¼Œä½¿å…¶èƒ½åœ¨å¤šç§æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶å¹³å°ä¸Šè¿è¡Œã€‚\nUPnP åŸºæœ¬åŸç† UPnP ç½‘ç»œé€šå¸¸åŒ…å«ä¸‰ç§è§’è‰²ï¼š\nè®¾å¤‡ (Device)ï¼šæä¾›ä¸€é¡¹æˆ–å¤šé¡¹æœåŠ¡çš„ç½‘ç»œå®ä½“ï¼ˆå¦‚æ™ºèƒ½ç¯æ³¡ã€ç½‘ç»œæ‘„åƒå¤´ï¼‰ã€‚\næœåŠ¡ (Service)ï¼šè®¾å¤‡æä¾›çš„æœ€å°åŠŸèƒ½æ§åˆ¶å•å…ƒï¼ˆå¦‚å¼€å…³æœåŠ¡ã€äº®åº¦è°ƒèŠ‚æœåŠ¡ï¼‰ã€‚\næ§åˆ¶ç‚¹ (Control Point)ï¼šå‘ç°å¹¶æ§åˆ¶è®¾å¤‡çš„æ§åˆ¶å™¨ï¼ˆå¦‚æ‰‹æœºAppã€ç”µè„‘ä¸Šçš„è½¯ä»¶ï¼‰ã€‚\nUPnP çš„å·¥ä½œæµç¨‹å¯åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒé˜¶æ®µï¼š\nå¯»å€ï¼ˆAddressingï¼‰ è®¾å¤‡æ¥å…¥ç½‘ç»œåï¼Œé¦–å…ˆé€šè¿‡ DHCP è·å– IP åœ°å€ï¼›è‹¥ DHCP ä¸å¯ç”¨ï¼Œåˆ™ä½¿ç”¨ Auto-IPï¼ˆå¦‚ 169.254.x.xï¼‰è‡ªè¡Œåˆ†é…ä¸€ä¸ªå±€åŸŸç½‘å†…å¯ç”¨çš„ IPã€‚\nå‘ç°ï¼ˆDiscoveryï¼‰ è®¾å¤‡ä½¿ç”¨ SSDPï¼ˆSimple Service Discovery Protocolï¼Œç®€å•æœåŠ¡å‘ç°åè®®ï¼‰å‘å±€åŸŸç½‘å¹¿æ’­è‡ªå·±çš„å­˜åœ¨ï¼š\nå¹¿æ’­æ¶ˆæ¯ï¼šè®¾å¤‡å‘é€ M-SEARCH è¯·æ±‚æˆ– NOTIFY é€šçŸ¥ã€‚\nå“åº”æœºåˆ¶ï¼šæ§åˆ¶ç‚¹ï¼ˆå¦‚æ‰‹æœºAppæˆ–PCï¼‰ç›‘å¬è¿™äº›å¹¿æ’­ï¼Œå¹¶å‘æ„Ÿå…´è¶£çš„è®¾å¤‡å‘é€è¯·æ±‚è·å–è¯¦ç»†ä¿¡æ¯ã€‚\nä½¿ç”¨ç»„æ’­åœ°å€ 239.255.255.250:1900 è¿›è¡Œé€šä¿¡ã€‚\næè¿°ï¼ˆDescriptionï¼‰ æ§åˆ¶ç‚¹é€šè¿‡ HTTP GET è¯·æ±‚ä»è®¾å¤‡æä¾›çš„ URL è·å– XML æè¿°æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ï¼š\nè®¾å¤‡ç±»å‹ã€å‚å•†ä¿¡æ¯ã€å‹å·ã€åºåˆ—å·\næ”¯æŒçš„æœåŠ¡åˆ—è¡¨ï¼ˆå¦‚ç«¯å£æ˜ å°„ã€éŸ³é‡æ§åˆ¶ç­‰ï¼‰\næ¯ä¸ªæœåŠ¡çš„æ§åˆ¶URLã€äº‹ä»¶URLã€æè¿°URL\næ§åˆ¶ï¼ˆControlï¼‰ æ§åˆ¶ç‚¹é€šè¿‡ SOAPï¼ˆSimple Object Access Protocolï¼‰åè®®å‘è®¾å¤‡å‘é€æ§åˆ¶æŒ‡ä»¤ï¼Œè°ƒç”¨å…¶æœåŠ¡æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š\nè°ƒç”¨â€œAddPortMappingâ€åœ¨è·¯ç”±å™¨ä¸Šæ·»åŠ ç«¯å£è½¬å‘è§„åˆ™\nè°ƒç”¨â€œSetVolumeâ€è°ƒèŠ‚éŸ³å“éŸ³é‡ è¯·æ±‚å’Œå“åº”å‡ä½¿ç”¨ XML æ ¼å¼å°è£…ï¼Œé€šè¿‡ HTTP POST å‘é€ã€‚\näº‹ä»¶é€šçŸ¥ï¼ˆEventingï¼‰ è®¾å¤‡çŠ¶æ€å˜åŒ–æ—¶ï¼ˆå¦‚æ’­æ”¾çŠ¶æ€æ”¹å˜ã€ç«¯å£æ˜ å°„æˆåŠŸï¼‰ï¼Œå¯é€šè¿‡ GENAï¼ˆGeneral Event Notification Architectureï¼‰åè®®å‘è®¢é˜…çš„æ§åˆ¶ç‚¹æ¨é€äº‹ä»¶é€šçŸ¥ï¼ˆä¹Ÿæ˜¯ XML æ ¼å¼ï¼‰ï¼Œå®ç°çŠ¶æ€åŒæ­¥ã€‚\nå±•ç¤ºï¼ˆPresentationï¼Œå¯é€‰ï¼‰ è®¾å¤‡å¯æä¾›ä¸€ä¸ªå†…ç½®çš„ Web ç•Œé¢ï¼ˆURL åŒ…å«åœ¨æè¿°æ–‡ä»¶ä¸­ï¼‰ï¼Œç”¨æˆ·å¯é€šè¿‡æµè§ˆå™¨è®¿é—®è¿›è¡Œå›¾å½¢åŒ–æ§åˆ¶æˆ–æŸ¥çœ‹çŠ¶æ€ã€‚\nUPnP ä¸»è¦åŠŸèƒ½ è‡ªåŠ¨è®¾å¤‡å‘ç°ä¸äº’æ“ä½œ å±€åŸŸç½‘å†…è®¾å¤‡è‡ªåŠ¨å¹¿æ’­èº«ä»½ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥ IP æˆ–é…ç½®ã€‚\nä¸åŒå‚å•†è®¾å¤‡åªè¦éµå¾ª UPnP æ ‡å‡†å³å¯äº’é€šï¼ˆå¦‚æ™ºèƒ½ç¯æ³¡ + æ‰‹æœºAppï¼‰ã€‚\nè‡ªåŠ¨ç«¯å£æ˜ å°„ï¼ˆNAT ç©¿é€ï¼‰ æœ€é‡è¦åŠŸèƒ½ä¹‹ä¸€ï¼šå…è®¸å†…ç½‘è®¾å¤‡ï¼ˆå¦‚æ¸¸æˆä¸»æœºã€P2Pè½¯ä»¶ã€ç›‘æ§æ‘„åƒå¤´ï¼‰è‡ªåŠ¨åœ¨è·¯ç”±å™¨ä¸Šåˆ›å»ºç«¯å£è½¬å‘è§„åˆ™ï¼Œå®ç°ä»å¤–ç½‘è®¿é—®ã€‚\nåº”ç”¨åœºæ™¯ï¼šåœ¨çº¿æ¸¸æˆè”æœºã€è¿œç¨‹è®¿é—®å®¶åº­æ‘„åƒå¤´ã€BTä¸‹è½½åŠ é€Ÿç­‰ã€‚\næ— éœ€ç”¨æˆ·ç™»å½•è·¯ç”±å™¨åå°æ‰‹åŠ¨è®¾ç½®ç«¯å£è½¬å‘ã€‚\nè®¾å¤‡æ§åˆ¶ä¸çŠ¶æ€åŒæ­¥ å¯è¿œç¨‹æ§åˆ¶è®¾å¤‡åŠŸèƒ½ï¼ˆæ’­æ”¾/æš‚åœã€å¼€å…³æœºã€è°ƒèŠ‚å‚æ•°ç­‰ï¼‰ã€‚\nå®æ—¶æ¥æ”¶è®¾å¤‡çŠ¶æ€å˜æ›´é€šçŸ¥ï¼ˆå¦‚â€œæ’­æ”¾ç»“æŸâ€ã€â€œç”µé‡ä½â€ï¼‰ã€‚\né›¶é…ç½®ç½‘ç»œä½“éªŒ ç”¨æˆ·æ— éœ€äº†è§£ç½‘ç»œçŸ¥è¯†ï¼Œæ’ä¸Šç½‘çº¿æˆ–è¿ä¸ŠWiFiå³å¯ä½¿ç”¨è®¾å¤‡åŠŸèƒ½ã€‚\nç‰¹åˆ«é€‚åˆå®¶åº­ç”¨æˆ·å’Œ IoT è®¾å¤‡ã€‚\næ”¯æŒå¤šç§è®¾å¤‡ç±»å‹ è·¯ç”±å™¨ã€æ‰“å°æœºã€NASã€åª’ä½“æœåŠ¡å™¨ï¼ˆDLNAï¼‰ã€æ™ºèƒ½å®¶ç”µã€å®‰é˜²è®¾å¤‡ç­‰å‡å¯æ”¯æŒ UPnPã€‚ UPnP çš„ä¼˜ç¼ºç‚¹ âœ… ä¼˜ç‚¹ï¼š ç®€å•æ˜“ç”¨ï¼šçœŸæ­£å®ç°â€œå³æ’å³ç”¨â€ã€‚\nè·¨å¹³å°å…¼å®¹ï¼šåŸºäºæ ‡å‡†äº’è”ç½‘åè®®ï¼Œæ”¯æŒ Windowsã€Linuxã€macOSã€Androidã€iOS ç­‰ã€‚\nè‡ªåŠ¨åŒ–ç¨‹åº¦é«˜ï¼šå‡å°‘äººå·¥é…ç½®é”™è¯¯ã€‚\nâŒ ç¼ºç‚¹ä¸é£é™©ï¼š å®‰å…¨é£é™©ï¼šæ¶æ„è½¯ä»¶å¯èƒ½åˆ©ç”¨ UPnP è‡ªåŠ¨åœ¨è·¯ç”±å™¨ä¸Šå¼€æ´ï¼Œæš´éœ²å†…ç½‘æœåŠ¡ï¼ˆå¦‚å‹’ç´¢è½¯ä»¶ã€åƒµå°¸ç½‘ç»œï¼‰ã€‚\nç¼ºä¹è®¤è¯æœºåˆ¶ï¼šé»˜è®¤æ— ç”¨æˆ·æƒé™æ§åˆ¶ï¼Œå±€åŸŸç½‘å†…ä»»ä½•è®¾å¤‡éƒ½å¯æ“ä½œã€‚\nç¨³å®šæ€§é—®é¢˜ï¼šéƒ¨åˆ†è®¾å¤‡å®ç°ä¸è§„èŒƒï¼Œå¯èƒ½å¯¼è‡´å†²çªæˆ–å¤±æ•ˆã€‚\nğŸ›¡ï¸ å®‰å…¨å»ºè®®ï¼š\nå®¶åº­ç”¨æˆ·å¦‚æ— è¿œç¨‹è®¿é—®éœ€æ±‚ï¼Œå»ºè®®åœ¨è·¯ç”±å™¨ä¸­å…³é—­ UPnP åŠŸèƒ½ã€‚ ä¼ä¸šç½‘ç»œåº”ä¸¥æ ¼ç¦ç”¨ UPnPã€‚ ä½¿ç”¨æ”¯æŒ UPnP-IGD v2 çš„è®¾å¤‡ï¼Œå…¶å®‰å…¨æ€§æœ‰æ‰€å¢å¼ºï¼ˆæ”¯æŒ PIN éªŒè¯ç­‰ï¼‰ã€‚ å…¸å‹åº”ç”¨åœºæ™¯ åœºæ™¯ è¯´æ˜ åœ¨çº¿æ¸¸æˆä¸»æœºè”ç½‘ Xbox/PS è‡ªåŠ¨è¯·æ±‚ç«¯å£æ˜ å°„ï¼Œå®ç° NAT å¼€æ”¾æˆ–ä¸­ç­‰ã€‚ P2P ä¸‹è½½ï¼ˆå¦‚ BitTorrentï¼‰ å®¢æˆ·ç«¯è‡ªåŠ¨æ˜ å°„ç«¯å£ï¼Œæé«˜è¿æ¥æ•°å’Œä¸‹è½½é€Ÿåº¦ã€‚ è¿œç¨‹è®¿é—®å®¶åº­æ‘„åƒå¤´/NAS è‡ªåŠ¨åœ¨è·¯ç”±å™¨ä¸Šæ˜ å°„ç«¯å£ï¼Œä¾¿äºå¤–ç½‘è®¿é—®ã€‚ DLNA åª’ä½“å…±äº« ç”µè§†è‡ªåŠ¨å‘ç°å±€åŸŸç½‘å†…çš„åª’ä½“æœåŠ¡å™¨å¹¶æ’­æ”¾å½±ç‰‡ã€‚ æ™ºèƒ½å®¶å±…æ§åˆ¶ æ‰‹æœº App è‡ªåŠ¨å‘ç°å¹¶æ§åˆ¶æ™ºèƒ½æ’åº§ã€ç¯æ³¡ç­‰ã€‚ ç›¸å…³åè®®ä¸æ ‡å‡†ç»„ç»‡ æ ‡å‡†ç»„ç»‡ï¼šUPnP Forumï¼ˆç°ç”± Open Connectivity Foundation æ¥ç®¡ï¼‰ æ ¸å¿ƒåè®®ï¼š SSDPï¼ˆå‘ç°ï¼‰ HTTP + XMLï¼ˆæè¿°ï¼‰ SOAPï¼ˆæ§åˆ¶ï¼‰ GENAï¼ˆäº‹ä»¶ï¼‰ æ‰©å±•æ ‡å‡†ï¼š UPnP-IGDï¼ˆInternet Gateway Deviceï¼‰ï¼šä¸“ç”¨äºè·¯ç”±å™¨ç«¯å£æ˜ å°„ã€‚ DLNAï¼ˆDigital Living Network Allianceï¼‰ï¼šåŸºäº UPnP çš„åª’ä½“å…±äº«æ ‡å‡†ã€‚ æ€»ç»“ UPnP æ˜¯ä¸€é¡¹æ—¨åœ¨ç®€åŒ–å®¶åº­å’Œå°å‹åŠå…¬ç½‘ç»œè®¾å¤‡äº’è”çš„æŠ€æœ¯ï¼Œé€šè¿‡æ ‡å‡†åŒ–çš„å‘ç°ã€æè¿°ã€æ§åˆ¶å’Œäº‹ä»¶æœºåˆ¶ï¼Œå®ç°äº†çœŸæ­£çš„â€œé›¶é…ç½®â€ä½“éªŒã€‚å°¤å…¶åœ¨è‡ªåŠ¨ç«¯å£æ˜ å°„æ–¹é¢æå¤§åœ°æ–¹ä¾¿äº†æ™®é€šç”¨æˆ·ã€‚ç„¶è€Œï¼Œå…¶å®‰å…¨æœºåˆ¶çš„ç¼ºå¤±ä¹Ÿå¸¦æ¥æ½œåœ¨é£é™©ï¼Œç”¨æˆ·åº”æ ¹æ®å®é™…éœ€æ±‚æƒè¡¡æ˜¯å¦å¯ç”¨ã€‚ éšç€ IoT å’Œæ™ºèƒ½å®¶å±…çš„æ™®åŠï¼ŒUPnP ä»åœ¨å¹¿æ³›ä½¿ç”¨ï¼Œä½†æ­£é€æ­¥è¢«æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆï¼ˆå¦‚ NAT-PMPã€PCPã€mDNS + DNS-SDï¼‰æ‰€è¡¥å……æˆ–å–ä»£ã€‚\nğŸ“š å‚è€ƒèµ„æ–™ï¼šUPnP Device Architecture 2.0, IETF RFC 6970, OCF Specifications\n","date":"2025-09-15T14:53:06+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/upnp%E9%80%9A%E7%94%A8%E5%8D%B3%E6%8F%92%E5%8D%B3%E7%94%A8%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/","title":"upnp(é€šç”¨å³æ’å³ç”¨)åè®®ä»‹ç»"},{"content":"docker æ­å»º hwdsl2/docker-ipsec-vpn-server: Docker image to run an IPsec VPN server, with IPsec/L2TP, Cisco IPsec and IKEv2\n1 2 3 4 5 6 7 8 9 10 docker run \\ --name ipsec-vpn-server \\ --restart=always \\ --env-file ./vpn.env \\ -v ikev2-vpn-data:/etc/ipsec.d \\ -v /lib/modules:/lib/modules:ro \\ -p 500:500/udp \\ -p 4500:4500/udp \\ -d --privileged \\ hwdsl2/ipsec-vpn-server vpn.env\n1 2 3 4 5 6 VPN_IPSEC_PSK=ipsec VPN_USER=vpnuser VPN_PASSWORD=123456 VPN_PUBLIC_IP=x.x.x.x VPN_ADDL_USERS=vpnuser1 vpnuser2 VPN_ADDL_PASSWORDS=123456 123456 æŸ¥çœ‹dockerå¯åŠ¨log\ndocker logs ipsec-vpn-server\nä¸€äº›client è¿æ¥å¯èƒ½é‡åˆ°çš„é—®é¢˜\nsetup-ipsec-vpn/docs/clients.md at master Â· hwdsl2/setup-ipsec-vpn\nè¿æ¥ipsec/l2tp å¯èƒ½é‡åˆ°çš„é—®é¢˜ Windows error 809\nError 809: The network connection between your computer and the VPN server could not be established because the remote server is not responding. This could be because one of the network devices (e.g, firewalls, NAT, routers, etc) between your computer and the remote server is not configured to allow VPN connections. Please contact your Administrator or your service provider to determine which device may be causing the problem.\n1 REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Services\\PolicyAgent /v AssumeUDPEncapsulationContextOnSendRule /t REG_DWORD /d 0x2 /f é…ç½®Ikev2 å¯å‚è€ƒdocker-ipsec-vpn-server/README-zh.md at master Â· hwdsl2/docker-ipsec-vpn-server\ndocker logs ipsec-vpn-serveræŸ¥çœ‹IKEv2 ç›¸å…³é…ç½®ä¿¡æ¯\n1 2 3 4 5 6 7 IKEv2 is already set up. Details for IKEv2 mode: VPN server address: 208.216.217.35 VPN client name: vpnclient Client configuration is available inside the Docker container at: é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œå¯èƒ½ä½¿ç”¨çš„æ˜¯é»˜è®¤é…ç½®ï¼Œéœ€è¦æ‰‹åŠ¨æ›´æ”¹\nè¿›å…¥dockerdocker exec -it ipsec-vpn-server /bin/sh\n1 2 wget https://get.vpnsetup.net/ikev2addr -O ikev2addr.sh bash ikev2addr.sh æ‰§è¡Œikev2addr.shå»æ‰‹åŠ¨æ›´æ”¹vpnserver address\né…ç½®IKEv2 clientï¼ˆwindows) 1 2 3 4 # æŸ¥çœ‹å®¹å™¨å†…çš„ /etc/ipsec.d ç›®å½•çš„æ–‡ä»¶ docker exec -it ipsec-vpn-server ls -l /etc/ipsec.d # ç¤ºä¾‹ï¼šå°†ä¸€ä¸ªå®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ä»å®¹å™¨å¤åˆ¶åˆ° Docker ä¸»æœºå½“å‰ç›®å½• docker cp ipsec-vpn-server:/etc/ipsec.d/vpnclient.p12 ./ åœ¨åˆ›å»ºIKEv2è¿æ¥ä¹‹å‰ï¼Œéœ€è¦åœ¨windows å®¢æˆ·ç«¯ å¯¼å…¥è¯ä¹¦\n1 2 # Import .p12 file (replace with your own value) certutil -f -importpfx \u0026#34;\\path\\to\\your\\file.p12\u0026#34; NoExport å¯èƒ½é‡åˆ°çš„é—®é¢˜ IKE authentication credentials are unacceptable\nå¯èƒ½æ˜¯IKEv2 vpn serverä¸­ server addressé…ç½®ä¸å¯¹ï¼Œå¯ä»¥å°è¯•æ›´æ”¹VPN server address\nPolicy match error\n1 REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Services\\RasMan\\Parameters /v NegotiateDH2048_AES256 /t REG_DWORD /d 0x1 /f åœ¨windows server ä¸Šæ­å»ºvpn server å¯å‚è€ƒWindows Server 2012 R2 å®‰è£…SSTP/L2TP/PPTP â€“ Noname\nåœ¨windows ä¸Šå®‰è£…å¹¶ä½¿ç”¨openvpn å‚è€ƒé“¾æ¥\nopenvpnå®‰è£…é…ç½®è¯´æ˜(windowsç³»ç»Ÿ) OpenVPN Windows å¹³å°å®‰è£…éƒ¨ç½²æ•™ç¨‹ å®‰è£…openvpn https://github.com/OpenVPN/openvpn\nhttps://openvpn.net/community-downloads/\nopenvpnè½¯ä»¶æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½æ˜¯åŒä¸€ä¸ªå®‰è£…åŒ… å®‰è£…æœåŠ¡ç«¯çš„æ—¶å€™è¦é€‰æ‹©Customizeï¼Œå‹¾é€‰openvpn serviceå’ŒEasyRSA3 å®‰è£…ï¼Œç”¨äºæœåŠ¡ç«¯é…ç½®å’Œè¯ä¹¦ç”Ÿæˆä½¿ç”¨ã€‚ å®‰è£…å®¢æˆ·ç«¯æ—¶å¯ç›´æ¥ç‚¹å‡»Install Nowè¿›è¡Œå®‰è£… è¯ä¹¦ç”Ÿæˆ å®‰è£…æœåŠ¡ç«¯çš„æ—¶å€™å·²ç»å®‰è£…äº†è¯ä¹¦ç”Ÿæˆå·¥å…·**EasyRSA3ï¼Œ**ä½¿ç”¨æ­¤å·¥å…·å³å¯ç”Ÿæˆæ‰€éœ€è¯ä¹¦\nè¿›å…¥EasyRSA shell ç¯å¢ƒdosçª—å£\nè¿›å…¥C:\\Program Files\\OpenVPN\\easy-rsaç›®å½•ï¼ŒåŒå‡»EasyRSA-Start.bat è¿›å…¥EasyRSA shell ç¯å¢ƒdosçª—å£ä¸­\nåˆå§‹åŒ–è¯ä¹¦ç”Ÿæˆç¨‹åº\nå¼¹å‡ºçš„dosçª—å£ä¸­è¾“å…¥./easyrsa init-pki åˆå§‹åŒ–è¯ä¹¦ç”Ÿæˆç¨‹åºï¼Œåˆå§‹åŒ–æˆåŠŸåä¼šåœ¨C:\\Program Files\\OpenVPN\\easy-rsaç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹kpi\nç”Ÿæˆcaè¯ä¹¦\nåœ¨dosçª—å£ä¸­è¾“å…¥./easyrsa build-ca nopassç”Ÿæˆæ— å¯†ç CAè¯ä¹¦ï¼Œç”Ÿæˆè¿‡ç¨‹ä¸­ä¼šè¦æ±‚è¾“å…¥è¯ä¹¦åç§°ï¼Œéšæ„è¾“å…¥å³å¯ï¼Œç”Ÿæˆç»“æŸåä¼šæ‰“å°å‡ºè¯ä¹¦æ‰€åœ¨ç›®å½•easy-rsa\\pki\\ca.crt\nç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦\nè¾“å…¥./easyrsa build-server-full server nopass ç”Ÿæˆæ— å¯†ç æœåŠ¡ç«¯è¯ä¹¦,ç”Ÿæˆåè¯ä¹¦æ–‡ä»¶åœ¨C:\\Program Files\\OpenVPN\\easy-rsa\\pki\\issuedæ–‡ä»¶å¤¹\nç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦\nè¾“å…¥./easyrsa build-client-full client nopassç”Ÿæˆæ— å¯†ç å®¢æˆ·ç«¯è¯ä¹¦,ç”Ÿæˆåè¯ä¹¦åœ¨C:\\Program Files\\OpenVPN\\easy-rsa\\pki\\issuedæ–‡ä»¶å¤¹\nç”ŸæˆDHå¯†é’¥äº¤æ¢åè®®\nè¾“å…¥./easyrsa gen-dhç”ŸæˆDHå¯†é’¥äº¤æ¢åè®®æ–‡ä»¶,ç”Ÿæˆæ–‡ä»¶åœ¨C:\\Program Files\\OpenVPN\\easy-rsa\\pkiç›®å½•ä¸‹\nç›®å½•C:\\Program Files\\OpenVPN\\easy-rsa\\pki\\privateä¸‹ä¸ºè¯ä¹¦key\nopenvpn --genkey tls-auth ta.keyto help block DoS attacks and UDP port flooding.\né…ç½®æ–‡ä»¶ æœåŠ¡ç«¯é…ç½®æ–‡ä»¶æ¨¡æ¿ä¸ºserver.ovpnï¼Œå®¢æˆ·ç«¯é…ç½®æ–‡ä»¶client.ovpnï¼Œåœ¨ C:\\Program Files\\OpenVPN\\sample-configç›®å½•ä¸‹æœ‰ã€‚åœ¨æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯çš„windowsä¸»æœºä¸Šå¤åˆ¶å¯¹åº”é…ç½®æ–‡ä»¶æ¨¡æ¿åˆ°C:\\Program Files\\OpenVPN\\configç›®å½•ä¸‹\né…ç½®æ–‡ä»¶ä¸­ ï¼› # éƒ½å¯ä»¥ç”¨ä½œæ³¨é‡Šï¼Œä½†æ˜¯ä¸æ”¯æŒåœ¨é…ç½®æŒ‡ä»¤çš„åŒä¸€è¡Œåé¢æ·»åŠ æ³¨é‡Š\nä¾‹å¦‚ cipher AES-256-CBC #é€‰æ‹©åŠ å¯†ç®—æ³• è¿™æ ·å†™æ˜¯é”™è¯¯çš„ï¼Œè§£ææ—¶ä¼šå°†cipher åçš„AES-256-CBC #é€‰æ‹©åŠ å¯†ç®—æ³•æ•´ä¸ªå­—ç¬¦ä¸²å½“æˆå‚æ•°å€¼ï¼Œä»è€Œå¯¼è‡´é”™è¯¯\næœåŠ¡ç«¯server.ovpn ä¿®æ”¹\nç«¯å£ï¼šï¼ˆå…¬ç½‘éœ€è¦å¯¹åº”å¼€é€šæ­¤ç«¯å£ï¼‰port udp 1194 åè®®æ–‡ä»¶åï¼šdh dh2048.pemä¿®æ”¹ä¸ºdh dh.pem è¿è¡Œå¤šç”¨æˆ·ä½¿ç”¨åŒä¸€å®¢æˆ·ç«¯è¯ä¹¦ï¼š;duplicate-cnå–æ¶ˆæ³¨é‡Šï¼ˆå‰é¢;å·åˆ é™¤ï¼‰ä¿®æ”¹ä¸ºduplicate-cn å®¢æˆ·ç«¯client.ovpnä¿®æ”¹\nä¿®æ”¹è¿æ¥æœåŠ¡å™¨åœ°å€: remote my-server-1 1194ä¿®æ”¹ä¸ºremote æœåŠ¡å™¨å…¬ç½‘ip 1194 å–æ¶ˆæ³¨é‡Šæ‰æ­¤è¡Œ: ;tls-auth ta.key 1ä¿®æ”¹ä¸º tls-auth ta.key 1ï¼ˆå‰é¢;å·åˆ é™¤ï¼‰ è¯ä¹¦å¤åˆ¶ é…ç½®æ–‡ä»¶server.ovpn client.ovpn ä¸­çš„è¯ä¹¦ å’Œ key éƒ½æ˜¯åªæœ‰æ–‡ä»¶å ï¼Œæ²¡æœ‰è§„å®šå…·ä½“è·¯å¾„\néœ€è¦å°†å…¶copy åˆ°C:\\Program Files\\OpenVPN\\config ä¸‹\nå°†æœåŠ¡ç«¯è¯ä¹¦ï¼ŒæœåŠ¡ç«¯keyï¼Œcaè¯ä¹¦ï¼Œdhæ–‡ä»¶, ta.keyå¤åˆ¶åˆ°æ–‡ä»¶å¤¹C:\\Program Files\\OpenVPN\\configä¸‹\nå°†å®¢æˆ·ç«¯è¯ä¹¦ï¼Œå®¢æˆ·ç«¯keyï¼Œcaè¯ä¹¦ , ta.keyå¤åˆ¶åˆ°ç›®å½•C:\\Program Files\\OpenVPN\\configä¸‹\nè¿æ¥ å³é”®ç‚¹å‡»ä»»åŠ¡æ å¸¦é”å°ç”µè„‘å›¾æ ‡ï¼Œç‚¹å‡»è¿æ¥,è¿æ¥æˆåŠŸåç³»ç»Ÿåˆ†é…ipï¼Œå°ç”µè„‘å˜ç»¿\nå…¶å®ƒ tls-auth ta.key é…ç½®ä¸ºé˜²å¾¡ DoS,UDP æ·¹æ²¡ç­‰æ¶æ„æ”»å‡»è¡Œä¸ºçš„é€‰é¡¹ï¼Œå¦‚é…ç½®éœ€è¦ç”Ÿæˆta.keyè¯ä¹¦ï¼Œç”Ÿæˆæ–¹å¼ï¼šè·³è½¬åˆ°openvpnè½¯ä»¶çš„binç›®å½•ä¸‹ï¼Œåœ¨dosçª—å£ä¸­è¾“å…¥ï¼šopenvpn.exe --genkey --secret ta.key ï¼Œä¾¿åœ¨binç›®å½•ä¸‹ç”Ÿæˆta.keyè¯ä¹¦äº†ï¼Œå¤åˆ¶åˆ°é…ç½®æ–‡ä»¶ç›®å½•å³å¯ã€‚ è¯ä¹¦æ—¶é—´ç­‰å‚æ•°å¯ä»¥åœ¨varsæ–‡ä»¶ä¸­è®¾ç½®ï¼Œè®¾ç½®åé‡æ–°å¯åŠ¨EasyRSA-Startå³å¯åŠ è½½æ–°é…ç½®ã€‚ ;client-to-clientä¸ºå®¢æˆ·ç«¯ä¹‹é—´æ˜¯å¦èƒ½ç›´æ¥è®¿é—®çš„é…ç½®ï¼Œå»æ‰æ³¨é‡Šåç”Ÿæ•ˆã€‚ ;push \u0026ldquo;redirect-gateway def1 bypass-dhcp\u0026rdquo; é…ç½®å¼€å¯åå®¢æˆ·ç«¯æ‰€æœ‰æµé‡å°†è·¯ç”±è‡³æœåŠ¡å™¨ï¼Œéœ€è¦åœ¨è®¿é—®ç«¯æœåŠ¡å™¨ä¸Šé…ç½®è·¯ç”±è½¬å‘åæ‰å¯ä»¥è®¿é—®å…¬ç½‘ã€‚ å¼€å¯ç¬¬4æ­¥åï¼Œå¯åœ¨å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ä¸­å¢åŠ route 192.168.1.0 255.255.255.0 net_gatewayé…ç½®ï¼Œä½¿è¯¥ç½‘æ®µä¸é€šè¿‡openvpnè·¯ç”± ","date":"2025-09-01T19:31:02+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/%E6%90%AD%E5%BB%BAvpn-server/","title":"æ­å»ºvpn server"},{"content":"å®˜æ–¹æ–‡æ¡£\nCORE (Common Open Research Emulator) æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ã€å¼€æºçš„ç½‘ç»œæ¨¡æ‹Ÿå’Œä»¿çœŸå·¥å…·ï¼Œå¹¿æ³›åº”ç”¨äºç½‘ç»œç ”ç©¶ã€æ•™å­¦ã€åè®®å¼€å‘å’Œç½‘ç»œåº”ç”¨æµ‹è¯•\nä¸»é¢˜ æè¿° Architecture ä½“ç³»ç»“æ„æ¦‚è¿°ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨Pythonã€gRPCç›´æ¥æ§åˆ¶Core Installation COREçš„å®‰è£…æ–¹æ³•åŠè¦æ±‚ GUI å¦‚ä½•ä½¿ç”¨GUI Node Types COREæ”¯æŒçš„èŠ‚ç‚¹ç±»å‹æ¦‚è¿° (BETA) Python GUI å¦‚ä½•ä½¿ç”¨åŸºäºPythonçš„BETA GUI Python API ä»‹ç»å¦‚ä½•ä½¿ç”¨Pythonç›´æ¥æ§åˆ¶Core (è‡ªå·±å®ç°core-daemon) gRPC API ä»‹ç»å¦‚ä½•ä½¿ç”¨gRPCæ§åˆ¶Core (è¿æ¥core-daemon è°ƒç”¨å…¶api) Distributed åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šè¿è¡ŒCOREçš„åˆ†å¸ƒå¼ç»†èŠ‚ CTRLNET å¦‚ä½•æ§åˆ¶ç½‘ç»œä»ä¸»æœºä¸èŠ‚ç‚¹é€šä¿¡ Services æ¦‚è¿°æ‰€æä¾›çš„æœåŠ¡å¹¶åˆ›å»ºè‡ªå®šä¹‰æœåŠ¡ Performance ä½¿ç”¨COREæ—¶çš„æ€§èƒ½è¯´æ˜ Developers Guide æ¦‚è¿°å¦‚ä½•å¯¹COREå¼€å‘ Core Emane COREä¸­è¿è¡Œå’Œä½¿ç”¨EMANEçš„é«˜çº§ä¸»é¢˜å’Œç¤ºä¾‹ Emaneå¼€å‘æ‰‹å†Œ Emaneçš„æ¶æ„ä»‹ç» å¼€å‘ç›¸å…³ ","date":"2025-08-18T20:01:30+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/corecommon-open-research-emulator%E7%BD%91%E7%BB%9C%E4%BB%BF%E7%9C%9F%E5%B7%A5%E5%85%B7/","title":"CORE(Common Open Research Emulator)ç½‘ç»œä»¿çœŸå·¥å…·"},{"content":"IPv6 åœ°å€ç»“æ„ ä¸€ä¸ª IPv6 åœ°å€ç”± 128 ä¸ªæ¯”ç‰¹ï¼ˆbitsï¼‰ç»„æˆï¼Œé€šå¸¸åˆ†ä¸º 8 ä¸ª 16 æ¯”ç‰¹çš„å—ï¼Œæ¯ä¸ªå—ç”¨å†’å·ï¼ˆ:ï¼‰åˆ†éš”ï¼Œå¹¶ä»¥åå…­è¿›åˆ¶è¡¨ç¤ºã€‚\nä¾‹å¦‚ï¼š2001:0db8:85a3:0000:0000:8a2e:0370:7334\nåœ°å€å‹ç¼©è§„åˆ™ ä¸ºäº†ç®€åŒ–ä¹¦å†™ï¼ŒIPv6 åœ°å€å¯ä»¥è¢«å‹ç¼©ï¼š\nçœç•¥å‰å¯¼é›¶ æ¯ä¸ªå—ä¸­å¼€å¤´çš„\n1 0 å¯ä»¥çœç•¥ã€‚\n0db8 -\u0026gt; db8 0000 -\u0026gt; 0 0370 -\u0026gt; 370 å‹ç¼©è¿ç»­çš„é›¶: å¯ä»¥ä½¿ç”¨åŒå†’å· :: æ¥æ›¿ä»£åœ°å€ä¸­ä»»æ„ä¸€æ®µè¿ç»­çš„ã€å…¨ä¸º 0 çš„å—ã€‚æ³¨æ„ï¼šåœ¨ä¸€ä¸ªåœ°å€ä¸­ :: åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚\nåº”ç”¨ä¸Šè¿°è§„åˆ™åï¼Œä¸Šé¢çš„åœ°å€å¯ä»¥è¢«ç®€åŒ–ä¸ºï¼š\n1 2001:db8:85a3::8a2e:370:7334 IPv6 åœ°å€ç±»å‹ IPv6 åœ°å€ä¸»è¦åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼šå•æ’­ï¼ˆUnicastï¼‰ã€å¤šæ’­ï¼ˆMulticastï¼‰å’Œä»»æ’­ï¼ˆAnycastï¼‰ã€‚\nå•æ’­åœ°å€ (Unicast) å•æ’­åœ°å€æ ‡è¯†ä¸€ä¸ªå”¯ä¸€çš„ç½‘ç»œæ¥å£ï¼Œå‘å¾€å•æ’­åœ°å€çš„æ•°æ®åŒ…å°†è¢«é€åˆ°è¯¥åœ°å€æ‰€æ ‡è¯†çš„å”¯ä¸€æ¥å£ã€‚\nå…¨çƒå•æ’­åœ°å€ (Global Unicast Address - GUA)\nèŒƒå›´: å…¨çƒå”¯ä¸€ï¼Œå¯åœ¨å…¬ç½‘è·¯ç”±ã€‚\nå‰ç¼€: é€šå¸¸ä»¥ 2000::/3 å¼€å¤´ã€‚\nç»“æ„:\nå…¨å±€è·¯ç”±å‰ç¼€ (Global Routing Prefix): é€šå¸¸ä¸º 48 ä½ï¼Œç”± ISP åˆ†é…ç»™ç»„ç»‡ã€‚ å­ç½‘ ID (Subnet ID): é€šå¸¸ä¸º 16 ä½ï¼Œç”±ç»„ç»‡å†…éƒ¨è§„åˆ’å­ç½‘ã€‚ æ¥å£ ID (Interface ID): 64 ä½ï¼Œç”¨äºæ ‡è¯†å­ç½‘ä¸­çš„å…·ä½“è®¾å¤‡æ¥å£ã€‚ é“¾è·¯æœ¬åœ°åœ°å€ (Link-Local Address)\nèŒƒå›´: ä»…åœ¨åŒä¸€ç‰©ç†æˆ–é€»è¾‘é“¾è·¯ä¸Šæœ‰æ•ˆï¼Œä¸èƒ½è·¨è·¯ç”±å™¨è·¯ç”±ã€‚\nå‰ç¼€: fe80::/10ã€‚\nç”¨é€”: ç”¨äºé‚»å±…å‘ç°ã€è‡ªåŠ¨åœ°å€é…ç½®ç­‰é“¾è·¯å†…éƒ¨é€šä¿¡ã€‚è®¾å¤‡å¯åŠ¨åä¼šè‡ªåŠ¨ç”Ÿæˆã€‚\nå”¯ä¸€æœ¬åœ°åœ°å€ (Unique Local Address - ULA)\nèŒƒå›´: ä»…åœ¨æœ‰é™èŒƒå›´å†…ï¼ˆå¦‚ä¸€ä¸ªç»„ç»‡æˆ–ç«™ç‚¹å†…éƒ¨ï¼‰ä½¿ç”¨ï¼ŒåŠŸèƒ½ç±»ä¼¼ IPv4 çš„ç§æœ‰åœ°å€ã€‚å®ƒä¸ä¼šåœ¨å…¬ç½‘è·¯ç”±ã€‚\nå‰ç¼€: fc00::/7ã€‚\nç‰¹æ®Šåœ°å€\nç¯å›åœ°å€: ::1/128ï¼Œç›¸å½“äº IPv4 çš„ 127.0.0.1ã€‚\nå¤šæ’­åœ°å€ (Multicast) å¤šæ’­åœ°å€æ ‡è¯†ä¸€ç»„ç½‘ç»œæ¥å£ï¼Œå‘å¾€å¤šæ’­åœ°å€çš„æ•°æ®åŒ…å°†è¢«é€åˆ°è¯¥ç»„ä¸­çš„æ‰€æœ‰æ¥å£ã€‚\nå‰ç¼€: ff00::/8ã€‚\nå¸¸è§ç¤ºä¾‹:\nff02::1: é“¾è·¯æœ¬åœ°èŒƒå›´å†…çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚ ff02::2: é“¾è·¯æœ¬åœ°èŒƒå›´å†…çš„æ‰€æœ‰è·¯ç”±å™¨ã€‚ ä»»æ’­åœ°å€ (Anycast) ä»»æ’­åœ°å€ä¹Ÿæ ‡è¯†ä¸€ç»„ç½‘ç»œæ¥å£ï¼Œä½†å‘å¾€ä»»æ’­åœ°å€çš„æ•°æ®åŒ…åªä¼šè¢«é€åˆ°è¿™ç»„æ¥å£ä¸­è·ç¦»æœ€è¿‘ï¼ˆæ ¹æ®è·¯ç”±åè®®çš„åº¦é‡ï¼‰çš„ä¸€ä¸ªã€‚ä»»æ’­åœ°å€çš„æ ¼å¼ä¸å•æ’­åœ°å€ç›¸åŒï¼Œä½†é€šè¿‡è·¯ç”±é…ç½®å®ç°ã€‚\nIPv6 åœ°å€åˆ†é…æ–¹æ³• è®¾å¤‡è·å– IPv6 åœ°å€ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š\næ— çŠ¶æ€åœ°å€è‡ªåŠ¨é…ç½® (SLAAC) SLAAC æ˜¯ IPv6 çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œå…è®¸è®¾å¤‡åœ¨æ²¡æœ‰ DHCP æœåŠ¡å™¨çš„æƒ…å†µä¸‹è‡ªåŠ¨é…ç½®åœ°å€ã€‚\nè¿‡ç¨‹:\nè®¾å¤‡å¯åŠ¨åï¼Œé¦–å…ˆä¸ºè‡ªå·±ç”Ÿæˆä¸€ä¸ªé“¾è·¯æœ¬åœ°åœ°å€ã€‚ è®¾å¤‡å‘æœ¬åœ°é“¾è·¯å‘é€ä¸€ä¸ªè·¯ç”±å™¨è¯·æ±‚ (Router Solicitation - RS) å¤šæ’­æ¶ˆæ¯ã€‚ é“¾è·¯ä¸Šçš„è·¯ç”±å™¨æ”¶åˆ° RS åï¼Œä¼šå›å¤ä¸€ä¸ªè·¯ç”±å™¨é€šå‘Š (Router Advertisement - RA) æ¶ˆæ¯ã€‚RA æ¶ˆæ¯ä¸­åŒ…å«äº†ç½‘ç»œå‰ç¼€ï¼ˆå¦‚ GUA å‰ç¼€ï¼‰å’Œå…¶ä»–ç½‘ç»œä¿¡æ¯ã€‚ è®¾å¤‡ä½¿ç”¨ RA ä¸­é€šå‘Šçš„å‰ç¼€ï¼Œå¹¶ç»“åˆè‡ªå·±çš„æ¥å£ IDï¼ˆé€šå¸¸é€šè¿‡ EUI-64 ç®—æ³•æˆ–éšæœºç”Ÿæˆï¼‰æ¥æ„æˆä¸€ä¸ªå®Œæ•´çš„å…¨çƒå•æ’­åœ°å€ã€‚ æœ‰çŠ¶æ€ DHCPv6 (Stateful) å·¥ä½œæ–¹å¼ç±»ä¼¼äº IPv4 çš„ DHCPï¼Œç”± DHCPv6 æœåŠ¡å™¨é›†ä¸­ç®¡ç†å’Œåˆ†é… IPv6 åœ°å€ã€‚\nä¼˜ç‚¹: ä¾¿äºé›†ä¸­ç®¡ç†å’Œå®¡è®¡ï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶åœ°å€åˆ†é…ã€‚ é€‚ç”¨åœºæ™¯: éœ€è¦ä¸¥æ ¼ç®¡ç†åœ°å€åˆ†é…çš„ä¼ä¸šç½‘ç»œã€‚ æ— çŠ¶æ€ DHCPv6 (Stateless) è¿™æ˜¯ä¸€ç§æ··åˆæ¨¡å¼ã€‚\nè®¾å¤‡é€šè¿‡ SLAAC è·å– IPv6 åœ°å€ã€‚ åŒæ—¶ï¼Œè®¾å¤‡é€šè¿‡ DHCPv6 è·å–å…¶ä»–ç½‘ç»œé…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚ DNS æœåŠ¡å™¨åœ°å€ã€åŸŸåç­‰ã€‚ è¿™ç§æ–¹å¼æ—¢åˆ©ç”¨äº† SLAAC çš„ä¾¿æ·æ€§ï¼Œåˆå¼¥è¡¥äº†å…¶æ— æ³•æä¾› DNS ç­‰é™„åŠ ä¿¡æ¯çš„ä¸è¶³ã€‚ é™æ€é…ç½® (Manual) ç®¡ç†å‘˜æ‰‹åŠ¨ä¸ºè®¾å¤‡é…ç½®é™æ€çš„ IPv6 åœ°å€ã€ç½‘å…³å’Œ DNS ç­‰ä¿¡æ¯ã€‚é€‚ç”¨äºæœåŠ¡å™¨ã€è·¯ç”±å™¨ç­‰éœ€è¦å›ºå®šåœ°å€çš„è®¾å¤‡ã€‚\nDHCPv6 äº¤äº’è¿‡ç¨‹ DHCPv6 å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡è¿‡ç¨‹ï¼Œç”¨äºè·å– IPv6 åœ°å€å’Œ/æˆ–å…¶ä»–ç½‘ç»œé…ç½®å‚æ•°ã€‚æ ‡å‡†çš„äº¤äº’è¿‡ç¨‹æ¶‰åŠå››æ¬¡æ¶ˆæ¯äº¤æ¢ï¼Œè¿™ç¡®ä¿äº†å®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©æœ€åˆé€‚çš„æœåŠ¡å™¨ã€‚\nå››æ­¥äº¤æ¢ (Four-Way Exchange):\nSolicit (è¯·æ±‚): å®¢æˆ·ç«¯åœ¨æœ¬åœ°é“¾è·¯ä¸Šå‘é€ä¸€ä¸ª Solicit å¤šæ’­æ¶ˆæ¯ï¼Œä»¥å‘ç°å¯ç”¨çš„ DHCPv6 æœåŠ¡å™¨ã€‚ æ¶ˆæ¯å‘é€åˆ°æ‰€æœ‰ DHCP ä¸­ç»§ä»£ç†å’ŒæœåŠ¡å™¨çš„å¤šæ’­åœ°å€ ff02::1:2ã€‚ Advertise (é€šå‘Š): æ”¶åˆ° Solicit æ¶ˆæ¯çš„ DHCPv6 æœåŠ¡å™¨ä¼šå›å¤ä¸€ä¸ª Advertise å•æ’­æ¶ˆæ¯ã€‚ æ­¤æ¶ˆæ¯ä¸­åŒ…å«äº†æœåŠ¡å™¨å¯ä»¥ä¸ºå®¢æˆ·ç«¯æä¾›çš„åœ°å€å’Œ/æˆ–é…ç½®ä¿¡æ¯ã€‚ä¸€ä¸ªå®¢æˆ·ç«¯å¯èƒ½ä¼šæ”¶åˆ°å¤šä¸ª Advertise æ¶ˆæ¯ã€‚ Request (è¯·æ±‚): å®¢æˆ·ç«¯ä»æ”¶åˆ°çš„ä¸€ä¸ªæˆ–å¤šä¸ª Advertise æ¶ˆæ¯ä¸­é€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå¹¶å‘å…¶å‘é€ä¸€ä¸ª Request å•æ’­æ¶ˆæ¯ï¼Œæ­£å¼è¯·æ±‚åˆ†é…åœ°å€å’Œ/æˆ–é…ç½®å‚æ•°ã€‚ æ¶ˆæ¯ä¸­ä¼šåŒ…å«å®ƒæ‰€é€‰æ‹©çš„æœåŠ¡å™¨çš„æ ‡è¯†ç¬¦ã€‚ Reply (å›å¤): è¢«é€‰ä¸­çš„æœåŠ¡å™¨æ”¶åˆ° Request æ¶ˆæ¯åï¼Œä¼šå‘é€ä¸€ä¸ª Reply å•æ’­æ¶ˆæ¯ï¼Œç¡®è®¤åœ°å€åˆ†é…å’Œé…ç½®ä¿¡æ¯ã€‚ æ­¤æ—¶ï¼Œå®¢æˆ·ç«¯å®Œæˆé…ç½®ï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨è·å–åˆ°çš„åœ°å€ã€‚ ä¸¤æ­¥äº¤æ¢ (Two-Way Exchange) - å¿«é€Ÿæäº¤ (Rapid Commit): ä¸ºäº†åŠ é€Ÿåœ°å€åˆ†é…è¿‡ç¨‹ï¼ŒDHCPv6 å¼•å…¥äº†å¿«é€Ÿæäº¤é€‰é¡¹ã€‚ Solicit (è¯·æ±‚): å®¢æˆ·ç«¯åœ¨ Solicit æ¶ˆæ¯ä¸­åŠ å…¥ \u0026ldquo;Rapid Commit\u0026rdquo; é€‰é¡¹ï¼Œè¡¨ç¤ºå¸Œæœ›ç«‹å³å®Œæˆåœ°å€åˆ†é…ã€‚ Reply (å›å¤): æ”¯æŒå¿«é€Ÿæäº¤çš„æœåŠ¡å™¨å¦‚æœæ„¿æ„ç«‹å³åˆ†é…åœ°å€ï¼Œä¼šç›´æ¥å›å¤ä¸€ä¸ª Reply æ¶ˆæ¯ï¼Œè·³è¿‡ Advertise å’Œ Request æ­¥éª¤ã€‚ è¿™ç§ä¸¤æ­¥äº¤æ¢å‡å°‘äº†å»¶è¿Ÿï¼Œåœ¨è®¸å¤šåœºæ™¯ä¸‹ï¼ˆå¦‚ç½‘ç»œä¸­åªæœ‰ä¸€ä¸ª DHCPv6 æœåŠ¡å™¨ï¼‰éå¸¸é«˜æ•ˆ å…³é”®åè®®ä¸æŠ€æœ¯ åœ¨ä¸€ä¸ªéƒ¨ç½² IPv6 çš„å¹¿æ’­åŸŸä¸­ï¼Œç›¸æ¯” IPv4 ä¸€ä¸ªæœ€æ˜æ˜¾çš„åŒºåˆ«å°±æ˜¯ IPv6 è·¯ç”±é€šå‘Šï¼›åœ¨ IPv4 æ—¶ä»£ï¼Œä¸€ä¸ªå¹¿æ’­åŸŸä¸­çš„ ipv4 ç½‘æ®µå¹¶æ²¡æœ‰æ˜¾å¼è¯´æ˜ï¼Œæˆ–è€…è¯´å¹¶æ²¡æœ‰ä¸€ä¸ª ipv4 ç½‘æ®µå®£ç§°å æ®äº†è¿™ä¸ªå¹¿æ’­åŸŸï¼Œä»…ä½¿ç”¨è¿™ä¸ªå¹¿æ’­åŸŸçš„å¹¿æ’­/ç»„æ’­èƒ½åŠ›ï¼Œå¤šä¸ªipv4ç½‘æ®µå…±ç”¨ä¸€ä¸ªå¹¿æ’­åŸŸçš„æƒ…å†µä¹Ÿä¸é²œè§ï¼›è€Œåœ¨ipv6ä¸­ï¼Œè¿è¡Œipv6åè®®çš„è·¯ç”±å™¨ä¼šä¸»åŠ¨å‘é€åä¸ºè·¯ç”±é€šå‘Š Router Advertisementçš„ ICMPv6 æŠ¥æ–‡ï¼Œåœ¨å¹¿æ’­åŸŸä¸­å®£å‘Š/å¹¿æ’­*æ­¤ ipv6 ç½‘æ®µå æ®äº†è¯¥å¹¿æ’­åŸŸï¼›\n*ï¼ˆå‡†ç¡®çš„è®²åº”è¯¥æ˜¯ç»„æ’­ï¼ŒIPv6 å·²ç»æ²¡æœ‰å¹¿æ’­æ¦‚å¿µäº†ï¼Œè¿™é‡Œä½¿ç”¨å¹¿æ’­è¿™ä¸ªè¯´æ³•ä¸ºäº†è¯´æ˜æ˜¯å…¬å¼€å‘é€çš„ï¼Œåœ¨ä¸€ä¸ªå¹¿æ’­åŸŸä¸­ï¼Œå¹¿æ’­å’Œç»„æ’­è¾¾æˆçš„åŠŸèƒ½ç±»ä¼¼ï¼Œä¸”åœ¨ä½ç«¯äº¤æ¢æœºä¸­ï¼Œå¹¿æ’­å’Œç»„æ’­çš„è½¬å‘æ–¹å¼æ˜¯ä¸€è‡´çš„ï¼‰\nRAï¼ˆè·¯ç”±é€šå‘Š Router Advertisementï¼‰ä½¿ç”¨ ICMPv6 æŠ¥æ–‡ï¼ˆtype 134ï¼‰ï¼Œå±äº NDP åè®®çš„ä¸€éƒ¨åˆ†\nIPv6 çš„åŠŸèƒ½å®ç°ä¸¥é‡ä¾èµ–äºä¸€äº›å…³é”®çš„åº•å±‚åè®®ï¼Œç‰¹åˆ«æ˜¯ ICMPv6 å’Œåœ¨å…¶åŸºç¡€ä¸Šæ„å»ºçš„é‚»å±…å‘ç°åè®® (NDP)ï¼Œä»¥åŠç”¨äºåŠ¨æ€åˆ†é…ç½‘ç»œå‰ç¼€çš„ DHCPv6-PDã€‚\nICMPv6 IPv6 æ—¶ä»£çš„ipå±‚æ§åˆ¶åè®®ï¼ˆç±»æ¯”ipv4ä¸­çš„arpã€icmpç­‰ï¼‰å‡ä½¿ç”¨icmpv6æŠ¥æ–‡ï¼Œå–æ¶ˆäº†IPå±‚çš„å¹¿æ’­ï¼Œè½¬è€Œå¹¿æ³›ä½¿ç”¨ç»„æ’­ã€‚ICMPv6 ä¸­çš„ type 133 ~ 137 æŠ¥æ–‡ç”±NDPåè®®ä½¿ç”¨ï¼Œç”¨äºå‘ç°ç½‘å…³ã€é‚»å±…ã€åœ°å€é…ç½®ç­‰ç­‰ã€‚\nICMPv6 ICMPv6 æ˜¯ IPv6 çš„ä¸€ä¸ªæ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œå…¶åŠŸèƒ½è¿œè¶… IPv4 ä¸­çš„ ICMPã€‚å®ƒä¸ä»…ç”¨äºä¼ è¾“ç½‘ç»œé”™è¯¯å’Œè¯Šæ–­ä¿¡æ¯ï¼Œè¿˜æ‰¿è½½äº†è®¸å¤šå…³é”®çš„ç½‘ç»œæ§åˆ¶åŠŸèƒ½ã€‚å¦‚æœé˜²ç«å¢™é”™è¯¯åœ°å®Œå…¨é˜»æ­¢ ICMPv6ï¼Œå°†å¯¼è‡´ IPv6 ç½‘ç»œä¸­æ–­ã€‚\nä¸»è¦åŠŸèƒ½:\né”™è¯¯æŠ¥å‘Š: å¦‚ \u0026ldquo;ç›®æ ‡ä¸å¯è¾¾\u0026rdquo;ã€\u0026ldquo;æ•°æ®åŒ…è¿‡å¤§\u0026rdquo;ã€\u0026ldquo;è¶…æ—¶\u0026rdquo; ç­‰ã€‚ è¯Šæ–­æŸ¥è¯¢: å¦‚ ping å‘½ä»¤æ‰€ä½¿ç”¨çš„ \u0026ldquo;Echo Request\u0026rdquo; å’Œ \u0026ldquo;Echo Reply\u0026rdquo;ã€‚ ç½‘ç»œæ§åˆ¶: ä¸º NDPã€MLD (å¤šæ’­ä¾¦å¬å‘ç°) ç­‰åè®®æä¾›æ¶ˆæ¯æ”¯æŒã€‚ NDP (é‚»å±…å‘ç°åè®®) NDP æ˜¯ IPv6 ä¸­ä¸€ä¸ªè‡³å…³é‡è¦çš„åè®®ï¼Œå®ƒå–ä»£äº† IPv4 ä¸­çš„ ARPã€ICMP è·¯ç”±å™¨å‘ç°å’Œ ICMP é‡å®šå‘ç­‰å¤šä¸ªåè®®çš„åŠŸèƒ½ã€‚NDP åŸºäº ICMPv6 å®ç°ï¼Œæ˜¯å®ç°å³æ’å³ç”¨å’Œ SLAAC çš„åŸºç¡€ã€‚\nNDP çš„æ ¸å¿ƒåŠŸèƒ½:\nåœ°å€è§£æ: å°† IPv6 åœ°å€è§£æä¸ºé“¾è·¯å±‚åœ°å€ï¼ˆå¦‚ MAC åœ°å€ï¼‰ï¼Œå–ä»£äº† ARPã€‚ è·¯ç”±å™¨å‘ç°: ä¸»æœºå¯ä»¥å‘ç°æœ¬åœ°é“¾è·¯ä¸Šçš„è·¯ç”±å™¨ã€‚ å‰ç¼€å‘ç°: ä¸»æœºå¯ä»¥å‘ç°ç”¨äºè‡ªåŠ¨é…ç½®çš„åœ°å€å‰ç¼€ã€‚ é‡å¤åœ°å€æ£€æµ‹ (DAD): èŠ‚ç‚¹å¯ä»¥ç¡®è®¤å…¶æƒ³è¦ä½¿ç”¨çš„åœ°å€åœ¨é“¾è·¯ä¸Šæ˜¯å”¯ä¸€çš„ã€‚ å¯è¾¾æ€§è·Ÿè¸ª: åˆ¤æ–­é‚»å±…èŠ‚ç‚¹æ˜¯å¦ä»ç„¶å¯è¾¾ã€‚ NDP ä½¿ç”¨çš„äº”ç§ ICMPv6 æ¶ˆæ¯ç±»å‹:\nè·¯ç”±å™¨è¯·æ±‚ (Router Solicitation - RS): é€šå¸¸ç”±ç»ˆç«¯ä¸»åŠ¨å‘é€ï¼Œç”¨äºåœ¨æœªæ”¶åˆ°å‘¨æœŸæ€§ RA çš„æƒ…å†µä¸‹ï¼Œè¯·æ±‚ RA è·¯ç”±å™¨é€šå‘Š (Router Advertisement - RA):ç”±è·¯ç”±å™¨å‘¨æœŸæ€§å‘é€ï¼Œä¹Ÿå¯ä»¥å“åº” RS å‘é€ï¼Œç”¨äºå®£å‘Šæœ¬å¹¿æ’­åŸŸä¸­ IPv6 ç›¸å…³ä¿¡æ¯ã€‚æ¯”å¦‚å‰ç¼€ã€ç½‘å…³ã€DNSç­‰ é‚»å±…è¯·æ±‚ (Neighbor Solicitation - NS): ç”¨äºè§£æé‚»å±…çš„é“¾è·¯å±‚åœ°å€æˆ–æ‰§è¡Œ DAD,å’Œ IPv4 çš„ ARP request åŠŸèƒ½ä¸€è‡´ã€‚ é‚»å±…é€šå‘Š (Neighbor Advertisement - NA): å¯¹ NS æ¶ˆæ¯çš„å“åº”ï¼Œæˆ–åœ¨é“¾è·¯å±‚åœ°å€å˜åŒ–æ—¶ä¸»åŠ¨å‘é€å’Œ ,IPv4 çš„ ARP replyåŠŸèƒ½ä¸€è‡´ã€‚ é‡å®šå‘ (Redirect): è·¯ç”±å™¨å‘ŠçŸ¥ä¸»æœºæœ‰æ›´ä¼˜çš„ä¸‹ä¸€è·³è·¯å¾„,ç±»ä¼¼äº IPv4 çš„icmp redirectåŠŸèƒ½ã€‚ RS/RA RS/RA æ˜¯IPv6 ç¯å¢ƒä¸‹ç‹¬æœ‰çš„æ§åˆ¶ä¿¡ä»¤ï¼Œæ­¤ä¿¡ä»¤æ˜ç¡®äº†ä¸€ä¸ªå¹¿æ’­åŸŸä¸­å„èŠ‚ç‚¹æ‰€ä»£è¡¨çš„è§’è‰²ã€‚\nå¹¿æ’­åŸŸä¸­å‘é€RAçš„ä¸ºè·¯ç”±å™¨\nå¹¿æ’­åŸŸä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªè·¯ç”±å™¨\nRA ç»„æ’­å‘¨æœŸæ€§å‘é€\nRS ç”¨äºåœ¨æœªæ”¶åˆ° RA æƒ…å†µä¸‹è¯·æ±‚ RA\nRA ä¸­çš„Flagsè¡¨æ˜å½“å‰å¹¿æ’­åŸŸä¸­ IPv6 åœ°å€çš„é…ç½®æ–¹å¼\nè¿™äº› Flags åˆ†å¸ƒåœ¨ä¸¤ä¸ªä½ç½®\u0026mdash;-ICMPv6 æŠ¥å¤´å’Œ prefix optionï¼Œåè€…ç§°ä¸º PIO(Prefix Information Option) flagã€‚\nM(Managed address configuration):ä½äºæŠ¥å¤´ï¼ŒM=1 è¡¨æ˜ç»ˆç«¯åº”è¯¥ä½¿ç”¨ DHCPv6 åè®®é…ç½®åœ°å€å’Œå…¶ä»–ç½‘ç»œå‚æ•°ï¼›å¦‚æœM=1ï¼Œåˆ™å¿½ç•¥ O Flagï¼›æ­¤flagç”¨äºDHCPv6 æœ‰çŠ¶æ€æ¨¡å¼ã€‚ O(Other configuration):ä½äºæŠ¥å¤´ï¼ŒO=1ä¸”M=0 è¡¨æ˜ç»ˆç«¯åº”è¯¥ä½¿ç”¨ DHCPv6 è®¾ç½®é™¤äº† IPv6 åœ°å€ä¹‹å¤–çš„å…¶ä»–ï¼ˆdns/ntpç­‰ï¼‰ï¼Œæ­¤ flag ç”¨äº DHCPv6 æ— çŠ¶æ€æ¨¡å¼ã€‚ A(Autononous address-configuration flag):ä½äºPIOä¸­ï¼ŒA=1 è¡¨æ˜ç»ˆç«¯åº”è¯¥ä½¿ç”¨ SLAAC é…ç½® IPv6 åœ°å€ï¼›PIOå¯ä»¥åŒ…å«å¤šä¸ª Prefixï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä¸€ä¸ªå¹¿æ’­åŸŸä¸­å¯ä»¥å­˜åœ¨å¤šä¸ª IPv6 ç½‘æ®µã€‚ è¿™å‡ ç§flagæ˜¯å¯ä»¥å¤åˆä½¿ç”¨çš„ï¼Œä»¥æ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚,é™¤äº†æ‰‹åŠ¨é™æ€é…ç½®ipv6åœ°å€ï¼ŒåŠ¨æ€/è‡ªåŠ¨é…ç½®æˆ–è€…åŠè‡ªåŠ¨é…ç½®ipv6åœ°å€çš„æ–¹å¼éƒ½éœ€è¦ä»ndpåè®®çš„ RA å¼€å§‹ï¼Œå°±å¥½åƒ RA å¼•å¯¼äº†IPv6è‡ªåŠ¨é…ç½®çš„å¼€å§‹ï¼›RAä¸­çš„ä¸åŒflagå åŠ å½±å“åœ°å€è‡ªåŠ¨é…ç½®ï¼›\nDHCPv6-PD DHCPv6å‰ç¼€ä»£ç†DHCPv6-PD(PrefixDelegation)æ˜¯ä¸€ç§å‰ç¼€åˆ†é…æœºåˆ¶ï¼Œé€šè¿‡DHCPv6å‰ç¼€ä»£ç†æœºåˆ¶ï¼Œä¸‹æ¸¸ ç½‘ç»œè®¾å¤‡ä¸éœ€è¦å†æ‰‹å·¥æŒ‡å®šç”¨æˆ·ä¾§é“¾è·¯çš„IPv6åœ°å€å‰ç¼€ï¼Œå®ƒåªéœ€è¦å‘ä¸Šæ¸¸ç½‘ç»œè®¾å¤‡æå‡ºå‰ç¼€åˆ†é…ç”³è¯·ï¼Œä¸Šæ¸¸ç½‘ ç»œè®¾å¤‡ä¾¿å¯ä»¥åˆ†é…åˆé€‚çš„åœ°å€å‰ç¼€ç»™ä¸‹æ¸¸è®¾å¤‡ï¼Œä¸‹æ¸¸è®¾å¤‡æŠŠè·å¾—çš„å‰ç¼€å†é€šè¿‡è·¯ç”±é€šå‘Š(RA)è‡³ä¸IPv6ä¸»æœºç›´è¿ çš„ç”¨æˆ·é“¾è·¯ä¸Šï¼Œå®ç°IPv6ä¸»æœºçš„åœ°å€è‡ªåŠ¨é…ç½®ï¼Œå®Œæˆæ•´ä¸ªç³»ç»Ÿå±‚æ¬¡çš„åœ°å€å¸ƒå±€ã€‚\nDHCP-PD æŠ€æœ¯æœ€æ—©åœ¨RFC3633ä¸­æå‡ºï¼Œç»è¿‡å‡ æ¬¡æ›´æ–°ç›®å‰æœ€æ–°çš„æ˜¯RFC8415ï¼Œå…¶ä¸»è¦æ€æƒ³æ˜¯æŠŠDHCPv6çš„åœ°å€åˆ†é…æ–¹å¼åˆ’åˆ†ä¸ºå¤šå±‚ï¼Œdhcp clientä¸å†æ˜¯ä»…ä»…è·å–åœ°å€ç”¨äºç»ˆç«¯é€šä¿¡ï¼Œè€Œæ˜¯å¯ä»¥ä½œä¸ºæ¬¡çº§è·¯ç”±å™¨èº«ä»½æŠŠåœ°å€å±‚å±‚åˆ†é…ä¸‹å»ï¼›è¿™æ ·çš„å¥½å¤„æ˜¯ä¾¿äºå¿«é€Ÿå’Œç»Ÿä¸€éƒ¨ç½²å¤§é‡åœ°å€ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡åŠ¨æ€åœ°å€çš„æƒ…å†µä¸‹ï¼Œæ­¤ç§åœ°å€åˆ†é…æ–¹å¼åœ¨å®¶åº­å®½å¸¦ä¸­å·²ç»å¤§é‡éƒ¨ç½²ï¼›å…‰çŒ«ä»å…¶ä¸Šçº§è·å–ä¸€æ®µåœ°å€ç”¨äºæœ¬åœ°ç½‘ç»œç»ˆç«¯çš„åœ°å€åˆ†é…ï¼Œç”šè‡³ä»å…‰çŒ«æ‹¿åˆ°çš„åœ°å€è¿˜èƒ½å†å¾€ä¸‹ä¸€å±‚åˆ†é….\nå·¥ä½œåŸç†:\nè¯·æ±‚: å®¶åº­è·¯ç”±å™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰å‘å…¶ä¸Šæ¸¸ ISP çš„è·¯ç”±å™¨ï¼ˆæœåŠ¡å™¨ï¼‰å‘é€ DHCPv6 è¯·æ±‚ï¼Œå¸Œæœ›è·å¾—ä¸€ä¸ª IPv6 åœ°å€å‰ç¼€ï¼ˆä¾‹å¦‚ä¸€ä¸ª /56 æˆ– /48 çš„åœ°å€å—ï¼‰ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€ä¸ªåœ°å€ã€‚ ä»£ç†: ISP è·¯ç”±å™¨ä»å…¶åœ°å€æ± ä¸­åˆ†é…ä¸€ä¸ªå‰ç¼€å—ï¼Œå¹¶é€šè¿‡ DHCPv6 å›å¤å°†å…¶â€œä»£ç†â€æˆ–â€œæˆæƒâ€ç»™å®¶åº­è·¯ç”±å™¨ã€‚ åˆ†é…: å®¶åº­è·¯ç”±å™¨è·å¾—è¯¥å‰ç¼€åï¼Œå°±æ‹¥æœ‰äº†ç®¡ç†è¿™ä¸ªåœ°å€å—çš„æƒé™ã€‚å®ƒå¯ä»¥å°†è¿™ä¸ªå‰ç¼€è¿›ä¸€æ­¥åˆ’åˆ†ä¸ºæ›´å°çš„å­ç½‘ï¼ˆä¾‹å¦‚å¤šä¸ª /64 å­ç½‘ï¼‰ï¼Œå¹¶ä¸ºè¿æ¥åˆ°å…¶ LAN å£çš„å„ä¸ªå†…éƒ¨ç½‘ç»œï¼ˆå¦‚å®¶åº­ç½‘ç»œã€è®¿å®¢ç½‘ç»œï¼‰åˆ†é…è¿™äº›å­ç½‘å‰ç¼€ã€‚ é€šå‘Š: å®¶åº­è·¯ç”±å™¨åœ¨å…¶å†…éƒ¨ç½‘ç»œä¸Šå‘é€ RA æ¶ˆæ¯ï¼Œé€šå‘Šè¿™äº› /64 çš„å­ç½‘å‰ç¼€ï¼Œä½¿å¾—å†…éƒ¨ç½‘ç»œä¸­çš„è®¾å¤‡å¯ä»¥é€šè¿‡ SLAAC è‡ªåŠ¨é…ç½® IPv6 åœ°å€ã€‚ ä¼˜åŠ¿:\nè‡ªåŠ¨åŒ–: æ— éœ€æ‰‹åŠ¨é…ç½®ä¸‹æ¸¸è·¯ç”±å™¨çš„å­ç½‘ï¼Œå®ç°äº†ç½‘ç»œéƒ¨ç½²çš„è‡ªåŠ¨åŒ–ã€‚ ç»“æ„åŒ–: ä½¿å¾—å®¶åº­æˆ–å°å‹åŠå…¬å®¤å¯ä»¥è½»æ¾åœ°æ‹¥æœ‰å¤šä¸ªç‹¬ç«‹çš„ IPv6 å­ç½‘ï¼Œä¾¿äºç½‘ç»œéš”ç¦»å’Œç®¡ç†ã€‚ é«˜æ•ˆæ€§: ç›¸æ¯”äº NATï¼Œæ¯ä¸ªè®¾å¤‡éƒ½èƒ½è·å¾—å…¨çƒå”¯ä¸€çš„å…¬ç½‘åœ°å€ï¼Œå®ç°äº†çœŸæ­£çš„ç«¯åˆ°ç«¯è¿æ¥ã€‚ link-local å¯¹æ¯”IPv4ç¯å¢ƒï¼ŒIPv6 åœ°å€æœ‰æ‰€è°“çš„ link-local åœ°å€è€Œä¸”å……å½“æ¯”è¾ƒé‡è¦ä½œç”¨ï¼›ç”±äºä¸€ä¸ªæ¥å£å¯ä»¥é…ç½®å¾ˆå¤šIPv6åœ°å€ï¼Œå½“è¿™äº›åœ°å€ä½œä¸ºä¸‹ä¸€è·³ä½¿ç”¨çš„æ—¶å€™ä¼šå‡ºç°æ··ä¹±ï¼Œè¿™æ ·ä¸åˆ©äºç®¡ç†ä¹Ÿä¸åˆ©äºè®¾å¤‡æ€§èƒ½å¼€é”€,ä½¿ç”¨Link Localåœ°å€å”¯ä¸€æ ‡è¯†é“¾è·¯ä¸Šçš„ä¸€ä¸ªèŠ‚ç‚¹å°±é¿å…äº†è¿™ä¸ªé—®é¢˜ã€‚è€Œä¸”åœ¨ç½‘ç»œé‡æ–°ç¼–å€è¿‡ç¨‹ä¸­ï¼ŒLink Localå¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ›´åˆ©äºå¿«é€Ÿæ›´æ”¹ç¼–å€\nDAD DAD åŸºäº ICMPv6 Neighbor Solicitationï¼ˆNSï¼Œé‚»å±…è¯·æ±‚ï¼‰ å’Œ Neighbor Advertisementï¼ˆNAï¼Œé‚»å±…é€šå‘Šï¼‰ æ¶ˆæ¯å®ç°ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š\nèŠ‚ç‚¹åˆ†é…ä¸€ä¸ª IPv6 åœ°å€ï¼ˆå¦‚é€šè¿‡ SLAAC æˆ–æ‰‹åŠ¨é…ç½®ï¼‰ï¼Œä½†è¯¥åœ°å€å°šæœªæ­£å¼å¯ç”¨ï¼ˆå¤„äº \u0026ldquo;tentative\u0026rdquo; çŠ¶æ€ï¼‰ã€‚ å‘é€ Neighbor Solicitationï¼ˆNSï¼‰ï¼š ç›®æ ‡åœ°å€ï¼ˆTarget Addressï¼‰è®¾ä¸ºå¾…æ£€æµ‹çš„ IPv6 åœ°å€ã€‚ æºåœ°å€è®¾ä¸º æœªæŒ‡å®šåœ°å€ï¼ˆ::ï¼‰ï¼ˆå› ä¸ºè¯¥åœ°å€å°šæœªæ­£å¼ä½¿ç”¨ï¼‰ã€‚ å‘é€åˆ° \u0026ldquo;è¯·æ±‚èŠ‚ç‚¹ç»„æ’­åœ°å€\u0026rdquo;ï¼ˆSolicited-Node Multicast Addressï¼ŒFF02::1:FFXX:XXXXï¼‰ã€‚ ç­‰å¾…å“åº”ï¼š å¦‚æœæ²¡æœ‰æ”¶åˆ° Neighbor Advertisementï¼ˆNAï¼‰ï¼Œè¯´æ˜åœ°å€æœªè¢«å ç”¨ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚ å¦‚æœæ”¶åˆ° NAï¼Œè¯´æ˜åœ°å€å·²è¢«å ç”¨ï¼ŒèŠ‚ç‚¹å¿…é¡»æ”¾å¼ƒè¯¥åœ°å€å¹¶é‡æ–°é…ç½®ï¼ˆå¦‚ SLAAC ä¼šç”Ÿæˆæ–°åœ°å€ï¼‰ã€‚ DAD å®Œæˆï¼š æˆåŠŸé€šè¿‡æ£€æµ‹åï¼Œåœ°å€å˜ä¸º \u0026ldquo;Preferred\u0026rdquo; æˆ– \u0026ldquo;Valid\u0026rdquo; çŠ¶æ€ï¼Œå¯ä»¥æ­£å¸¸é€šä¿¡ é‚»å±…è¡¨ é‚»å±…è¡¨ï¼Œåœ¨IPv4ç¯å¢ƒä¸‹å°±æ˜¯ARPè¡¨ï¼Œç³»ç»Ÿç»´æŠ¤Arpè¡¨å†…å®¹ç”±ç³»ç»Ÿè‡ªå·±å†³å®šï¼Œæ¯”å¦‚ç«¯å£ã€æ›´æ–°æ—¶é—´ç­‰ï¼›\nåˆ°äº†IPv6ç¯å¢ƒï¼ŒNDè¡¨ä»£æ›¿äº†arpè¡¨ï¼Œè€Œä¸”åè®®è§„å®šäº†5ç§é‚»å±…çŠ¶æ€ï¼ŒIPv6 é‚»å±…çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ï¼š Incompleteã€Reachableã€Staleã€Delayã€Probeï¼Œå…¶ä¸­åªæœ‰ Stale çŠ¶æ€æ˜¯ç¨³å®šçŠ¶æ€ã€‚\nIncomplete ï¼ˆæœªå®ŒæˆçŠ¶æ€ï¼‰ï¼šè¡¨â½°æ­£åœ¨è§£ æåœ°å€ï¼Œä½†é‚»å±…é“¾è·¯å±‚åœ°å€å°šæœªç¡®å®šã€‚ Reachable ï¼ˆå¯è¾¾çŠ¶æ€ï¼‰ï¼šè¡¨â½°åœ°å€è§£æ æˆåŠŸï¼Œè¯¥é‚»å±…å¯è¾¾ã€‚ Staleï¼ˆå¤±æ•ˆçŠ¶æ€ï¼‰ï¼šè¡¨â½°å¯è¾¾æ—¶é—´è€—å°½ï¼Œæœªç¡®å®šé‚»å±…æ˜¯å¦å¯è¾¾ã€‚ Delayï¼ˆå»¶è¿ŸçŠ¶æ€ï¼‰ï¼šè¡¨â½°æœªç¡®å®šé‚»å±…æ˜¯å¦å¯è¾¾ã€‚Delay çŠ¶æ€ä¸æ˜¯â¼€ä¸ªç¨³å®šçš„çŠ¶æ€ï¼Œâ½½æ˜¯â¼€ä¸ªå»¶æ—¶ç­‰å¾…çŠ¶æ€ã€‚ Probe ï¼ˆæ¢æµ‹çŠ¶æ€ï¼‰ï¼šèŠ‚ç‚¹ä¼šå‘å¤„äº Probe çŠ¶æ€çš„é‚»å±…æŒç»­å‘é€ NS æŠ¥â½‚ã€‚ ä¸åŒçŠ¶æ€ä¹‹é—´è¿ç§»å¦‚ä¸‹å›¾ 1 2 ip neigh ip -6 neigh ","date":"2025-08-15T19:58:16+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/ipv6-%E5%9C%B0%E5%9D%80%E5%88%86%E9%85%8D%E8%AF%A6%E8%A7%A3/","title":"IPv6 åœ°å€åˆ†é…è¯¦è§£"},{"content":"ä¸€èˆ¬æƒ…å†µä¸‹å¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨å…¶ä»–æ–‡ä»¶çš„å‡½æ•°æ—¶ï¼Œå¸¸è§„æ“ä½œæ˜¯å°†è¯¥å‡½æ•°åœ¨å¤´æ–‡ä»¶ä¸­å£°æ˜ï¼Œç„¶ååœ¨éœ€è¦ä½¿ç”¨çš„æ–‡ä»¶é‡Œå¼•ç”¨è¿™ä¸ªå¤´æ–‡ä»¶ ä½†è‹¥æ˜¯æ²¡å£°æ˜å‘¢ï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 11.c #include \u0026lt;stdio.h\u0026gt; extern char* b; int main() { printf(\u0026#34;aaa--d:%x----%s--p\\n\u0026#34;, aaa(),b,b); char*p = aaa(); printf(\u0026#34;p = %p\\n\u0026#34;, p); if(p) printf(\u0026#34;---\\n\u0026#34;); printf(\u0026#34;value = %s\\n\u0026#34;ï¼Œp);// å´©æºƒ! return 0; } 2.c char *b=\u0026#34;aaa\u0026#34;; char* aaa(){ return b;} 1 2 3 4 5 6 7 8 9 10 11 12 13 gcc 11.c 2.c -o test 11.c: In function â€˜main\u0026#39; 11.c:4:37: warning:: implicit declaration of function â€˜aaa\u0026#39;[-Wimplicit-function-declaration] 4| printf(\u0026#34;aaa--d:%x----%s--%p\\n\u0026#34;,aaa(),b,b); | ^~~ 11.c:5:15: warning:ï¼š initialization of â€˜char *â€™ fromnâ€˜int\u0026#39; makes pointer from integer without a cast [-Wint-conversion] 5| char *p = aaa(); | ^~~ ./test aaa--d:4b1c032----aaaa--0x560604b1c032 p=0x4b1c032 --- Segmentation fault (core dumped) è¿™é‡Œå¹¶æ²¡æœ‰å¼•ç”¨è¿™ä¸ªå¤´æ–‡ä»¶ï¼Œä¸ºä»€ä¹ˆä¾ç„¶å¯ä»¥ä½¿ç”¨å‘¢ï¼Ÿ\nè¿™å°±å¼•å‡ºäº†ä¸€ä¸ªæ¦‚å¿µï¼šéšå¼å£°æ˜ã€‚\nç®€å•æ¥è®²å°±æ˜¯å½“å‰æ–‡ä»¶ä½¿ç”¨æ²¡æœ‰å£°æ˜çš„å‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å£°æ˜ä¸€ä¸ªï¼Œä½†è¿”å›å€¼æ˜¯intç±»å‹\né‚£ä¸ºä»€ä¹ˆä¼šå‡ºç°æ®µé”™è¯¯å‘¢? ä¸Šé¢ç¼–è¯‘è¿è¡Œçš„ç¯å¢ƒæ˜¯64bitçš„:\nchar* aaa() è¿”å›çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆ8B(64bit) ä½†æ˜¯åœ¨ç¼–è¯‘æ—¶ å·²ç»ç¡®å®šäº†æ˜¯è¿”å›å€¼ç±»å‹(ç”±äºæ˜¯éšå¼å£°å,ç¼–è¯‘å™¨é»˜è®¤æ˜¯int) æ˜¯int 4B(32bit) ,æ‰€ä»¥å°±ä¼šæŠŠæŒ‡é’ˆçš„ä½32bit å–å‡ºæ¥ èµ‹ç»™char* *p æŒ‡é’ˆp çš„å€¼å°±æ˜¯ä¸€ä¸ªæˆªæ–­çš„å€¼, è¿™ä¸ªæŒ‡é’ˆå°±å˜æˆäº†ä¸€ä¸ªéæ³•çš„äº†,å¦‚æœå–è®¿é—®å…¶æŒ‡å‘çš„å†…å­˜,å°±ä¼šå‡ºç° æ®µé”™è¯¯.\nå¦‚æœæ˜¯32bit ç¯å¢ƒå‘¢\nint æ˜¯4B æŒ‡é’ˆä¹Ÿæ˜¯4B ,æŒ‡é’ˆä¸ä¼šè¢«æˆªæ–­,è¿˜æ˜¯åŸæ¥çš„å€¼,ä¸ä¼šå‡ºç°éæ³•è®¿é—®.\nå¦‚ä½•é¿å…å‘¢: åœ¨Makefile é‡ŒåŠ ä¸Š -Wall -Werror ,ç¼–è¯‘æ—¶ä¼šæ£€æµ‹å‡ºè¿™ç§é”™è¯¯\n","date":"2025-08-15T16:22:16+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/implicit-function-declaration/","title":"implicit-function-declaration"},{"content":"ä»€ä¹ˆæ˜¯è™šæ‹Ÿç½‘å¡ï¼Ÿ è™šæ‹Ÿç½‘å¡æ˜¯è½¯ä»¶å®ç°çš„ç½‘ç»œæ¥å£ï¼Œä¸ç‰©ç†ç½‘å¡ä¸åŒï¼Œå®ƒæ²¡æœ‰ç‰©ç†ç¡¬ä»¶ï¼Œåªå­˜åœ¨äºæ“ä½œç³»ç»Ÿçš„å†…å­˜ä¸­ã€‚è™šæ‹Ÿç½‘å¡å¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿç½‘ç»œç¯å¢ƒï¼Œè¿›è¡Œæ•°æ®åŒ…çš„æ•è·ã€åˆ†æå’Œå¤„ç†ã€‚ TUN å’Œ TAP çš„åŸºæœ¬æ¦‚å¿µ Tun ï¼ˆNetwork TUNnelï¼‰ TUN æ˜¯ä¸‰å±‚ï¼ˆç½‘ç»œå±‚ï¼‰çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œä¸»è¦ç”¨äº IP æ•°æ®åŒ…çš„å¤„ç†ã€‚TUN è®¾å¤‡ä¼šæ¨¡æ‹Ÿä¸€ä¸ªç½‘ç»œå±‚æ¥å£ï¼Œæ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¼šè¢«ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´çš„ç¨‹åºè¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œçš„æ•°æ®åŒ…ä¼šè¢«å‘é€å›å†…æ ¸ç½‘ç»œæ ˆã€‚\nTAPï¼ˆNetwork TAPï¼‰ TAP æ˜¯äºŒå±‚ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼‰çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œä¸»è¦ç”¨äºä»¥å¤ªç½‘å¸§çš„å¤„ç†ã€‚TAP è®¾å¤‡å¯ä»¥æ¨¡æ‹Ÿä¸€ä¸ªä»¥å¤ªç½‘æ¥å£ï¼Œèƒ½å¤Ÿæ¥æ”¶å’Œå‘é€åŸå§‹çš„ä»¥å¤ªç½‘å¸§ã€‚è¿™ä½¿å¾— TAP è®¾å¤‡éå¸¸é€‚åˆç”¨äºæ¡¥æ¥ä¸åŒçš„ç½‘ç»œç¯å¢ƒï¼Œæˆ–è€…åœ¨è™šæ‹Ÿæœºä¸­æ¨¡æ‹Ÿç‰©ç†ç½‘å¡ã€‚TAPæ˜¯æ•°æ®é“¾è·¯å±‚çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ã€‚\nTunå’ŒTapçš„å¼‚åŒ Tunæ˜¯ä¸‰å±‚çš„è®¾å¤‡ï¼Œè¯¥è®¾å¤‡æ²¡æœ‰MACåœ°å€ï¼Œä»å­—ç¬¦è®¾å¤‡ä¸Šè¯»å–IPæ•°æ®åŒ…ï¼Œå†™å…¥çš„ä¹Ÿæ˜¯IPæ•°æ®åŒ…ï¼Œå› æ­¤ä¸èƒ½è¿›è¡ŒäºŒå±‚çš„æ“ä½œï¼Œä¾‹å¦‚å‘ARPåŒ…å’Œä»¥å¤ªç½‘å¹¿æ’­ Tabæ˜¯äºŒå±‚çš„è®¾å¤‡ï¼Œè¯¥è®¾å¤‡æœ‰MACåœ°å€ï¼Œå¤„ç†çš„æ˜¯æ•°æ®é“¾è·¯å±‚çš„æ•°æ®å¸§ï¼Œä»å­—ç¬¦è®¾å¤‡ä¸Šè¯»å–çš„æ˜¯æ•°æ®é“¾è·¯å±‚çš„æ•°æ®å¸§ï¼Œå†™å…¥çš„ä¹Ÿæ˜¯æ•°æ®ã€‚\nåœ¨ä½¿ç”¨ä¸Šé¢ï¼Œä¸¤è€…éƒ½æ˜¯é€šè¿‡å­—ç¬¦è®¾å¤‡çš„æ–¹å¼è¿›è¡Œè¯»å–å’Œå†™å…¥ï¼ŒTunæ˜¯ä¸‰å±‚ç½‘ç»œè®¾å¤‡ï¼Œè€ŒTabæ˜¯äºŒå±‚ç½‘ç»œè®¾å¤‡ï¼ŒTunå¸¸ç”¨äºVPNç­‰æŠ€æœ¯ï¼Œç”±äºå·¥ä½œåœ¨IPå±‚ï¼Œæ— æ³•ä¸ç‰©ç†ç½‘å¡åšbridgeï¼Œä½†å¯ä»¥é€šè¿‡ä¸‰å±‚äº¤æ¢ï¼ˆå¦‚ ip_forwardï¼‰ä¸ç‰©ç†ç½‘å¡è¿é€šï¼ŒTabè®¾å¤‡å·¥ä½œåœ¨ç¬¬äºŒå±‚ï¼Œæ”¶å‘çš„æ˜¯MACå±‚æ•°æ®åŒ…ï¼Œæ‹¥æœ‰MACå±‚çš„åŠŸèƒ½ï¼Œå¯ä»¥ä¸ç‰©ç†ç½‘å¡åšbridgeï¼Œæ”¯æŒMACå±‚å¹¿æ’­ Tunå’ŒTapåº”ç”¨åœºæ™¯ Tunæ˜¯ä¸€ä¸ªç½‘ç»œå±‚è®¾å¤‡ï¼Œæ”¯æŒç‚¹åˆ°ç‚¹çš„ç½‘ç»œé€šä¿¡ï¼Œå¸¸ç”¨äºtunneléš§é“å’ŒVPNçš„æ„å»ºï¼ŒtunnelæŠ€æœ¯æ˜¯ç½‘ç»œè®¾å¤‡æŠŠç½‘ç»œå±‚æ•°æ®åŒ…å°è£…åˆ°å¦ä¸€ä¸ªåè®®ä¸­ä»¥è·¨è¿‡ç½‘ç»œä¼ é€åˆ°å¦ä¸€ä¸ªç½‘ç»œè®¾å¤‡çš„å¤„ç†è¿‡ç¨‹ï¼Œä¸»è¦ç”¨äºå…¬ç½‘ä¸»æœºå’Œç§æœ‰ç½‘ç»œäº’è”äº’é€šã€‚åœ¨Linuxç³»ç»Ÿä¸­æ”¯æŒå¤šç§éš§é“æŠ€æœ¯ï¼Œå…¶åº•å±‚å®ç°åŸç†éƒ½æ˜¯åŸºäºTunè®¾å¤‡ã€‚ TAPæ¥å£çš„å…¸å‹åº”ç”¨åœºæ™¯æ˜¯åœ¨è™šæ‹ŸåŒ–ç½‘ç»œä¸­ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬é€šè¿‡KVMåˆ›å»ºçš„å¤šä¸ªVMï¼ˆè™šæ‹Ÿæœºï¼‰ï¼Œä»¥LinuxBridgeï¼ˆæ¡¥æ¥ç½‘ç»œï¼‰äº’é€šï¼›å®é™…ä¸Šå³æ˜¯é€šè¿‡åƒvnet0è¿™æ ·çš„TAPæ¥å£æ¥æ¥å…¥LinuxBridgeçš„ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼ŒKVMç¨‹åºå°±æ˜¯å‘TAPæ¥å£è¯»å†™æ•°æ®çš„ç”¨æˆ·ç©ºé—´ç¨‹åºã€‚å½“VM0å‘æœ¬æœºçš„eth0æ¥å£å‘é€æ•°æ®ï¼ŒKVMä¼šå°†æ•°æ®å‘é€åˆ°TAPæ¥å£vnet0ï¼Œå†é€šè¿‡LinuxBridgeå°†æ•°æ®è½¬å‘åˆ°vnet1ä¸Šã€‚ç„¶åï¼ŒKVMå°†æ•°æ®å‘é€åˆ°VM1çš„eth0å£ã€‚ Tun é…ç½® 1 2 3 4 5 6 7 8 \\# åˆ›å»ºç½‘å¡å¹¶é…ç½®IP ip tuntap add dev tun0 mode tun ip link set dev tun0 up ip addr add 10.0.0.1/24 dev tun0 ip route add 10.0.0.0/24 via 10.0.0.1 \\# æ¸…é™¤ç½‘å¡ ip link set dev tun0 down ip tuntap del dev tun0 mode tun è½¬è½½è‡ª\nLinuxè™šæ‹Ÿç½‘å¡TUNå’ŒTAP - å¿ƒè‹¥å‘é˜³èŠ±è‡ªå¼€ - åšå®¢å›­\nå‚è€ƒèµ„æ–™ Universal TUN/TAP device driver Universal TUN/TAP device driver Frequently Asked Question Tun/Tap interface tutorial A simplistic, simple-minded, naive tunnelling program using tun/tap interfaces and TCP ","date":"2025-08-07T15:17:36+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/linux%E8%99%9A%E6%8B%9F%E7%BD%91%E5%8D%A1tun%E5%92%8Ctap/","title":"Linuxè™šæ‹Ÿç½‘å¡TUNå’ŒTAP"},{"content":"ä½œä¸šæ§åˆ¶ (Job Control) ä½œä¸šæ§åˆ¶æ˜¯å¤§å¤šæ•° shell æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·åœ¨å•ä¸ªç»ˆç«¯ä¸ŠåŒæ—¶è¿è¡Œå’Œç®¡ç†å¤šä¸ªå‘½ä»¤ï¼ˆä½œä¸šï¼‰ã€‚\nå‰å°ä½œä¸š (Foreground Job): åœ¨ç»ˆç«¯ä¸­å¯åŠ¨ï¼Œå®ƒä¼šç‹¬å ç»ˆç«¯çš„è¾“å…¥å’Œè¾“å‡ºã€‚åœ¨å®ƒè¿è¡ŒæœŸé—´ï¼Œshell ä¼šè¢«æŒ‚èµ·ï¼Œç­‰å¾…è¯¥ä½œä¸šå®Œæˆã€‚\nåå°ä½œä¸š (Background Job): é€šè¿‡åœ¨å‘½ä»¤åæ·»åŠ  \u0026amp; ç¬¦å·å¯åŠ¨ã€‚å®ƒä¸ä¼šå ç”¨ç»ˆç«¯ï¼Œä½ å¯ä»¥åœ¨å®ƒè¿è¡Œæ—¶ç»§ç»­åœ¨ shell ä¸­è¾“å…¥å…¶ä»–å‘½ä»¤ã€‚\nCtrl+Z(SIGTSTPï¼‰æš‚åœå‰å°è¿›ç¨‹Ctrl+C(SIGINTï¼‰ç»ˆæ­¢å½“å‰å‰å°è¿›ç¨‹Ctrl+Dï¼ˆEOFï¼‰\nå¸¸ç”¨å‘½ä»¤: jobs, fg, bg, kill %\u0026lt;job_id\u0026gt;ã€‚\nè¿›ç¨‹ç»„ (Process Group) è¿›ç¨‹ç»„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹çš„é›†åˆã€‚ç³»ç»Ÿä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½å±äºä¸€ä¸ªè¿›ç¨‹ç»„ã€‚\nç›®çš„: ä¸»è¦ç”¨äºä½œä¸šæ§åˆ¶ï¼Œæ–¹ä¾¿å°†ä¿¡å·ï¼ˆå¦‚ SIGINT, SIGTSTPï¼‰å‘é€åˆ°ä¸€ç»„ç›¸å…³çš„è¿›ç¨‹ã€‚ä¾‹å¦‚ï¼Œå½“ä½ åœ¨ç»ˆç«¯æŒ‰ä¸‹ Ctrl+C æ—¶ï¼ŒSIGINT ä¿¡å·ä¼šè¢«å‘é€åˆ°å½“å‰å‰å°ä½œä¸šçš„æ•´ä¸ªè¿›ç¨‹ç»„ã€‚\nè¿›ç¨‹ç»„ID (PGID): æ¯ä¸ªè¿›ç¨‹ç»„éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDã€‚\nè¿›ç¨‹ç»„é¢†å¯¼ (Process Group Leader): è¿›ç¨‹ç»„ä¸­ç¬¬ä¸€ä¸ªåˆ›å»ºçš„è¿›ç¨‹ï¼Œå…¶ PID é€šå¸¸å°±æ˜¯è¯¥è¿›ç¨‹ç»„çš„ PGIDã€‚\nä¸€ä¸ªç®¡é“ï¼ˆpipelineï¼‰ä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼ˆä¾‹å¦‚ cat file | grep \u0026quot;text\u0026quot; | wc -lï¼‰é€šå¸¸å±äºåŒä¸€ä¸ªè¿›ç¨‹ç»„ã€‚\nä¼šè¯ (Session) ä¼šè¯æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ç»„çš„é›†åˆã€‚å®ƒæä¾›äº†ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„è¿›ç¨‹ç»„ç»‡æ–¹å¼ã€‚\nç›®çš„: å°†ä¸€ä¸ªç”¨æˆ·ç™»å½•åˆ°é€€å‡ºæœŸé—´åˆ›å»ºçš„æ‰€æœ‰è¿›ç¨‹ç»„ç»‡åœ¨ä¸€èµ·ã€‚\nä¼šè¯ID (SID): æ¯ä¸ªä¼šè¯éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDã€‚\nä¼šè¯é¢†å¯¼ (Session Leader): åˆ›å»ºè¯¥ä¼šè¯çš„è¿›ç¨‹ã€‚é€šå¸¸ï¼Œè¿™æ˜¯ç”¨æˆ·ç™»å½•æ—¶å¯åŠ¨çš„ shell è¿›ç¨‹ã€‚\næ§åˆ¶ç»ˆç«¯ (Controlling Terminal): ä¸€ä¸ªä¼šè¯é€šå¸¸ä¸ä¸€ä¸ªæ§åˆ¶ç»ˆç«¯ç›¸å…³è”ã€‚å½“æ§åˆ¶ç»ˆç«¯æ–­å¼€è¿æ¥æ—¶ï¼ˆä¾‹å¦‚å…³é—­ç»ˆç«¯çª—å£æˆ–ç½‘ç»œæ–­å¼€ï¼‰ï¼Œå†…æ ¸ä¼šå‘ä¼šè¯é¢†å¯¼å‘é€ SIGHUP ä¿¡å·ï¼Œåè€…é€šå¸¸ä¼šå°†å…¶ä¼ æ’­ç»™ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œå¯¼è‡´å®ƒä»¬ç»ˆæ­¢ã€‚\nsetsid() ç³»ç»Ÿè°ƒç”¨ setsid() æ˜¯ä¸€ä¸ªå…³é”®çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ã€‚\nåŠŸèƒ½: 1. è°ƒç”¨ setsid() çš„è¿›ç¨‹ä¼šæˆä¸ºä¸€ä¸ªæ–°ä¼šè¯çš„ä¼šè¯é¢†å¯¼ã€‚\n2. è¯¥è¿›ç¨‹ä¼šæˆä¸ºä¸€ä¸ªæ–°è¿›ç¨‹ç»„çš„è¿›ç¨‹ç»„é¢†å¯¼ã€‚\n3. è¯¥è¿›ç¨‹ä¼šè„±ç¦»å®ƒä¹‹å‰çš„æ§åˆ¶ç»ˆç«¯ã€‚\nå‰æ: è°ƒç”¨ setsid() çš„è¿›ç¨‹ä¸èƒ½æ˜¯æŸä¸ªç°æœ‰è¿›ç¨‹ç»„çš„é¢†å¯¼è€…ã€‚ä¸ºäº†ç¡®ä¿è¿™ä¸€ç‚¹ï¼Œé€šå¸¸çš„åšæ³•æ˜¯ fork() ä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åè®©çˆ¶è¿›ç¨‹é€€å‡ºï¼Œå­è¿›ç¨‹å†è°ƒç”¨ setsid()ã€‚\nç”¨é€”: è¿™æ˜¯åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemonï¼‰çš„æ ‡å‡†æ–¹æ³•ã€‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ²¡æœ‰æ§åˆ¶ç»ˆç«¯çš„æ–°ä¼šhsè¯ï¼Œå®ˆæŠ¤è¿›ç¨‹å¯ä»¥ç¡®ä¿è‡ªå·±ä¸ä¼šå› ä¸ºç»ˆç«¯çš„å…³é—­è€Œæ„å¤–ç»ˆæ­¢ã€‚\nlxc-attach åå°è¿›ç¨‹å¯¼è‡´é€€å‡ºå¡ä½çš„åŸå› åˆ†æ é—®é¢˜åœºæ™¯ ç”¨æˆ·åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ lxc-attach \u0026lt;container_name\u0026gt;ã€‚\nåœ¨ lxc-attach åˆ›å»ºçš„ shell ä¸­ï¼Œå¯åŠ¨ä¸€ä¸ªåå°ä½œä¸šã€‚\nè¾“å…¥ exit å°è¯•é€€å‡º lxc-attach çš„ shellã€‚\næ­¤æ—¶ï¼Œç»ˆç«¯å¡ä½ï¼Œç”¨telnet è¿æ¥ç„¶åkill æ‰æ‰å¯ä»¥å›åˆ°host ä¸»æœºçš„shell\nåŸå› å‰–æ è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒåœ¨äºè¿›ç¨‹å…³ç³»å’Œä¿¡å·å¤„ç†ã€‚\nè¿›ç¨‹ç»“æ„: - å½“ä½ è¿è¡Œ lxc-attach æ—¶ï¼Œå®ƒä¼šåœ¨å®¹å™¨å†…å¯åŠ¨ä¸€ä¸ªæ–°çš„ shell è¿›ç¨‹ï¼ˆå¦‚ bashï¼‰ã€‚\n- è¿™ä¸ªæ–°çš„ shell æ˜¯ lxc-attach è¿›ç¨‹çš„å­è¿›ç¨‹ã€‚\n- é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæ–° shell æ²¡æœ‰æˆä¸ºæ–°çš„ä¼šè¯é¢†å¯¼ã€‚å®ƒä¸ lxc-attach è¿›ç¨‹ã€ä»¥åŠä½ æœ€åˆçš„ç™»å½• shell ä½äºåŒä¸€ä¸ªä¼šè¯ä¸­ï¼Œå¹¶å…±äº«åŒä¸€ä¸ªæ§åˆ¶ç»ˆç«¯ã€‚\nå¯åŠ¨åå°è¿›ç¨‹: - å½“ä½ åœ¨ lxc-attach çš„ shell ä¸­è¿è¡Œä¸€ä¸ªåå°è¿›ç¨‹ã€‚\n- è¿™ä¸ª åå°è¿›ç¨‹ä¸ lxc-attach çš„ shell å±äºåŒä¸€ä¸ªè¿›ç¨‹ç»„ã€‚\næ‰§è¡Œ exit: - ä½ è¾“å…¥ exitï¼Œlxc-attach çš„ shell è¿›ç¨‹å¼€å§‹é€€å‡ºæµç¨‹ã€‚\n- shell è¿›ç¨‹æœ¬èº«ä¼šç»ˆæ­¢ã€‚\n- lxc-attach è¿›ç¨‹åœ¨ç­‰å¾…å…¶å­è¿›ç¨‹ï¼ˆå³é‚£ä¸ª shellï¼‰å®Œå…¨ç»ˆæ­¢ã€‚\nå¡ä½çš„æ ¹æº: - shell è¿›ç¨‹è™½ç„¶ç»ˆæ­¢äº†ï¼Œä½†å®ƒå¯åŠ¨çš„åå°è¿›ç¨‹ä»ç„¶åœ¨è¿è¡Œã€‚\n- è¿™ä¸ªåå°è¿›ç¨‹ä»ç„¶æ˜¯å‰å°è¿›ç¨‹ç»„çš„ä¸€éƒ¨åˆ†ï¼ˆç›¸å¯¹äºæ§åˆ¶ç»ˆç«¯è€Œè¨€ï¼‰ï¼Œæˆ–è€…è¯´å®ƒä»ç„¶ä¸æ§åˆ¶ç»ˆç«¯å…³è”ã€‚\n- æ§åˆ¶ç»ˆç«¯çš„é©±åŠ¨ç¨‹åºä¼šå‘ç°ï¼Œè™½ç„¶å‰å°çš„ shell é€€å‡ºäº†ï¼Œä½†è¯¥è¿›ç¨‹ç»„é‡Œè¿˜æœ‰å…¶ä»–è¿›ç¨‹ åœ¨è¿è¡Œã€‚æ­¤æ—¶ï¼Œç»ˆç«¯ä¼šå¤„äºä¸€ç§â€œæŒ‚èµ·â€æˆ–â€œç­‰å¾…â€çŠ¶æ€ï¼Œå› ä¸ºå®ƒéœ€è¦å¤„ç†è¿™ä¸ªä»åœ¨è¿è¡Œçš„åå°è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥/è¾“å‡ºï¼ˆå³ä½¿å®ƒä¸è¯»å†™ï¼‰ã€‚\n- lxc-attach è¿›ç¨‹æœ¬èº«ä¹Ÿåœ¨ç­‰å¾…ï¼Œå› ä¸ºå®ƒå¯èƒ½éœ€è¦æ¸…ç†ä¸å­è¿›ç¨‹ç›¸å…³çš„æ‰€æœ‰èµ„æºã€‚åªè¦ è¿™ä¸ªåå°è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œæ•´ä¸ªè¿›ç¨‹é“¾å°±æ— æ³•å¹²å‡€åœ°ç»“æŸã€‚\n- åªæœ‰å½“ è¿™ä¸ªåå°è¿›ç¨‹ç»“æŸåï¼Œæ•´ä¸ªè¿›ç¨‹ç»„æ‰ç®—å®Œå…¨ç»ˆç»“ï¼Œæ§åˆ¶ç»ˆç«¯çš„é”å®šçŠ¶æ€è¢«è§£é™¤ï¼Œlxc-attach è¿›ç¨‹ä¹Ÿéšä¹‹é€€å‡ºï¼Œä½ æ‰èƒ½å›åˆ°åŸæ¥çš„ shell æç¤ºç¬¦ã€‚\nè§£å†³åŠæ³•: nohup setsid disown\nå‚è€ƒé“¾æ¥ Linux sessionå’Œè¿›ç¨‹ç»„æ¦‚è¿° - Linuxç¨‹åºå‘˜ - SegmentFault æ€å¦\nLinux TTY/PTSæ¦‚è¿° - Linuxç¨‹åºå‘˜ - SegmentFault æ€å¦\n","date":"2025-08-06T15:36:36+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/linux-%E4%BD%9C%E4%B8%9A%E6%8E%A7%E5%88%B6%E8%BF%9B%E7%A8%8B%E7%BB%84%E5%92%8C%E4%BC%9A%E8%AF%9D/","title":"Linux ä½œä¸šæ§åˆ¶ã€è¿›ç¨‹ç»„å’Œä¼šè¯"},{"content":"frok ä¸€ä¸ªè¿è¡Œçš„è¿›ç¨‹,å®ƒè°ƒç”¨äº†fork()å‡½æ•°ï¼Œç„¶åå°±äº§ç”Ÿäº†å­è¿›ç¨‹ï¼ŒåŸæ¥çš„è¿›ç¨‹å«çˆ¶è¿›ç¨‹ã€‚è¿™ä¸ªå­è¿›ç¨‹ä¹Ÿæ˜¯è¿›ç¨‹ï¼Œä½†å‡¡æ˜¯è¿›ç¨‹ï¼Œéƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆè®©æ¯ä¸ªè¿›ç¨‹è‡ªå·±çœ‹èµ·æ¥æ˜¯ç‹¬å å†…å­˜ï¼Œé€šè¿‡æ®µé¡µå†…å­˜ç®¡ç†æ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†åœ°å€ç©ºé—´ï¼‰ã€‚è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯ä»0åˆ°4Gçš„å¤§å°ï¼Œå…¶ä¸­3-4Gæ˜¯å±äºå†…æ ¸çš„ï¼ˆ32ä½ç³»ç»Ÿï¼‰ã€‚åˆ›å»ºå®Œå­è¿›ç¨‹åï¼Œçˆ¶è¿›ç¨‹ç»§ç»­è¿è¡Œç¨‹åºï¼ˆå³åŸæ¥çš„è¿›ç¨‹ï¼‰çš„ä»£ç ï¼Œåˆšåˆ›å»ºå‡ºæ¥çš„å­è¿›ç¨‹æ‹¥æœ‰å’Œçˆ¶è¿›ç¨‹å®Œå…¨ä¸€æ ·çš„ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œä¹Ÿå°±æ˜¯è¯´å®Œå®Œå…¨å…¨æ‹·è´äº†ä¸€ä»½çˆ¶è¿›ç¨‹ï¼Œå’Œçˆ¶è¿›ç¨‹å®Œå…¨ä¸€æ ·ã€‚å³cloneçˆ¶è¿›ç¨‹0-3Gçš„å†…å®¹ï¼Œè€Œ3-4Gçš„kernelåªéœ€è¦é‡æ–°æ˜ å°„ä¸€ä¸‹åˆ°ç‰©ç†åœ°å€çš„kernelå³å¯ã€‚ä½†æ˜¯æ“ä½œç³»ç»Ÿè¦å¦‚ä½•åŒºåˆ†è¿™ä¸¤ä¸ªè¿›ç¨‹å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯è¿›ç¨‹IDå³pidã€‚pidæ˜¯å­˜å‚¨åœ¨PCBå½“ä¸­çš„ç±»ä¼¼èº«ä»½è¯çš„ä¸œè¥¿. kernelä¼šåˆ›å»ºå­è¿›ç¨‹è‡ªå·±çš„PCB,ç„¶åcloneçˆ¶è¿›ç¨‹çš„PCB(task_struct)çš„ç»å¤§éƒ¨åˆ†ä¿¡æ¯ï¼Œå¦‚å†…å­˜æ˜ å°„(mm_structï¼Œé‡‡ç”¨Â COW æœºåˆ¶copy on write),æ–‡ä»¶æè¿°ç¬¦è¡¨,è°ƒåº¦ä¿¡æ¯ï¼ˆä¼˜å…ˆçº§ã€CPU æ—¶é—´ç­‰ï¼‰,ä½†æŸäº›å…³é”®å­—æ®µä¼šè¢«ä¿®æ”¹,å¦‚pid,ppidç­‰.\nkernelä¼šè®¾ç½® fork() çš„è¿”å›å€¼.åœ¨å­è¿›ç¨‹çš„ task_struct ä¸­ï¼Œkernelä¼šé¢„å…ˆè®¾ç½® eax/rax å¯„å­˜å™¨ï¼ˆå­˜å‚¨è¿”å›å€¼ï¼‰ä¸º 0ï¼Œå› æ­¤å­è¿›ç¨‹çœ‹åˆ°çš„ fork() è¿”å› 0ã€‚çˆ¶è¿›ç¨‹çš„ fork() è¿”å›å­è¿›ç¨‹çš„ pidã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; int q_val = 100; int main() { printf(\u0026#34;father is running, pid: %d, ppid: %d\\n\u0026#34;, getpid(), getppid()); sleep(2); pid_t id = fork(); int cnt = 3; while(1) { if(id == 0) { // Child process printf(\u0026#34;I am child process, pid: %d, ppid: %d, q_val: %d, \u0026amp;q_val: %p\\n\u0026#34;, getpid(), getppid(), q_val, \u0026amp;q_val); sleep(1); cnt--; if(cnt == 0) { q_val = 300; printf(\u0026#34;I am child, q_val is changed, 100 -\u0026gt; 300\\n\u0026#34;); } } else { // Parent process printf(\u0026#34;I am father process, pid: %d, ppid: %d, q_val: %d, \u0026amp;q_val: %p\\n\u0026#34;, getpid(), getppid(), q_val, \u0026amp;q_val); sleep(1); } } return 0; } forkåº•å±‚æ˜¯è°ƒç”¨äº†å†…æ ¸çš„å‡½æ•°æ¥å®ç°forkçš„åŠŸèƒ½çš„ï¼Œå³å…ˆcreate()å…ˆåˆ›å»ºè¿›ç¨‹ï¼Œæ­¤æ—¶è¿›ç¨‹å†…å®¹ä¸ºç©ºï¼Œç„¶åclone()å¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å®¹åˆ°å­è¿›ç¨‹ä¸­ï¼Œæ­¤æ—¶å­è¿›ç¨‹å°±è¯ç”Ÿäº†ï¼Œæ¥ç€çˆ¶è¿›ç¨‹å°±returnè¿”å›äº†ã€‚è€Œå­è¿›ç¨‹è¯ç”Ÿåï¼Œæ˜¯ç›´æ¥è¿è¡Œreturnè¿”å›çš„ï¼Œç„¶åæ¥ç€æ‰§è¡Œåé¢çš„ç¨‹åºï¼Œè¿™é‡Œæ³¨æ„ï¼šå­è¿›ç¨‹æ˜¯ä¸ä¼šæ‰§è¡Œå‰é¢çˆ¶è¿›ç¨‹å·²ç»æ‰§è¡Œè¿‡çš„ç¨‹åºäº†å¾—ï¼Œå› ä¸ºPCBä¸­è®°å½•äº†å½“å‰è¿›ç¨‹è¿è¡Œåˆ°å“ªé‡Œï¼Œè€Œå­è¿›ç¨‹åˆæ˜¯å®Œå…¨æ‹·è´è¿‡æ¥çš„ï¼Œæ‰€ä»¥PCBçš„ç¨‹åºè®¡æ•°å™¨ä¹Ÿæ˜¯å’Œçˆ¶è¿›ç¨‹ç›¸åŒçš„ï¼Œæ‰€ä»¥æ˜¯ä»fork()åé¢çš„ç¨‹åºç»§ç»­æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 father is running, pid: 2193928, ppid: 784260 I am father process, pid: 2193928, ppid: 784260, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am child process, pid: 2193930, ppid: 2193928, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am father process, pid: 2193928, ppid: 784260, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am child process, pid: 2193930, ppid: 2193928, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am father process, pid: 2193928, ppid: 784260, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am child process, pid: 2193930, ppid: 2193928, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am father process, pid: 2193928, ppid: 784260, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am child process, pid: 2193930, ppid: 2193928, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am father process, pid: 2193928, ppid: 784260, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am child, q_val is changed, 100 -\u0026gt; 300 I am child process, pid: 2193930, ppid: 2193928, q_val: 300, \u0026amp;q_val: 0x55e878c7f010 I am father process, pid: 2193928, ppid: 784260, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am child process, pid: 2193930, ppid: 2193928, q_val: 300, \u0026amp;q_val: 0x55e878c7f010 I am father process, pid: 2193928, ppid: 784260, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am child process, pid: 2193930, ppid: 2193928, q_val: 300, \u0026amp;q_val: 0x55e878c7f010 I am father process, pid: 2193928, ppid: 784260, q_val: 100, \u0026amp;q_val: 0x55e878c7f010 I am child process, pid execæ— ç”¨forkåˆ›å»ºå­è¿›ç¨‹åæ‰§è¡Œçš„æ˜¯å’Œçˆ¶è¿›ç¨‹ç›¸åŒçš„ç¨‹åºï¼ˆä½†æœ‰å¯èƒ½æ‰§è¡Œä¸åŒçš„ä»£ç åˆ†æ”¯ï¼‰ï¼Œ å­è¿›ç¨‹å¾€å¾€è¦è°ƒç”¨ä¸€ç§execå‡½æ•°ä»¥æ‰§è¡Œå¦ä¸€ä¸ªç¨‹åºã€‚å½“è¿›ç¨‹è°ƒç”¨ä¸€ç§execå‡½æ•°æ—¶ï¼Œè¯¥è¿›ç¨‹çš„ ç”¨æˆ·ç©ºé—´ä»£ç å’Œæ•°æ®å®Œå…¨è¢«æ–°ç¨‹åºæ›¿æ¢ï¼Œä»æ–°ç¨‹åºçš„å¯åŠ¨ä¾‹ç¨‹å¼€å§‹æ‰§è¡Œã€‚è°ƒç”¨execå¹¶ä¸åˆ›å»º æ–°è¿›ç¨‹ï¼Œæ‰€ä»¥è°ƒç”¨execå‰åè¯¥è¿›ç¨‹çš„idå¹¶æœªæ”¹å˜\n1 2 3 4 5 6 7 #include int execl(const char *path, const char *arg, ...); int execlp(const char *file, const char *arg, ...); int execle(const char *path, const char *arg, ..., char *const envp[]); int execv(const char *path, char *const argv[]); int execvp(const char *file, char *const argv[]); int execve(const char *path, char *const argv[], char *const envp[]); è¿™äº›å‡½æ•°å¦‚æœè°ƒç”¨æˆåŠŸåˆ™åŠ è½½æ–°çš„ç¨‹åºä»å¯åŠ¨ä»£ç å¼€å§‹æ‰§è¡Œï¼Œä¸å†è¿”å›ï¼Œå¦‚æœè°ƒç”¨å‡ºé”™ åˆ™è¿”å›-1ï¼Œæ‰€ä»¥execå‡½æ•°åªæœ‰å‡ºé”™çš„è¿”å›å€¼è€Œæ²¡æœ‰æˆåŠŸçš„è¿”å›å€¼\nwait/waitpid åƒµå°¸è¿›ç¨‹: å­è¿›ç¨‹é€€å‡ºï¼Œçˆ¶è¿›ç¨‹æ²¡æœ‰å›æ”¶å­è¿›ç¨‹èµ„æºï¼ˆPCBï¼‰ï¼Œåˆ™å­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹ å­¤å„¿è¿›ç¨‹: çˆ¶è¿›ç¨‹å…ˆäºå­è¿›ç¨‹ç»“æŸï¼Œåˆ™å­è¿›ç¨‹æˆä¸ºå­¤å„¿è¿›ç¨‹,å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æˆä¸º1å· è¿›ç¨‹initè¿›ç¨‹ï¼Œç§°ä¸ºinitè¿›ç¨‹é¢†å…»å­¤å„¿è¿›ç¨‹\nä¸€ä¸ªè¿›ç¨‹åœ¨ç»ˆæ­¢æ—¶ä¼šå…³é—­æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œé‡Šæ”¾åœ¨ç”¨æˆ·ç©ºé—´åˆ†é…çš„å†…å­˜ï¼Œä½†å®ƒçš„PCBè¿˜ ä¿ç•™ç€ï¼Œå†…æ ¸åœ¨å…¶ä¸­ä¿å­˜äº†ä¸€äº›ä¿¡æ¯ï¼šå¦‚æœæ˜¯æ­£å¸¸ç»ˆæ­¢åˆ™ä¿å­˜ç€é€€å‡ºçŠ¶æ€ï¼Œå¦‚æœæ˜¯å¼‚å¸¸ç»ˆæ­¢ åˆ™ä¿å­˜ç€å¯¼è‡´è¯¥è¿›ç¨‹ç»ˆæ­¢çš„ä¿¡å·æ˜¯å“ªä¸ªã€‚è¿™ä¸ªè¿›ç¨‹çš„çˆ¶è¿›ç¨‹å¯ä»¥è°ƒç”¨waitæˆ–waitpidè·å–è¿™ äº›ä¿¡æ¯ï¼Œç„¶åå½»åº•æ¸…é™¤æ‰è¿™ä¸ªè¿›ç¨‹ã€‚æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªè¿›ç¨‹çš„é€€å‡ºçŠ¶æ€å¯ä»¥åœ¨Shellä¸­ç”¨ç‰¹æ®Šå˜ é‡$?æŸ¥çœ‹ï¼Œå› ä¸ºShellæ˜¯å®ƒçš„çˆ¶è¿›ç¨‹ï¼Œå½“å®ƒç»ˆæ­¢æ—¶Shellè°ƒç”¨waitæˆ–waitpidå¾—åˆ°å®ƒçš„é€€å‡ºçŠ¶ æ€åŒæ—¶å½»åº•æ¸…é™¤æ‰è¿™ä¸ªè¿›ç¨‹ã€‚ä½†æ˜¯ï¼Œå¦‚æœçˆ¶è¿›ç¨‹å…ˆäºå­è¿›ç¨‹ç»“æŸï¼Œåˆ™å­è¿›ç¨‹æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹å°†è¢« init è¿›ç¨‹ï¼ˆè¿›ç¨‹å·ä¸º1ï¼‰é¢†å…»ï¼Œå¹¶ç”± init è¿›ç¨‹å¯¹å­¤å„¿è¿›ç¨‹å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚è€Œå¦‚æœå­è¿›ç¨‹å…ˆäºçˆ¶è¿›ç¨‹é€€å‡ºï¼ŒåŒæ—¶çˆ¶è¿›ç¨‹å¤ªå¿™äº†ï¼Œæ— ç‘•å›æ”¶å­è¿›ç¨‹çš„èµ„æºï¼Œå­è¿›ç¨‹æ®‹ç•™èµ„æºï¼ˆPCBï¼‰å­˜æ”¾äºå†…æ ¸ä¸­ï¼Œå˜æˆåƒµå°¸ã€‚ä»»ä½•è¿›ç¨‹åœ¨åˆšç»ˆæ­¢æ—¶éƒ½æ˜¯åƒµå°¸è¿›ç¨‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œåƒµ å°¸è¿›ç¨‹éƒ½ç«‹åˆ»è¢«çˆ¶è¿›ç¨‹æ¸…ç†äº†.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; int main(void) { pid_t pid; pid = fork(); if (pid == 0) { printf(\u0026#34;I am child, my parent= %d, going to sleep 3s\\n\u0026#34;, getppid()); sleep(3); printf(\u0026#34;-------------child die--------------\\n\u0026#34;); } else if (pid \u0026gt; 0) { printf(\u0026#34;I am parent, pid = %d, myson = %d, going to sleep 5s\\n\u0026#34;, getpid(), pid); sleep(5); system(\u0026#34;ps -o pid,ppid,state,tty,command\u0026#34;); } else { perror(\u0026#34;fork\u0026#34;); return 1; } return 0; } åœ¨è¿™ä¸ªç¨‹åºé‡Œï¼Œçˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹ä¹‹åï¼Œå°±ä¼‘çœ  5 ç§’é’Ÿã€‚è€Œå­è¿›ç¨‹åªä¼‘çœ  3 ç§’é’Ÿå°±é€€å‡ºï¼Œåœ¨å®ƒé€€å‡ºä¹‹åï¼Œçˆ¶è¿›ç¨‹è¿˜æœªè‹é†’ï¼Œå› æ­¤æ²¡äººç»™å­è¿›ç¨‹ã€Œæ”¶å°¸ã€ï¼Œæ‰€ä»¥å®ƒå°±å˜æˆäº†åƒµå°¸è¿›ç¨‹ã€‚\nåƒµå°¸è¿›ç¨‹å…¶å®å·²ç»å°±æ˜¯é€€å‡ºçš„è¿›ç¨‹ï¼Œå› æ­¤æ— æ³•å†åˆ©ç”¨killå‘½ä»¤æ€æ­»åƒµå°¸è¿›ç¨‹ã€‚åƒµå°¸è¿›ç¨‹çš„ç½ªé­ç¥¸é¦–æ˜¯çˆ¶è¿›ç¨‹æ²¡æœ‰å›æ”¶å®ƒçš„èµ„æºï¼Œé‚£æˆ‘ä»¬å¯ä»¥æƒ³åŠæ³•å®ƒå…¶å®ƒè¿›ç¨‹å»å›æ”¶åƒµå°¸è¿›ç¨‹çš„èµ„æºï¼Œè¿™ä¸ªè¿›ç¨‹å°±æ˜¯ init è¿›ç¨‹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ€æ­»çˆ¶è¿›ç¨‹ï¼Œinit è¿›ç¨‹å°±ä¼šå¾ˆå–„è‰¯åœ°æŠŠé‚£äº›åƒµå°¸è¿›ç¨‹é¢†å…»è¿‡æ¥ï¼Œå¹¶åˆç†çš„å›æ”¶å®ƒä»¬çš„èµ„æºï¼Œé‚£äº›åƒµå°¸è¿›ç¨‹å°±å¾—åˆ°äº†å¦¥å–„çš„å¤„ç†äº†\n","date":"2025-07-31T17:22:16+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/%E8%BF%9B%E7%A8%8B%E5%8E%9F%E8%AF%ADfork-exceve-waitpid/","title":"è¿›ç¨‹åŸè¯­fork exceve waitpid"},{"content":"openwrt procdå¯åŠ¨æµç¨‹åˆ†æ kernel_init Linuxå†…æ ¸æ‰§è¡Œstart_kernelå‡½æ•°æ—¶ä¼šè°ƒç”¨kernel_initæ¥å¯åŠ¨initè¿›ç¨‹ï¼Œæµç¨‹å¦‚ä¸‹å›¾\nstart_kernel\u0026ndash;\u0026gt;rest_init\u0026ndash;\u0026gt;kernel_init\u0026ndash;\u0026gt;try_to_run_init_process\nkernel_init()(ä½äº linux-4.1.52/init/main.c)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 /* * We try each of these until one succeeds. * * The Bourne shell can be used instead of init if we are * trying to recover a really broken machine. */ if (execute_command) { ret = run_init_process(execute_command); if (!ret) return 0; panic(\u0026#34;Requested init %s failed (error %d).\u0026#34;, execute_command, ret); } if (!try_to_run_init_process(\u0026#34;/sbin/init\u0026#34;) || !try_to_run_init_process(\u0026#34;/etc/init\u0026#34;) || !try_to_run_init_process(\u0026#34;/bin/init\u0026#34;) || !try_to_run_init_process(\u0026#34;/bin/sh\u0026#34;)) return 0; panic(\u0026#34;No working init found. Try passing init= option to kernel. \u0026#34; \u0026#34;See Linux Documentation/init.txt for guidance.\u0026#34;); } /sbin/init openwrt æºç  openwrt/package/system/procd/Makefile\n1 2 3 4 5 6 7 8 9 10 define Package/procd/install $(INSTALL_DIR) $(1)/sbin $(1)/etc $(1)/lib/functions $(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/{init,procd,askfirst,udevtrigger,upgraded} $(1)/sbin/ $(INSTALL_DATA) $(PKG_INSTALL_DIR)/usr/lib/libsetlbf.so $(1)/lib $(INSTALL_BIN) ./files/reload_config $(1)/sbin/ $(INSTALL_CONF) ./files/hotplug*.json $(1)/etc/ $(INSTALL_DATA) ./files/procd.sh $(1)/lib/functions/ $(INSTALL_BIN) ./files/service $(1)/sbin/service endef procdæºç procd/CMakeList.txt\n1 2 3 4 5 6 7 8 9 10 IF(DISABLE_INIT) ADD_DEFINITIONS(-DDISABLE_INIT) ELSE() ADD_EXECUTABLE(init initd/init.c initd/early.c initd/preinit.c initd/mkdev.c sysupgrade.c watchdog.c utils/utils.c) TARGET_INCLUDE_DIRECTORIES(init PUBLIC ${SELINUX_INCLUDE_DIRS}) TARGET_LINK_LIBRARIES(init ${LIBS} ${SELINUX_LIBRARIES}) INSTALL(TARGETS init RUNTIME DESTINATION ${CMAKE_INSTALL_SBINDIR} ) procd å¯åŠ¨æµç¨‹ /sbin/init main å‡½æ•°å…¥å£ä½äº procd/initd/init.c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 int main(int argc, char **argv) { pid_t pid; ulog_open(ULOG_KMSG, LOG_DAEMON, \u0026#34;init\u0026#34;); sigaction(SIGTERM, \u0026amp;sa_shutdown, NULL); sigaction(SIGUSR1, \u0026amp;sa_shutdown, NULL); sigaction(SIGUSR2, \u0026amp;sa_shutdown, NULL); sigaction(SIGPWR, \u0026amp;sa_shutdown, NULL); if (selinux(argv)) exit(-1); early(); cmdline(); watchdog_init(1); pid = fork(); if (!pid) { char *kmod[] = { \u0026#34;/sbin/kmodloader\u0026#34;, \u0026#34;/etc/modules-boot.d/\u0026#34;, NULL }; if (debug \u0026lt; 3) patch_stdio(\u0026#34;/dev/null\u0026#34;); execvp(kmod[0], kmod); ERROR(\u0026#34;Failed to start kmodloader: %m\\n\u0026#34;); exit(EXIT_FAILURE); } if (pid \u0026lt;= 0) { ERROR(\u0026#34;Failed to start kmodloader instance: %m\\n\u0026#34;); } else { const struct timespec req = {0, 10 * 1000 * 1000}; int i; for (i = 0; i \u0026lt; 1200; i++) { if (waitpid(pid, NULL, WNOHANG) \u0026gt; 0) break; nanosleep(\u0026amp;req, NULL); watchdog_ping(); } } uloop_init(); preinit(); uloop_run(); return 0; } kmodloader å…ˆå¯åŠ¨çš„æ˜¯kmodloader(å®ç°äºopenwrt/ubox/kmodloader.c),ä¼šinsmodä½äº/etc/modules.d/ä¸‹çš„kernel module list\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 static int main_loader(int argc, char **argv) { int gl_flags = GLOB_NOESCAPE | GLOB_MARK; char *dir = \u0026#34;/etc/modules.d/\u0026#34;; struct module_node *mn; struct module *m; glob_t gl; char *path; int ret = 0, fail, j; if (argc \u0026gt; 1) dir = argv[1]; path = malloc(strlen(dir) + 2); if (!path) { ULOG_ERR(\u0026#34;out of memory\\n\u0026#34;); return -1; } strcpy(path, dir); strcat(path, \u0026#34;*\u0026#34;); if (scan_module_folders()) { ret = -1; goto free_path; } if (scan_loaded_modules()) { ret = -1; goto free_path; } ULOG_INFO(\u0026#34;loading kernel modules from %s\\n\u0026#34;, path); ...... } int main(int argc, char **argv) { char *exec = basename(*argv); avl_init(\u0026amp;modules, avl_modcmp, true, NULL); if (!strcmp(exec, \u0026#34;insmod\u0026#34;)) return main_insmod(argc, argv); if (!strcmp(exec, \u0026#34;rmmod\u0026#34;)) return main_rmmod(argc, argv); if (!strcmp(exec, \u0026#34;lsmod\u0026#34;)) return main_lsmod(argc, argv); if (!strcmp(exec, \u0026#34;modinfo\u0026#34;)) return main_modinfo(argc, argv); load_options(); if (!strcmp(exec, \u0026#34;modprobe\u0026#34;)) return main_modprobe(argc, argv); ulog_open(ULOG_KMSG, LOG_USER, \u0026#34;kmodloader\u0026#34;); return main_loader(argc, argv); } uloop_initå®ç°ä½äºlibuboxæºç uloop.c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 int uloop_init(void) { if (uloop_init_pollfd() \u0026lt; 0) return -1; if (waker_init() \u0026lt; 0) { uloop_done(); return -1; } return 0; } static int uloop_init_pollfd(void) { if (poll_fd \u0026gt;= 0) return 0; poll_fd = epoll_create(32); if (poll_fd \u0026lt; 0) return -1; fcntl(poll_fd, F_SETFD, fcntl(poll_fd, F_GETFD) | FD_CLOEXEC); return 0; } preinitå®ç°ä½äºprocdæºç æ–‡ä»¶initd/preinit.c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 static struct uloop_process preinit_proc; static struct uloop_process plugd_proc; void preinit(void) { char *init[] = { \u0026#34;/bin/sh\u0026#34;, \u0026#34;/etc/preinit\u0026#34;, NULL }; char *plug[] = { \u0026#34;/sbin/procd\u0026#34;, \u0026#34;-h\u0026#34;, \u0026#34;/etc/hotplug-preinit.json\u0026#34;, NULL }; int fd; LOG(\u0026#34;- preinit -\\n\u0026#34;); plugd_proc.cb = plugd_proc_cb; plugd_proc.pid = fork(); if (!plugd_proc.pid) { execvp(plug[0], plug); ERROR(\u0026#34;Failed to start plugd: %m\\n\u0026#34;); exit(EXIT_FAILURE); } if (plugd_proc.pid \u0026lt;= 0) { ERROR(\u0026#34;Failed to start new plugd instance: %m\\n\u0026#34;); return; } uloop_process_add(\u0026amp;plugd_proc); setenv(\u0026#34;PREINIT\u0026#34;, \u0026#34;1\u0026#34;, 1); fd = creat(\u0026#34;/tmp/.preinit\u0026#34;, 0600); if (fd \u0026lt; 0) ERROR(\u0026#34;Failed to create sentinel file: %m\\n\u0026#34;); else close(fd); preinit_proc.cb = spawn_procd; preinit_proc.pid = fork(); if (!preinit_proc.pid) { execvp(init[0], init); ERROR(\u0026#34;Failed to start preinit: %m\\n\u0026#34;); exit(EXIT_FAILURE); } if (preinit_proc.pid \u0026lt;= 0) { ERROR(\u0026#34;Failed to start new preinit instance: %m\\n\u0026#34;); return; } uloop_process_add(\u0026amp;preinit_proc); DEBUG(4, \u0026#34;Launched preinit instance, pid=%d\\n\u0026#34;, (int) preinit_proc.pid); } åˆ›å»ºå­è¿›ç¨‹æ‰§è¡Œ /sbin/procd -h /etc/hotplug-preinit.json ï¼Œä¸»è¿›ç¨‹åŒæ—¶ä½¿ç”¨ uloop_process_add()æŠŠ /sbin/procd å­è¿›ç¨‹åŠ å…¥ uloop è¿›è¡Œç›‘æ§ï¼Œå½“ /sbin/procd è¿›ç¨‹ç»“æŸæ—¶å›è°ƒ plugd_proc_cb å‡½æ•°ã€‚ åˆ›å»ºå­è¿›ç¨‹æ‰§è¡Œ /etc/preinit è„šæœ¬ï¼Œæ­¤æ—¶ PREINITç¯å¢ƒå˜é‡è¢«è®¾ç½®ä¸º1ï¼Œä¸»è¿›ç¨‹åŒæ—¶ä½¿ç”¨ uloop_process_add() æŠŠ/etc/preinit å­è¿›ç¨‹åŠ å…¥ uloop è¿›è¡Œç›‘æ§ï¼Œå½“ /etc/preinit æ‰§è¡Œç»“æŸæ—¶å›è°ƒ spawn_procdå‡½æ•° spawn_procd()å‡½æ•°ç¹è¡Œåç»§çœŸæ­£ä½¿ç”¨çš„ /sbin/procd è¿›ç¨‹ï¼Œä» /tmp/debuglevel è¯»å‡º debug çº§åˆ«å¹¶è®¾ç½®åˆ°ç¯å¢ƒå˜é‡ DBGLVL ä¸­ï¼ŒæŠŠ watchdog fd è®¾ç½®åˆ°ç¯å¢ƒå˜é‡ WDTFD ä¸­ï¼Œæœ€åè°ƒç”¨ execvp()ç¹è¡Œ /sbin/procd è¿›ç¨‹ é¦–å…ˆçœ‹procdï¼Œå› ä¸ºå¸¦æœ‰å‚æ•°â€œ-h /etc/hotplug-preinit.jsonâ€ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œhotplug_runå‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 int main(int argc, char **argv) { int ch; char *dbglvl = getenv(\u0026#34;DBGLVL\u0026#34;); int ulog_channels = ULOG_KMSG; if (dbglvl) { debug = atoi(dbglvl); unsetenv(\u0026#34;DBGLVL\u0026#34;); } while ((ch = getopt(argc, argv, \u0026#34;d:s:h:S\u0026#34;)) != -1) { switch (ch) { case \u0026#39;h\u0026#39;: return hotplug_run(optarg); // hotplug case \u0026#39;s\u0026#39;: ubus_socket = optarg; break; case \u0026#39;d\u0026#39;: debug = atoi(optarg); break; case \u0026#39;S\u0026#39;: ulog_channels = ULOG_STDIO; break; default: return usage(argv[0]); } } ulog_open(ulog_channels, LOG_DAEMON, \u0026#34;procd\u0026#34;); ulog_threshold(LOG_DEBUG + 1); setsid(); uloop_init(); procd_signal(); procd_udebug_set_enabled(true); if (getpid() != 1) procd_connect_ubus(); else procd_state_next(); uloop_run(); uloop_done(); return 0; } hotplugå®ç°å¦‚ä¸‹ï¼Œè¿™é‡Œæ˜¯å»ºç«‹netlinké€šä¿¡æœºåˆ¶ï¼Œå®Œæˆç”¨æˆ·å±‚å’Œå†…æ ¸çš„äº¤äº’ï¼Œç›‘å¬å†…æ ¸çš„ueventäº‹ä»¶ã€‚\nprocd/plug/hotplug.c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 void hotplug(char *rules) { struct sockaddr_nl nls; int nlbufsize = 512 * 1024; rule_file = strdup(rules); memset(\u0026amp;nls,0,sizeof(struct sockaddr_nl)); nls.nl_family = AF_NETLINK; nls.nl_pid = getpid(); nls.nl_groups = -1; if ((hotplug_fd.fd = socket(PF_NETLINK, SOCK_DGRAM | SOCK_CLOEXEC, NETLINK_KOBJECT_UEVENT)) == -1) { ERROR(\u0026#34;Failed to open hotplug socket: %s\\n\u0026#34;, strerror(errno)); exit(1); } if (bind(hotplug_fd.fd, (void *)\u0026amp;nls, sizeof(struct sockaddr_nl))) { ERROR(\u0026#34;Failed to bind hotplug socket: %s\\n\u0026#34;, strerror(errno)); exit(1); } if (setsockopt(hotplug_fd.fd, SOL_SOCKET, SO_RCVBUFFORCE, \u0026amp;nlbufsize, sizeof(nlbufsize))) ERROR(\u0026#34;Failed to resize receive buffer: %s\\n\u0026#34;, strerror(errno)); json_script_init(\u0026amp;jctx); queue_proc.cb = queue_proc_cb; uloop_fd_add(\u0026amp;hotplug_fd, ULOOP_READ); } int hotplug_run(char *rules) { uloop_init(); hotplug(rules); uloop_run(); return 0; } å†…æ ¸å‘å‡ºueventäº‹ä»¶ å†…æ ¸ä½¿ç”¨ uevent äº‹ä»¶é€šçŸ¥ç”¨æˆ·ç©ºé—´ï¼Œ uevent é¦–å…ˆåœ¨å†…æ ¸ä¸­è°ƒç”¨ netink_kemel_create() å‡½æ•°åˆ›å»ºä¸€ä¸ª socket å¥—æ¥å­—ï¼Œè¯¥å‡½æ•°åŸå‹åœ¨ netink.h ä¸­å®šä¹‰ã€‚è¿™æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ socket ï¼Œä¸“é—¨ç”¨äºå†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´çš„å¼‚æ­¥é€šä¿¡ã€‚kobject_uevent()äº§ç”Ÿuevent äº‹ä»¶ (/lib/kobject_uevent.c)ï¼Œäº‹ä»¶çš„éƒ¨åˆ†ä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ï¼Œå¦‚$ACTION,$DEVPATH,$SUBSYSTEM ç­‰ï¼Œäº§ç”Ÿçš„ uevent å…ˆç”± netlink_broadcast_filtered()å‘å‡ºï¼Œæœ€åè°ƒç”¨uevent helper æ‰€æŒ‡å®šçš„ç¨‹åºæ¥å¤„ç†ã€‚åœ¨linux ä¸­ï¼Œuevent_helper é‡Œé»˜è®¤æŒ‡å®š\u0026quot;/sbin/hotplugâ€ï¼Œä½†å¯ä»¥é€šè¿‡ /sys/kemel/uevent helper (kernel/ksysfs.c) /proc/kernel/uevent_elper(kernel/sysctl.c)æ¥ä¿®æ”¹æˆæŒ‡å®šçš„ç¨‹åºã€‚åœ¨æ–° OpenWRT ä¸­ï¼Œå¹¶ä¸ä½¿ç”¨ user helper æŒ‡å®šç¨‹åºæ¥å¤„ç† uevent(/sbin/hotplug ä¸å­˜åœ¨ï¼Œåœ¨ä»¥å‰ç‰ˆæœ¬ä¸­å­˜åœ¨)ï¼Œè€Œæ˜¯é€šè¿‡PF_NETLINKå¥—æ¥å­—æ¥è·å–æ¥è‡ªå†…æ ¸ç©ºé—´çš„ uevent ã€‚ ç”¨æˆ·ç©ºé—´ç›‘å¬uevent åœ¨ procd/plug/hotplug.c ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª PF_NETLINK å¥—æ¥å­—æ¥ç›‘å¬å†…æ ¸ netlink_broadcast_fitered() å‘å‡ºçš„ uevent ã€‚æ”¶åˆ°uevent ä¹‹åï¼Œåœ¨æ ¹æ® /etc/hotplug.json é‡Œçš„æè¿°ï¼Œå®šä½åˆ°å¯¹åº”çš„æ‰§è¡Œå‡½æ•°æ¥å¤„ç†.é€šå¸¸æƒ…å†µä¸‹ï¼Œ /etc/hotplug.json ä¼šè°ƒç”¨ /sbin/hotplug-call æ¥å¤„ç† uevent ï¼Œå®ƒæ ¹æ® uevent çš„ $SUBSYSTEM å˜é‡æ¥åˆ†åˆ«è°ƒç”¨ /etc/hotplug.d ä¸‹ä¸åŒç›®å½•ä¸­çš„è„šæœ¬ã€‚ /etc/preinitè„šæœ¬å¤§è‡´å†…å®¹å¦‚ä¸‹ï¼Œå…ˆè°ƒç”¨å¦å¤–çš„shellè„šæœ¬ï¼Œè·å–å‡½æ•°å®šä¹‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 . /lib/functions.sh . /lib/functions/preinit.sh . /lib/functions/system.sh # åˆå§‹åŒ–hooké“¾ boot_hook_init preinit_essential boot_hook_init preinit_main boot_hook_init failsafe boot_hook_init initramfs # ä¾æ¬¡æ‰§è¡Œ/lib/preinitç›®å½•ä¸­çš„è„šæœ¬ï¼Œå°†å‡½æ•°è°ƒç”¨æ·»åŠ åˆ°hooké“¾ä¸­ for pi_source_file in /lib/preinit/*; do . $pi_source_file done # æ‰§è¡Œpreinit_essentialæ³¨å†Œçš„hooké“¾çš„æ‰€æœ‰å‡½æ•° boot_run_hook preinit_essential # æ‰§è¡Œpreinit_mainæ³¨å†Œçš„hooké“¾çš„æ‰€æœ‰å‡½æ•° boot_run_hook preinit_main /etc/preinitè„šæœ¬æ‰§è¡Œå®Œæˆåï¼Œè°ƒç”¨spawn_procd,spawn_procdä¼šè°ƒç”¨ execvp()æ‰§è¡Œ /sbin/procdè¿›ç¨‹\nprocd/initd/preinit.c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 spawn_procd(struct uloop_process *proc, int ret) { char *wdt_fd = watchdog_fd(); char *argv[] = { \u0026#34;/sbin/procd\u0026#34;, NULL}; char dbg[2]; if (plugd_proc.pid \u0026gt; 0) kill(plugd_proc.pid, SIGKILL); unsetenv(\u0026#34;PREINIT\u0026#34;); unlink(\u0026#34;/tmp/.preinit\u0026#34;); check_sysupgrade(); DEBUG(2, \u0026#34;Exec to real procd now\\n\u0026#34;); if (wdt_fd) setenv(\u0026#34;WDTFD\u0026#34;, wdt_fd, 1); check_dbglvl(); if (debug \u0026gt; 0) { snprintf(dbg, 2, \u0026#34;%d\u0026#34;, debug); setenv(\u0026#34;DBGLVL\u0026#34;, dbg, 1); } execvp(argv[0], argv); } procd/procd.cä¸­\n1 2 3 4 5 6 7 8 9 10 setsid(); uloop_init(); procd_signal(); procd_udebug_set_enabled(true); if (getpid() != 1) procd_connect_ubus(); else procd_state_next(); uloop_run(); uloop_done(); æ­¤æ—¶getpid()ç­‰äº1ï¼Œæ‰€ä»¥è°ƒç”¨procd_state_nextï¼Œè¿›å…¥åˆ°çŠ¶æ€æœºå¤„ç†ä¸­ã€‚\nprocd_stateä¸æ–­è¿ç§»ï¼ŒåŒ…æ‹¬STATE_EARLYï¼ŒSTATE_UBUSï¼ŒSTATE_INITç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 [ 3.161338@3] init: Console is alive [ 3.173921@3] init: Ping [ 3.184207@3] init: Ping [ 3.192558@1] kmodloader: loading kernel modules from /etc/modules-boot.d/* [ 3.194447@3] init: Ping [ 3.196209@1] kmodloader: done loading kernel modules from /etc/modules-boot.d/* [ 3.204716@3] init: Ping [ 3.206180@3] init: - preinit - [ 3.208671@3] init: Launched preinit instance, pid=1308 [ 3.302967@3] init: Exec to real procd now [ 3.308865@3] procd: - early - [ 3.524654@2] procd: Finished udevtrigger [ 4.024929@2] procd: Coldplug complete [ 4.028061@2] procd: - ubus - [ 4.029198@2] procd: Create service ubus [ 4.030829@2] procd: Create instance ubus::instance1 [ 4.032109@2] procd: Started instance ubus::instance1[1554] [ 4.098895@2] procd: Connected to ubus, id=459ede6c [ 4.099092@2] procd: - init - [ 4.102474@2] procd: Launched new askconsole action, pid=1555 [ 4.104142@2] procd: Launched new askfirst action, pid=1556 ä»¥STATE_INITä¸ºä¾‹ï¼Œæ‰§è¡Œprocd_inittab_run(\u0026ldquo;xxx\u0026rdquo;)ä¼šè°ƒç”¨å¯¹åº”handlersçš„callbackï¼Œå¯¹åº”æ‰€æœ‰çš„init_actionæ˜¯åœ¨procd_inittab()ä¸­æ·»åŠ çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 case STATE_INIT: LOG(\u0026#34;- init -\\n\u0026#34;); procd_inittab(); procd_inittab_run(\u0026#34;respawn\u0026#34;); procd_inittab_run(\u0026#34;askconsole\u0026#34;); procd_inittab_run(\u0026#34;askfirst\u0026#34;); procd_inittab_run(\u0026#34;sysinit\u0026#34;); static struct init_handler handlers[] = { { .name = \u0026#34;sysinit\u0026#34;, .cb = runrc, }, { .name = \u0026#34;shutdown\u0026#34;, .cb = runrc, }, { .name = \u0026#34;askfirst\u0026#34;, .cb = askfirst, .multi = 1, }, { .name = \u0026#34;askconsole\u0026#34;, .cb = askconsole, .multi = 1, }, { .name = \u0026#34;respawn\u0026#34;, .cb = rcrespawn, .multi = 1, } }; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 static const char *tab = \u0026#34;/etc/inittab\u0026#34;; static char *ask = \u0026#34;/sbin/askfirst\u0026#34;; static int add_action(struct init_action *a, const char *name) { int i; for (i = 0; i \u0026lt; ARRAY_SIZE(handlers); i++) if (!strcmp(handlers[i].name, name)) { a-\u0026gt;handler = \u0026amp;handlers[i]; list_add_tail(\u0026amp;a-\u0026gt;list, \u0026amp;actions); return 0; } ERROR(\u0026#34;Unknown init handler %s\\n\u0026#34;, name); return -1; } void procd_inittab(void) { #define LINE_LEN 128 FILE *fp = fopen(tab, \u0026#34;r\u0026#34;); struct init_action *a; regex_t pat_inittab; regmatch_t matches[5]; char *line; if (!fp) { ERROR(\u0026#34;Failed to open %s: %m\\n\u0026#34;, tab); return; } regcomp(\u0026amp;pat_inittab, \u0026#34;([a-zA-Z0-9]*):([a-zA-Z0-9]*):([a-zA-Z0-9]*):(.*)\u0026#34;, REG_EXTENDED); line = malloc(LINE_LEN); a = calloc(1, sizeof(struct init_action)); while (fgets(line, LINE_LEN, fp)) { char *tags[TAG_PROCESS + 1]; char *tok; int i; int len = strlen(line); while (isspace(line[len - 1])) len--; line[len] = 0; if (*line == \u0026#39;#\u0026#39;) continue; if (regexec(\u0026amp;pat_inittab, line, 5, matches, 0)) continue; DEBUG(4, \u0026#34;Parsing inittab - %s\\n\u0026#34;, line); for (i = TAG_ID; i \u0026lt;= TAG_PROCESS; i++) { line[matches[i].rm_eo] = \u0026#39;\\0\u0026#39;; tags[i] = \u0026amp;line[matches[i + 1].rm_so]; }; tok = strtok(tags[TAG_PROCESS], \u0026#34; \u0026#34;); for (i = 0; i \u0026lt; (MAX_ARGS - 1) \u0026amp;\u0026amp; tok; i++) { a-\u0026gt;argv[i] = tok; tok = strtok(NULL, \u0026#34; \u0026#34;); } a-\u0026gt;argv[i] = NULL; a-\u0026gt;id = tags[TAG_ID]; a-\u0026gt;line = line; if (add_action(a, tags[TAG_ACTION])) continue; line = malloc(LINE_LEN); a = calloc(1, sizeof(struct init_action)); } fclose(fp); free(line); free(a); regfree(\u0026amp;pat_inittab); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 void procd_inittab_run(const char *handler) { struct init_action *a; list_for_each_entry(a, \u0026amp;actions, list) { if (!strcmp(a-\u0026gt;handler-\u0026gt;name, handler)) { if (a-\u0026gt;handler-\u0026gt;multi) { a-\u0026gt;handler-\u0026gt;cb(a); continue; } a-\u0026gt;handler-\u0026gt;cb(a); break; } } } /etc/inittab\n1 2 3 ::sysinit:/etc/init.d/rcS S boot ::shutdown:/etc/init.d/rcS K shutdown ::askconsole:/usr/libexec/login.sh è¿™é‡Œæ¥çœ‹runrcçš„å®ç°ï¼Œä»£ç ä½äºinittab.c\n1 2 3 4 5 6 7 8 9 10 11 static void runrc(struct init_action *a) { if (!a-\u0026gt;argv[1] || !a-\u0026gt;argv[2]) { ERROR(\u0026#34;valid format is rcS \u0026lt;S|K\u0026gt; \u0026lt;param\u0026gt;\\n\u0026#34;); return; } /* proceed even if no init or shutdown scripts run */ if (rcS(a-\u0026gt;argv[1], a-\u0026gt;argv[2], rcdone)) rcdone(NULL); } rcS.c\n1 2 3 4 5 6 7 8 int rcS(char *pattern, char *param, void (*q_empty)(struct runqueue *)) { runqueue_init(\u0026amp;q); q.empty_cb = q_empty; q.max_running_tasks = 1; return _rc(\u0026amp;q, \u0026#34;/etc/rc.d\u0026#34;, pattern, \u0026#34;*\u0026#34;, param); } æ‰§è¡Œ/etc/rc.dç›®å½•ä¸‹Så¼€å¤´çš„è„šæœ¬\n","date":"2025-07-30T18:28:23+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/openwrt-procd%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/","title":"openwrt procdå¯åŠ¨æµç¨‹åˆ†æ"},{"content":"OverlayFS ç®€ä»‹ OverlayFS (Overlay Filesystem) æ˜¯ä¸€ç§è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnion Filesystemï¼‰ï¼Œå®ƒå…è®¸ç”¨æˆ·å°†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ˆé€šå¸¸æ˜¯å¯å†™çš„ï¼‰â€œè¦†ç›–â€åœ¨å¦ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ˆé€šå¸¸æ˜¯åªè¯»çš„ï¼‰ä¹‹ä¸Šã€‚å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿçœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªåˆå¹¶åçš„å•ä¸€ç›®å½•æ ‘ã€‚\nOverlayFS åœ¨ Linux å†…æ ¸ 3.18 ä¸­è¢«åˆå¹¶è¿›ä¸»çº¿ï¼Œå› å…¶è®¾è®¡ç®€æ´ã€æ€§èƒ½é«˜æ•ˆè€Œè¢«å¹¿æ³›åº”ç”¨äºå®¹å™¨æŠ€æœ¯ï¼ˆå¦‚ Dockerï¼‰å’ŒåµŒå…¥å¼ç³»ç»Ÿï¼ˆå¦‚ OpenWrtï¼‰ã€‚\næ ¸å¿ƒæ¦‚å¿µ OverlayFS ä¸»è¦æ¶‰åŠå››ä¸ªç›®å½•å±‚çº§ï¼š\nLower Dir (åº•å±‚ç›®å½•): é€šå¸¸æ˜¯åªè¯»çš„ã€‚ åœ¨ OpenWrt ä¸­ï¼Œè¿™é€šå¸¸å¯¹åº”äºå‹ç¼©çš„åªè¯»å›ºä»¶éƒ¨åˆ†ï¼ˆSquashFSï¼‰ã€‚ å¯ä»¥æœ‰å¤šä¸ª Lower å±‚ã€‚\nUpper Dir (ä¸Šå±‚ç›®å½•): æ˜¯å¯å†™çš„ã€‚ æ‰€æœ‰å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹ï¼ˆæ–°å»ºã€ä¿®æ”¹ã€åˆ é™¤ï¼‰éƒ½ä¼šè®°å½•åœ¨è¿™é‡Œã€‚ åœ¨ OpenWrt ä¸­ï¼Œè¿™é€šå¸¸å¯¹åº”äº JFFS2 æˆ– UBIFS åˆ†åŒºã€‚\nWork Dir (å·¥ä½œç›®å½•): ä¸€ä¸ªå¯¹ç”¨æˆ·ä¸å¯è§çš„ç©ºç›®å½•ï¼ŒOverlayFS ä½¿ç”¨å®ƒæ¥å‡†å¤‡æ–‡ä»¶æ“ä½œï¼ˆå¦‚åŸå­æ€§ä¿è¯ï¼‰ã€‚ å¿…é¡»ä¸ Upper Dir åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸‹ã€‚\nMerged Dir (åˆå¹¶ç›®å½•): è¿™æ˜¯ç”¨æˆ·æœ€ç»ˆçœ‹åˆ°çš„æŒ‚è½½ç‚¹ã€‚ å®ƒå±•ç¤ºäº† Lower å’Œ Upper åˆå¹¶åçš„è§†å›¾ã€‚\nå·¥ä½œåŸç† è¯»å– (Read): å¦‚æœæ–‡ä»¶åœ¨ Upper å±‚å­˜åœ¨ï¼Œç›´æ¥è¯»å– Upper å±‚çš„æ–‡ä»¶ã€‚ å¦‚æœæ–‡ä»¶ä»…åœ¨ Lower å±‚å­˜åœ¨ï¼Œè¯»å– Lower å±‚çš„æ–‡ä»¶ã€‚ å¦‚æœä¸¤å±‚éƒ½æœ‰ï¼ŒUpper å±‚çš„æ–‡ä»¶ä¼šâ€œé®ç›–â€ä½ Lower å±‚çš„æ–‡ä»¶ã€‚\nå†™å…¥ (Write):\nä¿®æ”¹æ–‡ä»¶: å½“å°è¯•ä¿®æ”¹ä¸€ä¸ªä½äº Lower å±‚çš„æ–‡ä»¶æ—¶ï¼ŒOverlayFS ä¼šè§¦å‘ Copy-Up æ“ä½œï¼Œå°†æ–‡ä»¶ä» Lower å±‚å¤åˆ¶åˆ° Upper å±‚ï¼Œç„¶åå¯¹ Upper å±‚çš„æ–‡ä»¶è¿›è¡Œä¿®æ”¹ã€‚ æ–°å»ºæ–‡ä»¶: ç›´æ¥åœ¨ Upper å±‚åˆ›å»ºã€‚ åˆ é™¤ (Delete): å¦‚æœåˆ é™¤çš„æ˜¯ Upper å±‚çš„æ–‡ä»¶ï¼Œç›´æ¥åˆ é™¤ã€‚ å¦‚æœåˆ é™¤çš„æ˜¯ Lower å±‚çš„æ–‡ä»¶ï¼ŒOverlayFS ä¼šåœ¨ Upper å±‚åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„ Whiteout æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯å­—ç¬¦è®¾å¤‡ 0/0ï¼‰ï¼Œç”¨äºæ ‡è®°è¯¥æ–‡ä»¶å·²è¢«â€œé®ç›–â€ï¼ˆå³åˆ é™¤ï¼‰ï¼Œä»è€Œåœ¨ Merged è§†å›¾ä¸­ä¸å¯è§ã€‚\nOpenWrt ä¸­çš„ OverlayFS åº”ç”¨ OpenWrt æ˜¯ OverlayFS æœ€ç»å…¸çš„è½åœ°åœºæ™¯ä¹‹ä¸€ã€‚å®ƒåˆ©ç”¨ OverlayFS å®Œç¾è§£å†³äº†åµŒå…¥å¼è®¾å¤‡å­˜å‚¨ç©ºé—´æœ‰é™ä¸”éœ€è¦ç³»ç»Ÿæ¢å¤èƒ½åŠ›çš„çŸ›ç›¾ã€‚\nOpenWrt çš„æ–‡ä»¶ç³»ç»Ÿæ¶æ„ OpenWrt çš„å›ºä»¶é€šå¸¸åŒ…å«ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼š\n/rom (Read-Only): è¿™æ˜¯ä¸€ä¸ª SquashFS æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…å«äº†ç³»ç»Ÿå¯åŠ¨æ‰€éœ€çš„æ‰€æœ‰åŸºç¡€æ–‡ä»¶ã€å†…æ ¸æ¨¡å—å’Œé»˜è®¤é…ç½®ã€‚ å®ƒæ˜¯é«˜åº¦å‹ç¼©çš„ï¼Œä¸”åœ¨è¿è¡Œæ—¶æ˜¯åªè¯»çš„ã€‚è¿™ä¿è¯äº†ç³»ç»Ÿæ ¸å¿ƒæ–‡ä»¶çš„å®‰å…¨æ€§ï¼Œæ— è®ºç”¨æˆ·å¦‚ä½•è¯¯æ“ä½œï¼Œéƒ½å¯ä»¥æ¢å¤å‡ºå‚è®¾ç½®ã€‚\n/overlay (Read-Write): è¿™æ˜¯ä¸€ä¸ª JFFS2 (å¯¹äº NOR Flash) æˆ– UBIFS (å¯¹äº NAND Flash) æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…æ˜¯ ext4 (å¯¹äº SD å¡/ç¡¬ç›˜)ã€‚ å®ƒç”¨äºå­˜å‚¨ç”¨æˆ·çš„é…ç½®æ›´æ”¹ã€å®‰è£…çš„è½¯ä»¶åŒ…ç­‰ã€‚\næŒ‚è½½æœºåˆ¶ å½“ OpenWrt å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š\næŒ‚è½½ SquashFS åˆ†åŒºåˆ° /romã€‚ æŒ‚è½½å¯å†™åˆ†åŒºï¼ˆå¦‚ JFFS2ï¼‰åˆ° /overlayã€‚ ä½¿ç”¨ OverlayFS å°† /overlayï¼ˆUpperï¼‰è¦†ç›–åœ¨ /romï¼ˆLowerï¼‰ä¹‹ä¸Šï¼Œå¹¶å°†ç»“æœæŒ‚è½½åˆ°æ ¹ç›®å½• /ã€‚ æŒ‚è½½å‘½ä»¤ç¤ºä¾‹:\n1 mount -t overlay overlay -o lowerdir=/rom,upperdir=/overlay/upper,workdir=/overlay/work / (æ³¨ï¼šOpenWrt çš„å®é™…æŒ‚è½½è¿‡ç¨‹ç”± mount_root å’Œ preinit è„šæœ¬å¤„ç†ï¼Œç»†èŠ‚å¯èƒ½å› ç‰ˆæœ¬è€Œå¼‚ï¼Œæ—©æœŸç‰ˆæœ¬ä½¿ç”¨ mini_foï¼Œç°ä»£ç‰ˆæœ¬å‡ä½¿ç”¨ overlayfs)*\nå®é™…æ“ä½œä¸ç®¡ç† æŸ¥çœ‹æŒ‚è½½çŠ¶æ€ åœ¨ OpenWrt ç»ˆç«¯ä¸­è¾“å…¥ df -h æˆ– mount å¯ä»¥çœ‹åˆ° OverlayFS çš„ç»“æ„ï¼š\n1 2 3 4 5 6 root@OpenWrt:~# df -h Filesystem Size Used Available Use% Mounted on /dev/root 2.5M 2.5M 0 100% /rom tmpfs 61.8M 168.0K 61.6M 0% /tmp /dev/mtdblock3 5.0M 424.0K 4.6M 8% /overlay overlayfs:/overlay 5.0M 424.0K 4.6M 8% / å¯ä»¥çœ‹åˆ° / çš„ç±»å‹æ˜¯ overlayfs:/overlayï¼Œå®ƒçš„å¤§å°ç­‰äº /overlay åˆ†åŒºçš„å¤§å°ã€‚\næ¢å¤å‡ºå‚è®¾ç½® (Firstboot) ç”±äº OverlayFS çš„ç‰¹æ€§ï¼Œæ¢å¤å‡ºå‚è®¾ç½®å˜å¾—éå¸¸ç®€å•ï¼šåªéœ€è¦æ¸…ç©º /overlay åˆ†åŒºå³å¯ã€‚\nå½“ /overlay è¢«æ¸…ç©ºåï¼ŒUpper å±‚æ²¡æœ‰äº†ä»»ä½•æ–‡ä»¶ï¼Œç³»ç»Ÿé‡å¯åï¼ŒOverlayFS å‘ˆç°çš„å®Œå…¨æ˜¯ Lower å±‚ï¼ˆå³ /romï¼‰çš„å†…å®¹ï¼Œç³»ç»Ÿå°±å›åˆ°äº†åˆå§‹çŠ¶æ€ã€‚\nå‘½ä»¤ï¼š\n1 2 firstboot -y reboot æ‰©å®¹ (Extroot) OpenWrt è®¾å¤‡çš„å†…ç½® Flash é€šå¸¸å¾ˆå°ï¼ˆå¦‚ 16MBï¼‰ã€‚åˆ©ç”¨ OverlayFSï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾å®ç°æ‰©å®¹ï¼ˆExtrootï¼‰ï¼š\næ’å…¥ä¸€ä¸ª USB Uç›˜ã€‚ å°† Uç›˜æ ¼å¼åŒ–ä¸º ext4ã€‚ å°† Uç›˜æŒ‚è½½ä¸º /overlayã€‚ è¿™æ ·ï¼Œç³»ç»Ÿçš„å¯ç”¨ç©ºé—´å°±å˜æˆäº† Uç›˜çš„å¤§å°ï¼Œå¯ä»¥å®‰è£…å¤§é‡çš„è½¯ä»¶åŒ…ã€‚ å¸¸è§é—®é¢˜ ç©ºé—´ä¸è¶³: å¦‚æœ /overlay æ»¡äº†ï¼Œç³»ç»Ÿå¯èƒ½æ— æ³•ä¿å­˜é…ç½®æˆ–å®‰è£…è½¯ä»¶ã€‚æ­¤æ—¶åˆ é™¤æ–‡ä»¶å®é™…ä¸Šæ˜¯åœ¨ Upper å±‚æ“ä½œã€‚ æ–‡ä»¶è¢«é®æŒ¡: å¦‚æœä½ åœ¨ /rom ä¸­ä¿®æ”¹äº†æºç é‡æ–°ç¼–è¯‘å›ºä»¶ï¼Œä½†åˆ·æœºåå‘ç°æ–‡ä»¶æ²¡å˜ï¼Œå¯èƒ½æ˜¯å› ä¸º /overlay ä¸­å­˜åœ¨æ—§çš„ä¿®æ”¹ç‰ˆæœ¬é®æŒ¡äº†æ–°çš„ /rom æ–‡ä»¶ã€‚åˆ·æœºæ—¶é€šå¸¸å»ºè®®é€‰æ‹©â€œä¸ä¿ç•™é…ç½®â€æ¥æ¸…ç©º /overlayã€‚\næ€»ç»“ OverlayFS æ˜¯ OpenWrt çµæ´»æ€§çš„åŸºçŸ³ã€‚å®ƒé€šè¿‡åˆ†å±‚æœºåˆ¶ï¼Œæ—¢ä¿è¯äº†ç³»ç»Ÿåº•å±‚çš„ç¨³å®šæ€§ï¼ˆåªè¯»çš„ /romï¼‰ï¼Œåˆæä¾›äº†ç”¨æˆ·æ‰€éœ€çš„çµæ´»æ€§ï¼ˆå¯å†™çš„ /overlayï¼‰ï¼Œå¹¶ä¸”å®ç°äº†æä½æˆæœ¬çš„â€œæ¢å¤å‡ºå‚è®¾ç½®â€åŠŸèƒ½ã€‚ç†è§£ OverlayFS å¯¹äºæ·±å…¥ç©è½¬ OpenWrtï¼ˆå¦‚å®šåˆ¶å›ºä»¶ã€æ‰©å®¹ã€è°ƒè¯•ï¼‰è‡³å…³é‡è¦ã€‚\n","date":"2025-07-29T09:52:54+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/overlayfs/","title":"OverlayFS"},{"content":"LXC (Linux å®¹å™¨) å·¥ä½œåŸç†è¯¦è§£ LXC (Linux Containers) æ˜¯ä¸€ç§æ“ä½œç³»ç»Ÿçº§åˆ«çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå®ƒå…è®¸åœ¨å•ä¸ª Linux å†…æ ¸ä¸Šè¿è¡Œå¤šä¸ªéš”ç¦»çš„ Linux ç³»ç»Ÿï¼ˆå®¹å™¨ï¼‰ã€‚ä¸è™šæ‹Ÿæœºï¼ˆVMï¼‰ä¸åŒï¼ŒLXC ä¸éœ€è¦æ¨¡æ‹Ÿç¡¬ä»¶ï¼Œå› æ­¤å®ƒéå¸¸è½»é‡çº§ä¸”å¯åŠ¨é€Ÿåº¦å¿«ã€‚\nLXC çš„æ ¸å¿ƒæ˜¯åˆ©ç”¨ Linux å†…æ ¸çš„ä¸¤ä¸ªå…³é”®ç‰¹æ€§ï¼šå‘½åç©ºé—´ (Namespaces) å’Œ æ§åˆ¶ç»„ (Cgroups)ã€‚\nNamespacesï¼šè´Ÿè´£éš”ç¦»ï¼Œç¡®ä¿ä¸€ä¸ªå®¹å™¨ä¸­çš„è¿›ç¨‹çœ‹ä¸åˆ°æˆ–å½±å“åˆ°å¦ä¸€ä¸ªå®¹å™¨æˆ–å®¿ä¸»æœºçš„è¿›ç¨‹ã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç­‰ã€‚ Cgroupsï¼šè´Ÿè´£èµ„æºé™åˆ¶å’Œå®¡è®¡ï¼Œç¡®ä¿æ¯ä¸ªå®¹å™¨åªèƒ½ä½¿ç”¨åˆ†é…ç»™å®ƒçš„ CPUã€å†…å­˜ã€I/O ç­‰èµ„æºã€‚ æœ¬æ–‡å°†é‡ç‚¹è¯¦ç»†ä»‹ç»å‡ ä¸ªå…³é”®çš„å‘½åç©ºé—´ã€‚\n1. PID å‘½åç©ºé—´ (PID Namespace) PID (Process ID) å‘½åç©ºé—´ç”¨äºéš”ç¦»è¿›ç¨‹ IDã€‚\nåŸç† éš”ç¦»è¿›ç¨‹æ ‘ï¼šæ¯ä¸ª PID å‘½åç©ºé—´éƒ½æœ‰ä¸€å¥—ç‹¬ç«‹çš„è¿›ç¨‹ IDï¼Œä» 1 å¼€å§‹ã€‚ å®¹å™¨çš„ init è¿›ç¨‹ï¼šåœ¨ä¸€ä¸ªæ–°çš„ PID å‘½åç©ºé—´ä¸­åˆ›å»ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ä¼šæˆä¸ºè¯¥ç©ºé—´çš„ \u0026ldquo;init\u0026rdquo; è¿›ç¨‹ï¼Œå…¶ PID ä¸º 1ã€‚è¿™ä¸ªè¿›ç¨‹è´Ÿè´£ç®¡ç†å®¹å™¨å†…çš„æ‰€æœ‰å…¶ä»–è¿›ç¨‹ï¼ˆä¾‹å¦‚ï¼Œå¤„ç†å­¤å„¿è¿›ç¨‹ï¼‰ã€‚å¦‚æœè¿™ä¸ª PID ä¸º 1 çš„è¿›ç¨‹ç»ˆæ­¢ï¼Œå†…æ ¸å°†ç»ˆæ­¢è¯¥å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰å…¶ä»–è¿›ç¨‹ã€‚ å†…å¤– PID æ˜ å°„ï¼šå®¹å™¨å†…çš„è¿›ç¨‹åœ¨å®¹å™¨å†…éƒ¨æœ‰è‡ªå·±çš„ PIDï¼ˆä¾‹å¦‚ï¼ŒPID 1, 2, 3\u0026hellip;ï¼‰ï¼ŒåŒæ—¶åœ¨å®¿ä¸»æœºä¸Šä¹Ÿæœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ PIDã€‚è¿™æ„å‘³ç€ä»å®¿ä¸»æœºçœ‹ï¼Œæ‰€æœ‰å®¹å™¨çš„è¿›ç¨‹éƒ½æ˜¯æ™®é€šçš„è¿›ç¨‹ï¼Œåªæ˜¯è¢« PID å‘½åç©ºé—´éš”ç¦»å¼€æ¥ã€‚ ç¤ºä¾‹ å‡è®¾æˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šå¯åŠ¨ä¸€ä¸ª LXC å®¹å™¨ï¼Œå¹¶åœ¨å®¹å™¨å†…è¿è¡Œ bashã€‚\nå®¹å™¨å†…è§†è§’:\n1 2 3 4 5 6 # åœ¨å®¹å™¨å†…æ‰§è¡Œ ps aux USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 1 0.1 0.0 2384 1596 ? Ss 10:00 0:00 /sbin/init root 15 0.0 0.0 4372 3480 pts/0 Ss 10:01 0:00 bash root 25 0.0 0.0 5924 1788 pts/0 R+ 10:02 0:00 ps aux åœ¨è¿™é‡Œï¼Œinit è¿›ç¨‹çš„ PID æ˜¯ 1ï¼Œbash çš„ PID æ˜¯ 15ã€‚\nå®¿ä¸»æœºè§†è§’:\n1 2 3 4 # åœ¨å®¿ä¸»æœºæ‰§è¡Œ ps aux | grep bash # è¾“å‡ºå¯èƒ½åƒè¿™æ · root 12345 0.0 0.0 4372 3480 pts/0 Ss 10:01 0:00 bash åœ¨å®¿ä¸»æœºä¸Šï¼ŒåŒä¸€ä¸ª bash è¿›ç¨‹çš„ PID å¯èƒ½æ˜¯ 12345ã€‚è¿™ç§éš”ç¦»ä½¿å¾—å®¹å™¨å†…çš„è¿›ç¨‹ç®¡ç†ä¸å®¿ä¸»æœºå®Œå…¨åˆ†ç¦»ã€‚\n2. ç½‘ç»œå‘½åç©ºé—´ (Network Namespace) ç½‘ç»œå‘½åç©ºé—´ä¸ºæ¯ä¸ªå®¹å™¨æä¾›äº†ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ç½‘ç»œåè®®æ ˆã€‚\nåŸç† ç‹¬ç«‹ç½‘ç»œæ ˆï¼šæ¯ä¸ªç½‘ç»œå‘½åç©ºé—´éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ç½‘ç»œè®¾å¤‡ï¼ˆå¦‚ lo, eth0ï¼‰ã€IP åœ°å€ã€è·¯ç”±è¡¨ã€iptables é˜²ç«å¢™è§„åˆ™ã€ç«¯å£å·ç­‰ã€‚ä¸€ä¸ªå®¹å™¨é»˜è®¤æ— æ³•è®¿é—®å¦ä¸€ä¸ªå®¹å™¨æˆ–å®¿ä¸»æœºçš„ç½‘ç»œã€‚ veth è®¾å¤‡å¯¹ï¼šä¸ºäº†è®©å®¹å™¨èƒ½ä¸å¤–éƒ¨é€šä¿¡ï¼ŒLXC é€šå¸¸ä½¿ç”¨ veth (Virtual Ethernet) è®¾å¤‡å¯¹ã€‚veth è®¾å¤‡æ€»æ˜¯æˆå¯¹å‡ºç°ï¼Œåƒä¸€æ ¹è™šæ‹Ÿç½‘çº¿ã€‚æ•°æ®ä»ä¸€ç«¯è¿›å…¥ï¼Œä¼šä»å¦ä¸€ç«¯å‡ºæ¥ã€‚ è¿æ¥è¿‡ç¨‹: åˆ›å»ºä¸€å¯¹ veth è®¾å¤‡ï¼Œä¾‹å¦‚ veth_host å’Œ veth_containerã€‚ å°† veth_host ç•™åœ¨å®¿ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ä¸­ã€‚ å°† veth_container \u0026ldquo;ç§»åŠ¨\u0026rdquo; åˆ°å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¸­ï¼Œå¹¶å°†å…¶é‡å‘½åä¸º eth0ã€‚ åœ¨å®¿ä¸»æœºä¸Šï¼Œé€šå¸¸ä¼šåˆ›å»ºä¸€ä¸ªç½‘æ¡¥ï¼ˆä¾‹å¦‚ lxcbr0ï¼‰ï¼Œå¹¶å°† veth_host ç«¯è¿æ¥åˆ°è¿™ä¸ªç½‘æ¡¥ä¸Šã€‚ ä¸ºå®¹å™¨å†…çš„ eth0 åˆ†é… IP åœ°å€ã€‚ æ•°æ®æµ: å®¹å™¨å†… eth0 å‘å‡ºçš„ç½‘ç»œåŒ… -\u0026gt; é€šè¿‡ veth å¯¹åˆ°è¾¾å®¿ä¸»æœºçš„ veth_host -\u0026gt; è¿›å…¥å®¿ä¸»æœºçš„ç½‘æ¡¥ lxcbr0 -\u0026gt; é€šè¿‡å®¿ä¸»æœºçš„ç‰©ç†ç½‘å¡å’Œè·¯ç”±è§„åˆ™ä¸å¤–éƒ¨ç½‘ç»œé€šä¿¡ã€‚ è¿™ç§ç»“æ„ä½¿å¾—æ¯ä¸ªå®¹å™¨éƒ½åƒä¸€å°ç‹¬ç«‹çš„æœºå™¨è¿æ¥åˆ°äº†ä¸€ä¸ªè™šæ‹Ÿäº¤æ¢æœºï¼ˆç½‘æ¡¥ï¼‰ä¸Šï¼Œå®ç°äº†ç½‘ç»œéš”ç¦»å’Œäº’è”ã€‚\n3. æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´ (Mount Namespace) æ–‡ä»¶ç³»ç»Ÿï¼ˆæŒ‚è½½ï¼‰å‘½åç©ºé—´å…è®¸æ¯ä¸ªå®¹å™¨æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ï¼Œå°¤å…¶æ˜¯ç‹¬ç«‹çš„æ ¹ç›®å½• (/)ã€‚\nåŸç† éš”ç¦»æŒ‚è½½ç‚¹ï¼šæ¯ä¸ªæŒ‚è½½å‘½åç©ºé—´ç»´æŠ¤ç€ä¸€ä¸ªç‹¬ç«‹çš„æŒ‚è½½ç‚¹åˆ—è¡¨ã€‚åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­çš„ mount() å’Œ umount() æ“ä½œä¸ä¼šå½±å“åˆ°å…¶ä»–å‘½åç©ºé—´ã€‚ ç‹¬ç«‹çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ (rootfs)ï¼šLXC åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚å®¹å™¨è¿›ç¨‹çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„ä¸å®¿ä¸»æœºå®Œå…¨ä¸åŒã€‚ å®ç°æ–¹å¼: å‡†å¤‡ rootfsï¼šé¦–å…ˆï¼Œéœ€è¦ä¸ºå®¹å™¨å‡†å¤‡ä¸€ä¸ªç›®å½•ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå®Œæ•´çš„ Linux ç³»ç»Ÿæ‰€éœ€çš„æ–‡ä»¶å’Œç›®å½•ï¼ˆå¦‚ /bin, /etc, /lib, /usr ç­‰ï¼‰ã€‚è¿™é€šå¸¸é€šè¿‡å¤åˆ¶ä¸€ä¸ªæœ€å°åŒ–çš„ç³»ç»Ÿæ¨¡æ¿æ¥å®Œæˆã€‚ pivot_root ç³»ç»Ÿè°ƒç”¨ï¼šä¸ºäº†å°†å®¹å™¨çš„æ ¹ç›®å½•åˆ‡æ¢åˆ°å‡†å¤‡å¥½çš„ rootfsï¼ŒLXC ä½¿ç”¨ pivot_root ç³»ç»Ÿè°ƒç”¨ï¼ˆæˆ–è€…åœ¨æŸäº›æƒ…å†µä¸‹ä½¿ç”¨ chrootï¼Œä½† pivot_root æ›´å¼ºå¤§ã€æ›´å®‰å…¨ï¼‰ã€‚pivot_root ä¼šå°†å½“å‰è¿›ç¨‹çš„æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢åˆ°ä¸€ä¸ªæ–°çš„æŒ‚è½½ç‚¹ï¼ŒåŒæ—¶å°†æ—§çš„æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°æ–°æ ¹ä¸‹çš„ä¸€ä¸ªæŒ‡å®šç›®å½•ä¸­ï¼Œä¹‹åå¯ä»¥å°†å…¶å¸è½½ã€‚ éš”ç¦»æŒ‚è½½ï¼šåœ¨å®¹å™¨å¯åŠ¨åï¼Œå®ƒå¯ä»¥åœ¨è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´å†…è‡ªç”±åœ°æŒ‚è½½å…¶ä»–è®¾å¤‡æˆ–æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ proc, sysfs, tmpfsï¼‰ï¼Œè€Œè¿™äº›æŒ‚è½½å¯¹å®¿ä¸»æœºæ˜¯ä¸å¯è§çš„ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®¹å™¨å†…çš„è¿›ç¨‹è¢«\u0026quot;å›šç¦\u0026quot;åœ¨å…¶è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ä¸­ï¼Œæ— æ³•è®¿é—®æˆ–ä¿®æ”¹å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆé™¤éç‰¹åˆ«é…ç½®äº†ç»‘å®šæŒ‚è½½ bind mountï¼‰ã€‚\nå…¶ä»–å‘½åç©ºé—´ é™¤äº†ä»¥ä¸Šä¸‰ä¸ªï¼ŒLXC è¿˜ä½¿ç”¨äº†å…¶ä»–å‘½åç©ºé—´æ¥å®ç°å…¨æ–¹ä½éš”ç¦»ï¼š\nUTS Namespace: éš”ç¦»ä¸»æœºåå’ŒåŸŸåã€‚ IPC Namespace: éš”ç¦»è¿›ç¨‹é—´é€šä¿¡èµ„æºï¼Œå¦‚ System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ—ã€‚ User Namespace: éš”ç¦»ç”¨æˆ·å’Œç»„ IDã€‚å…è®¸å®¹å™¨å†…çš„ root ç”¨æˆ·ï¼ˆUID 0ï¼‰æ˜ å°„ä¸ºå®¿ä¸»æœºä¸Šçš„ä¸€ä¸ªéç‰¹æƒç”¨æˆ·ï¼Œæå¤§åœ°æå‡äº†å®‰å…¨æ€§ã€‚ Cgroup Namespace: éš”ç¦»æ§åˆ¶ç»„è§†å›¾ã€‚ æ€»ç»“ LXC é€šè¿‡ç²¾å·§åœ°ç»„åˆä½¿ç”¨ Linux å†…æ ¸çš„ Namespaces å’Œ Cgroups ç‰¹æ€§ï¼Œä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªè½»é‡çº§ã€é«˜æ•ˆä¸”éš”ç¦»æ€§è‰¯å¥½çš„å®¹å™¨ç¯å¢ƒã€‚PIDã€ç½‘ç»œå’Œæ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´æ˜¯å®ç°è¿™ç§éš”ç¦»çš„åŸºç¡€ï¼Œå®ƒä»¬åˆ†åˆ«åˆ›å»ºäº†ç‹¬ç«‹çš„è¿›ç¨‹æ ‘ã€ç½‘ç»œåè®®æ ˆå’Œæ–‡ä»¶ç³»ç»Ÿè§†å›¾ï¼Œä½¿å¾—å®¹å™¨å†…çš„ç¯å¢ƒçœ‹èµ·æ¥å°±åƒä¸€ä¸ªç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿã€‚\n","date":"2025-07-28T20:00:08+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/lxc%E8%AF%A6%E8%A7%A3/","title":"LXCè¯¦è§£"},{"content":"å¯¹ç§°åŠ å¯† åŠ å¯†å‰çš„åŸå§‹æ•°æ®ï¼Œå«åšÂ åŸæ–‡ï¼ˆÂ original textÂ ï¼‰ï¼Œæˆ–è€…Â æ˜æ–‡ï¼ˆÂ plain textÂ ï¼‰ï¼› åŠ å¯†åçš„ä¸è§„åˆ™ï¼ˆÂ scrambledÂ ï¼‰æ•°æ®ï¼Œé€šå¸¸å«åšÂ å¯†æ–‡ï¼ˆÂ cipher textÂ ï¼‰ï¼› åŠ å¯†æ‰€ç”¨çš„å¯†ç ï¼Œé€šå¸¸å«åšÂ å¯†é’¥ï¼ˆÂ secret keyÂ ï¼‰ï¼› å¯¹ç§°åŠ å¯†ï¼ˆsymmetric encryptionï¼‰ç®—æ³•æœ€å¤§çš„ç‰¹ç‚¹æ˜¯ï¼Œå®ƒåªæœ‰ä¸€æŠŠå¯†é’¥ï¼ŒåŠ å¯†å’Œè§£å¯†è¿‡ç¨‹ç”¨çš„éƒ½æ˜¯åŒä¸€æŠŠå¯†é’¥ï¼Œè¿™ä¹Ÿç¬¦åˆå¤§ä¼—å¯¹åŠ å¯†ç®—æ³•çš„è®¤çŸ¥ï¼Œç”¨å¯†ç å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ä¹‹åï¼Œå¿…é¡»ç”¨åŒä¸€ä¸ªå¯†ç æ‰èƒ½å°†æ•°æ®è§£å¯†å‡ºæ¥\nAESÂ ï¼Œé«˜çº§åŠ å¯†æ ‡å‡†ï¼Œæ–°ä¸€ä»£åŠ å¯†ç®—æ³•æ ‡å‡†ï¼Œé€Ÿåº¦å¿«ï¼Œå®‰å…¨çº§åˆ«é«˜ï¼› DESÂ ï¼Œæ•°æ®åŠ å¯†æ ‡å‡†ï¼Œé€Ÿåº¦è¾ƒå¿«ï¼Œé€‚ç”¨äºåŠ å¯†å¤§é‡æ•°æ®ï¼Œä½†å®‰å…¨æ€§è¾ƒå¼±ï¼› BlowfishÂ ï¼Œä½¿ç”¨å˜é•¿å¯†é’¥ï¼Œè¿è¡Œé€Ÿåº¦å¾ˆå¿«ï¼Œéä¸“åˆ©ç®—æ³•ï¼Œæ²¡æœ‰ä½¿ç”¨é™åˆ¶ï¼› etc éå¯¹ç§°åŠ å¯† ä»å‰æœ‰ä¸€ä¸ªé»‘å¸®ï¼Œè€å¤§å’Œæ‰‹ä¸‹ä»¬ä¹‹é—´çš„é€šä¿¡å¿…é¡»åŠ å¯†ç¡®ä¿å®‰å…¨ã€‚äºæ­¤åŒæ—¶ï¼Œè€å¤§å¸Œæœ›æ‰‹ä¸‹å‘ç»™ä»–çš„ä¿¡æ¯ï¼Œä¸èƒ½è¢«å…¶ä»–æ‰‹ä¸‹çŸ¥æ™“ã€‚è‹¥é‡‡ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œåªèƒ½ç»™æ¯ä¸ªæ‰‹ä¸‹éƒ½åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„å¯†é’¥ï¼Œä½†è€å¤§è§‰å¾—å¤ªéº»çƒ¦äº†ã€‚è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\né»‘å¸®è€å¤§å¸Œæœ›ä»–åªç»´æŠ¤ä¸€ä»½å¯†é’¥ï¼Œå°±èƒ½è¾¾åˆ°è¿™æ ·çš„æ•ˆæœï¼Œæœ‰åŠæ³•åšåˆ°å—ï¼Ÿ\nå¯ä»¥ç”¨éå¯¹ç§°åŠ å¯†ï¼ˆasymmetric encryptionï¼‰\néå¯¹ç§°åŠ å¯†ï¼Œé¡¾æ˜æ€è®®ï¼Œåœ¨åŠ å¯†å’Œè§£å¯†ç¯èŠ‚ç”¨çš„å¯†é’¥æ˜¯ä¸åŒçš„ã€‚\néå¯¹ç§°åŠ å¯†ç®—æ³•éœ€è¦ä¸¤æŠŠä¸åŒçš„å¯†é’¥ï¼Œè¿™ä¸¤æŠŠå¯†é’¥ç»„æˆä¸€å¯¹ï¼š\nå…¬é’¥ï¼ˆÂ public keyÂ ï¼‰ï¼Œå…¬é’¥ç”¨æ¥å¯¹æ•°æ®è¿›è¡ŒÂ åŠ å¯†Â ï¼› ç§é’¥ï¼ˆÂ private keyÂ ï¼‰ï¼Œä¹Ÿç§°ä¸ºÂ å¯†é’¥ï¼ˆÂ secret keyÂ ï¼‰ï¼Œç”¨æ¥å¯¹æ•°æ®è¿›è¡ŒÂ è§£å¯†Â ï¼› å…¬é’¥å’Œç§é’¥æ€»æ˜¯æˆå¯¹å‡ºç°ï¼Œç”¨å…¬é’¥åŠ å¯†åå¾—åˆ°çš„å¯†æ–‡ï¼Œå¿…é¡»ç”¨å¯¹åº”çš„ç§é’¥æ‰èƒ½è§£å¯†ï¼› è¿™å¥—åŠ å¯†æœºåˆ¶å®Œç¾è§£å†³äº†é»‘å¸®è€å¤§çš„éš¾é¢˜ï¼Œä»–åªéœ€è¦ç”Ÿæˆä¸€å¯¹å¯†é’¥ï¼šå…¬é’¥åˆ†å‘ç»™æ‰‹ä¸‹ä»¬ï¼Œä»–ä»¬å…ˆç”¨å…¬é’¥åŠ å¯†ä¿¡æ¯ï¼Œå†å‘è€å¤§ï¼›è€å¤§æ¥åˆ°å¯†æ–‡ï¼Œå°±ç”¨è‡ªå·±ä¿ç®¡çš„ç§é’¥æ¥è§£å¯†ï¼›æ‰‹ä¸‹ä»¬å°±ç®—æ‹¿åˆ°åˆ«äººå‘çš„å¯†æ–‡ä¹Ÿè§£ä¸å¼€ï¼Œå› ä¸ºç§é’¥åªæœ‰ä»–ä»¬è€å¤§æ‰æœ‰ã€‚\næ•°å­¦åŸç† å…¬é’¥å’Œç§é’¥çš„åŠ å¯†æœºåˆ¶çœ‹èµ·æ¥éå¸¸ä¸å¯æ€è®®ï¼Œè¿™ä¸€åˆ‡å…¶å®æ¥ä¸€ä¸ªç¥å¥‡çš„æ•°å­¦åŸç†ã€‚\næˆ‘ä»¬æ¥åšä¸€ä¸ªæ•°å­—æ¸¸æˆï¼Œæ‚¨éšä¾¿å†™ä¸‹ä¸€ä¸ªæ•´æ•°Â mÂ ï¼ˆ1\u0026lt;m\u0026lt;7387Â ï¼‰ï¼Œç„¶åè®¡ç®—m ^3 mod 7387Â å¹¶æŠŠç»“æœå‘Šè¯‰æˆ‘ï¼Œæˆ‘å°±çŸ¥é“æ‚¨å†™ä¸‹çš„æ•´æ•°Â mÂ æ˜¯ä»€ä¹ˆ\n1 2 3 4 5 6 7 8 9 10 11 # 520 \u0026gt;\u0026gt;\u0026gt; 520 ** 3 % 7387 3842 \u0026gt;\u0026gt;\u0026gt; 3842 ** 4811 % 7387 520 # 1314 \u0026gt;\u0026gt;\u0026gt; 1314 ** 3 % 7387 7382 \u0026gt;\u0026gt;\u0026gt; 7382 ** 4811 % 7387 1314 å…¬é’¥å‚æ•° 3 å’Œ 7387 ï¼Œç§é’¥å‚æ•° 4811 å’Œ 7387 åˆæ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿ ç¬¬ä¸€æ­¥ï¼Œéšæœºé€‰æ‹©ä¸¤ä¸ªè´¨æ•° p å’Œ q ï¼š p = 83 q = 89 ç¬¬äºŒæ­¥ï¼Œè®¡ç®— p å’Œ q çš„ä¹˜ç§¯ n ï¼š n = p * q = 7387 ç¬¬ä¸‰æ­¥ï¼Œè®¡ç®— n çš„æ¬§æ‹‰å‡½æ•° ï¼Œè®°ä¸º phi ï¼š Ï†(n) = (p-1) * (q-1) = 7216 ç¬¬å››æ­¥ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªæ•´æ•° e ï¼Œæ»¡è¶³1\u0026lt;e\u0026lt;Ï†(n)ï¼Œä¸” e å’ŒÏ†(n)äº’è´¨ï¼š é€‰ä¸€ä¸ªè´¨æ•° e ï¼Œä½¿å¾—ä¸èƒ½è¢« e æ•´é™¤å³å¯ã€‚ ç¬¬äº”æ­¥ï¼Œè®¡ç®— e å¯¹Ï†(n)çš„æ¨¡åå…ƒç´  d ï¼Œå³æ‰¾åˆ°ä¸€ä¸ªæ•° d ä½¿å¾— ed é™¤ä»¥Ï†(n)çš„ä½™æ•°ä¸º 1 ï¼š ed â‰¡ 1 mod(Ï† ( n )) \u0026lt;=\u0026gt; ed = kÏ†(n) + 1 å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªd :4811\nå®‰å…¨æ€§åˆ†æ é‚£ä¹ˆï¼Œæœ‰æ— å¯èƒ½åœ¨å·²çŸ¥nå’Œeçš„æƒ…å†µä¸‹ï¼Œæ¨å¯¼å‡ºdï¼Ÿ\n1 2 3 edâ‰¡1 (mod Ï†(n))ã€‚åªæœ‰çŸ¥é“eå’ŒÏ†(n)ï¼Œæ‰èƒ½ç®—å‡ºdã€‚ Ï†(n)=(p-1)(q-1)ã€‚åªæœ‰çŸ¥é“på’Œqï¼Œæ‰èƒ½ç®—å‡ºÏ†(n)ã€‚ n=pqã€‚åªæœ‰å°†nå› æ•°åˆ†è§£ï¼Œæ‰èƒ½ç®—å‡ºpå’Œqã€‚ å¤§æ•´æ•°çš„å› æ•°åˆ†è§£ï¼Œæ˜¯ä¸€ä»¶éå¸¸å›°éš¾çš„äº‹æƒ…\nç›®å‰ï¼Œèƒ½å¤Ÿè¢«ç ´è§£çš„Â nÂ æœ€å¤§ä½æ•°æ˜¯Â 768Â ä½(è¿™é‡Œæåˆ°çš„ä½æ˜¯æŒ‡äºŒè¿›åˆ¶ä½)ï¼Œå› æ­¤æœ‰äººå¼€å§‹è´¨ç–‘Â 1024Â ä½å¯†é’¥çš„å®‰å…¨æ€§ã€‚ç°åœ¨æ¨èçš„å¯†é’¥é•¿åº¦è‡³å°‘è¦Â 2048Â ä½ï¼Œåªè¦é•¿åº¦è¶³å¤Ÿï¼Œå®‰å…¨æ€§å®Œå…¨ä¸ç”¨æ‹…å¿ƒ\nåº”ç”¨åœºæ™¯ åŠ å¯† å…¬é’¥åŠ å¯†ç§é’¥è§£å¯†æ˜¯éå¯¹ç§°åŠ å¯†ç®—æ³•æœ€å…¸å‹çš„åº”ç”¨åœºæ™¯ï¼Œç‰¹åˆ«é€‚ç”¨äºå¯†é’¥éœ€è¦å…¬å¼€çš„åœºæ™¯ï¼Œæ¯”å¦‚ ä¼ è¾“å±‚å®‰å…¨åè®®Â TLSÂ ï¼Œå®ƒä¸ºé€šè®¯åŒæ–¹æä¾›å¯é çš„åŠ å¯†è¿æ¥\nå¦‚æœæ²¡æœ‰éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼ŒTLSÂ å°†æ— æ³•å®ç°ã€‚å› ä¸ºå¯¹ç§°åŠ å¯†ç®—æ³•è¦æ±‚åŒæ–¹ä½¿ç”¨åŒä¸€å¯†é’¥ï¼ŒåŠ å¯†è¿æ¥å»ºç«‹ä¹‹å‰ï¼Œåªèƒ½æ˜æ–‡åå•†å¯†é’¥ã€‚è¯•æƒ³æµè§ˆå™¨æƒ³è·ŸæœåŠ¡å™¨å»ºç«‹å®‰å…¨è¿æ¥ï¼Œæ— è®ºæ˜¯å®ƒé€‰å®šå¯†é’¥ç„¶åå‘ç»™æœåŠ¡å™¨ï¼Œè¿˜æ˜¯æœåŠ¡å™¨é€‰å®šå¯†é’¥å‘ç»™å®ƒï¼Œåªè¦å¯†é’¥ç»è¿‡æ˜æ–‡ä¼ è¾“ï¼ŒåŠ å¯†å°±å¤±å»æ„ä¹‰ã€‚\næœ‰äº†éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼ŒæœåŠ¡å™¨å¯ä»¥ç”Ÿæˆä¸€å¯¹å¯†é’¥ï¼Œç§é’¥è‡ªå·±ä¿ç®¡ï¼Œå…¬é’¥å¯ä»¥å…¬å¼€ã€‚å½“æµè§ˆå™¨è¯·æ±‚å»ºç«‹åŠ å¯†è¿æ¥æ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥å°†å…¬é’¥å‘ç»™æµè§ˆå™¨ï¼Œå› ä¸ºå…¬é’¥æ˜¯å¯ä»¥å…¬å¼€çš„ã€‚æµè§ˆå™¨å°†æ•æ„Ÿä¿¡æ¯ç”¨å…¬é’¥åŠ å¯†åå†å‘ç»™æµè§ˆå™¨ï¼Œåªæœ‰æŒæ¡ç§é’¥çš„æœåŠ¡å™¨æ‰èƒ½è§£å¯†ï¼Œä»–äººä¾¿æ— æ³•çŸ¥æ™“ã€‚\nåŒç†ï¼ŒæœåŠ¡å™¨æƒ³å‘æ•æ„Ÿä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼Œå¿…é¡»ç”±å®¢æˆ·ç«¯ç”Ÿæˆçš„å…¬é’¥åŠ å¯†ã€‚æ¢å¥è¯è®²ï¼Œæ¯å¯¹å¯†é’¥è§£å†³ä¸€ä¸ªæ–¹å‘çš„åŠ å¯†é—®é¢˜ï¼Œé€šè®¯åŒæ–¹éƒ½éœ€è¦ç”Ÿæˆè‡ªå·±çš„å¯†é’¥å¯¹ï¼Œè´Ÿè´£åŠ å¯†å¯¹æ–¹å‘æ¥çš„æ•°æ®ã€‚\nç”±äºéå¯¹ç§°åŠ å¯†ç®—æ³•è¿ç®—å¤æ‚ï¼ŒåŠ å¯†æ•ˆç‡ä¸é«˜ï¼Œé€šå¸¸åªæ˜¯ç”¨æ¥åŠ å¯†å°‘é‡çš„å…³é”®ä¿¡æ¯ï¼Œæ¯”å¦‚åå•†å¯†é’¥ã€‚å›åˆ°Â TLSÂ è¿™ä¸ªä¾‹å­ï¼Œå…¶å®å¯ä»¥å€ŸåŠ©éå¯¹ç§°åŠ å¯†ç®—æ³•åå•†å¯†é’¥ï¼Œä»è€Œç›´æ¥ä½¿ç”¨æ›´é«˜æ•ˆçš„å¯¹ç§°åŠ å¯†ç®—æ³•æ¥åŠ å¯†æ•°æ®ï¼š\næœåŠ¡å™¨ç”Ÿæˆå…¬é’¥å’Œç§é’¥ å¯¹ï¼› å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰è¿æ¥ä¸Šæ¥åï¼ŒæœåŠ¡å™¨å°†å…¬é’¥å‘ç»™å®¢æˆ·ç«¯ï¼› å®¢æˆ·ç«¯éšæœºç”Ÿæˆä¸€ä¸ªç”¨äºå¯¹ç§°åŠ å¯†ï¼ˆÂ AESÂ ï¼‰çš„å¯†é’¥ï¼› å®¢æˆ·ç«¯ç”¨å…¬é’¥å¯¹ç”Ÿæˆçš„å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œç„¶ååå‘ç»™æœåŠ¡å™¨ï¼› æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯ç”¨å…¬é’¥åŠ å¯†çš„å¯†é’¥åï¼Œç”¨è‡ªå·±çš„ç§é’¥è§£å¯†ï¼Œè‡³æ­¤å¯†é’¥åå•†å®Œæ¯•ï¼› ç”±äºç§é’¥åªæœ‰æœåŠ¡å™¨æ‰æœ‰ï¼Œå› æ­¤ç¬¬ä¸‰æ–¹æ— æ³•çŸ¥æ™“å®¢æˆ·ç«¯é€‰å®šçš„å¯†é’¥æ˜¯å•¥ï¼› æ­¤åé€šä¿¡åŒæ–¹é‡‡ç”¨å¯¹ç§°åŠ å¯†ï¼Œä»¥è¯¥å¯†é’¥åŠ å¯†æ•°æ®ï¼› ç­¾å å®é™…ä¸Šï¼Œç§é’¥ä¹Ÿå¯ä»¥ç”¨æ¥åŠ å¯†æ•°æ®ï¼ŒåŠ å¯†åçš„å¯†æ–‡åªæœ‰å…¬é’¥æ‰èƒ½è§£å¯†ã€‚å°½ç®¡å¦‚æ­¤ï¼Œç”±äºå…¬é’¥æ˜¯å…¬å¼€çš„ï¼Œå› æ­¤è¿™ä¸ªæœºåˆ¶ä¸èƒ½æ¥åŠ å¯†æ•°æ®ï¼Œä½†å¯ä»¥å¯¹ç”¨æ¥å¯¹æ•°æ®è¿›è¡Œç­¾åé˜²ä¼ªã€‚\næ•°å­—è¯ä¹¦(certificate) ä¿¡æ¯æ‘˜è¦ï¼ˆÂ digestÂ ï¼‰ï¼Œæ•°æ®ç»è¿‡å“ˆå¸Œç®—æ³•å¾—åˆ°çš„ä¸€ä¸²å“ˆå¸Œå€¼ï¼Œä»£è¡¨æ•°æ®çš„ç‰¹å¾ï¼Œä¹Ÿç§°ä¸ºæ•°æ®æŒ‡çº¹ï¼› æ‘˜è¦ç®—æ³•Â ï¼Œå¯ä»¥æŠŠä»»æ„é•¿åº¦çš„æ•°æ®ï¼Œæ˜ å°„æˆä¸€ä¸ªå®šé•¿çš„å­—ç¬¦ä¸²ï¼ˆå“ˆå¸Œå€¼ï¼‰ï¼› ç”±äºå“ˆå¸Œå†²çªçš„å­˜åœ¨ï¼Œä¸¤ä»½ä¸åŒçš„æ•°æ®ï¼Œæœ‰å¯èƒ½ç®—å‡ºç›¸åŒçš„æ‘˜è¦å€¼ï¼› æ‘˜è¦ç®—æ³•æ— æ³•ç”¨äºæ•°æ®åŠ å¯†ï¼Œé€šå¸¸ç”¨æ¥æ ¡éªŒæ•°æ®å®Œæ•´æ€§ï¼Œå³Â æ•°æ®é˜²ä¼ªÂ ï¼› å¸¸è§çš„æ‘˜è¦ç®—æ³•æœ‰ï¼šMD5Â ã€SHA1Â ã€SHA256Â ã€SHA512Â ã€‚ æ•°å­—ç­¾åï¼ˆÂ signatureÂ ï¼‰ï¼Œæ‘˜è¦ç”±ç§é’¥åŠ å¯†åï¼Œå¾—åˆ°çš„æ‘˜è¦å¯†æ–‡å°±æ˜¯æ•°å­—ç­¾åï¼› ç­¾åï¼Œç”±æ•°æ®å‘é€æ–¹ç”Ÿæˆï¼Œè¿™æ˜¯ä¸€ä¸ªÂ åŠ å¯†Â è¿‡ç¨‹ï¼ˆä½¿ç”¨ç§é’¥ï¼‰ï¼› éªŒç­¾ï¼Œç”±æ•°æ®æ¥æ”¶æ–¹æ ¡éªŒï¼Œè¿™æ˜¯ä¸€ä¸ªÂ è§£å¯†Â è¿‡ç¨‹ï¼ˆä½¿ç”¨å…¬é’¥ï¼‰ï¼› æ•°å­—ç­¾ååªèƒ½ç”±ç§é’¥ç”Ÿæˆï¼Œå› æ­¤ç¬¬ä¸‰æ–¹æ— æ³•ä¼ªé€ ï¼› åœ¨ä»‹ç»å¯†é’¥åå•†æ—¶ï¼Œæˆ‘ä»¬æåˆ°æœåŠ¡å™¨å…ˆå°†å…¬é’¥å‘ç»™å®¢æˆ·ç«¯ï¼Œç”¨å…¬é’¥ä¿æŠ¤å¯¹ç§°åŠ å¯†å¯†é’¥ï¼Œç¡®ä¿é€šä¿¡å†…å®¹ä¸ä¼šè¢«ç¬¬ä¸‰æ–¹è·æ‚‰ã€‚ä½†å¦‚æœå®¢æˆ·ç«¯è¿æ¥çš„æœåŠ¡å™¨æ˜¯å‡çš„å‘¢ï¼Ÿå¦‚æœç”¨æˆ·å¯¹å‡ç½‘ç«™ä¿¡ä»¥ä¸ºçœŸï¼Œè¾“å…¥äº†è´¦å·å¯†ç ï¼Œé‚£ä¹ˆè¿™äº›æ•æ„Ÿä¿¡æ¯éƒ½ä¼šè¢«å‡ç½‘ç«™çªƒå–ï¼\nä¸ŠèŠ‚æˆ‘ä»¬ä¹Ÿè®¨è®ºäº†æ•°å­—ç­¾åï¼Œé€šè¿‡å®ƒå¯ä»¥å®ç°æ•°æ®é˜²ä¼ªã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥åˆ©ç”¨è¿™é¡¹æŠ€æœ¯æ¥ç”„åˆ«ä»¿å†’ç«™ç‚¹å‘¢\næƒå¨æœºæ„ç”Ÿæˆä¸€å¯¹å¯†é’¥ï¼Œå¹¶æä¾›ç«™ç‚¹è®¤è¯å®¡æ ¸å’Œæ•°å­—ç­¾åé¢å‘æœåŠ¡ï¼› ç«™ç‚¹ç®¡ç†å‘˜å°†ç«™ç‚¹ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŸŸåã€è¿è¥å•ä½ã€å…¬é’¥ç­‰ä¿¡æ¯å‘ç»™æƒå¨æœºæ„å®¡æ ¸ï¼› æƒå¨æœºæ„å¯¹æäº¤ä¸Šæ¥çš„ç«™ç‚¹ä¿¡æ¯è¿›è¡Œå®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡åˆ™ç”¨ç§é’¥ç­¾ååè¿”å›ç»™ç«™ç‚¹ç®¡ç†å‘˜ï¼› å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰è¿æ¥ç«™ç‚¹æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å°†ç«™ç‚¹ä¿¡æ¯ä»¥åŠå¯¹åº”çš„æ•°å­—ç­¾åå‘ç»™å®¢æˆ·ç«¯ï¼› å®¢æˆ·ç«¯ç”¨æƒå¨æœºæ„æä¾›çš„å…¬é’¥æ¥æ ¡éªŒæ•°å­—ç­¾åï¼Œå³å¯åˆ¤æ–­ç«™ç‚¹ä¿¡æ¯çš„çœŸä¼ªæ€§ï¼› ç­¾åéªŒè¯é€šè¿‡ï¼Œå®¢æˆ·ç«¯ä»ç«™ç‚¹ä¿¡æ¯ä¸­å–å‡ºå…¬é’¥ï¼Œä¸æœåŠ¡ç«¯åå•†å¯†é’¥ï¼Œå‘èµ·åŠ å¯†é€šä¿¡ï¼› ç”±äºç­¾åç”¨çš„ç§é’¥åªæœ‰æƒå¨æœºæ„æŒæ¡ï¼Œé»‘å®¢æ— æ³•ä¼ªé€ æ•°å­—ç­¾åï¼Œä¹Ÿå°±æ— æ³•æ¶è®¾ä»¿å†’ç«™ç‚¹ï¼› æƒå¨æœºæ„å¿…é¡»ç”±å¯ä¿¡çš„å•ä½è¿è¥ï¼› ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œé»‘å®¢ç›´æ¥ç›—ç”¨ç«™ç‚¹ä¿¡æ¯å’Œç­¾åä¸å°±å¯ä»¥ä¼ªé€ åŸç«™ç‚¹äº†å˜›ï¼Ÿæ­¤è¨€å·®çŸ£ï¼å› ä¸ºå…¬é’¥å±äºç«™ç‚¹ä¿¡æ¯\nçš„ä¸€ éƒ¨åˆ†ï¼Œä¹Ÿä¼šå‚ä¸ç­¾åï¼å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åå•†å¯†é’¥æ—¶ï¼Œä¼šä½¿ç”¨è¿™ä¸ªå…¬é’¥åŠ å¯†å¯†é’¥ã€‚ç”±äºé»‘å®¢ä¸æŒæ¡ç«™ç‚¹ç§ é’¥ï¼Œå› æ­¤ åŠ å¯†è¿æ¥æ— æ³•å»ºç«‹ï¼é»‘å®¢æŠŠå…¬é’¥æ›¿æ¢æˆè‡ªå·±çš„å§ï¼Œç­¾åå°±ä¸å¯¹ï¼Œè‚¯å®šä¼šè¢«éªŒå‡ºæ¥ï¼\nè¯ä¹¦ç­¾å‘å®éªŒ CAæƒå¨æœºæ„ é¦–å…ˆï¼Œæƒå¨æœºæ„éœ€è¦ç”Ÿæˆä¸€å¯¹å¯†é’¥ï¼Œcakey.pem æ˜¯ç§é’¥,\n1 openssl genrsa -out cakey.pem 2048 ç„¶åï¼Œç”Ÿæˆæ ¹è¯ä¹¦ç­¾å‘ç”³è¯·æ–‡ä»¶ï¼ˆ csr æ–‡ä»¶ï¼‰ï¼š\n1 openssl req -new -key cakey.pem -out ca.csr -subj \u0026#39;/C=CN/ST=Guangdong/L=Guangzhou/O=coding-fans/OU=CA/CN=ca.fasionchan.com\u0026#39; è¯ä¹¦ç”³è¯·æ–‡ä»¶åŒ…å«æƒå¨æœºæ„çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœºæ„ä¿¡æ¯(SubjectÂ )å’Œå…¬é’¥(Public KeyÂ éƒ¨åˆ†)å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹ï¼š\n1 openssl req -in ca.csr -text -noout æœ€åï¼Œè‡ªç­¾æ ¹è¯ä¹¦ï¼ˆÂ cerÂ æ–‡ä»¶ ï¼‰ï¼š\n1 openssl x509 -req -days 3650 -sha1 -extensions v3_ca -signkey cakey.pem -in ca.csr -out ca.cer è¿™ä¸€æ­¥ç”Ÿæˆçš„Â cerÂ æ–‡ä»¶å°±æ˜¯æ ¹è¯ä¹¦æ–‡ä»¶ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ‰¿è½½æƒå¨æœºæ„å…¬é’¥ï¼Œä»¥ä¾¿é¢„è£…åœ¨æ“ä½œç³»ç»Ÿæˆ–è€…å…¶ä»–ç»ˆç«¯ã€‚å®ƒåŒæ ·ä¼šåŒ…å«æƒå¨æœºæ„çš„ä¿¡æ¯ï¼Œå…¬é’¥ï¼Œä»¥åŠå¯¹åº”çš„ç­¾åã€‚\nå•†ä¸šç«™ç‚¹ï¼ˆæœåŠ¡ç«¯ï¼‰ é¦–å…ˆï¼Œç«™ç‚¹ç®¡ç†å‘˜ç”Ÿæˆä¸€å¯¹å¯†é’¥\n1 openssl genrsa -out sitekey.pem 2048 ç„¶åï¼Œç”Ÿæˆè¯ä¹¦ç­¾å‘ç”³è¯·æ–‡ä»¶ï¼ˆ csr æ–‡ä»¶ï¼‰ï¼š\n1 openssl req -new -key sitekey.pem -out site.csr -subj \u0026#39;/C=CN/ST=Guangdong/L=Guangzhou/O=fasionchan/OU=website/CN=fasionchan.co è¯ä¹¦ç”³è¯·æ–‡ä»¶åŒ…å«ç«™ç‚¹ä¿¡æ¯å’Œå…¬é’¥ï¼Œç«™ç‚¹ç®¡ç†å‘˜å°†è¯ä¹¦ç”³è¯·æ–‡ä»¶å‘ç»™æƒå¨æœºæ„å®¡æ ¸ï¼Œ\næƒå¨æœºæ„å¯¹ç”³è¯·è¿›è¡Œå®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡åˆ™ç”¨è‡ªå·±çš„ç§é’¥å¯¹å®ƒè¿›è¡Œç­¾åï¼Œç”Ÿæˆè¯ä¹¦(cer æ–‡ä»¶):\n1 openssl x509 -req -days 365 -sha1 -extensions v3_req -CA ca.cer -CAkey cakey.pem -CAserial ca.srl -CAcreateserial -in site.csr -out site.cer è¯ä¹¦ä¸­ä¿å­˜ç€åŒ…æ‹¬å…¬é’¥åœ¨å†…çš„ç«™ç‚¹ä¿¡æ¯ï¼Œä»¥åŠæƒå¨æœºæ„å¯¹è¿™äº›ä¿¡æ¯çš„ç­¾åã€‚ç®¡ç†å‘˜æ¥åˆ°æƒå¨æœºæ„é¢å‘çš„è¯ä¹¦ï¼Œå°±å¯ä»¥éƒ¨ç½²ç½‘ç«™äº†\næµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰ å®¢æˆ·ç«¯æµè§ˆå™¨è®¿é—®ç«™ç‚¹ï¼ŒæœåŠ¡ç«¯ä¼šå°†å…¶è¯ä¹¦å‘ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯å…ˆå¯¹è¯ä¹¦ç­¾åè¿›è¡ŒéªŒè¯ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š\né‡æ–°å¯¹è¯ä¹¦ä¸­çš„ç«™ç‚¹ä¿¡æ¯è®¡ç®—Â æ‘˜è¦å€¼Â ï¼› ç”¨å…¬é’¥å¯¹è¯ä¹¦ä¸­çš„ç­¾åè¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°è¯ä¹¦çš„åŸå§‹æ‘˜è¦å€¼ï¼› å…¬é’¥é€šå¸¸ç”±æ ¹è¯ä¹¦æä¾›ï¼Œæ ¹è¯ä¹¦é€šå¸¸é¢„è£…åœ¨ç³»ç»Ÿé‡Œï¼› å¯¹æ¯”ä¸¤ä¸ªæ‘˜è¦å€¼çœ‹æ˜¯å¦ä¸€è‡´ï¼› è°ƒç”¨Â opensslÂ å·¥å…·ï¼Œä¸€è¡Œå‘½ä»¤å³å¯å®Œæˆç­¾åéªŒè¯\n1 openssl verify -CAfile ca.cer site.cer æ€»ç»“ æ•°å­—è¯ä¹¦æ˜¯æ”¯æ’‘äº’è”ç½‘èº«ä»½è®¤è¯çš„é‡è¦æŠ€æœ¯æ‰‹æ®µï¼Œå¯ä»¥ç®€å•ç†è§£æˆç»è¿‡Â CAÂ æƒå¨ç»“æ„ç­¾åè®¤è¯è¿‡çš„ç«™ç‚¹ä¿¡æ¯ã€‚ç”±äºç»è¿‡Â CAÂ ç­¾åï¼Œç¬¬ä¸‰æ–¹æ— æ³•é€šè¿‡ä¼ªé€ æ‰‹æ®µå†’å……èº«ä»½ã€‚\nè¯ä¹¦ç”±ç«™ç‚¹ä¿¡æ¯å’ŒÂ CAÂ ç­¾åç»„æˆï¼Œç«™ç‚¹ä¿¡æ¯åŒ…å«ç«™ç‚¹å…¬é’¥ï¼Œå…¬é’¥ç”¨äºåå•†å¯¹ç§°åŠ å¯†å¯†é’¥ï¼› è¯ä¹¦ç”±Â CAÂ æƒå¨æœºæ„å®¡æ ¸ç­¾å‘ï¼Œç­¾åç”¨çš„æ˜¯Â CAÂ çš„ç§é’¥ï¼› CAÂ å…¬é’¥é€šå¸¸ä»¥æ ¹è¯ä¹¦å½¢å¼é¢„è£…åœ¨ç³»ç»Ÿå†…ï¼Œå®¢æˆ·ç«¯é€šè¿‡å®ƒæ¥éªŒè¯è¯ä¹¦ç­¾åï¼› æœ‰äº†æ•°å­—ç­¾åï¼Œé»‘å®¢æ— æ³•å¯¹è¯ä¹¦è¿›è¡Œç¯¡æ”¹ï¼Œä¹Ÿæ— æ³•ä¼ªé€ è¯ä¹¦ï¼Œå› æ­¤æ— æ³•éƒ¨ç½²ä»¿å†’ç«™ç‚¹ï¼› è‹¥åªçªƒå–åŸç«™ç‚¹è¯ä¹¦ï¼Œä¸åšç¯¡æ”¹ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨çœŸå®ç«™ç‚¹çš„å…¬é’¥ï¼Œè€Œé»‘å®¢æ— æ³•æŒæ¡ç«™ç‚¹ç§é’¥ï¼Œå› æ­¤åŠ å¯†è¿æ¥æ— æ³•å»ºç«‹ï¼› å¦‚æœç¯¡æ”¹åŸç«™ç‚¹è¯ä¹¦ï¼Œæ¢ä¸Šè‡ªå·±çš„å…¬é’¥ï¼Œä½†å› ä¸ºæ²¡æœ‰Â CAÂ ç§é’¥æ— æ³•ç”Ÿæˆåˆæ³•ç­¾åï¼Œä¹Ÿä¼šè¢«è¯†åˆ«å‡ºæ¥ï¼› è½¬è½½è‡ªæ•°å­—è¯ä¹¦èº«ä»½è®¤è¯åŸç†ä¸ç­¾å‘æ­¥éª¤è¯¦è§£ | å°èœå­¦ç½‘ç»œ\n","date":"2025-07-28T16:36:08+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3/","title":"è¯ä¹¦è¯¦è§£"},{"content":"RESTful API ä¸€ã€RESTful APIæ¦‚è¿° 1.1 å®šä¹‰ RESTï¼ˆRepresentational State Transferï¼‰å³è¡¨ç°å±‚çŠ¶æ€è½¬ç§»ï¼Œæ˜¯ä¸€ç§é’ˆå¯¹ç½‘ç»œåº”ç”¨çš„è®¾è®¡é£æ ¼ï¼Œä¸»è¦ç”¨äºè®¾è®¡åˆ†å¸ƒå¼è¶…åª’ä½“ç³»ç»Ÿã€‚RESTful API åˆ™æ˜¯éµå¾ª REST æ¶æ„åŸåˆ™çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œå…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡ HTTP åè®®è¿›è¡Œäº¤äº’ã€‚å®ƒé‡‡ç”¨èµ„æºå®šä½çš„æ€ç»´æ¨¡å¼ï¼Œå°†æ‰€æœ‰çš„æ“ä½œéƒ½è§†ä¸ºå¯¹èµ„æºçš„æ“ä½œï¼Œä»¥ä½¿ç³»ç»Ÿæ›´åŠ ç®€æ´ã€æ˜“äºç†è§£å’Œæ‰©å±•ã€‚\n1.2 æ ¸å¿ƒæ¦‚å¿µ èµ„æºï¼ˆResourceï¼‰ï¼šRESTful API ä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡ã€å®ä½“æˆ–æ•°æ®éƒ½è¢«æŠ½è±¡ä¸ºä¸€ä¸ªèµ„æºã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·ã€æ–‡ç« ç­‰éƒ½å¯ä»¥ä½œä¸ºèµ„æºã€‚æ¯ä¸ªèµ„æºéƒ½é€šè¿‡ä¸€ä¸ªå”¯ä¸€çš„ URIï¼ˆç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼‰æ ‡è¯†ã€‚æ¯”å¦‚ï¼Œ/users/123 è¡¨ç¤º id ä¸º 123 çš„ç”¨æˆ·èµ„æºï¼Œ/posts/456 è¡¨ç¤º id ä¸º 456 çš„æ–‡ç« èµ„æºã€‚ URIï¼ˆç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼‰ï¼šç”¨äºæ ‡è¯†èµ„æºçš„åœ°å€ï¼Œé€šå¸¸ä½¿ç”¨ URLï¼ˆç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼‰ä½œä¸º URIã€‚ HTTP åŠ¨ä½œï¼ˆHTTP Methodsï¼‰ï¼šä¾èµ–äº HTTP åè®®çš„å¸¸è§æ–¹æ³•æ¥å¯¹èµ„æºè¿›è¡Œæ“ä½œï¼Œæ¯ä¸ª HTTP æ–¹æ³•å¯¹åº”ä¸åŒçš„æ“ä½œï¼š GETï¼šè·å–æœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚ POSTï¼šåœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºæ–°çš„èµ„æºã€‚ PUTï¼šæ›´æ–°æœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚ DELETEï¼šåˆ é™¤æœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚ æ— çŠ¶æ€ï¼ˆStatelessnessï¼‰ï¼šæ¯ä¸ªè¯·æ±‚éƒ½åº”è¯¥æ˜¯ç‹¬ç«‹çš„ï¼ŒæœåŠ¡å™¨ä¸ä¼šåœ¨è¯·æ±‚ä¹‹é—´ä¿å­˜å®¢æˆ·ç«¯çš„çŠ¶æ€ã€‚æ¯æ¬¡è¯·æ±‚éƒ½å¿…é¡»åŒ…å«ç†è§£è¯·æ±‚æ‰€å¿…éœ€çš„ä¿¡æ¯ã€‚ è¡¨ç°å±‚çŠ¶æ€è½¬ç§»ï¼ˆRepresentational State Transferï¼‰ï¼šèµ„æºçš„è¡¨ç°å½¢å¼å¯ä»¥æ˜¯ JSONã€XMLã€HTML ç­‰æ ¼å¼ï¼Œé€šå¸¸ RESTful API ä½¿ç”¨ JSON ä½œä¸ºæ•°æ®äº¤æ¢æ ¼å¼ï¼Œå› ä¸ºå®ƒè½»é‡ä¸”æ˜“äºè§£æã€‚å®¢æˆ·ç«¯é€šè¿‡æ¥æ”¶èµ„æºçš„è¡¨ç°å½¢å¼ï¼ˆå¦‚ JSONã€XMLï¼‰æ¥æ„ŸçŸ¥èµ„æºçš„å˜åŒ–ï¼Œä»è€Œå®ç°çŠ¶æ€çš„â€œè½¬ç§»â€ã€‚ äºŒã€RESTful APIçš„ç‰¹ç‚¹å’Œä¼˜åŠ¿ 2.1 ç‰¹ç‚¹ èµ„æºå¯¼å‘ï¼šæ‰€æœ‰å†…å®¹éƒ½è¢«æŠ½è±¡ä¸ºèµ„æºï¼ˆå¦‚ Userã€Orderã€Article ç­‰ï¼‰ï¼Œæ¯ä¸ªèµ„æºéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆURIï¼‰ã€‚ä¾‹å¦‚ï¼Œ/users è¡¨ç¤ºç”¨æˆ·èµ„æºï¼Œ/users/1 è¡¨ç¤º ID ä¸º 1 çš„ç”¨æˆ·ã€‚ ä½¿ç”¨æ ‡å‡†åè®®ï¼šåŸºäº HTTP åè®®ï¼Œç›´æ¥ä½¿ç”¨å…¶æ–¹æ³•ï¼ˆGETã€POST ç­‰ï¼‰æ¥æ“ä½œèµ„æºã€‚ æ— çŠ¶æ€é€šä¿¡ï¼šæ¯æ¬¡è¯·æ±‚éƒ½åŒ…å«æ‰€æœ‰ä¸Šä¸‹æ–‡ï¼Œä¸ä¾èµ–æœåŠ¡å™¨ä¿å­˜çŠ¶æ€ã€‚è¿™ä½¿å¾—æœåŠ¡å™¨å¯ä»¥æ›´åŠ å®¹æ˜“åœ°è¿›è¡Œæ‰©å±•å’Œè´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸éœ€è¦è€ƒè™‘ä¹‹å‰çš„è¯·æ±‚çŠ¶æ€ã€‚ ç»Ÿä¸€æ¥å£ï¼šæ¥å£é£æ ¼ç»Ÿä¸€ã€æ˜“äºç†è§£å’Œä½¿ç”¨ã€‚é€šè¿‡æ ‡å‡†çš„ HTTP æ–¹æ³•ï¼ˆGETã€POSTã€PUTã€DELETE ç­‰ï¼‰å’Œèµ„æºæ ‡è¯†ç¬¦ï¼ˆURIï¼‰è®¿é—®èµ„æºï¼Œç®€åŒ–äº†ç³»ç»Ÿçš„æ•´ä½“æ¶æ„ï¼Œæå‡äº†äº’æ“ä½œæ€§ã€‚ å¯ç¼“å­˜ï¼šå®¢æˆ·ç«¯å¯æ ¹æ®å“åº”å¤´å¯¹èµ„æºè¿›è¡Œç¼“å­˜ï¼Œæé«˜æ€§èƒ½ã€‚åˆ©ç”¨ HTTP åè®®çš„ç¼“å­˜æœºåˆ¶ï¼Œå…è®¸ä¸­é—´ä»¶æˆ–å®¢æˆ·ç«¯ç¼“å­˜å“åº”ç»“æœï¼Œå‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚ï¼Œä»è€Œæå‡å“åº”é€Ÿåº¦å’Œå‡è½»æœåŠ¡å™¨è´Ÿæ‹…ã€‚ åˆ†å±‚æ¶æ„ï¼šå®¢æˆ·ç«¯æ— éœ€çŸ¥é“è¯·æ±‚æœ€ç»ˆç”±è°å¤„ç†ï¼ˆä¾‹å¦‚ä¸­é—´å±‚ã€è´Ÿè½½å‡è¡¡ç­‰ï¼‰ã€‚å…è®¸é€šè¿‡ä¸­é—´å±‚ï¼ˆå¦‚ä»£ç†æœåŠ¡å™¨ã€ç½‘å…³ï¼‰æ¥å¤„ç†è¯·æ±‚ï¼Œæ¯å±‚åªéœ€ä¸ç›¸é‚»å±‚é€šä¿¡ï¼Œå¢å¼ºäº†ç³»ç»Ÿçš„å®‰å…¨æ€§ã€å¯æ‰©å±•æ€§å’Œçµæ´»æ€§ã€‚ æŒ‰éœ€ä»£ç ï¼ˆå¯é€‰ï¼‰ï¼šå®¢æˆ·ç«¯å¯ä»¥ä»æœåŠ¡å™¨ä¸‹è½½ä»£ç æˆ–è„šæœ¬ï¼Œä»¥æ‰©å±•å…¶åŠŸèƒ½ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚ 2.2 ä¼˜åŠ¿ ç®€æ´æ˜“æ‡‚ï¼šä½¿ç”¨ HTTP åè®®çš„æ ‡å‡†æ–¹æ³•å’Œ URIï¼Œå¯ä»¥è®© API çš„è®¾è®¡å’Œä½¿ç”¨å˜å¾—ç®€å•ã€‚é€šè¿‡ URL å’Œ HTTP åŠ¨è¯çš„ç»„åˆï¼Œå¯ä»¥æ˜ç¡®åœ°è¡¨ç¤ºå¯¹ç‰¹å®šèµ„æºçš„æ“ä½œæ„å›¾ã€‚ çµæ´»æ€§ï¼šèµ„æºå¯ä»¥æœ‰ä¸åŒçš„è¡¨ç¤ºå½¢å¼ï¼ˆJSONã€XML ç­‰ï¼‰ï¼ŒåŒæ—¶ HTTP æ–¹æ³•æ˜ç¡®åŒºåˆ†ä¸åŒçš„æ“ä½œã€‚å®¢æˆ·ç«¯å¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ•°æ®æ ¼å¼ã€‚ æ‰©å±•æ€§å¼ºï¼šé€šè¿‡ä¸€è‡´çš„æ¥å£è®¾è®¡ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•å’Œç»´æŠ¤ APIã€‚éšç€åº”ç”¨ç¨‹åºçš„å‘å±•ï¼Œå¯ä»¥è½»æ¾åœ°æ·»åŠ æ–°çš„èµ„æºå’Œæ“ä½œï¼Œè€Œä¸ä¼šå½±å“ç°æœ‰çš„ API ç»“æ„ã€‚ æ— çŠ¶æ€æ€§ï¼šç®€åŒ–äº†æœåŠ¡å™¨ç«¯çš„è®¾è®¡ï¼Œå¢å¼ºäº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚æœåŠ¡å™¨ä¸éœ€è¦ä¿å­˜å®¢æˆ·ç«¯çš„çŠ¶æ€ä¿¡æ¯ï¼Œä½¿å¾—æœåŠ¡å™¨å¯ä»¥æ›´å®¹æ˜“åœ°è¿›è¡Œæ‰©å±•å’Œè´Ÿè½½å‡è¡¡ã€‚ è·¨å¹³å°ï¼šåŸºäº HTTP åè®®ï¼Œå¯ä»¥è¢«ä»»ä½•æ”¯æŒ HTTP çš„å®¢æˆ·ç«¯è°ƒç”¨ï¼Œé€‚ç”¨äºå„ç§åº”ç”¨åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯éœ€è¦è·¨å¹³å°å’Œè·¨è¯­è¨€äº¤äº’çš„ç³»ç»Ÿã€‚ ä¸‰ã€RESTful APIçš„è®¾è®¡åŸåˆ™ 3.1 åŸºäºèµ„æº å°†ç½‘ç»œä¸Šçš„æ¯ä¸ªå®ä½“æˆ–æ¦‚å¿µè§†ä¸ºå”¯ä¸€èµ„æºæ˜¯ä¸€ä¸ªå…³é”®åŸåˆ™ã€‚é€šè¿‡ URL æ¥è¡¨ç¤ºè¿™äº›èµ„æºï¼Œä½¿å¾—èµ„æºçš„å®šä½æ›´åŠ æ¸…æ™°å’Œç›´è§‚ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåšå®¢æ–‡ç« å¯ä»¥è¢«è¡¨ç¤ºä¸º /articles/123ï¼Œå…¶ä¸­ â€œarticlesâ€ è¡¨ç¤ºæ–‡ç« èµ„æºçš„é›†åˆï¼Œâ€œ123â€ æ˜¯å…·ä½“æŸä¸€ç¯‡æ–‡ç« çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚è¿™ç§æ–¹å¼ä½¿å¾—å¼€å‘è€…å’Œç”¨æˆ·éƒ½èƒ½å¤Ÿè½»æ¾åœ°ç†è§£å’Œè®¿é—®ç‰¹å®šçš„èµ„æºã€‚ä»¥ç”µå•†å¹³å°ä¸ºä¾‹ï¼Œå•†å“å¯ä»¥è¡¨ç¤ºä¸º /productsï¼Œæ¯ä¸ªå…·ä½“çš„å•†å“å¯ä»¥é€šè¿‡ /products/{productId} æ¥è®¿é—®ï¼Œå…¶ä¸­ {productId} æ˜¯å•†å“çš„å”¯ä¸€æ ‡è¯†ã€‚\n3.2 ç»Ÿä¸€æ¥å£ èµ„æºæ ‡è¯†ï¼ˆResource Identificationï¼‰ï¼šæ¯ä¸ªèµ„æºéƒ½åº”æœ‰å”¯ä¸€çš„ URLã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·èµ„æºå¯ä»¥é€šè¿‡ /users/{id} è¿›è¡Œæ ‡è¯†ï¼Œå…¶ä¸­ {id} æ˜¯ç”¨æˆ·çš„å…·ä½“æ ‡è¯†ã€‚ èµ„æºæ“ä½œï¼ˆResource Manipulation Through Representationsï¼‰ï¼šé€šè¿‡è¡¨ç¤ºï¼ˆrepresentationï¼‰æ¥æ“ä½œèµ„æºï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œèµ„æºæœ¬èº«ã€‚ä½¿ç”¨æ ‡å‡†çš„ HTTP æ–¹æ³•ï¼ˆGETã€POSTã€PUTã€DELETE ç­‰ï¼‰æ¥æ“ä½œèµ„æºã€‚ è‡ªæè¿°æ¶ˆæ¯ï¼ˆSelf - descriptive Messagesï¼‰ï¼šå“åº”æ¶ˆæ¯åº”åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ä»¥ä¾¿å®¢æˆ·ç«¯æ— éœ€é¢å¤–æ–‡æ¡£å³å¯ç†è§£ã€‚æ¯ä¸ªè¯·æ±‚å’Œå“åº”éƒ½åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œä½¿å¾—å®¢æˆ·ç«¯èƒ½å¤Ÿç†è§£å¦‚ä½•å¤„ç†å®ƒä»¬ã€‚ æ— çŠ¶æ€ï¼ˆStatelessï¼‰ï¼šæœåŠ¡å™¨ä¸ä¿å­˜å®¢æˆ·ç«¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚æ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œä½¿æœåŠ¡å™¨èƒ½å¤Ÿç†è§£å’Œå¤„ç†è¯¥è¯·æ±‚ï¼Œè€Œä¸ä¾èµ–äºä¹‹å‰çš„è¯·æ±‚ã€‚ 3.3 ä½¿ç”¨æ ‡å‡†çš„ HTTP æ–¹æ³• ä¸»è¦ä½¿ç”¨ HTTP æ–¹æ³•æ¥å®šä¹‰å¯¹èµ„æºçš„æ“ä½œï¼Œå¸¸è§çš„ HTTP æ–¹æ³•åŠå…¶ä½œç”¨å¦‚ä¸‹ï¼š\nHTTP æ–¹æ³• æ“ä½œ å¹‚ç­‰æ€§ å®‰å…¨æ€§ ç¤ºä¾‹ GET è·å–èµ„æº âœ… âœ… GET /users æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ï¼›GET /users/id æŸ¥çœ‹è¯¥ id çš„ç”¨æˆ·ä¿¡æ¯ POST åˆ›å»ºèµ„æº âŒ âŒ POST /users åˆ›å»ºç”¨æˆ·ï¼Œå¯åœ¨ DATA å¤„å¸¦éœ€è¦çš„å‚æ•° PUT æ›´æ–°æˆ–æ›¿æ¢èµ„æº âœ… âŒ PUT /users/id?name='å¼ ä¸‰'\u0026amp;age=20 ä¿®æ”¹è¯¥ id çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆname å’Œ ageï¼‰ PATCH éƒ¨åˆ†æ›´æ–°èµ„æº âŒ âŒ å¯¹èµ„æºè¿›è¡Œéƒ¨åˆ†å±æ€§çš„æ›´æ–° DELETE åˆ é™¤èµ„æº âœ… âŒ DELETE /users/id åˆ é™¤è¯¥ id çš„ç”¨æˆ·ä¿¡æ¯ HEAD è·å–èµ„æºçš„å…ƒæ•°æ® âœ… âœ… OPTIONS è·å–ä¿¡æ¯ï¼Œå…³äºèµ„æºçš„å“ªäº›å±æ€§æ˜¯å®¢æˆ·ç«¯å¯ä»¥æ”¹å˜çš„ âœ… âœ… 3.4 æ— çŠ¶æ€é€šä¿¡ æ¯ä¸ªè¯·æ±‚å¿…é¡»åŒ…å«æœåŠ¡å™¨å¤„ç†è¯¥è¯·æ±‚æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒæœåŠ¡å™¨ä¸ä¾èµ–ä¹‹å‰çš„è¯·æ±‚ä¸Šä¸‹æ–‡ã€‚è¿™ä½¿å¾—æœåŠ¡å™¨å¯ä»¥æ›´åŠ å®¹æ˜“åœ°è¿›è¡Œæ‰©å±•å’Œè´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸éœ€è¦è€ƒè™‘ä¹‹å‰çš„è¯·æ±‚çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå½“å®¢æˆ·ç«¯å‘é€å¤šä¸ªè¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨ä¸éœ€è¦è®°ä½ä¹‹å‰çš„è¯·æ±‚å†…å®¹ï¼Œåªéœ€è¦æ ¹æ®å½“å‰è¯·æ±‚çš„ä¿¡æ¯è¿›è¡Œå¤„ç†ã€‚\n3.5 è¿”å›é€‚å½“çš„çŠ¶æ€ç  API åº”è¿”å›é€‚å½“çš„ HTTP çŠ¶æ€ç ï¼Œå‡†ç¡®åæ˜ è¯·æ±‚ç»“æœã€‚å¸¸ç”¨çš„çŠ¶æ€ç å¦‚ä¸‹ï¼š\nçŠ¶æ€ç  å«ä¹‰ è¯´æ˜ 200 OK æœåŠ¡å™¨æˆåŠŸè¿”å›ç”¨æˆ·è¯·æ±‚çš„æ•°æ®ï¼Œè¯¥æ“ä½œæ˜¯å¹‚ç­‰çš„ï¼ˆIdempotentï¼‰ï¼Œé€šç”¨æˆåŠŸã€‚ 201 Created èµ„æºå·²åˆ›å»ºï¼Œé€šå¸¸ç”¨äº POST è¯·æ±‚ã€‚ 204 No Content è¯·æ±‚æˆåŠŸï¼Œä½†æ— è¿”å›å†…å®¹ï¼Œé€šå¸¸ç”¨äº DELETE è¯·æ±‚ã€‚ 400 Bad Request è¯·æ±‚å‚æ•°æœ‰è¯¯ï¼ŒæœåŠ¡å™¨æ— æ³•å¤„ç†ã€‚ 401 Unauthorized è®¤è¯å¤±è´¥ï¼Œå®¢æˆ·ç«¯éœ€è¦æä¾›èº«ä»½éªŒè¯ã€‚ 403 Forbidden æ²¡æœ‰æƒé™è®¿é—®èµ„æºï¼ŒæœåŠ¡å™¨ç†è§£è¯·æ±‚ï¼Œä½†æ‹’ç»æ‰§è¡Œï¼Œé€šå¸¸ç”±äºæƒé™é—®é¢˜ã€‚ 404 Not Found è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨ã€‚ 500 Internal Server Error æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ã€‚ 3.6 è¿‡æ»¤ä¿¡æ¯ å¦‚æœè®°å½•æ•°é‡å¾ˆå¤šï¼ŒæœåŠ¡å™¨ä¸å¯èƒ½éƒ½å°†å®ƒä»¬è¿”å›ç»™ç”¨æˆ·ã€‚API åº”è¯¥æä¾›å‚æ•°ï¼Œè¿‡æ»¤è¿”å›ç»“æœã€‚å¸¸è§çš„å‚æ•°å¦‚ä¸‹ï¼š\n?limit=10ï¼šæŒ‡å®šè¿”å›è®°å½•çš„æ•°é‡ã€‚ ?offset=10ï¼šæŒ‡å®šè¿”å›è®°å½•çš„å¼€å§‹ä½ç½®ã€‚ ?page=2\u0026amp;per_page=100ï¼šæŒ‡å®šç¬¬å‡ é¡µï¼Œä»¥åŠæ¯é¡µçš„è®°å½•æ•°ã€‚ ?sortby=name\u0026amp;order=ascï¼šæŒ‡å®šè¿”å›ç»“æœæŒ‰ç…§å“ªä¸ªå±æ€§æ’åºï¼Œä»¥åŠæ’åºé¡ºåºã€‚ ?animal_type_id=1ï¼šæŒ‡å®šç­›é€‰æ¡ä»¶ã€‚ 3.7 æ”¯æŒ HATEOASï¼ˆè¶…åª’ä½“ä½œä¸ºåº”ç”¨ç¨‹åºçŠ¶æ€å¼•æ“ï¼‰ HATEOAS è¦æ±‚å®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡æœåŠ¡å™¨è¿”å›çš„è¶…é“¾æ¥ï¼ˆURLï¼‰å¯¼èˆªåˆ°ç›¸å…³èµ„æºã€‚ç®€è€Œè¨€ä¹‹ï¼ŒHATEOAS è¦æ±‚ API çš„å“åº”ä¸ä»…åŒ…å«èµ„æºæ•°æ®ï¼Œè¿˜åº”è¯¥åŒ…å«ä¸èµ„æºç›¸å…³çš„æ“ä½œé“¾æ¥ï¼Œå¸®åŠ©å®¢æˆ·ç«¯æ›´å¥½åœ°ç†è§£å¦‚ä½•è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚ä¾‹å¦‚ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œé™¤äº†è¿”å›ç”¨æˆ·çš„è¯¦ç»†æ•°æ®å¤–ï¼ŒAPI è¿˜å¯ä»¥æä¾›ç›¸å…³æ“ä½œçš„é“¾æ¥ï¼š\n1 2 3 4 5 6 7 8 9 { \u0026#34;user_id\u0026#34;: 123, \u0026#34;name\u0026#34;: \u0026#34;John Doe\u0026#34;, \u0026#34;links\u0026#34;: { \u0026#34;self\u0026#34;: \u0026#34;/users/123\u0026#34;, \u0026#34;update\u0026#34;: \u0026#34;/users/123/update\u0026#34;, \u0026#34;delete\u0026#34;: \u0026#34;/users/123/delete\u0026#34; } } 3.8 æ•°æ®æ ¼å¼ è¿”å›æ•°æ®æ ¼å¼é€šå¸¸ä½¿ç”¨ JSON æˆ– XMLï¼Œå…¶ä¸­ JSON å› å…¶è½»é‡çº§å’Œæ˜“è¯»æ€§ï¼Œå·²æˆä¸º RESTful API äº‹å®ä¸Šçš„æ•°æ®äº¤æ¢æ ¼å¼ã€‚ç»Ÿä¸€è¿”å› JSON æ ¼å¼ï¼ŒåŒ…å«æ•°æ®ã€çŠ¶æ€ç å’Œé”™è¯¯ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 { \u0026#34;status\u0026#34;: 200, \u0026#34;data\u0026#34;: { \u0026#34;id\u0026#34;: 123, \u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34; }, \u0026#34;error\u0026#34;: null } 3.9 ç‰ˆæœ¬æ§åˆ¶ å½“ API å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯ä»¥é€šè¿‡ç‰ˆæœ¬å·æ¥ç®¡ç†ä¸åŒç‰ˆæœ¬çš„ APIï¼Œä»¥ä¿æŒå‘åå…¼å®¹æ€§ã€‚å¸¸è§çš„ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥æœ‰ï¼š\nURL è·¯å¾„ç‰ˆæœ¬ï¼šå¦‚ /v1/resourceï¼Œä¼˜ç‚¹æ˜¯ç®€å•ã€æ˜¾å¼ã€æ˜“ç¼“å­˜ï¼›ç¼ºç‚¹æ˜¯ä¸å¤Ÿä¼˜é›…ã€URL è†¨èƒ€ã€‚ è¯·æ±‚å¤´ç‰ˆæœ¬ï¼šå¦‚ X - API - Version: 1ï¼Œä¼˜ç‚¹æ˜¯ URL å¹²å‡€ã€æ¾è€¦åˆï¼›ç¼ºç‚¹æ˜¯éš¾è°ƒè¯•ã€å¯èƒ½è¢«ä»£ç†ç§»é™¤ã€‚ å†…å®¹åå•†ç‰ˆæœ¬ï¼šå¦‚ Accept: application/vnd.example.v1+jsonï¼Œä¼˜ç‚¹æ˜¯ RESTfulã€æ ‡å‡† HTTP å¤´ï¼›ç¼ºç‚¹æ˜¯å¤æ‚ã€å®¢æˆ·ç«¯æ”¯æŒä¸ä¸€ã€‚ æŸ¥è¯¢å‚æ•°ç‰ˆæœ¬ï¼šå¦‚ /resource?version=1ï¼Œä¼˜ç‚¹æ˜¯ç®€å•ã€æ˜¾å¼ï¼›ç¼ºç‚¹æ˜¯ä¸æ˜¯ RESTfulã€URL æ±¡æŸ“ã€‚ å››ã€RESTful APIçš„è®¾è®¡ç¤ºä¾‹ ä»¥ä¸€ä¸ªç®€å•çš„åšå®¢å¹³å°ä¸ºä¾‹ï¼Œè®¾è®¡å…¶ RESTful APIï¼š\n4.1 èµ„æºåˆ—è¡¨ ç”¨æˆ·ï¼ˆ/usersï¼‰ æ–‡ç« ï¼ˆ/articlesï¼‰ è¯„è®ºï¼ˆ/commentsï¼‰ 4.2 æ“ä½œè®¾è®¡ æ“ä½œ HTTP æ–¹æ³• URL è¯´æ˜ è·å–æ‰€æœ‰ç”¨æˆ· GET /users è¿”å›æ‰€æœ‰ç”¨æˆ·çš„åˆ—è¡¨ è·å–ç‰¹å®šç”¨æˆ· GET /users/{id} è¿”å›æŒ‡å®š ID ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ åˆ›å»ºç”¨æˆ· POST /users æ ¹æ®è¯·æ±‚ä½“ä¸­çš„æ•°æ®åˆ›å»ºæ–°ç”¨æˆ· æ›´æ–°ç”¨æˆ·ä¿¡æ¯ PUT /users/{id} æ›´æ–°æŒ‡å®š ID ç”¨æˆ·çš„ä¿¡æ¯ åˆ é™¤ç”¨æˆ· DELETE /users/{id} åˆ é™¤æŒ‡å®š ID çš„ç”¨æˆ· è·å–æ‰€æœ‰æ–‡ç«  GET /articles è¿”å›æ‰€æœ‰æ–‡ç« çš„åˆ—è¡¨ è·å–ç‰¹å®šæ–‡ç«  GET /articles/{id} è¿”å›æŒ‡å®š ID æ–‡ç« çš„è¯¦ç»†ä¿¡æ¯ åˆ›å»ºæ–‡ç«  POST /articles æ ¹æ®è¯·æ±‚ä½“ä¸­çš„æ•°æ®åˆ›å»ºæ–°æ–‡ç«  æ›´æ–°æ–‡ç« ä¿¡æ¯ PUT /articles/{id} æ›´æ–°æŒ‡å®š ID æ–‡ç« çš„ä¿¡æ¯ åˆ é™¤æ–‡ç«  DELETE /articles/{id} åˆ é™¤æŒ‡å®š ID çš„æ–‡ç«  è·å–ç‰¹å®šæ–‡ç« çš„è¯„è®º GET /articles/{id}/comments è¿”å›æŒ‡å®š ID æ–‡ç« çš„æ‰€æœ‰è¯„è®º åˆ›å»ºè¯„è®º POST /articles/{id}/comments åœ¨æŒ‡å®š ID æ–‡ç« ä¸‹åˆ›å»ºæ–°è¯„è®º åˆ é™¤è¯„è®º DELETE /comments/{id} åˆ é™¤æŒ‡å®š ID çš„è¯„è®º äº”ã€RESTful APIçš„å®ç° 5.1 æœåŠ¡ç«¯å®ç°ï¼ˆä»¥ Node.js ä¸ºä¾‹ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 const express = require(\u0026#39;express\u0026#39;); const app = express(); app.use(express.json()); // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ® const users = [ { id: 1, name: \u0026#39;John Doe\u0026#39;, email: \u0026#39;john@example.com\u0026#39; }, { id: 2, name: \u0026#39;Jane Smith\u0026#39;, email: \u0026#39;jane@example.com\u0026#39; } ]; // è·å–æ‰€æœ‰ç”¨æˆ· app.get(\u0026#39;/api/v1/users\u0026#39;, (req, res) =\u0026gt; { res.status(200).json({ status: 200, data: users }); }); // åˆ›å»ºæ–°ç”¨æˆ· app.post(\u0026#39;/api/v1/users\u0026#39;, (req, res) =\u0026gt; { const newUser = req.body; users.push(newUser); res.status(201).json({ status: 201, data: newUser }); }); // è·å–ç‰¹å®šç”¨æˆ· app.get(\u0026#39;/api/v1/users/:id\u0026#39;, (req, res) =\u0026gt; { const userId = parseInt(req.params.id); const user = users.find(u =\u0026gt; u.id === userId); if (user) { res.status(200).json({ status: 200, data: user }); } else { res.status(404).json({ status: 404, error: \u0026#39;User not found\u0026#39; }); } }); // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ app.put(\u0026#39;/api/v1/users/:id\u0026#39;, (req, res) =\u0026gt; { const userId = parseInt(req.params.id); const updatedUser = req.body; const index = users.findIndex(u =\u0026gt; u.id === userId); if (index!== -1) { users[index] = updatedUser; res.status(200).json({ status: 200, data: updatedUser }); } else { res.status(404).json({ status: 404, error: \u0026#39;User not found\u0026#39; }); } }); // åˆ é™¤ç”¨æˆ· app.delete(\u0026#39;/api/v1/users/:id\u0026#39;, (req, res) =\u0026gt; { const userId = parseInt(req.params.id); const index = users.findIndex(u =\u0026gt; u.id === userId); if (index!== -1) { users.splice(index, 1); res.status(204).send(); } else { res.status(404).json({ status: 404, error: \u0026#39;User not found\u0026#39; }); } }); const port = process.env.PORT || 3000; app.listen(port, () =\u0026gt; { console.log(`Server is running on port ${port}`); }); 5.2 å®¢æˆ·ç«¯è°ƒç”¨ï¼ˆä»¥ JavaScript Fetch ä¸ºä¾‹ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 // è·å–ç”¨æˆ·æ•°æ® fetch(\u0026#39;https://api.example.com/users/123\u0026#39;) .then(response =\u0026gt; response.json()) .then(data =\u0026gt; console.log(data)) .catch(error =\u0026gt; console.error(\u0026#39;Error:\u0026#39;, error)); // æäº¤æ–°æ–‡ç«  fetch(\u0026#39;https://api.example.com/articles\u0026#39;, { method: \u0026#39;POST\u0026#39;, headers: { \u0026#39;Content - Type\u0026#39;: \u0026#39;application/json\u0026#39; }, body: JSON.stringify({ title: \u0026#39;Hello REST\u0026#39;, content: \u0026#39;...\u0026#39; }) }); å…­ã€RESTful APIçš„åº”ç”¨åœºæ™¯ 6.1 Web æœåŠ¡ æä¾› Web æœåŠ¡ï¼Œå¦‚ç¤¾äº¤åª’ä½“ã€ç”µå•†ç½‘ç«™ç­‰ã€‚å‰ç«¯ï¼ˆå¦‚ JavaScriptã€Angularã€React ç­‰ï¼‰å¯ä»¥é€šè¿‡ RESTful API ä¸åç«¯æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œè·å–å’Œæ›´æ–°æ•°æ®ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç”µå•†ç½‘ç«™çš„å‰ç«¯å¯ä»¥ä½¿ç”¨ RESTful API ä»æœåŠ¡å™¨è·å–å•†å“åˆ—è¡¨ã€ç”¨æˆ·ä¿¡æ¯ç­‰ï¼Œå¹¶å°†ç”¨æˆ·çš„è®¢å•ä¿¡æ¯å‘é€åˆ°æœåŠ¡å™¨è¿›è¡Œå¤„ç†ã€‚\n6.2 ç§»åŠ¨åº”ç”¨ ç§»åŠ¨åº”ç”¨é€šè¿‡ RESTful API ä¸æœåŠ¡å™¨äº¤äº’ï¼Œè·å–å’Œæ›´æ–°æ•°æ®ï¼Œå®ç°ç”¨æˆ·ç™»å½•ã€æ•°æ®åŒæ­¥ç­‰åŠŸèƒ½ã€‚Android å’Œ iOS åº”ç”¨å¯ä»¥ä½¿ç”¨ RESTful API ä¸æœåŠ¡å™¨äº¤äº’ï¼Œæä¾›ä¸°å¯Œçš„ç”¨æˆ·ä½“éªŒã€‚\n6.3 ç‰©è”ç½‘ï¼ˆIoTï¼‰ è®¾å¤‡é€šè¿‡ RESTful API ä¸æœåŠ¡å™¨é€šä¿¡ï¼Œå®ç°æ•°æ®é‡‡é›†å’Œæ§åˆ¶ã€‚ç‰©è”ç½‘è®¾å¤‡å¯ä»¥é€šè¿‡ RESTful API å°†é‡‡é›†åˆ°çš„æ•°æ®å‘é€åˆ°æœåŠ¡å™¨ï¼ŒåŒæ—¶æ¥æ”¶æœåŠ¡å™¨çš„æ§åˆ¶æŒ‡ä»¤ã€‚\n6.4 å¾®æœåŠ¡æ¶æ„ å¾®æœåŠ¡ä¹‹é—´é€šè¿‡ RESTful API è¿›è¡Œé€šä¿¡å’Œåä½œã€‚æ¯ä¸ªå¾®æœåŠ¡éƒ½å¯ä»¥æš´éœ²è‡ªå·±çš„ RESTful APIï¼Œå…¶ä»–å¾®æœåŠ¡å¯ä»¥é€šè¿‡è°ƒç”¨è¿™äº› API æ¥è·å–æ‰€éœ€çš„æ•°æ®æˆ–æ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç”µå•†ç³»ç»Ÿå¯èƒ½ç”±ç”¨æˆ·æœåŠ¡ã€å•†å“æœåŠ¡ã€è®¢å•æœåŠ¡ç­‰å¤šä¸ªå¾®æœåŠ¡ç»„æˆï¼Œè¿™äº›å¾®æœåŠ¡ä¹‹é—´å¯ä»¥é€šè¿‡ RESTful API è¿›è¡Œæ•°æ®äº¤äº’å’Œä¸šåŠ¡åä½œã€‚\n6.5 ä¼ä¸šçº§åº”ç”¨é›†æˆ ä¼ä¸šå†…éƒ¨çš„ä¸åŒç³»ç»Ÿä¹‹é—´å¯ä»¥ä½¿ç”¨ RESTful API è¿›è¡Œé›†æˆã€‚ä¾‹å¦‚ï¼Œä¼ä¸šçš„å®¢æˆ·å…³ç³»ç®¡ç†ç³»ç»Ÿï¼ˆCRMï¼‰å’Œä¼ä¸šèµ„æºè§„åˆ’ç³»ç»Ÿï¼ˆERPï¼‰å¯ä»¥é€šè¿‡ RESTful API è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œå®ç°ä¿¡æ¯å…±äº«å’Œä¸šåŠ¡æµç¨‹çš„ååŒã€‚\nä¸ƒã€RESTful APIä¸ä¼ ç»Ÿ APIçš„å¯¹æ¯” æ¯”è¾ƒé¡¹ RESTful API ä¼ ç»Ÿ API é£æ ¼ æ¥å£é£æ ¼ èµ„æºå¯¼å‘ï¼Œç»“æ„æ¸…æ™° åŠ¨ä½œå¯¼å‘ï¼Œæ¥å£æ··ä¹± åŠ¨ä½œè¡¨ç¤º ä½¿ç”¨ HTTP æ–¹æ³•è¡¨ç¤ºåŠ¨ä½œ æ¥å£è·¯å¾„ä¸­åŒ…å«åŠ¨è¯ï¼ˆå¦‚ /getUserï¼‰ å¯è¯»æ€§ é«˜ï¼Œå¯ç›´è§‚ç†è§£æ“ä½œå«ä¹‰ ä½ï¼Œéœ€è¦é˜…è¯»æ–‡æ¡£æ‰èƒ½ç†è§£ ç»´æŠ¤æ€§ æ˜“äºæ‰©å±•å’Œç»´æŠ¤ æ‰©å±•æ€§å·®ï¼Œæ¥å£è†¨èƒ€ æ•°æ®ä¼ è¾“æ ¼å¼ é€šå¸¸ä½¿ç”¨ JSON æˆ– XMLï¼Œæœ‰æ˜ç¡®æ ‡å‡† å¯èƒ½ä½¿ç”¨å¤šç§æ ¼å¼ï¼Œæ— æ˜ç¡®æ ‡å‡† çŠ¶æ€ä¸ç¼“å­˜ å¼ºè°ƒçŠ¶æ€æ— å…³æ€§ï¼Œå¯åˆ©ç”¨ HTTP ç¼“å­˜æœºåˆ¶ å¯èƒ½ä¾èµ–æœåŠ¡å™¨ç«¯çŠ¶æ€ï¼Œç¼“å­˜ç­–ç•¥ä¸ä¸€è‡´ å®‰å…¨æ€§å’Œè®¤è¯ æ”¯æŒå„ç§å®‰å…¨æ€§æªæ–½ï¼Œå¦‚ HTTPSã€è®¤è¯ã€æˆæƒç­‰ å¯èƒ½ç¼ºä¹ç»Ÿä¸€çš„å®‰å…¨æ ‡å‡† æ¥å£ä¸€è‡´æ€§ ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºä½¿ç”¨ æ¥å£è®¾è®¡æ¾æ•£ï¼Œä¸ä¸€è‡´ èµ„æºå…³è”æ€§ åœ¨å“åº”ä¸­æä¾›ç›¸å…³èµ„æºçš„é“¾æ¥ï¼Œå…·æœ‰è‡ªæè¿°æ€§ é€šå¸¸ä¸æä¾›è‡ªæè¿°æ€§ ç»¼ä¸Šæ‰€è¿°ï¼ŒRESTful API ä»¥å…¶ç®€æ´ã€çµæ´»ã€å¯æ‰©å±•ç­‰ä¼˜ç‚¹ï¼Œæˆä¸ºç°ä»£ Web å¼€å‘ä¸­ä¸»æµçš„ API è®¾è®¡é£æ ¼ä¹‹ä¸€ï¼Œå¹¿æ³›åº”ç”¨äºå„ç§ç½‘ç»œåº”ç”¨åœºæ™¯ä¸­ã€‚åœ¨è®¾è®¡å’Œå¼€å‘ RESTful API æ—¶ï¼Œéµå¾ªå…¶è®¾è®¡åŸåˆ™å’Œæœ€ä½³å®è·µï¼Œèƒ½å¤Ÿæ„å»ºå‡ºé«˜æ•ˆã€æ˜“ç”¨ã€å¯ç»´æŠ¤çš„ API ç³»ç»Ÿã€‚\n","date":"2025-06-26T15:22:59+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/restful-api/","title":"RESTful API"},{"content":"åˆ›å»ºpublicä»“åº“ç”¨æ¥å­˜æ”¾ç…§ç‰‡ åˆ›å»ºtoken tokenå°†æ¥PicGoæ“ä½œä½ çš„githubä»“åº“æ¥ä¸Šä¼ å›¾ç‰‡æ—¶è¦ç”¨åˆ°ï¼Œåœ¨ GitHub è´¦æˆ·ä¸‹ Setting - Developer setting - Personal access tokens(classic) ä¸‹åˆ›å»ºä¸€ä¸ªä¸è¿‡æœŸ(no expiration)çš„ Tokenï¼Œæƒé™éœ€è¦å¼€å¯ repo.è¿™ä¸ªæˆ‘ä»¬åœ¨ç”¨Github action æ¥éƒ¨ç½²åšå®¢ä»“åº“æ—¶å·²ç»åˆ›å»ºäº†ï¼Œç”¨é‚£ä¸ªå°±å¥½.token åœ¨åˆ›å»ºæ—¶åªæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¦ä¿å­˜å¥½å“¦ï¼\né…ç½®PicGo github æœç´¢PicGo ç„¶åå®‰è£… å›¾åºŠå…·ä½“å‚æ•°é…ç½® ä»“åº“å åˆ†æ”¯å å¯¹åº”äºä¹‹å‰ä½ åˆ›å»ºçš„GitHubä»“åº“\nTokenå°±æ˜¯å‰é¢åˆ›å»ºçš„Token,è¢«PicGoç”¨æ¥ä¸Šä¼ ç…§ç‰‡åˆ°é•¿ä»“åº“\nè·¯å¾„å¯ä»¥è‡ªå®šä¹‰\nè‡ªå®šä¹‰åŸŸåæ ¼å¼:https://cdn.jsdelivr.net/gh/ç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯å\nTypora Typora å¯æ­é…PicGoä½¿ç”¨\nè‹¥PicGoæ˜¾ç¤ºunable to verify the first certificate at TLS,æ— æ³•ä¸Šä¼ ï¼Œåˆ™å¯èƒ½æ˜¯ä½ çš„ç½‘ç»œåŠ é€Ÿå·¥å…·é€ æˆçš„æŸäº›ç½‘ç»œåŠ é€Ÿå·¥å…·å¯èƒ½ä¼šä¿®æ”¹ç½‘ç»œæµé‡ï¼Œå¯èƒ½ä¸ SSLè¯ä¹¦éªŒè¯æœºåˆ¶å‘ç”Ÿå†²çªã€‚è¿™å¯èƒ½å¯¼è‡´ SSL è¯ä¹¦éªŒè¯å¤±è´¥ï¼Œå› ä¸ºæœåŠ¡å™¨çš„è¯ä¹¦æ— æ³•æ­£å¸¸éªŒè¯ï¼Œä»è€Œå‡ºç°ç±»ä¼¼ \u0026ldquo;unable to verify the first certificate\u0026rdquo; çš„é”™è¯¯ã€‚ä¾‹å¦‚æˆ‘ä¹‹å‰ç”¨Watt Toolkitå°±å‡ºç°äº†ï¼š\nå¦‚æœTyporaæ˜¾ç¤ºfailed to fetch ï¼›æ£€æŸ¥PicGo server è®¾ç½®çš„ç›‘å¬åœ°å€æ˜¯å¦ä¸€è‡´ï¼ˆç‚¹å‡»Typoraå›¾ç‰‡è®¾ç½®ä¸­çš„éªŒè¯å›¾ç‰‡ä¸Šä¼ ï¼‰\njsDelivr jsDelivræ˜¯ä¸€ä¸ªå…è´¹ã€å¼€æºçš„åŠ é€ŸCDNå…¬å…±æœåŠ¡,æ‰˜ç®¡äº†è®¸å¤šå¤§å¤§å°å°çš„é¡¹ç›®,å¯åŠ é€Ÿè®¿é—®æ‰˜ç®¡çš„é¡¹ç›®ç›®å½•æˆ–å›¾ç‰‡èµ„æºã€‚ ä»–æ”¯æŒæä¾›npmã€Githubã€WordPressä¸Šèµ„æºcdnæœåŠ¡ã€‚\nCDN (å…¨ç§° Content Delivery Network)ï¼Œå³å†…å®¹åˆ†å‘ç½‘ç»œã€‚\nCDNæ„å»ºåœ¨ç°æœ‰ç½‘ç»œåŸºç¡€ä¹‹ä¸Šçš„æ™ºèƒ½è™šæ‹Ÿç½‘ç»œï¼Œä¾é éƒ¨ç½²åœ¨å„åœ°çš„è¾¹ç¼˜æœåŠ¡å™¨ï¼Œé€šè¿‡ä¸­å¿ƒå¹³å°çš„è´Ÿè½½å‡è¡¡ã€å†…å®¹åˆ†å‘ã€è°ƒåº¦ç­‰åŠŸèƒ½æ¨¡å—ï¼Œä½¿ç”¨æˆ·å°±è¿‘è·å–æ‰€éœ€å†…å®¹ï¼Œé™ä½ç½‘ç»œæ‹¥å¡ï¼Œæé«˜ç”¨æˆ·è®¿é—®å“åº”é€Ÿåº¦å’Œå‘½ä¸­ç‡ã€‚\nCDN çš„å…³é”®æŠ€æœ¯ä¸»è¦æœ‰å†…å®¹å­˜å‚¨å’Œåˆ†å‘æŠ€æœ¯ï¼Œç®€å•æ¥è®²ï¼ŒCDNå°±æ˜¯æ ¹æ®ç”¨æˆ·ä½ç½®åˆ†é…æœ€è¿‘çš„èµ„æºï¼Œäºæ˜¯ï¼Œç”¨æˆ·åœ¨ä¸Šç½‘çš„æ—¶å€™ä¸ç”¨ç›´æ¥è®¿é—®æºç«™ï¼Œè€Œæ˜¯è®¿é—®ç¦»ä»–â€œæœ€è¿‘çš„â€ä¸€ä¸ª CDN èŠ‚ç‚¹(ä¹Ÿå«åšâ€œè¾¹ç¼˜èŠ‚ç‚¹â€ã€edge node)ï¼Œå…¶å®å°±æ˜¯ç¼“å­˜äº†æºç«™å†…å®¹çš„ä»£ç†æœåŠ¡å™¨\n","date":"2025-06-12T19:33:46+08:00","permalink":"https://charles-7777.github.io/hugo-stack/p/github--picgo-%E6%90%AD%E5%BB%BA%E5%9B%BE%E5%BA%8A/","title":"Github + PicGo æ­å»ºå›¾åºŠ"},{"content":" åˆ›å»ºä»“åº“ é¦–å…ˆåœ¨githubåˆ›å»ºä¸¤ä¸ªä»“åº“ï¼Œä¸€ä¸ªç”¨äºå­˜å‚¨hugo new siteåˆ›å»ºçš„workspaceï¼Œè¿™ä¸ªè®¾ç½®ä¸ºprivateç§å¯†ï¼›å¦ä¸€ä¸ªä»“åº“ç”¨æ¥å­˜å‚¨hugo -Dç”Ÿæˆçš„ç½‘é¡µæ–‡ä»¶ ï¼Œè®¾ç½®ä¸ºå…¬å¼€:\næœ¬åœ°è·å–sshå¯†é’¥ ç»ˆç«¯è¾“å…¥å‘½ä»¤ï¼š\n1 2 git config --global user.email \u0026#34;you@example.com\u0026#34; #you@example.comæ›¿æ¢ä¸ºä½ çš„é‚®ç®± git config --global user.name \u0026#34;Your Name\u0026#34; #Your Nameæ›¿æ¢ä¸ºä½ çš„åå­—å¹¶å›è½¦ ç”Ÿæˆssh key,åœ¨git bashä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤:\nssh-keygen -t rsa -C \u0026quot;your_email@example.com\u0026quot; ç”Ÿæˆçš„å¯†é’¥å°†å­˜å‚¨åœ¨C:\\uers\\username\\.ssh\\è·¯å¾„ä¸‹ æ‰“å¼€å…¬é’¥æ–‡ä»¶ id_rsa.pubï¼Œ å¤åˆ¶æ‰€æœ‰å†…å®¹ï¼Œåœ¨GitHubä¸Šæ‰“å¼€Setting -\u0026gt; SSH and GPG keys -\u0026gt; add SSH keyï¼Œå°†å¤åˆ¶çš„å†…å®¹ç²˜è´´åœ¨é‡Œè¾¹ï¼Œä¿å­˜ã€‚\nè‹¥é…ç½®å®Œåï¼Œè¿˜æ˜¯æ˜¾ç¤ºæ— æ³•è¿æ¥åˆ°github,å¯èƒ½æ˜¯ä½ çš„Windowsç”µè„‘çš„username æ˜¯ä¸­æ–‡å¯¼è‡´çš„bug æˆ–è€…å°è¯•åœ¨.ssh ä¸‹åˆ›å»ºä¸€ä¸ªconfig æ–‡ä»¶\n1 2 3 4 5 6 Host github.com HostName ssh.github.com # **è¿™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†** User git Port 443 PreferredAuthentications publickey IdentityFile ~/.ssh/id_rsa åˆ›å»ºgithub token åœ¨ GitHub è´¦æˆ·ä¸‹ Setting - Developer setting - Personal access tokens(classic) ä¸‹åˆ›å»ºä¸€ä¸ªä¸è¿‡æœŸ(no expiration)çš„ Tokenï¼Œæƒé™éœ€è¦å¼€å¯ repo ä¸ workflowã€‚\nï¼ˆæ³¨æ„ï¼štokenåªä¼šæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·åŠæ—¶ä¿å­˜ï¼‰ ç§å¯†æºä»“åº“è®¾ç½®token åœ¨åšå®¢æºä»“åº“çš„ Settings-\u0026gt;Secrets-\u0026gt;Actions ä¸­æ·»åŠ  PERSONAL_TOKEN ç¯å¢ƒå˜é‡ä¸ºåˆšæ‰çš„ Token,\nè¿™æ · GitHub Action å°±å¯ä»¥è·å–åˆ°Token äº†ã€‚ æœ¬åœ°é¦–æ¬¡åˆ›å»ºåšå®¢ 1 2 3 hugo new site hugo-stack-blog-dev git init git submodule add https://github.com/CaiJimmy/hugo-theme-stack/ themes/hugo-theme-stack git submoduleä¸»è¦æ˜¯å°†è‡ªå·±çš„æ”¹åŠ¨ï¼Œä¸å¼•ç”¨çš„stackä¸»é¢˜ä»“åº“åˆ†å¼€ã€‚hugo-theme-stack ä¸‹çš„ç›®å½•ç»“æ„åŸºæœ¬ä¸ç«™ç‚¹æºç›®å½•ç»“æ„ä¸€è‡´ hugo ç”Ÿæˆç½‘ç«™æ—¶ä¼˜å…ˆå¯»æ‰¾ç«™ç‚¹æºç›®å½•ä¸‹çš„ï¼Œæ‰¾ä¸åˆ°ï¼Œæ‰ä¼šå»stackä¸»é¢˜å¯¹åº”ç›®å½•ä¸‹å¯»æ‰¾\næ¥ä¸‹æ¥å°† exampleSiteæ ·ä¾‹æ•°æ®ä¸­çš„ Content å’Œ hugo.yaml å¤åˆ¶åˆ°ä¸»æ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶åˆ æ‰hugo.toml\nå¯ä»¥hugo server -Dçœ‹ä¸€ä¸‹åˆå§‹ç½‘ç«™é•¿å•¥æ ·\nåˆ›å»ºä¸€ç¯‡æ–°æ–‡ç« (åœ¨ä¸»ç›®å½•ä¸‹)\n1 hugo new post/blog1/index.zh-cn.md åˆå§‹åŒ–åšå®¢æºä»“åº“ï¼Œæäº¤åˆ°github\n1 2 3 4 5 git add . git commit -m \u0026#34;first commit\u0026#34; git branch -M main git remote add origin git@github.com:charles-7777/hugo-stack-blog-dev.git git push -u origin main åˆ›å»ºworkflowså‘å¸ƒæ–‡ä»¶ åœ¨æœ¬åœ°åšå®¢ä¸»ç›®å½•ä¸‹åˆ›å»º .github/workflowsç›®å½•ï¼Œç„¶ååˆ›å»ºxxxx.yamlæ–‡ä»¶ã€‚æˆ‘çš„ GitHub Action é…ç½®ä¸ºï¼Œè‡ªåŠ¨å‘å¸ƒç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 name: deploy # ä»£ç æäº¤åˆ°mainåˆ†æ”¯æ—¶è§¦å‘github action on: push: branches: - main jobs: deploy: runs-on: ubuntu-latest steps: - name: Checkout uses: actions/checkout@v2 with: submodules: recursive fetch-depth: 0 - name: Setup Hugo uses: peaceiris/actions-hugo@v3 with: hugo-version: \u0026#34;0.147.7\u0026#34; extended: true - name: Build Web run: hugo -D - name: Deploy Web uses: peaceiris/actions-gh-pages@v4 with: PERSONAL_TOKEN: ${{ secrets.TOKEN }} EXTERNAL_REPOSITORY: charles-7777/hugo-stack PUBLISH_BRANCH: main PUBLISH_DIR: ./public commit_message: auto deploy æäº¤github actionçš„æ”¹åŠ¨åï¼Œæ¯æ¬¡push hugo-stack-blog-dev ,å°±ä¼šæŠŠåŸºäºè¿™ä¸ªå‚åº“ hugo -D ç”Ÿæˆçš„æ–‡ä»¶ è‡ªåŠ¨push åˆ°ä»“åº“ hugo-stack\nGitHub Pages å‰å¾€hugo-stack ä»“åº“çš„settings--\u0026gt;Pageså»æ·»åŠ deploy GitHub Pages åœ¨åˆ«çš„ç”µè„‘æ‹‰å–æºä»“åº“ä¿®æ”¹ 1 2 3 git clone git@github.com:charles-7777/hugo-stack-blog-dev.git git submodule init git submodule update å‚è€ƒé“¾æ¥\nhttps://letere-gzj.github.io/hugo-stack/tags/hugo/\nå‚è€ƒåšä¸»letere-gzjçš„è§†é¢‘ markdownä¸­çš„å›¾ç‰‡ä¹Ÿå¯ä»¥ä¸ç”¨æœ¬åœ°çš„å›¾ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨ç½‘ç»œurlï¼Œå¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ªå›¾åºŠï¼Œæ–¹ä¾¿ç®¡ç†ã€‚ githubå›¾åºŠ\n","date":"2025-06-09T00:00:00Z","image":"https://cdn.jsdelivr.net/gh/charles-7777/ImageBed@main/blog/hugo.png","permalink":"https://charles-7777.github.io/hugo-stack/p/hugo-stack-blog-%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95/","title":"hugo stack blog æ­å»ºè®°å½•"}]